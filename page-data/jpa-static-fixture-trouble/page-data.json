{"componentChunkName":"component---src-templates-blog-template-js","path":"/jpa-static-fixture-trouble/","result":{"data":{"cur":{"id":"d8b36762-4fef-5be7-8a68-c557aed75585","html":"<h2 id=\"문제상황\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\" aria-label=\"문제상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제상황</h2>\n<p><a href=\"https://github.com/woowacourse/jwp-qna\">우테코 QNA 미션</a>에서 상수로 선언된 엔티티 픽스쳐가 있었다. 레벨3 같은 팀 크루인 봄이 해당 미션을 진행하다 테스트가 터져 어쩌다보니 같이 원인을 찾게 되었다. 상황을 비슷하게 복구해보자면 이런 구성이었다.  <!--more--></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BlogServiceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">BlogService</span> blogService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">User</span> <span class=\"token constant\">USER_A</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"새로운 회원 저장 후 포스트 저장 1\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">saveUser_savePost1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        blogService<span class=\"token punctuation\">.</span><span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span><span class=\"token constant\">USER_A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        blogService<span class=\"token punctuation\">.</span><span class=\"token function\">savePost</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포스팅1\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">USER_A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"새로운 회원 저장 후 포스트 저장 2\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">saveUser_savePost2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        blogService<span class=\"token punctuation\">.</span><span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span><span class=\"token constant\">USER_A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        blogService<span class=\"token punctuation\">.</span><span class=\"token function\">savePost</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포스팅2\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">USER_A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>원본 미션 코드에서는 픽스쳐가 <code class=\"language-text\">public static final</code>로 별도 클래스에 선언되어 있었다. 그런데 테스트 클래스 하나에서만 사용되고 있어서 해당 클래스로 옮겼던 것 같다. 나도 픽스쳐를 옮겼다가, 평소 쓰는 방식대로 한다고 지웠었다.</p>\n<p>어쨌든 <code class=\"language-text\">User</code>와 <code class=\"language-text\">Post</code>는 <code class=\"language-text\">Post -> User</code>의 단방향 연관관계였고, <code class=\"language-text\">BlogService</code>는 <code class=\"language-text\">UserRepository, PostRepository</code>를 통해 저장해주는 상태였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Post</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">500</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> contents<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">User</span> writer<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그러다 테스트가 터지며 의문의 에러메시지를 마주했다.</p>\n<blockquote>\n<p>org.springframework.dao.DataIntegrityViolationException: could not execute statement; SQL [n/a]; constraint [FK83S99F4KX8OIQM3RO0SASMPWW]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement</p>\n</blockquote>\n<p>좀 더 내려보니 <code class=\"language-text\">insert</code> 수행이 안 되는 상황이었다.</p>\n<blockquote>\n<p>Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Referential integrity constraint violation: “FK83S99F4KX8OIQM3RO0SASMPWW: PUBLIC.POST FOREIGN KEY(USERS_ID) REFERENCES PUBLIC.USERS(ID) (CAST(1 AS BIGINT))”; SQL statement:\ninsert into post (id, contents, user_id) values (default, ?, ?) [23506-214]</p>\n</blockquote>\n<p>무언가 <em><strong>외래키가 없어서 post에 insert가 안 되는 상황인가…?</strong></em> 하는 추측은 했지만 이유를 알 수가 없었다. 분명히 <code class=\"language-text\">@Transactional</code>로 변경을 롤백한 후에, <code class=\"language-text\">saveUser()</code>를 통해 <code class=\"language-text\">USER_A</code>를 저장해줬기 때문이다.</p>\n<br>\n<h3 id=\"추측-1persist와-merge-실행-차이\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EC%B8%A1-1persist%EC%99%80-merge-%EC%8B%A4%ED%96%89-%EC%B0%A8%EC%9D%B4\" aria-label=\"추측 1persist와 merge 실행 차이 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추측 1.persist()와 merge() 실행 차이?</h3>\n<p><code class=\"language-text\">Post</code>를 저장하는데 외래키가 없는 게 맞다면 <code class=\"language-text\">User</code>를 저장할 때 문제가 생기는 것이라 추측했다. 그래서 디버거를 찍으며 따라가다 보니 <code class=\"language-text\">SimpleJpaRepository</code>라는 클래스의 <code class=\"language-text\">save()</code> 메서드에 도착했다. 여기서 **먼저 실행돼 통과하는 테스트는 persist()**를, **나중에 실행돼 실패하는 테스트는 merge()**를 호출하고 있음을 확인했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAzklEQVQY02XGWWrDMAAAUV+kTuM1lqxdsh0CKWTzHVqauPc/xBQcSD/68ZjJbAg4LfFWkVyPtZoQDD5EtDForRhdizcdnZD/CPlHSknmfUT1iuATKR0Y0p4YBmJMWG8x1qCtw1iL1+LFKUHQAtVLpOjp5VM2ek9sCg5dyclpjs4yiZZhV5GaglBtSXVBrLeMTc7UvLFfm7Nvc2K1IZQbQvW+yobpg+r8TX/7wlw/EfMPcl5oLnfa6wMxL9SXx/q720J7XdieHi/F6b4qz0+/Jfd/Nk1bLA0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"call merge\"\n        title=\"call merge\"\n        src=\"/static/26745027aaab5f8593b368764fd9910f/37523/merge.png\"\n        srcset=\"/static/26745027aaab5f8593b368764fd9910f/e9ff0/merge.png 180w,\n/static/26745027aaab5f8593b368764fd9910f/f21e7/merge.png 360w,\n/static/26745027aaab5f8593b368764fd9910f/37523/merge.png 720w,\n/static/26745027aaab5f8593b368764fd9910f/302a4/merge.png 1080w,\n/static/26745027aaab5f8593b368764fd9910f/07a9c/merge.png 1440w,\n/static/26745027aaab5f8593b368764fd9910f/e04e6/merge.png 2152w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그래서 실제로 저장된 적 없는 데이터인데 <code class=\"language-text\">merge()</code>로 처리되어서 들어가지 않는건가? 생각했다. 그런데 <code class=\"language-text\">show_sql</code>을 설정해 콘솔에서 sql문을 보니 <code class=\"language-text\">insert</code>가 실행되고 있었다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABDElEQVQoz12RS1LEMAxEc5zEfzuxk0ky9nwoFsCKLcVBWHD2piRiJmGh0kJdT91S8/r5jeePL8RpRYoDuq6DVArWezgfoIyBmwrub++Ynl4wDAPGcYS1Fs45aK1hnYcLAdoYNGu5Yyk3KKWRUkQIAVJKhln/K+rnjCnfkNYCrQ1SSgyOMTKUlxNQGzRzuWA+F/TbZhIIIdgpu5USSy5YL1ec1sxz0hGQZqQRooPgLtAs5Yo5X+C9R9/3LFJKcZGA4p/OBaSb1oy4ueOZlIc6AK1zHIViELg63QPJIS3aJ6mgauThMIQDjI5ene6B9SnGmIMzvrtzDyA9pW3b7Sbir/5HpqfR0nrfPZQi/wBjKd6rFfJ9ygAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sql\"\n        title=\"sql\"\n        src=\"/static/b80d694fac170b44fb688c4f2237ca6f/37523/sql.png\"\n        srcset=\"/static/b80d694fac170b44fb688c4f2237ca6f/e9ff0/sql.png 180w,\n/static/b80d694fac170b44fb688c4f2237ca6f/f21e7/sql.png 360w,\n/static/b80d694fac170b44fb688c4f2237ca6f/37523/sql.png 720w,\n/static/b80d694fac170b44fb688c4f2237ca6f/302a4/sql.png 1080w,\n/static/b80d694fac170b44fb688c4f2237ca6f/07a9c/sql.png 1440w,\n/static/b80d694fac170b44fb688c4f2237ca6f/0330c/sql.png 2458w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>알아보니 <code class=\"language-text\">merge()</code>는 아래 순서로 엔티티를 처리한다고 한다.</p>\n<ol>\n<li>id 값으로 1차 캐시 조회</li>\n<li>1차 캐시에 없다면 <code class=\"language-text\">select</code>문으로 DB에서 조회 후 있다면 1차 캐시에 저장</li>\n<li>조회 결과 마저 없으면 <code class=\"language-text\">insert</code>를 수행</li>\n</ol>\n<br>\n<h3 id=\"추측-2id값이-달라서\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EC%B8%A1-2id%EA%B0%92%EC%9D%B4-%EB%8B%AC%EB%9D%BC%EC%84%9C\" aria-label=\"추측 2id값이 달라서 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추측 2.id값이 달라서?</h3>\n<p>그럼 대체 왜 저장된 값의 PK가 없다고 하는 것일까?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABTElEQVQoz23M3U7jMBCG4VwLKzU/LYlTh7qJ7diJk5JC2zMuAKGWM+7/7F0laAWIPXj0zXwjTdQ2dzTqD5VM2JYZQqTc5ylFnrBOV6TJiixdsU5jsuQrsyRe5u82WUK0VQ2tH6mNQztHrS1F5ch3lrLpkcojKktWKjYPlrXU3D9YNpUhFYq03BMLRVwoEqGIxOVKebmRT3O+U51ekfN+fkWeb1TPN8TpSv3ygbi8k5+uiPNtUczz6Up2fCOd3paMDkPP9HRgHCzG1Gij2dcK7x3TcSIMnq7TONdiTIPWv839P5FtB8bD0/LU+g7jexrrMK4nTM+M0yNh7NGtX27f2VkXfoiUC0jTU9QOaTpK3VEow9xXNpDv3dLN8tojmi9b0yPtp6oNSBuIShMYxiPKT4h2ZN0Ekp1FmJ4wPmK6I9IdKEwgUX4R/8/uM/8CiW/shyq8w78AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ids\"\n        title=\"ids\"\n        src=\"/static/2508e47d6c3e3a11b8f2338a3974a28f/37523/different_ids.png\"\n        srcset=\"/static/2508e47d6c3e3a11b8f2338a3974a28f/e9ff0/different_ids.png 180w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/f21e7/different_ids.png 360w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/37523/different_ids.png 720w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/302a4/different_ids.png 1080w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/07a9c/different_ids.png 1440w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/ec5f6/different_ids.png 1852w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>디버거를 통해 찍어보니, 저장 된 뒤의 id는 <code class=\"language-text\">2L</code>인데 static 픽스쳐의 id는 <code class=\"language-text\">1L</code>이었다. FK로 1L의 값을 넣으니 찾을 수 없어 무결성 제약 조건에 위배되었던 것이다. <code class=\"language-text\">@Transactional</code>로 데이터는 초기화 되었지만, h2에서 id값은 초기화하지 않아서 생긴 문제였다. 생각보다 허망한 이유였다.</p>\n<br>\n<h2 id=\"해결안\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EC%95%88\" aria-label=\"해결안 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결안</h2>\n<h3 id=\"1-픽스쳐-공유하지-않기\" style=\"position:relative;\"><a href=\"#1-%ED%94%BD%EC%8A%A4%EC%B3%90-%EA%B3%B5%EC%9C%A0%ED%95%98%EC%A7%80-%EC%95%8A%EA%B8%B0\" aria-label=\"1 픽스쳐 공유하지 않기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 픽스쳐 공유하지 않기</h3>\n<p>평소 테스트를 할 때 일회용 인스턴트를 쓰고 버리는(?) 방식을 선호했다.</p>\n<ol>\n<li>테스트 격리를 위해 데이터도 격리한다</li>\n<li>생성되는 데이터를 메서드 내에서 바로 보고싶다</li>\n</ol>\n<p>그래서 같은 데이터를 쓰더라도 다 분리했기에 익숙한 형식으로 바꿨다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"새로운 회원 저장 후 포스트 저장 1\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">saveUser_savePost1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blogService<span class=\"token punctuation\">.</span><span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Post</span> post <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포스팅\"</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blogService<span class=\"token punctuation\">.</span><span class=\"token function\">savePost</span><span class=\"token punctuation\">(</span>post<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"새로운 회원 저장 후 포스트 저장 2\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">saveUser_savePost2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blogService<span class=\"token punctuation\">.</span><span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span>useer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Post</span> post <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포스팅\"</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blogService<span class=\"token punctuation\">.</span><span class=\"token function\">savePost</span><span class=\"token punctuation\">(</span>post<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>솔직히 테스트 픽스쳐를 공유해서 쓰다가 실제로 문제를 마주쳐 봐서 이렇게 한 것은 아니었고… <a href=\"https://jojoldu.tistory.com/611\">테스트 픽스처 올바르게 사용하기 by.향로</a> 이 포스팅을 읽었어서가 크다. 어쨌든 상수 픽스쳐를 사용한 건 처음이었다.</p>\n<br>  \n<h3 id=\"2-generatedvalue-떼기\" style=\"position:relative;\"><a href=\"#2-generatedvalue-%EB%96%BC%EA%B8%B0\" aria-label=\"2 generatedvalue 떼기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. @GeneratedValue 떼기</h3>\n<p>그럼 <code class=\"language-text\">id</code>를 직접 지정해주면 되지 않을까 싶어서 static 픽스쳐에서 지정해주고 <code class=\"language-text\">@GeneratedValue</code>를 제거했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BlogServiceTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Member</span> <span class=\"token constant\">MEMBER_A</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이러니 테스트는 통과했지만 사실 이렇게 짤 일은 없다고 생각한다. 그냥 다른 방법으로도 통과시켜 보려고 해본 것이다.</p>\n<br>\n<h2 id=\"그럼-기존-코드는-왜-\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9F%BC-%EA%B8%B0%EC%A1%B4-%EC%BD%94%EB%93%9C%EB%8A%94-%EC%99%9C-\" aria-label=\"그럼 기존 코드는 왜  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그럼 기존 코드는 왜…? 🤔</h2>\n<p>상수 픽스쳐 선언이 근본적으로 좋지 않은 방식이라면 왜 기존 미션 코드에서 사용하고 있었을까?<br>\n<a href=\"https://github.com/woowacourse/jwp-qna/blob/main/src/test/java/qna/service/QnaServiceTest.java\">기존 서비스 테스트 코드</a>를 보면 서비스를 슬라이스 테스트 하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> delete_성공<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">when</span><span class=\"token punctuation\">(</span>questionRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndDeletedFalse</span><span class=\"token punctuation\">(</span>question<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">thenReturn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>question<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">when</span><span class=\"token punctuation\">(</span>answerRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByQuestionIdAndDeletedFalse</span><span class=\"token punctuation\">(</span>question<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">thenReturn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span>answer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">Repository</code>의 메서드를 모두 모킹하고 있기 때문에 <code class=\"language-text\">JPA</code>와 무관한 테스트였다. 따라서 정말 <em>고정된 값</em>으로써의 상수 픽스쳐를 사용해도 괜찮았던 것이다. 이를 통합 테스트로 바꾸면서 생긴 문제였다.</p>\n<p>테스트 간 데이터 격리가 중요하다는 말이 맞는 말이긴 하지만, 이전까진 고정관념처럼 무작정 받아들여 박혀있었다. 그런데 이번 문제를 맞딱드리면서 고정관념이 아닌 <em>진짜 나의 생각</em>이 된 것 같아 좋았다. 어쨌든, 테스트 격리 잘 하자.</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\">문제상황</a></p>\n<ul>\n<li><a href=\"#%EC%B6%94%EC%B8%A1-1persist%EC%99%80-merge-%EC%8B%A4%ED%96%89-%EC%B0%A8%EC%9D%B4\">추측 1.persist()와 merge() 실행 차이?</a></li>\n<li><a href=\"#%EC%B6%94%EC%B8%A1-2id%EA%B0%92%EC%9D%B4-%EB%8B%AC%EB%9D%BC%EC%84%9C\">추측 2.id값이 달라서?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%95%B4%EA%B2%B0%EC%95%88\">해결안</a></p>\n<ul>\n<li><a href=\"#1-%ED%94%BD%EC%8A%A4%EC%B3%90-%EA%B3%B5%EC%9C%A0%ED%95%98%EC%A7%80-%EC%95%8A%EA%B8%B0\">1. 픽스쳐 공유하지 않기</a></li>\n<li><a href=\"#2-generatedvalue-%EB%96%BC%EA%B8%B0\">2. @GeneratedValue 떼기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B7%B8%EB%9F%BC-%EA%B8%B0%EC%A1%B4-%EC%BD%94%EB%93%9C%EB%8A%94-%EC%99%9C-\">그럼 기존 코드는 왜…? 🤔</a></p>\n</li>\n</ul>\n</div>","excerpt":"문제상황 우테코 QNA 미션에서 상수로 선언된 엔티티 픽스쳐가 있었다. 레벨3 같은 팀 크루인 봄이 해당 미션을 진행하다 테스트가 터져 어쩌다보니 같이 원인을 찾게 되었다. 상황을 비슷하게 복구해보자면 이런 구성이었다.   원본 미션 코드에서는 픽스쳐가 로 별도 클래스에 선언되어 있었다. 그런데 테스트 클래스 하나에서만 사용되고 있어서 해당 클래스로 옮겼던 것 같다. 나도 픽스쳐를 옮겼다가, 평소 쓰는 방식대로 한다고 지웠었다. 어쨌든 와 는 의 단방향 연관관계였고, 는 를 통해 저장해주는 상태였다. 그러다 테스트가 터지며 의문의 에러메시지를 마주했다. org.springframework.dao.DataIntegrityViolationException: could not execute statement; SQL [n/a]; constraint [FK83S99F4KX8OIQM3RO0SASMPWW]; nested exception is org.hibernate.exception.Con…","frontmatter":{"date":"August 13, 2022","title":"[JPA] 상수 픽스쳐 사용 주의","categories":"JPA 트러블슈팅","author":"써머","emoji":"headers/jpa-static-fixture-trouble.png"},"fields":{"slug":"/jpa-static-fixture-trouble/"}},"next":{"id":"974e8c24-9935-58ce-9245-bbb561588786","html":"<p>야생 학습을 하면 자연스레 지식이 실전을 뒤따르게 된다. 우테코에서 처음 제대로 경험한 야생 학습은 낯설었으나 <em>너무 잘</em> 적응한 탓인지 어느 순간 당장 쓰이지 않을 지식을 공부하는 게 마땅찮았다.<br>\n당장 터지는 테스트를 고치고 싶을 뿐인데 왜 <code class=\"language-text\">Configuration</code>을 알아야 하지? 이걸 쓸 때가 있을까? 좋게 말하면 야생, 나쁘게 말하면 땜빵 마인드로, 그래도 연계되는 지식을 우겨넣고는 있었다. 언젠가는 쓸모가 있겠지 하고.  <!--more-->\n이런 <em>알지만 알지 못하는 죽은 지식</em>이 레벨3 프로젝트를 하다 <em>죽은 줄 알았지만 다 때가 있구나!</em> 로 바뀌는 순간을 겪었다.</p>\n<h2 id=\"bean은-외부-라이브러리를-등록하고\" style=\"position:relative;\"><a href=\"#bean%EC%9D%80-%EC%99%B8%EB%B6%80-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC%EB%A5%BC-%EB%93%B1%EB%A1%9D%ED%95%98%EA%B3%A0\" aria-label=\"bean은 외부 라이브러리를 등록하고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@Bean은 외부 라이브러리를 등록하고…</h2>\n<p>나에겐 <code class=\"language-text\">@Bean</code>이 <em>알지만 알지 못하는 죽은 지식</em>이었다.\n<a href=\"https://hyewoncc.github.io/2022/04/25/spring-study-1.html#bean%EA%B3%BC-component%EC%9D%98-%EC%B0%A8%EC%9D%B4\">@Bean과 @Component의 차이</a> 포스팅을 쓰기도 했고, <code class=\"language-text\">@Bean</code>의 쓰임새가 뭐냐고 하면 줄줄 얘기할 수 있었다. <em>개발자가 직접 제어할 수 없는 외부 라이브러리 클래스를 빈에 등록할 때 사용됩니다.</em> 하고. 그런데 좀처럼 <code class=\"language-text\">@Bean</code>을 사용할 일이 없었다.</p>\n<p>그러다 레벨3 프로젝트인 줍줍에서 슬랙 api를 자바 라이브러리를 통해 호출하게 되었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">MethodsClient</span> slackClient <span class=\"token operator\">=</span> <span class=\"token class-name\">Slack</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">methods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">ConversationsInfoResponse</span> response <span class=\"token operator\">=</span> slackClient<span class=\"token punctuation\">.</span><span class=\"token function\">conversationsInfo</span><span class=\"token punctuation\">(</span>\n    request <span class=\"token operator\">-></span> request<span class=\"token punctuation\">.</span><span class=\"token function\">token</span><span class=\"token punctuation\">(</span>slackBotToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>해당 코드를 살펴보자. 우선 <code class=\"language-text\">Slack.getInstance()</code>부분이다. <code class=\"language-text\">getInstance()</code>라는 정적 팩토리 메서드 명에서 추측 가능하듯이 <code class=\"language-text\">Slack</code>의 싱글턴 객체를 얻게 된다. <code class=\"language-text\">methods()</code>는 <code class=\"language-text\">MethodsClient</code>라는 api 호출용 인스턴스를 반환한다. 이 <code class=\"language-text\">methods()</code>안에서는 http 요청을 보낼 때 필요값을 설정하는 작업이 일어난다.</p>\n<p>얻게 되는 최종 인스턴스는 <code class=\"language-text\">MethodsClientImpl</code>이라는 <code class=\"language-text\">MethodsClient</code>의 구현체이다. 변경되는 상태값이 없는데다 여러 객체에서 이 인스턴스를 이용해 슬랙 api를 호출한다. 따라서 필요한 곳에서 중복 생성하기 보다 싱글턴 스프링 빈으로 만들어 관리하고 주입하는게 좋을 것 같았다. 그런데 이걸 어떻게 빈으로 만들까? 생각하다가 <em>바로 이 때 <code class=\"language-text\">@Bean</code>을 쓰는 거구나!</em> 하는 깨달음이 왔다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SlackConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MethodsClient</span> <span class=\"token function\">methodsClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Slack</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">methods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그리고 이렇게 생성한 빈을 해당 객체를 사용하는 곳에서 주입받게 개선했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberInitializer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MemberInitializer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>slackClient <span class=\"token operator\">=</span> slackClient<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberRepository <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<br>\n<h2 id=\"야생-적응-완료-기념비\" style=\"position:relative;\"><a href=\"#%EC%95%BC%EC%83%9D-%EC%A0%81%EC%9D%91-%EC%99%84%EB%A3%8C-%EA%B8%B0%EB%85%90%EB%B9%84\" aria-label=\"야생 적응 완료 기념비 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>야생 적응 완료 기념비</h2>\n<p>어찌보면 그냥 <em><code class=\"language-text\">@Bean</code>을 사용했다</em> 로 요약할 수 있는 하찮은 내용을 굳이 회고 포스팅으로 남긴 두 가지 이유가 있다. 먼저 이 일을 통해 내가 완전히 야생 학습에 적응했다는 것을 기념하고 싶어서다.</p>\n<p><a href=\"https://github.com/hyewoncc/woowa-writing-4/blob/hyewoncc/level2.md\">우테코 레벨2 글쓰기 미션</a>에서 야생 학습이 익숙하지 않았음을 얘기했었다. 주어진 인터넷 강의를 차례로 들으며 따라 치는게 익숙했었고, 책을 목차대로 읽는게 마음 편했다. 그런데 이번 일로 야생에서 익히지 않은, 그러니까 실전과 일치하지 않는 지식은 사실 나에게 <em>진짜</em> 와닿은 지식이 아니었음을 실감했다. 우테코에 와서 바뀐 나의 학습 모습이 스스로도 놀랍다.</p>\n<p>두번째로, 다람쥐가 묻어두고 잊어버린 도토리처럼 죽은 줄 알았던 지식이 우연히 실전이라는 비를 만나 싹틔우는 짜릿함에 눈뜬 것을 기념하기 위함이다. 부끄럽지만 깊은 학습을 해야 한다고 되뇌이면서도, 야생 학습이라는 핑계로 늘 빠져나갈 궁리를 했던 것 같다. 그런데 <code class=\"language-text\">@Bean</code>이라는 복선이 회수되는 순간 진심으로 <code class=\"language-text\">와... 이걸 위해 공부했구나!</code> 싶어 정말 기뻤다. 야생 학습과 모순되는 말이겠지만 이 즐거움을 더 느끼고 싶어서라도 지식을 더 더 많이, 미리 확장시켜 둬야겠다 생각했다.</p>\n<p>하여간 <code class=\"language-text\">@Bean</code>하나 적절히 쓴 걸로 유난이다 싶을 수도 있겠지만… 이 일이 있어 더 열심히 할 수 있을 것 같다. 또 다시 <em>얻어 걸리기</em> 위해서.  레벨3, 진~짜 힘들지만 재밌다.</p>\n<br>  \n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#bean%EC%9D%80-%EC%99%B8%EB%B6%80-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC%EB%A5%BC-%EB%93%B1%EB%A1%9D%ED%95%98%EA%B3%A0\">@Bean은 외부 라이브러리를 등록하고…</a></li>\n<li><a href=\"#%EC%95%BC%EC%83%9D-%EC%A0%81%EC%9D%91-%EC%99%84%EB%A3%8C-%EA%B8%B0%EB%85%90%EB%B9%84\">야생 적응 완료 기념비</a></li>\n</ul>\n</div>","frontmatter":{"date":"August 02, 2022","title":"야생에서 사과씨 심기 (@Bean)","categories":"Spring 회고 우아한테크코스","author":"써머","emoji":"headers/wild-seed.png"},"fields":{"slug":"/wild-seed/"}},"prev":{"id":"fa74bf94-c4c4-53ef-a3b5-e3dde0bc36d6","html":"<h2 id=\"문제상황\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\" aria-label=\"문제상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제상황</h2>\n<h3 id=\"서비스-배경지식\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%B0%B0%EA%B2%BD%EC%A7%80%EC%8B%9D\" aria-label=\"서비스 배경지식 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서비스 배경지식</h3>\n<h4 id=\"첫번째-참고\" style=\"position:relative;\"><a href=\"#%EC%B2%AB%EB%B2%88%EC%A7%B8-%EC%B0%B8%EA%B3%A0\" aria-label=\"첫번째 참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>첫번째 참고</h4>\n<p>현재 개발중인 <a href=\"https://github.com/woowacourse-teams/2022-pickpick\">줍줍</a>은 슬랙 무료 워크스페이스의 사라지는 메세지들을 대신 저장하고 보여주는 서비스다.\n메세지 저장을 위해 최초 어플리케이션 구동 시, 해당 워크스페이스에 속한 모든 회원 정보를 가져온다.\n이 역할을 <code class=\"language-text\">MemberInicializer</code>라는 클래스의 <code class=\"language-text\">@PostContruct</code>안에 작성했다. 이유는 아래와 같았다.   <!--more--></p>\n<ol>\n<li>어플리케이션이 구동하는 동안 발생하는 신규 가입, 탈퇴 이벤트는 실시간 반영이 된다</li>\n<li>하지만 어플리케이션 최초 구동 전, 또는 업데이트 배포로 어플리케이션이 중지된 사이에 발생한 이벤트는 반영이 안된다</li>\n<li>따라서 재구동 시 한 번 슬랙 API를 호출하여, 유저 정보를 업데이트한다</li>\n</ol>\n<p>유저 정보를 메시지에서 참조하고 있어서 저장이 선행되어야 했다.\n또, 로그인 시 이 정보와 <code class=\"language-text\">OAuth</code> 슬랙 로그인으로 받은 정보를 대조해서 자체 토큰을 발급하는 까닭도 있다.</p>\n<br>\n<h4 id=\"두번째-참고\" style=\"position:relative;\"><a href=\"#%EB%91%90%EB%B2%88%EC%A7%B8-%EC%B0%B8%EA%B3%A0\" aria-label=\"두번째 참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>두번째 참고</h4>\n<p>슬랙은 <code class=\"language-text\">MethodClient</code>라는 이름으로 슬랙 API에 HTTP 요청을 보내고 응답을 받는 객체를 제공한다.\n그래서 슬랙 API 호출이 필요한 곳에서는 이 <code class=\"language-text\">MethodClient</code> 빈을 주입받아 사용한다.\n이렇게 만들어진 <code class=\"language-text\">MemberInitializer</code> 코드는 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberInitializer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MemberInitializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>slackClient <span class=\"token operator\">=</span> slackClient<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberRepository <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setupMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SlackApiException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> savedSlackIds <span class=\"token operator\">=</span> <span class=\"token function\">findSavedSlackIds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> currentWorkspaceMembers <span class=\"token operator\">=</span> <span class=\"token function\">fetchWorkspaceMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> membersToSave <span class=\"token operator\">=</span> <span class=\"token function\">filterMembersToSave</span><span class=\"token punctuation\">(</span>savedSlackIds<span class=\"token punctuation\">,</span> currentWorkspaceMembers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span>membersToSave<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">fetchWorkspaceMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SlackApiException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 실제로 슬랙 API 호출이 이뤄지는 부분</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">toMembers</span><span class=\"token punctuation\">(</span>slackClient<span class=\"token punctuation\">.</span><span class=\"token function\">usersList</span><span class=\"token punctuation\">(</span>request <span class=\"token operator\">-></span> request<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">getMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<br>\n<h3 id=\"테스트-시-외부-api-호출을-대체할-mockbean-사용\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C-%EC%99%B8%EB%B6%80-api-%ED%98%B8%EC%B6%9C%EC%9D%84-%EB%8C%80%EC%B2%B4%ED%95%A0-mockbean-%EC%82%AC%EC%9A%A9\" aria-label=\"테스트 시 외부 api 호출을 대체할 mockbean 사용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트 시 외부 API 호출을 대체할 @MockBean 사용</h3>\n<p>테스트에서 실제 슬랙 API를 호출하지 않기 위해 해당 <code class=\"language-text\">MethodClient</code>를 <code class=\"language-text\">@MockBean</code>을 통한 가짜 객체로 바꿔쳤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@AutoConfigureMockMvc</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthServiceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@MockBean</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">void</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SlackApiException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"slackId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"thumbnail.png\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">given</span><span class=\"token punctuation\">(</span>slackClient<span class=\"token punctuation\">.</span><span class=\"token function\">oauthV2Access</span><span class=\"token punctuation\">(</span><span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OAuthV2AccessRequest</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">willReturn</span><span class=\"token punctuation\">(</span><span class=\"token function\">generateOAuthV2AccessResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>사유는 다음과 같다.</p>\n<ol>\n<li>슬랙의 서버 상태에 의존하는 테스트가 된다</li>\n<li>원하는 특정 값 또는 상황을 테스트하기 어렵다</li>\n<li>(아직 걸린 적은 없지만) 호출 제한이 걸릴 수 있다</li>\n</ol>\n<p>참고로 <a href=\"https://api.slack.com/docs/rate-limits\">슬랙 API</a>는 명세 별로 등급에 따라 호출 횟수를 제한한다. <code class=\"language-text\">Tier2</code>의 경우 분당 약 20회로 제한되는데, 테스트가 늘어난다면 충분히 걸릴 수 있는 횟수로 보인다.</p>\n<p>그런데 한 인수테스트에서 <code class=\"language-text\">@MockBean</code>을 선언하자 <code class=\"language-text\">ApplicationContext</code> 로드가 실패했다.</p>\n<blockquote>\n<p>Failed to load ApplicationContext</p>\n</blockquote>\n<p>java.lang.IllegalStateException: Failed to load ApplicationContext\nat org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:132)\nat org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:124)\nat org.springframework.boot.test.mock.mockito.MockitoTestExecutionListener.postProcessFields(MockitoTestExecutionListener.java:110)</p>\n<blockquote>\n<p>…<br>\nCaused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name ‘memberInitializer’: Invocation of init method failed; nested exception is java.lang.NullPointerException</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">at app//org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor.postProcessBeforeInitialization(InitDestroyAnnotationBeanPostProcessor.java:160)  </code></pre></div>\n<blockquote>\n<p>…<br>\nCaused by: java.lang.NullPointerException</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">at com.pickpick.member.application.MemberInitializer.fetchWorkspaceMembers(MemberInitializer.java:46)\nat com.pickpick.member.application.MemberInitializer.setupMember(MemberInitializer.java:31)\nat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)  </code></pre></div>\n<blockquote>\n<p>…</p>\n</blockquote>\n<br>\n<h2 id=\"해결시도\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EC%8B%9C%EB%8F%84\" aria-label=\"해결시도 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결시도</h2>\n<h3 id=\"1-빈-재정의하기\" style=\"position:relative;\"><a href=\"#1-%EB%B9%88-%EC%9E%AC%EC%A0%95%EC%9D%98%ED%95%98%EA%B8%B0\" aria-label=\"1 빈 재정의하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 빈 재정의하기</h3>\n<p><a href=\"https://hyewoncc.github.io/2022/04/25/spring-study-1.html#%EC%9D%BC%EB%8B%A8-%ED%95%B4%EA%B2%B0%EC%9D%80-%ED%96%88%EC%9C%BC%EB%82%98\">예전에 DAO 객체를 테스트 할 때, 실제 DB 대신 HashMap을 이용한 가짜 객체를 사용</a>했다.\n이 때 추출한 인터페이스의 구현체를 빈으로 등록하고, 테스트에서 덮어 씌웠다. 그래서 <code class=\"language-text\">@PostConstruct</code> 내용물이 텅 빈 가짜 클래스를 만들어 해당 방식을 시도했다. 하지만 아랑곳않고 예외가 터졌다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FakeMemberInitializer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MemberInitializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>slackClient <span class=\"token operator\">=</span> slackClient<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberRepository <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setupMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SlackApiException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 텅 빈 메서드  </span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">@PostConstruct</code>의 실행 시점이 문제였다.\n이 방법을 시도하면서 기대한 실행 시점은 아래와 같았다.</p>\n<ol>\n<li><code class=\"language-text\">MemberInitializer</code>가 생성되고, 주입된다</li>\n<li><code class=\"language-text\">FakeMemberInitializer</code>가 덮어 씌워진다</li>\n<li><code class=\"language-text\">FakeMemberInitializer</code>의 텅 빈 <code class=\"language-text\">setupMember()</code>가 호출된다</li>\n</ol>\n<p>그런데 실제로는 <code class=\"language-text\">1-3-2</code>의 순서로 실행되는 것 같았다.\n테스트용 깡통 빈으로 덮어 씌우기 전에 <code class=\"language-text\">@MockBean</code>으로 대치된 <code class=\"language-text\">MethodClient</code>를 사용하니 <code class=\"language-text\">NullPointerException</code>이 발생한 것이었다.</p>\n<br>\n<h3 id=\"2-profile로-생성-막기\" style=\"position:relative;\"><a href=\"#2-profile%EB%A1%9C-%EC%83%9D%EC%84%B1-%EB%A7%89%EA%B8%B0\" aria-label=\"2 profile로 생성 막기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. @Profile로 생성 막기</h3>\n<p><code class=\"language-text\">@PostContruct</code>를 쓰는 한, 빈의 생성 자체를 막아야 한다고 판단했다.\n그래서 <code class=\"language-text\">@Profile</code>을 통해 해당 빈이 프로뎍션 환경에서만 생성되도록 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prod\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberInitializer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">@Profile</code>을 도입하는 동시에 다른 팀원의 도움으로 로컬, 개발, 운영 설정의 분리도 함께 이루어졌다. 각 환경에 필요한 <code class=\"language-text\">yml</code> 설정 파일을 지원 형식에 따라 명명했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVQY03WPy07DMBREu2+RYMUngFBasQGa5/UjadMEN7HjpMqGx/9/xKC4hrYgFiNf2zPH41lIAtcrwjxgWCwZFgHh9rnEU93hIbe44xr30uDmUWIekPecacnc+dWKI5ZbzBImsE4ZwowjzJjTtOfbCnp8gzIWe2ORlzVeUvKek9f5M4aIOOTGA6OMISaOmJjXFCAIkePdjjDDAdr2aLsJ3qGsFaKUfIYjzhgSxiGKzQk4veBWD19nBCkKfNgRejig7Xo0ncVro92sWoOUS585ghPilw3/A7Z2QGOO7XZq72alO+TlDuGvpn+A35cTMBcFPqeG/fDz3Uo1rqnSBnlZXQKJ4QuOsdNR4CyAawAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ymls\"\n        title=\"ymls\"\n        src=\"/static/78c374a54f2c2f2667643e82d31eddbc/37523/ymls.png\"\n        srcset=\"/static/78c374a54f2c2f2667643e82d31eddbc/e9ff0/ymls.png 180w,\n/static/78c374a54f2c2f2667643e82d31eddbc/f21e7/ymls.png 360w,\n/static/78c374a54f2c2f2667643e82d31eddbc/37523/ymls.png 720w,\n/static/78c374a54f2c2f2667643e82d31eddbc/167b5/ymls.png 776w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그리고 각 배포 스크립트에서 명령어로 어떤 <code class=\"language-text\">profile</code>을 활성화 시킬 것인지 지정해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token parameter variable\">-Dspring.profiles.active</span><span class=\"token operator\">=</span>prod pickpick-0.0.1-SNAPSHOT.jar</code></pre></div>\n<p>생각해보면 이제까지 테스트에서 컨텍스트가 로딩될 때 마다 실제로 호출이 일어나고, 사용하지 않는 데이터가 적재되었다. 로컬 환경에서야 H2니 운영 데이터 오염이나 DB 비용 지불의 문제는 없었다. 하지만 테스트가 늘어났다면 호출 제한에 걸려 실제 운영에 지장을 초래할 수도 있었다. 더 큰 문제가 생기기 전에 <code class=\"language-text\">@Profile</code>을 도입해서 다행이었다.</p>\n<h2 id=\"앞으로의-과제\" style=\"position:relative;\"><a href=\"#%EC%95%9E%EC%9C%BC%EB%A1%9C%EC%9D%98-%EA%B3%BC%EC%A0%9C\" aria-label=\"앞으로의 과제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>앞으로의 과제?</h2>\n<p>보다 실제 상황과 비슷한 테스트를 하려면, 테스트 환경에서도 <code class=\"language-text\">MemberInitializer</code>가 생성되는 게 맞다고 생각한다. 특히 인수 테스트에서 컨텍스트가 처음 생성되었을 때 일부 유저가 저장되고, 이 유저에 대한 프로필 수정, 탈퇴 등의 이벤트가 발생했을 시, 제대로 작동되는지 보면 좋을 것 같다.</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\">문제상황</a></p>\n<ul>\n<li>\n<p><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%B0%B0%EA%B2%BD%EC%A7%80%EC%8B%9D\">서비스 배경지식</a></p>\n<ul>\n<li><a href=\"#%EC%B2%AB%EB%B2%88%EC%A7%B8-%EC%B0%B8%EA%B3%A0\">첫번째 참고</a></li>\n<li><a href=\"#%EB%91%90%EB%B2%88%EC%A7%B8-%EC%B0%B8%EA%B3%A0\">두번째 참고</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C-%EC%99%B8%EB%B6%80-api-%ED%98%B8%EC%B6%9C%EC%9D%84-%EB%8C%80%EC%B2%B4%ED%95%A0-mockbean-%EC%82%AC%EC%9A%A9\">테스트 시 외부 API 호출을 대체할 @MockBean 사용</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%95%B4%EA%B2%B0%EC%8B%9C%EB%8F%84\">해결시도</a></p>\n<ul>\n<li><a href=\"#1-%EB%B9%88-%EC%9E%AC%EC%A0%95%EC%9D%98%ED%95%98%EA%B8%B0\">1. 빈 재정의하기</a></li>\n<li><a href=\"#2-profile%EB%A1%9C-%EC%83%9D%EC%84%B1-%EB%A7%89%EA%B8%B0\">2. @Profile로 생성 막기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%95%9E%EC%9C%BC%EB%A1%9C%EC%9D%98-%EA%B3%BC%EC%A0%9C\">앞으로의 과제?</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"August 23, 2022","title":"[Spring] @PostConstruct를 막아라","categories":"Spring 트러블슈팅","author":"써머","emoji":"headers/post-construct-profile.png"},"fields":{"slug":"/post-construct-profile/"}},"site":{"siteMetadata":{"siteUrl":"https://hyewoncc.github.io","comments":{"utterances":{"repo":"hyewoncc/hyewoncc.github.io"}}}}},"pageContext":{"slug":"/jpa-static-fixture-trouble/","nextSlug":"/wild-seed/","prevSlug":"/post-construct-profile/"}},"staticQueryHashes":["1073350324","1956554647","2938748437","3350743975"]}