{"componentChunkName":"component---src-templates-blog-template-js","path":"/fetch-join-and-entity-graph/","result":{"data":{"cur":{"id":"134fb41c-ec9a-5848-ad32-fa11d872d752","html":"<p>백엔드 면접 단골 질문 중 하나가 <code class=\"language-text\">JPA N+1 문제를 어떻게 해결하나요?</code>이다.\n물론 몇 달 전까지 나도 줄줄 외우고 있었다.\ndto로 갖고 오던가, 페치 조인이 엔티티 그래프가 어쩌고 배치 사이즈를…\n그리고 몇 개는 실제로 적용해서 문제를 해결해보기도 했지만, 비교적 전형적인 케이스만 다뤘기에 적용했더니 해결됐다, 끝! 이었다.\n그래서 최근에 <code class=\"language-text\">N+1</code>을 해결하기 위해 페치 조인을 쓰다가 동작을 잘 모른다는 걸 알게 되었다.</p>\n<br>\n<h2 id=\"-문제-상황\" style=\"position:relative;\"><a href=\"#-%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9\" aria-label=\" 문제 상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🎁 문제 상황</h2>\n<p>단방향 연관관계를 가진 두 엔티티가 있다.\n<code class=\"language-text\">ItemAcquire</code>는 유저가 획득한 아이템이다.\n<code class=\"language-text\">ItemLog</code>는 아이템을 획득, 또는 사용될 때 생기는 로그다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemAcquire</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ElementCollection</span>\n    <span class=\"token annotation punctuation\">@CollectionTable</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"item_acquire_log\"</span><span class=\"token punctuation\">,</span> joinColumns <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"item_acquire_id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"item_log_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> itemLogIds <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemLog</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Enumerated</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">EnumType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Action</span> action<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">enum</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Action</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token constant\">ACQUIRE</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">USE</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>엔티티 <code class=\"language-text\">ItemAcquire</code>, <code class=\"language-text\">ItemLog</code>는 다음과 같은 비즈니스 로직을 가진다.</p>\n<ol>\n<li>아이템 로그는 아이템에 취한 행동에 따라 <code class=\"language-text\">ACQUIRE(획득)</code>, <code class=\"language-text\">USE(사용)</code>이 정해진다.</li>\n<li>아이템 획득은 <code class=\"language-text\">ItemAcquire 생성</code> -> <code class=\"language-text\">ItemLog(action = ACQUIRE) 생성</code> 순서로 이뤄진다.</li>\n<li><code class=\"language-text\">아이템 획득 생성</code> 이 후 <code class=\"language-text\">아이템 획득 로그 생성</code>까지 로직에서 문제가 생기더라도, <code class=\"language-text\">아이템 획득</code>은 남아야 한다.</li>\n<li>따라서 <code class=\"language-text\">ItemAcquire</code>는 아이템 로그를 가지지 않을 수도 있다.</li>\n<li>두 엔티티는 단방향 간접참조로 연결되어있다. 아이템 로그는 아이템 획득 엔티티를 모른다.</li>\n</ol>\n<p>DB에는 두 테이블을 연결하는 <code class=\"language-text\">item_acquire_log</code> 테이블이 추가로 생성된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAwElEQVR42n2RCQqFMAxEe/8rCuIuKrgr7vOZgUr/ZiAtmSYvbWOu68KnUXN1N/6V7+qGy7ZtWNdV+3Ecj2Ba27YoigJ1XeM8T7k9N1yapkEcx/B9H3meC0y96zpEUYQgCBCGoUDU+75Xnud5gs7zfEPNvu8SkyRBmqZKHIZBXpblrXMnkM0YV1WFaZr0sjcgOzKRAMJZYBN4wyzL1ITF4zjKGbMBX/YFxINZOH1ZFjV0/9b+nzswYw9/+dM0/035Bf6UIhZ8KoWBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"diagram\"\n        title=\"\"\n        src=\"/static/acba0fb5e13cd69ce1ea9c87a7168eed/37523/diagram.png\"\n        srcset=\"/static/acba0fb5e13cd69ce1ea9c87a7168eed/e9ff0/diagram.png 180w,\n/static/acba0fb5e13cd69ce1ea9c87a7168eed/f21e7/diagram.png 360w,\n/static/acba0fb5e13cd69ce1ea9c87a7168eed/37523/diagram.png 720w,\n/static/acba0fb5e13cd69ce1ea9c87a7168eed/302a4/diagram.png 1080w,\n/static/acba0fb5e13cd69ce1ea9c87a7168eed/2cefc/diagram.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ItemAcquire</span> itemAcquire <span class=\"token operator\">=</span> itemAcquireRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ItemAcquire</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포션\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 여기서 예외가 발생하더라도 itemAcquire는 저장되어야 한다. 논리적으로 분리된 단위다. </span>\n        inventoryService<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>itemAcquire<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        itemLogRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ItemLog</span><span class=\"token punctuation\">(</span>itemAcquire<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Action</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACQUIRE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>예상 가능하듯이, <code class=\"language-text\">ItemAcquire</code>를 조회하고 하위 <code class=\"language-text\">itemLogIds</code>에 접근할 때 추가 조회 쿼리가 발생한다.\n이를 해결하기 위해 페치 조인을 사용했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ItemAcquireRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemAcquire</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select i from ItemAcquire i join fetch i.itemLogIds where c.id = :id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemAcquire</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>조회 쿼리는 원하는 대로 join을 사용하게 고쳐졌으나, <code class=\"language-text\">ItemAcquire</code>를 조회하는 몇 테스트가 실패했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ItemAcquire</span> itemAcquire <span class=\"token operator\">=</span> itemAcquireRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ItemAcquire</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포션\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 여기서 예외가 발생하더라도 itemAcquire는 저장되어야 한다. 논리적으로 분리된 단위다. </span>\n        inventoryService<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>itemAcquire<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        itemLogRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ItemLog</span><span class=\"token punctuation\">(</span>itemAcquire<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Action</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACQUIRE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> itemAcquire<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ItemAcquireRepository</span><span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ItemNotExistException</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"아이템이 생성되나 유저 인벤토리 등록에 실패한다.\"</span><span class=\"token punctuation\">)</span> \n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">failPutInInventory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Long</span> itemId <span class=\"token operator\">=</span> itemService<span class=\"token punctuation\">.</span><span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ItemNotExistException 발생 </span>\n    <span class=\"token class-name\">ItemAcquire</span> item <span class=\"token operator\">=</span> itemService<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span>itemId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span><span class=\"token function\">getItemLogIds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>내가 기대한 결과는 <code class=\"language-text\">빈 itemLogIds를 갖는 ItemAcquire가 조회된다</code>였으나, 실제로는 <code class=\"language-text\">ItemNotExistException</code> 예외가 발생했다.\n이상한 점은 <code class=\"language-text\">itemId</code>을 id로 갖는 <code class=\"language-text\">ItemAcquire</code>가 분명 존재한다는 것이었다.\n이유를 모른 채로 다른 <code class=\"language-text\">N+1</code> 해결책인 <code class=\"language-text\">@EntityGraph</code>를 적용해 변경했더니 통과했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ItemAcquireRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemAcquire</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token annotation punctuation\">@EntityGraph</span><span class=\"token punctuation\">(</span>attributePaths <span class=\"token operator\">=</span> <span class=\"token string\">\"itemLogIds\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemAcquire</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p><code class=\"language-text\">@EntityGraph</code>를 사용하는 경우에는 의도대로 <code class=\"language-text\">빈 itemLogIds를 갖는 ItemAcquire</code>가 조회된다.</p>\n<br>\n<h2 id=\"-원인-탐색\" style=\"position:relative;\"><a href=\"#-%EC%9B%90%EC%9D%B8-%ED%83%90%EC%83%89\" aria-label=\" 원인 탐색 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🔍 원인 탐색</h2>\n<p>각 경우에 실행되는 sql문을 비교해 원인을 찾을 수 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># join fetch로 실행되는 sql </span>\n<span class=\"token keyword\">select</span>\n    itemacquire<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id<span class=\"token punctuation\">,</span>\n    itemacquire<span class=\"token punctuation\">.</span>item_log_id <span class=\"token keyword\">as</span> item_log_id \n<span class=\"token keyword\">from</span>\n    item_acquire itemacquire \n<span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span>\n    item_log itemlog \n        <span class=\"token keyword\">on</span> itemacquire<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>itemlog<span class=\"token punctuation\">.</span>item_acquire_id \n<span class=\"token keyword\">where</span>\n    item_acquire<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>?\n\n<span class=\"token comment\"># EntityGraph로 실행되는 sql </span>\n<span class=\"token keyword\">select</span>\n    itemacquire<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> id<span class=\"token punctuation\">,</span>\n    itemacquire<span class=\"token punctuation\">.</span>item_log_id <span class=\"token keyword\">as</span> item_log_id \n<span class=\"token keyword\">from</span>\n    item_acquire itemacquire \n<span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n    item_log itemlog \n        <span class=\"token keyword\">on</span> itemacquire<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>itemlog<span class=\"token punctuation\">.</span>item_acquire_id \n<span class=\"token keyword\">where</span>\n    item_acquire<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>?</code></pre></div>\n<br>  \n<h3 id=\"inner-join과-outer-join\" style=\"position:relative;\"><a href=\"#inner-join%EA%B3%BC-outer-join\" aria-label=\"inner join과 outer join permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>inner join과 outer join</h3>\n<p>테이블에 다음과 같은 데이터가 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA6klEQVR42kWQXW8CIRRE/f//zbTpgxvTNNHUal2N+8ECFy5wGtjaPgy5wHAyw6aUAhSCFuYlMC0e4xTNIFowNjIvwmwDPhY0FSQWrCQm47GS23nOlQObJ/DyEN7ee166E7vDwGiVw7dh232x3Z3Ydie648hslWPv2X/OvO7P7A4PPi4OiXkF1qVCQ4h4LyzL0mYJkWEYuV57ptlwu9+bNGWscxhjiJra/ThOlDXgCswVqJkQFeeEWGdN1BYprzVTVZszXiLOB6wo/e3OY5j+Kz8TNrMmYtT26Gng90tWrdvm09R8znlEwl/CH0HMhBEaFvVUAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"data\"\n        title=\"\"\n        src=\"/static/a7b52e526ccada51c42af6536228b104/37523/data.png\"\n        srcset=\"/static/a7b52e526ccada51c42af6536228b104/e9ff0/data.png 180w,\n/static/a7b52e526ccada51c42af6536228b104/f21e7/data.png 360w,\n/static/a7b52e526ccada51c42af6536228b104/37523/data.png 720w,\n/static/a7b52e526ccada51c42af6536228b104/302a4/data.png 1080w,\n/static/a7b52e526ccada51c42af6536228b104/07a9c/data.png 1440w,\n/static/a7b52e526ccada51c42af6536228b104/95e59/data.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">inner join</code>을 사용할 경우, 조인 테이블에 join에 사용되는 id값이 없다면 조회가 되지 않는다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA9klEQVR42l2R3U7CQBSEef8n48JEUNQSWQtI6RZo3druX9vdz2z1Rs7FmcxkMplkFhCJEawPtL1DdZbejkwhYnzgW3va3s5oh8g4xRmTJ+nG//KYQoBFeomcrp4XceNpKxGFpjMBUfSsMsk6K1lnkn1p6MyEKA3ZUbHannk7KPaVZZzC/0DZVhxuB/JLTqFO1PpG9rllk29mbfPxzO78jhscfa/RWjOOE1KWMw/3DVX1yvW4pNovaYoHjG740jVNV9EYRZ24VShX814JxEUgrjmPuxU7KZjCXUPGAQZH9BZGD3+G+0te7TTaG4w3tH2LdiYtkebgB0D2frjtH2kbAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"inner join\"\n        title=\"\"\n        src=\"/static/b39704f6301d969ad0e3bd42128bea38/37523/inner_join.png\"\n        srcset=\"/static/b39704f6301d969ad0e3bd42128bea38/e9ff0/inner_join.png 180w,\n/static/b39704f6301d969ad0e3bd42128bea38/f21e7/inner_join.png 360w,\n/static/b39704f6301d969ad0e3bd42128bea38/37523/inner_join.png 720w,\n/static/b39704f6301d969ad0e3bd42128bea38/302a4/inner_join.png 1080w,\n/static/b39704f6301d969ad0e3bd42128bea38/07a9c/inner_join.png 1440w,\n/static/b39704f6301d969ad0e3bd42128bea38/95e59/inner_join.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>각 id에 대해 <code class=\"language-text\">findBy(Long id)</code>를 시행하면 하나의 엔티티만 나온다.</p>\n<ul>\n<li>ItemAcquire(id=1L, itemLogIds = [2L])</li>\n</ul>\n<br>\n<p>반면, <code class=\"language-text\">left outer join</code>은 join에 사용되는 id값이 없더라도 조회가 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/klEQVR42lWPW2+CQBSE/f9/rOlDffBSoyCoBFlQ5LbLLrC7XyONqT3JnMzknExmFuDxHqS2lI3iVkkaNTJZT6ctj7anrBWPVqOMY7QOaTy1HCibfv5Rg8M/TYDFcznvSe8Du6hkE+SchUb2jmMqWR/EjNVekBSGrrfEQrO/1KwDwT5pSG4G69y7oSOrr5zvJ05FRFollKpkd/lmG68532I20YpjFmBGg1JqxjhZsuyKVOp/Qu8ctdhyv3ySxx9U6RLdZXRS0Mqcpk1pOkEncyqVc8hDgiIkLI58HZaEIppb/hk+hZtgGmEawI6/+jX+jXqPHvWc1EwG2cuZv24/z4B+fJz7yQgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"outer join\"\n        title=\"\"\n        src=\"/static/f405def3baea772f979068a2ab98a0b1/37523/outer_join.png\"\n        srcset=\"/static/f405def3baea772f979068a2ab98a0b1/e9ff0/outer_join.png 180w,\n/static/f405def3baea772f979068a2ab98a0b1/f21e7/outer_join.png 360w,\n/static/f405def3baea772f979068a2ab98a0b1/37523/outer_join.png 720w,\n/static/f405def3baea772f979068a2ab98a0b1/302a4/outer_join.png 1080w,\n/static/f405def3baea772f979068a2ab98a0b1/07a9c/outer_join.png 1440w,\n/static/f405def3baea772f979068a2ab98a0b1/95e59/outer_join.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>각 id에 대해 <code class=\"language-text\">findBy(Long id)</code>를 시행하면 두 개의 엔티티가 나온다.</p>\n<ul>\n<li>ItemAcquire(id=1L, itemLogIds = [2L])</li>\n<li>ItemAcquire(id=2L, itemLogIds = [ ])</li>\n</ul>\n<p>의도한 join 방식이 <code class=\"language-text\">left outer join</code>이기에 우선 <code class=\"language-text\">@EntityGraph</code>를 적용해 해결했다.</p>\n<br>\n<h2 id=\"-적용할-수-있었던-다른-선택지들\" style=\"position:relative;\"><a href=\"#-%EC%A0%81%EC%9A%A9%ED%95%A0-%EC%88%98-%EC%9E%88%EC%97%88%EB%8D%98-%EB%8B%A4%EB%A5%B8-%EC%84%A0%ED%83%9D%EC%A7%80%EB%93%A4\" aria-label=\" 적용할 수 있었던 다른 선택지들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🍷 적용할 수 있었던 다른 선택지들</h2>\n<h3 id=\"left-join-fetch\" style=\"position:relative;\"><a href=\"#left-join-fetch\" aria-label=\"left join fetch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>left join fetch</h3>\n<p>JPQL에 <code class=\"language-text\">left join fetch</code>를 쓰면 <code class=\"language-text\">@EntityGraph</code>와 동일하게 <code class=\"language-text\">outer join</code>으로 가져올 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ItemAcquireRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemAcquire</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select i from ItemAcquire i left join fetch i.itemLogIds where c.id = :id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemAcquire</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>  \n<h3 id=\"fetchtypeeager-하지만\" style=\"position:relative;\"><a href=\"#fetchtypeeager-%ED%95%98%EC%A7%80%EB%A7%8C\" aria-label=\"fetchtypeeager 하지만 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FetchType.EAGER, 하지만…</h3>\n<p>또는, <code class=\"language-text\">itemLogIds</code>에 <code class=\"language-text\">FetchType.EAGER</code>를 사용하는 것도 방법이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemAcquire</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ElementCollection</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">EAGER</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@CollectionTable</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"item_acquire_log\"</span><span class=\"token punctuation\">,</span> joinColumns <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"item_acquire_id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"item_log_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> itemLogIds <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>하지만 이 방법은 <a href=\"https://docs.jboss.org/hibernate/orm/5.5/userguide/html_single/Hibernate_User_Guide.html#fetching-strategies-dynamic-fetching-entity-graph\">Hibernate 공식 문서</a>에서 권장하지 않는다.</p>\n<blockquote>\n<p>JPQL 쿼리에서 EAGER 연관관계가 생략된 경우, Hibernate는 각 객체의 EAGER 연관관계를 조회하기 위해 또 다른 조회문을 실행해 N+1 문제가 발생하게 됩니다.\n따라서 LAZY를 설정하고 필요할 때만 쿼리별로 EAGER를 적용하는 게 낫습니다.</p>\n</blockquote>\n<p><code class=\"language-text\">left outer join</code>을 사용하거나, <code class=\"language-text\">@EntityGraph</code>를 이용하는 게 낫다.\n<code class=\"language-text\">@EntityGraph</code>의 경우 <a href=\"https://docs.jboss.org/hibernate/orm/5.5/userguide/html_single/Hibernate_User_Guide.html#fetching-strategies-dynamic-fetching-entity-subgraph\">Hibernate 공식 문서</a>의 예시에는 <code class=\"language-text\">inner join</code>이 실행된다.\n내가 겪은 문제처럼 연관관계에 따라 엔티티가 조회되지 않을 수도 있는 경우에는 <code class=\"language-text\">outer join</code>을 실행하도록 구현되어있는 것 같다.</p>\n<br>\n<h2 id=\"️-이상과-현실\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-%EC%9D%B4%EC%83%81%EA%B3%BC-%ED%98%84%EC%8B%A4\" aria-label=\"️ 이상과 현실 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>☁️ 이상과 현실</h2>\n<p>일을 하면서 내 지식의 얕음을 마주칠 때 마다 부끄러움 반 더 열심히 공부하자는 투지 반이 든다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABu0lEQVR42m2Sb2/SUBSH9/0/hMZX7oVME7c5DAlMF9kkk0HbSJuW0gLtbW+hfyhDh+1jqEAm4yQ3J+ck57m/e+7vBKAsy00iX+Touo5lWeR5zmEURcGx2M1v4mRT7BrCF3Q6nQqaZRlJkhCGEiEEURQhpUTKiCAIqiOjaH/JjvEfcJakWLZNEEps20ZVFOZJRrZcEYYhqqpUeZ4uiLMFSZZTbGefAauKTVquSxZPBenqCcseYZgmYhaT/v6DmCdV7XqCOF8SpylRklVzPBNVKdwB/SjG8wWOTHCCGYYzqdSOxhP00QQ3fsSMcrp9le6PLpN0dRxYlv/20FYMrpstHgwbc7akJ3IUVeVe06l9uMQYGGSPv7ht33H9pY21KFkX1RNfKtz0XSG5ad9iOw6TOGcgEn4OdJypjzby0IYuUy/gvq9w872DH8rtDg+BW0v4nodpDjF0g+FU4I4nzKKIh56KDEP64xBtHNDrKXz83OLrt7v9hxz95aE1pPauxtWnqwrmC0Gr2eTV6zecn1/g+T6hlFxeXPL29BTXdV8CD42paVplmV00Gg3en51Rr9dZr9dVL47jPezQ2H8B+2TwPACmy4MAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"순히포\"\n        title=\"\"\n        src=\"/static/fc57fc2e46ccc296e843dddf5b2ba765/37523/shp1.png\"\n        srcset=\"/static/fc57fc2e46ccc296e843dddf5b2ba765/e9ff0/shp1.png 180w,\n/static/fc57fc2e46ccc296e843dddf5b2ba765/f21e7/shp1.png 360w,\n/static/fc57fc2e46ccc296e843dddf5b2ba765/37523/shp1.png 720w,\n/static/fc57fc2e46ccc296e843dddf5b2ba765/302a4/shp1.png 1080w,\n/static/fc57fc2e46ccc296e843dddf5b2ba765/07a9c/shp1.png 1440w,\n/static/fc57fc2e46ccc296e843dddf5b2ba765/29007/shp1.png 1600w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmElEQVR42pWSXU8aQRSG/V+9MPFfNfEKbbwyKqnGNOmFCbIaMBGiFS3FthYMhI/AtrsFDaTsjssKJmQrCpTdp1lEUEQTz81Mzsz7zHvOmSnHcXDDXe/3zWYTRVFQVRW/34/P50OSJLa2JILBAJZlDTXg6hhqp54DyrJMqajw8cMiC563vF9+h3dpjlXvAjXD6N+zbfspcEDDYZRstVqU1DTFX3HgElH5Se9GY3dng8j+Nn+t5piJO93QoXMPdRx6Pbt/MO+ZZWb6DaIqUzqv0KgLlEKMdDLC1VX9SVUjh2PAQZ698DbrK2uYusq5mqGmyVxbNYyLMvVL8wGQQdnOZIdudLod4l9OON77zplSoG6UyebzpJI5jnc3MYR2B5zUw4nAdpvP4SNioSj5WAjTMMikPpE+jZAKLGFevACcNJTO7TWxwCaJgx9UMkm0qoYo5/jz+xvhoIQQ+kBmD0t+NJTxBv9r3xD1rRPeOSQaCpA//UoynkBRS6QzWRqNxuv+ofuyWTOoVKvoQu+XLHQNoet9WLfbfRb4H5Hl6PQf0Df6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"순히포\"\n        title=\"\"\n        src=\"/static/632d4f2e378a0243e2e5290c1638c7d2/37523/shp2.png\"\n        srcset=\"/static/632d4f2e378a0243e2e5290c1638c7d2/e9ff0/shp2.png 180w,\n/static/632d4f2e378a0243e2e5290c1638c7d2/f21e7/shp2.png 360w,\n/static/632d4f2e378a0243e2e5290c1638c7d2/37523/shp2.png 720w,\n/static/632d4f2e378a0243e2e5290c1638c7d2/302a4/shp2.png 1080w,\n/static/632d4f2e378a0243e2e5290c1638c7d2/07a9c/shp2.png 1440w,\n/static/632d4f2e378a0243e2e5290c1638c7d2/29007/shp2.png 1600w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  다음 웹툰 순정 히포크라테스. 초반엔 딱 이런 심정이었는데 요새는 이 정도는 아니고🥹 좋아하는 웹툰이라 가져와봤다.  \n</div>  \n<br>  \n<p>이번 문제는 도메인 로직 때문에 생경한 조합을 사용하면서 마주쳤다.\n<code class=\"language-text\">@ElementCollection</code>을 처음 써봤으며 트랜잭션도 일부 구간만 묶여있다.\n‘전형적인’ 경우였다면 <code class=\"language-text\">ItemAcquire</code> 생성과 <code class=\"language-text\">ItemLog</code> 생성이 동일 트랜잭션으로 묶여있어, 한 쪽만 생기는 일이 없었을 것 같다.</p>\n<p>이런 일을 마주하면 앞으로 어떻게 공부해야 더 깊이있고 효율적이게 공부할 수 있을까 고민이 든다.\n물론 처음부터 꼼꼼하게 공부한다면 좋았겠지만, 새로운 기술을 배우면서 야생형으로 학습하기 보다 경우의 수를 정복하는 데 중점을 두는 건 좋은 해결책이 아니라고 생각한다.\n우테코 때 부터 계속 했던 고민이라 선택한 극복법 중에 하나가 “관련된 부분 공식 문서 읽기”였는데 소홀해진 것 같아 반성했다.</p>\n<p>챗지피티 얘기를 지금 하면 뜬금없는 뒷북같긴 하지만, 그 때만 해도 공식 문서를 찾는 것 부터 일이었는데, 요즘은 문제의 키워드를 얻거나 관련 문서 링크를 찾는 데에 정말 유용하게 쓰는 중이다. 몇 달 새에 무서울 정도로 공부하기가 쉬워졌다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA+klEQVR42oWO206DUBBF+SFjYrXQUmMLBywUOKBVbofWSy+giYmxfv8yPTa1bz7srJ09kz1jnE0qzkWDOwmZuAnCSxEixdWSeH6GNfC46N3Quxz/K+NqGNK3Q+zRlKE91bRHwYFT7OtAF/YtgWkJ+uYpPayBjznwdLanIZ5XiNc1s6AgkopYKmZxTSwb7aNEkWSL40xmS6KkRt4tCaOKsZMi/AfthT/HcOICP1MU5Yay3pKXa4pqQ6Va6qajUp2mWrzprKxbmuW79o/F7+7+gOvND4VuRhDkbLsdbffNav3Jpv3i6eXj+GUiG5L0z5/mMltwG+Q44l4X/gD9lb1PGVhICQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"chatgpt\"\n        title=\"\"\n        src=\"/static/4d225b73cc6bd5812e7ead4a93077d48/37523/chatgpt.png\"\n        srcset=\"/static/4d225b73cc6bd5812e7ead4a93077d48/e9ff0/chatgpt.png 180w,\n/static/4d225b73cc6bd5812e7ead4a93077d48/f21e7/chatgpt.png 360w,\n/static/4d225b73cc6bd5812e7ead4a93077d48/37523/chatgpt.png 720w,\n/static/4d225b73cc6bd5812e7ead4a93077d48/302a4/chatgpt.png 1080w,\n/static/4d225b73cc6bd5812e7ead4a93077d48/07a9c/chatgpt.png 1440w,\n/static/4d225b73cc6bd5812e7ead4a93077d48/9f9a4/chatgpt.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  존재하지 않는 섹션 링크를 붙이는 정도는 눈감아주자...\n</div>  \n<br>  \n<p>이번 문제는 페이지네이션이 없어서 평일에 <code class=\"language-text\">@EntityGraph</code>만 적용하고 넘어갔었다.\n주말에 공부를 하면서 공식 문서를 읽다 보니 <code class=\"language-text\">@BatchSize</code>보다 dto 프로젝션, 또는 fetch join을 권장한다는 것,\n<code class=\"language-text\">@EntityGraph</code>도 디폴트 <code class=\"language-text\">EntityGraphType</code> 옵션이 있어서 다른 옵션을 설정하면 표기한 연관 객체를 제외하고 EAGER로 불러올 수도 있다는 것… 등등\n많은 새로운 정보를 알게 됐다.\n작심삼일도 삼일마다 하면 된다고, 이번처럼 그냥 넘어가지 말고 나중에라도 공부하자고 매번 상기하고 실천해야겠다.</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9\">🎁 문제 상황</a></p>\n</li>\n<li>\n<p><a href=\"#-%EC%9B%90%EC%9D%B8-%ED%83%90%EC%83%89\">🔍 원인 탐색</a></p>\n<ul>\n<li><a href=\"#inner-join%EA%B3%BC-outer-join\">inner join과 outer join</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EC%A0%81%EC%9A%A9%ED%95%A0-%EC%88%98-%EC%9E%88%EC%97%88%EB%8D%98-%EB%8B%A4%EB%A5%B8-%EC%84%A0%ED%83%9D%EC%A7%80%EB%93%A4\">🍷 적용할 수 있었던 다른 선택지들</a></p>\n<ul>\n<li><a href=\"#left-join-fetch\">left join fetch</a></li>\n<li><a href=\"#fetchtypeeager-%ED%95%98%EC%A7%80%EB%A7%8C\">FetchType.EAGER, 하지만…</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EF%B8%8F-%EC%9D%B4%EC%83%81%EA%B3%BC-%ED%98%84%EC%8B%A4\">☁️ 이상과 현실</a></p>\n</li>\n</ul>\n</div>","excerpt":"백엔드 면접 단골 질문 중 하나가 이다.\n물론 몇 달 전까지 나도 줄줄 외우고 있었다.\ndto로 갖고 오던가, 페치 조인이 엔티티 그래프가 어쩌고 배치 사이즈를…\n그리고 몇 개는 실제로 적용해서 문제를 해결해보기도 했지만, 비교적 전형적인 케이스만 다뤘기에 적용했더니 해결됐다, 끝! 이었다.\n그래서 최근에 을 해결하기 위해 페치 조인을 쓰다가 동작을 잘 모른다는 걸 알게 되었다. 🎁 문제 상황 단방향 연관관계를 가진 두 엔티티가 있다.\n는 유저가 획득한 아이템이다.\n는 아이템을 획득, 또는 사용될 때 생기는 로그다. 엔티티 , 는 다음과 같은 비즈니스 로직을 가진다. 아이템 로그는 아이템에 취한 행동에 따라 , 이 정해진다. 아이템 획득은  ->  순서로 이뤄진다.  이 후 까지 로직에서 문제가 생기더라도, 은 남아야 한다. 따라서 는 아이템 로그를 가지지 않을 수도 있다. 두 엔티티는 단방향 간접참조로 연결되어있다. 아이템 로그는 아이템 획득 엔티티를 모른다. DB에는 두 테이블…","frontmatter":{"date":"March 26, 2023","title":"[JPA] 실종된 데이터와 연관 객체 조회하기","categories":"트러블슈팅 JPA","author":"써머","emoji":"headers/fetch-join-and-entity-graph.png"},"fields":{"slug":"/fetch-join-and-entity-graph/"}},"next":{"id":"5a639548-89a6-57f0-87d9-f42c81b3037b","html":"<p>💡 해당 글은 사내에 작성한 문서를 허가 하에 개인 포스팅용으로 적절히 수정한 글입니다.</p>\n<p>디어에 입사하고 처음 맡은 일은 개발 중이던 신규 인터널 API 서버 개발을 마무리하고 프로덕션 환경에 올리는 것이었다.\n전체 사이클에서 내 생각에 한 80% 지점에 참여하게 되었다.\n현재 신규 서버는 프로덕션 환경에 올라간 채로 ‘회사 사람들이 디어 앱을 통해 하는 요청’ 이라는 티끌의 트래픽만 받고 있는데, 다음 2주 간의 스프린트에 전체 트래픽을 100% 전환하는 게 목표다.\n그래서 이번 스프린트 중에 이 서버의 성능을 테스트하고, 운영 환경에 적절한 인프라 설정값을 찾는 과제를 수행했다.</p>\n<br>\n<h2 id=\"-인프라-구조\" style=\"position:relative;\"><a href=\"#-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\" aria-label=\" 인프라 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🏗 인프라 구조</h2>\n<p>모든 인프라 구조도는 극히 단순화하여 그렸다.</p>\n<h3 id=\"기존-프로덕션-인프라-구조\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%EC%A1%B4-%ED%94%84%EB%A1%9C%EB%8D%95%EC%85%98-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\" aria-label=\"기존 프로덕션 인프라 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기존 프로덕션 인프라 구조</h3>\n<p>신규 인터널 서버는 기존 디어 서버에서 외부 API 연동이 잦은 특정 도메인을 분리한 서버다.\n기존에는 디어 앱에서 특정 요청이 들어오면, 디어 서버를 거쳐, 경우에 따라 또 다른 인터널 서버를 경유해 로직을 수행했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVR42m2RbU/CMBSF+f9/y8TElw9GAwEFh8BYu7UV5tbRjvYx28CIeJOTe5rcPDm3d0SMRCB2PYbO0R6PWGuxB0/tAtYFatdi/ZHq0OLacJqPhDB4ToxRHBy/q6w9ydawVJ7EwPNqy93igZvxLffJE4n8xBiDlLLvF8BzwuAUtR4TbIrceRJZkamSd1Ez3uyYCsUkzZlkmrW2GKN7oNa6T3kNbDKq/BG3n7MpKuZrRZZrZivNy0fJXLa8Cc9r1pKIL/JckqYpRVFcAv9bWdeRWR5ZqEHTbcNMHHpNM8dSVihVIIRAKfUnIXHgnT65ezc+sLeBsjkr/vh90x0pEkMghOujfAOJ9c41jQ0l0gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"production infra\"\n        title=\"\"\n        src=\"/static/5116c05fea8ebd0083f6ee7ce8a65f5d/37523/infra_production.png\"\n        srcset=\"/static/5116c05fea8ebd0083f6ee7ce8a65f5d/e9ff0/infra_production.png 180w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/f21e7/infra_production.png 360w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/37523/infra_production.png 720w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/302a4/infra_production.png 1080w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/07a9c/infra_production.png 1440w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/9f9a4/infra_production.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>신규 인터널 서버를 분리하면서 구조도 변했다.</p>\n <br>\n<h3 id=\"신규-서버-도입-후-인프라-구조\" style=\"position:relative;\"><a href=\"#%EC%8B%A0%EA%B7%9C-%EC%84%9C%EB%B2%84-%EB%8F%84%EC%9E%85-%ED%9B%84-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\" aria-label=\"신규 서버 도입 후 인프라 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>신규 서버 도입 후 인프라 구조</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA+klEQVR42mWR2W6DMBRE8/9/1oc+NFWrBgQhDS0Bgw1Z7NhgnworW5UrjWYsWUd37EUIgXlmD8HPiWnyGGM4W4exHmOnm7SdcFO43L/rylhcw+Mczch2p/huLbmETQ/FAJsB1gry3QnZddR1jZSScRzvwBvd9dghxesf2r2laAy10hSNZpX1JIkgSVpW64GsOqCUQggRgc65Z6A/N+x3L2j5yW97IN22VLUgLTuWbyXL15z3WR8VX1tJKwRlWUbovw0vicfSvQ6kIpC1kHewlhcpyDrIqmOs3DTNc+UIi7Tr4waM86jTRK991JzjObrncPaxprU2+uOn/AEd2s7io4pLGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"new production infra\"\n        title=\"\"\n        src=\"/static/8878210584397d26c1e40f1afa5bb478/37523/infra_new_production.png\"\n        srcset=\"/static/8878210584397d26c1e40f1afa5bb478/e9ff0/infra_new_production.png 180w,\n/static/8878210584397d26c1e40f1afa5bb478/f21e7/infra_new_production.png 360w,\n/static/8878210584397d26c1e40f1afa5bb478/37523/infra_new_production.png 720w,\n/static/8878210584397d26c1e40f1afa5bb478/302a4/infra_new_production.png 1080w,\n/static/8878210584397d26c1e40f1afa5bb478/07a9c/infra_new_production.png 1440w,\n/static/8878210584397d26c1e40f1afa5bb478/9f9a4/infra_new_production.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>앞으로 해당 도메인과 관련된 모든 요청은 신규 서버를 경유한다.\n신규 서버가 분리되면서 요청을 처리할 외부 서버를 간편하게 추가할 수 있게 되었다.\n실제로 이번에 D사 서버 연동을 추가해야 했는데, 첫 삽을 뜨기부터 스테이지 테스트를 완료하기 까지 단 이틀이 걸렸다.</p>\n<p>신규 서버를 도입하면서 목표는 ‘사용자 관점에서 아무 변화도 없어야 한다’ 였다.\n현재 디어 서버에서 이뤄지는 해당 도메인의 트래픽, 나아가서 회사가 올해 목표하는 트래픽 양을 문제없이 처리할 수 있어야 했다.\n이를 위해 부하테스트를 진행했다.</p>\n<br>\n<h3 id=\"부하테스트-인프라\" style=\"position:relative;\"><a href=\"#%EB%B6%80%ED%95%98%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%9D%B8%ED%94%84%EB%9D%BC\" aria-label=\"부하테스트 인프라 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>부하테스트 인프라</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA2klEQVR42o2RbWvCMBRG/f9/bTBw062d1lrtzEpdxL4kaUlzRtpFnfhhDzycfLgcuLkz5xw+gT7D4NBao5Sh0ZZG3VXbcT4Uz0nC7FYWaDrLVpxJS0N6glQycnuamB0HBq4JMs9ZkPR9T1VVtE1FrR0HUSA+nsizFXEiWb7sWcx3vEcF668OLfeofI46vEJ3HmXe9UdY1zVtU/8KBeXmmc/dmiiRxEtB5BuXrIRByxwjFnTFG+5W+GhlZSzJERIJG3ldOTT7/sfK0wdPA9YOtNpe2jx4X45xd5QfE1HQs9dDM70AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"test infra\"\n        title=\"\"\n        src=\"/static/1d71ef9c09a0917fca8e178b059b4318/37523/infra_test.png\"\n        srcset=\"/static/1d71ef9c09a0917fca8e178b059b4318/e9ff0/infra_test.png 180w,\n/static/1d71ef9c09a0917fca8e178b059b4318/f21e7/infra_test.png 360w,\n/static/1d71ef9c09a0917fca8e178b059b4318/37523/infra_test.png 720w,\n/static/1d71ef9c09a0917fca8e178b059b4318/302a4/infra_test.png 1080w,\n/static/1d71ef9c09a0917fca8e178b059b4318/07a9c/infra_test.png 1440w,\n/static/1d71ef9c09a0917fca8e178b059b4318/9f9a4/infra_test.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>앞선 구조도에서 볼 수 있듯이, 신규 서버는 디어 서버를 유일한 클라이언트로 가진다.\n즉, 외부에서 요청을 받을 일이 없다.\n따라서 실제와 비슷하며 프로덕션 보안정책을 준수하는 테스틀 위해 VPC 내에서 요청을 보낼 목 클라이언트가 필요하다.\n또한, 외부 서버와 통신을 해야하며, 이 요청의 응답 속도나 상태가 제어 밖이라는 점도 특징이다.\n그래서 외부 목 서버도 필요했다.\n더 정확한 테스트를 위해서라면 디어 앱을 모킹한 곳에서 요청을 보내야겠지만, 테스트의 주 목적을 생각해 내부 클라이언트(디어 서버)까지만 모킹하고 여기서 요청을 보냈다.</p>\n<p>외부 목 서버는 스프링으로 만들었다.\n며칠 간 쌓인 신규 서버 로그 데이터를 통해 외부 서버의 API 응답 속도를 대략 알 수 있었다.\n이 중 평균 소요시간이 제일 긴 서버의 경우 약 2초의 시간이 걸릴 때가 많았다.\n따라서 목 서버는 간단하게 스레드를 2초간 정지하고 응답하도록 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MockController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MockApiResponse</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MockApiRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2_000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MockApiResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<h2 id=\"-테스트-시나리오-짜기\" style=\"position:relative;\"><a href=\"#-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-%EC%A7%9C%EA%B8%B0\" aria-label=\" 테스트 시나리오 짜기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📝 테스트 시나리오 짜기</h2>\n<h3 id=\"목표-트래픽-처리량-설정\" style=\"position:relative;\"><a href=\"#%EB%AA%A9%ED%91%9C-%ED%8A%B8%EB%9E%98%ED%94%BD-%EC%B2%98%EB%A6%AC%EB%9F%89-%EC%84%A4%EC%A0%95\" aria-label=\"목표 트래픽 처리량 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>목표 트래픽 처리량 설정</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAADF0lEQVR42i3DW0+TBwCA4e9iP2BLtmTOaYbuaiRbsoM6HNmWRbrEyBRFMoQakylWwLFUoAUp1cIntRRpgR7WFuuggBRYZXKyXw/0QOkJaFMQEHUs283+xLubPckjWMbc9HvnMC6E6Akl6PZH0QcSGEKrGEJJzJE84+nXWJc30fhWkDYK+Ap/M5HbZyL1klB2l5X8SxK5V0SyOwhWtw2D4zf03qeIoQRd/gg9oRX0gTim6BqWwDo/ixbk9WouVlxAXlWJzvkYX+EfltI7SNltwhu7RNZ3CWa3EQY8w2j9cbqXlhH9MXT+KGIwTm84jTWc5/y1ZkplFXxReorDHxZz8vhXVNdc5llmh2DmOVJmCyn9/8xzhMFRJ3elVboXw3Q9i6BdimIIprDHNrGFcpSeruTQ4SN8+/kxDA0NzPXruN9QhWchyO+5fWYye4wndhiNbzMcySE8mhjh1+QejlgeZ3wT18oW7uQ2o6kXTKb2MOs0nCv7Dm2NHE+bGmlQ5I68jAGTnsdb/zK29iee9X3GNv5iZO01wuxShOnkC6ayr9AHtqjyJKkZX6V6MsNgIINpyEGzRuRG+WncLUr6FHLUl04xoJIzO/8H01IU86MZel3TGJxTCJqZFBcexqn1JJE5Y5TY45TYV1B4Eww8eYpueJJmZTtnTn7KpW9OoDjxGfdqZYg/ybjfpcI66sZktdDX78JoeogwEshhXtxgcGEdh1RAbZtC5ZjAlc7TYbVhHPJSV1tPpew4SlUjHrsVY8s1rLfl2M06up0uer2TuGf9+JYSCPq5LA7/Om5pjau+Aop2DQaFjAd3NHSW/0jXD5dp+riE1k+KMZaXY7hynXtnz+E4U4al5iztoo5Om43hYBQpvY1QbpBotC+jGY3zRt0iVxRNDF08gqr4I3rePEjH2+9z870i9G8dYOhQEfoPjtLzzkH07xah/fIYrZpWboh9TIezPInlEb5Xz9PQF0Y7vIrwtZuK2/MYHT6qazrpaHnArbq7NJ6/Tl3DLzTrRbTKJtS3lNRru7mpaaNN2YTZMs1Ai4hL3ct/hmpVrGW+WnQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"진짜같다짤\"\n        title=\"\"\n        src=\"/static/a182ce258762ffea712f6b392fd19d65/37523/realistic.png\"\n        srcset=\"/static/a182ce258762ffea712f6b392fd19d65/e9ff0/realistic.png 180w,\n/static/a182ce258762ffea712f6b392fd19d65/f21e7/realistic.png 360w,\n/static/a182ce258762ffea712f6b392fd19d65/37523/realistic.png 720w,\n/static/a182ce258762ffea712f6b392fd19d65/302a4/realistic.png 1080w,\n/static/a182ce258762ffea712f6b392fd19d65/07a9c/realistic.png 1440w,\n/static/a182ce258762ffea712f6b392fd19d65/14747/realistic.png 1914w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>시나리오 작성의 목표는 ‘최대한 현실과 비슷하게’였다.\n먼저 신규 서버가 감당해야 할 최소 트래픽을 계산했는데, 해상도를 제일 높여 잰다면 ‘디어를 운영한 모든 기간 중에 트래픽이 제일 많았던 시간의 순간 트래픽량’이 필요하다.\n하지만 몇 년 간의 데이터를 분석하기보다, 현실적으로 서비스가 계속 성장해왔음을 감안해 범위를 2022년도의 데이터로 한정하고, 다음과 같은 과정으로 간략히 구했다.</p>\n<ol>\n<li>2022년도의 365일 중, 해당 요청이 가장 많았던 날짜를 구한다.</li>\n<li>해당 날짜의 기록을 분당 group by 하여, 제일 트래팩이 많았던 시간의 요청 수를 구한다.</li>\n</ol>\n<p>데이터 전문가가 보면 킹받을지도 모른다는 걱정이 잠깐 들지만 나름 합리적인 계산이었다.\n2022년도의 x월 x일에 가장 많은 요청이 있었고, 특정 시간대에 요청이 제일 많았다.\n분당 최대 요청수를 초단위로 단순화해보면 신규 서버는 최소 <code class=\"language-text\">n tps</code>를 처리할 수 있어야 했다.\n다만 이번년도에 내가 속한 디어서비스팀은 모든 걸 10x로 목표하고 있다.\n따라서 신규 서버도 최소 <code class=\"language-text\">10*n tps</code>를 지원하는 것을 목표한다.</p>\n<br>\n<h3 id=\"유저-행동-설정\" style=\"position:relative;\"><a href=\"#%EC%9C%A0%EC%A0%80-%ED%96%89%EB%8F%99-%EC%84%A4%EC%A0%95\" aria-label=\"유저 행동 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>유저 행동 설정</h3>\n<p>디어에서 해당 도메인을 경유지로 이뤄지는 요청은 세 가지가 있다. 1.단순 요청  2.별도 요청  3.자동 요청<br>\n뭔가 최대한 정보를 마스킹하려다 보니 요상해지는데 꿋꿋하게 설명하겠다.\n3번 요청은 항상 1과 함께 이뤄지되, 3이 선행될 경우 1에서 외부 서버 요청이 일어나지 않는다는 특성이 있다.\n좋은 테스트를 위해 각 요청이 어떤 비율로 일어나는지 알아야 한다.\n만약 1번 요청과 2번 요청이 1:1 비율로 발생하는데, 1번 요청만 테스트 시나리오에 사용한다면 현실과 큰 괴리가 생기기 떄문이다.</p>\n<p>2022년도에 1번 유형 요쳥은 약 x건이 일어났다.\n2번 요청은 x건의 0.5% 정도가, 3번 요청은 0.6% 정도 발생했다.\n초당 요청량을 생각했을 때 이정도 비율은 큰 의미가 없을 것 같아 1번 요청을 단일한 시나리오로 작성하려 했다.\n다만 이미 테스트 DB에 3번-1번 요청을 연달하 하도록 설정된 유저 데이터가 있길래, 추후 테스트 대상 유저 데이터를 선정할 때 해당 비율로 섞고, 2번 요청은 제외했다.</p>\n<br>\n<h2 id=\"-테스팅-툴-선정\" style=\"position:relative;\"><a href=\"#-%ED%85%8C%EC%8A%A4%ED%8C%85-%ED%88%B4-%EC%84%A0%EC%A0%95\" aria-label=\" 테스팅 툴 선정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🧪 테스팅 툴 선정</h2>\n<p>테스팅 툴은 1.빠르게 실행가능 할 것  2.이용이 간단할 것을 중점으로 선정했다.\n2주간의 스프린트 계획을 짤 때 부하테스트에 약 2~3일을 배정했고, 목표 tps를 테스트 할 때 너무 상세하거나 복잡한 기능을 필요하지 않다고 생각했다.\n그래서 별도의 서버를 필요로 하는 툴은 제외하고, 코드나 설정 파일로 간단히 실행 가능한 <a href=\"https://github.com/rakyll/hey\">hey</a>, <a href=\"https://www.artillery.io/\">artillery</a>, <a href=\"https://k6.io/\">k6</a>를 후보로 골랐다.</p>\n<h3 id=\"hey\" style=\"position:relative;\"><a href=\"#hey\" aria-label=\"hey permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>hey</h3>\n<p>hey는 다음과 같이 커맨드라인에서 간단히 요청을 보낼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">hey <span class=\"token parameter variable\">-z</span> 10s <span class=\"token parameter variable\">-m</span> GET http://new-server.stage.com/actuator/health</code></pre></div>\n<br>\n<p>해당 명령어는 10초간 신규 서버의 헬스체크 주소로 요청을 보낸다.\n문서를 보면 요청 수, 초당 동시 실행할 worker의 수, 지속 시간, 헤더 등등을 설정할 수 있다.\ncurl 명령어와 비슷하다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.222222222222214%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA1klEQVR42n2R2wqDMBBENZJEo/F+V1Cw//+LU2aLUKn2YXAxm7OzkyAIAoRhiKqqEEURiqJAlmXg/2+dZ23bIk3Tn/MvfYqu6+CcwzRNcukcRJ3AYRiwbRvKsvwP5CVOjeMYWuvbRqUU6rrGsiy3G/w4ZCMdrOsqolNqnmf0fS+DCKQ7bpDnuUSgtYGNEygVXoGEUUmSwForMsbIlzA65ABC9n2X+nUcaPoRw7LBWnMFjuMoD/O0CoFN08B7L3kzItapc8i9l4wvQK7BhifgmTPFx3vK8A0VuZiu0j3AQwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"hey test\"\n        title=\"\"\n        src=\"/static/b5e7cdd93701ce85fc23475f803e5084/37523/hey.png\"\n        srcset=\"/static/b5e7cdd93701ce85fc23475f803e5084/e9ff0/hey.png 180w,\n/static/b5e7cdd93701ce85fc23475f803e5084/f21e7/hey.png 360w,\n/static/b5e7cdd93701ce85fc23475f803e5084/37523/hey.png 720w,\n/static/b5e7cdd93701ce85fc23475f803e5084/302a4/hey.png 1080w,\n/static/b5e7cdd93701ce85fc23475f803e5084/07a9c/hey.png 1440w,\n/static/b5e7cdd93701ce85fc23475f803e5084/2adcb/hey.png 1984w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>테스트 결과를 이런 형태로 출력해 보여준다.</p>\n<p>사용법은 제일 간단했지만, 일련의 요청 흐름을 실행할 수 없었다.\n1,2,3번 유형에 관계없이 모든 요청의 흐름은 디어 서버에서 신규 서버로 1. POST 요청을 보낸다  2. GET 요청으로 이전 요청의 결과값을 조회한다  두 가지 요청이 항상 묶음으로 보내졌기에, hey로는 원하는 시나리오 테스트를 할 수 없었다.</p>\n<br>\n<h3 id=\"k6-하려다-못-함\" style=\"position:relative;\"><a href=\"#k6-%ED%95%98%EB%A0%A4%EB%8B%A4-%EB%AA%BB-%ED%95%A8\" aria-label=\"k6 하려다 못 함 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>k6 하려다 못 함</h3>\n<p>두번째로 k6는 자바스크립트로 테스트를 작성할 수 있다는 점이 매력적이었다. 그런데 설치에 문제가 있었다.\n처음 목 클라이언트와 목 서버 인스턴스를 제일 저렴한 <code class=\"language-text\">t2.micro</code>로 생성했다.\n사실 현실과 가까운 테스틑가 목적이라면 실제 클라이언트인 디어 서버와 비슷한 스펙으로 설정해야 했다.\n하지만 당시에는 거기까지 생각하지 못했고, 후에 문제를 만나 바꾸게 된다.\n어쨌든 <code class=\"language-text\">t2.micro</code> 인스턴스는 스펙이 부족해 k6를 설치할 수 없었다… 그래서 우선 artillery로 넘어갔다.</p>\n<br>\n<h3 id=\"️-artillery\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-artillery\" aria-label=\"️ artillery permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⭐️ artillery</h3>\n<p>마지막으로 artillery는 node.js로 만들어진 툴이다.\nhey처럼 커맨드라인으로 간단한 테스트가 가능한 동시에, <code class=\"language-text\">json</code>, <code class=\"language-text\">yaml</code>로 자세한 시나리오 테스트를 작성할 수 있어 선택했다.\n테스팅 결과 역시 <code class=\"language-text\">json</code>과 <code class=\"language-text\">html</code> 파일로 출력 가능하다.\n<a href=\"https://blog.outsider.ne.kr/1238\">Artillery를 이용한 스트레스 테스트 - Outsider’s dev story</a> 해당 블로그 포스팅에서 많은 도움을 받았다.</p>\n<br>\n<h2 id=\"️-yaml로-시나리오-작성\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-yaml%EB%A1%9C-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-%EC%9E%91%EC%84%B1\" aria-label=\"️ yaml로 시나리오 작성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ yaml로 시나리오 작성</h2>\n<p>테스트 대상 신규 서버의 엔드포인트는 총 두 개다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">POST http://new-server.stage.com/deers\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"userId\"</span><span class=\"token builtin class-name\">:</span> 유저 아이디,\n  <span class=\"token string\">\"deerId\"</span><span class=\"token builtin class-name\">:</span> 생성할 엔티티와 관련된 아이디, \n  <span class=\"token string\">\"data\"</span><span class=\"token builtin class-name\">:</span> 특정값  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">GET http://new-server.stage.com/deers?userId<span class=\"token operator\">=</span>:userId<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">deerId</span><span class=\"token operator\">=</span>:deerId</code></pre></div>\n<br>\n<p>그런데 문제가 있다. 로직 상 한 번 POST 요청이 성공하면 동일한 <code class=\"language-text\">deerId</code>로 다시 요청할 수 없다.\n따라서 <code class=\"language-text\">deerId</code>가 요청마다 다르지 않으면 테스트가 불가능하다.\nartillery는 <a href=\"https://www.artillery.io/docs/guides/plugins/plugin-fuzzer\">매 요청마다 랜덤한 문자열을 생성하는 플러그인</a>을 지원하지만, 숫자는 찾지 못했다.\n대신 <code class=\"language-text\">csv</code> 파일에서 랜덤한 값을 요청마다 지정하는 기능이 있었다.</p>\n<p>그래서 자바스크립트로 간단히 1000부터 100000까지 숫자가 적힌 <code class=\"language-text\">numbers.csv</code> 파일을 아래와 같이 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"csv\"><pre class=\"language-csv\"><code class=\"language-csv\"><span class=\"token value\">1000</span>\n<span class=\"token value\">1001</span>\n<span class=\"token value\">...</span>\n<span class=\"token value\">99999</span>\n<span class=\"token value\">100000</span></code></pre></div>\n <br>\n<p>또, 디어 앱에서부터 유저 흐름을 생각하면, 한 유저는 대게 단일한 요청을 보낸다.\n짧은 시간 내 여러 요청을 보내는 경우는 외부 API 연동이 실패해 재요청하는 경우 뿐이다.\n궁금해서 외부 API 처리 실패율을 단순하게 ‘실패한 횟수 % 전체 횟수’로 계산했는데, 실패율이 가장 높은 외부 서버 기준으로 약 <code class=\"language-text\">0.2%</code>에 불과했다.\n적은 비율이라 테스트에서 한 유저는 한 번만 요청을 보낸다 가정했다.\n만약 요청 특성 상 특정 시간에 한 유저가 여러 요청을 보낼 수 있었다면, 유저가 평균 몇 번 요청을 보내는지 조사하고 반영해야 했을 것이다.</p>\n<p>테스트 DB에 존재하는 유저 데이터 id 목록을 조회해 마찬가지로 <code class=\"language-text\">users.csv</code>라는 파일로 만들고 시나리오를 <code class=\"language-text\">yaml</code>로 작성했다.\nartillery 공식 문서가 친절해서 조건을 하나씩 추가하며 작성하기 수월했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://new-server.stage.com\"</span>\n  <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token key atrule\">phases</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">duration</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n      <span class=\"token key atrule\">arrivalRate</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n  <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">expect</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">payload</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span>\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"users.csv\"</span>\n      <span class=\"token key atrule\">fields</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"userId\"</span>\n    <span class=\"token punctuation\">-</span>\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"numbers.csv\"</span>\n      <span class=\"token key atrule\">fields</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"deerId\"</span>\n\n<span class=\"token key atrule\">scenarios</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"specific scenario\"</span>\n    <span class=\"token key atrule\">flow</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">post</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/deers\"</span>\n          <span class=\"token key atrule\">json</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">userId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ userId }}\"</span>\n            <span class=\"token key atrule\">deerId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ deerId }}\"</span>\n            <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span>\n          <span class=\"token key atrule\">headers</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">Content-Type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span>\n            <span class=\"token key atrule\">capture</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">json</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"code\"</span>\n              <span class=\"token key atrule\">as</span><span class=\"token punctuation\">:</span> code\n          <span class=\"token key atrule\">expect</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">statusCode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">equals</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"{{ code }}\"</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"success\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">get</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/deers?deerId={{ deerId }}&amp;userId={{ userId }}\"</span>\n          <span class=\"token key atrule\">capture</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">json</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"code\"</span>\n              <span class=\"token key atrule\">as</span><span class=\"token punctuation\">:</span> code\n          <span class=\"token key atrule\">expect</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">statusCode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">equals</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"{{ code }}\"</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"success\"</span></code></pre></div>\n<br>\n<p>설정을 간략히 설명하자면, 신규 서버(target)로 60초간(duration) 초당 5명의 요청(arrivalRate)을 보낸다.\n응답이 10초간 오지 않을 시 요청이 실패(timeout)한 것으로 취급한다.</p>\n<p>해당 스크립트를 실행하면 POST, GET 요청이 각각 연달아 나간다.\n또한 요청마다 <code class=\"language-text\">csv</code> 파일에서 랜덤 지정된 <code class=\"language-text\">userId</code>와 <code class=\"language-text\">deerId</code>값이 각각 json 바디, url에 지정된다.\n<code class=\"language-text\">expect</code> 플러그인으로 응답 코드와 응답 바디값에 간단한 검증도 붙였다.\n실행 시 옵션을 주면 결과를 json 파일로 생성할 수 있고, 이를 보기 편한 html로 변환할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">npx artillery run <span class=\"token parameter variable\">--output</span> report.json script.yaml</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">artillery report ./report.json</code></pre></div>\n<br>\n<h2 id=\"-문제-해결하기\" style=\"position:relative;\"><a href=\"#-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\" aria-label=\" 문제 해결하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🛠 문제 해결하기</h2>\n<h3 id=\"예상치-못한-삽질\" style=\"position:relative;\"><a href=\"#%EC%98%88%EC%83%81%EC%B9%98-%EB%AA%BB%ED%95%9C-%EC%82%BD%EC%A7%88\" aria-label=\"예상치 못한 삽질 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>예상치 못한 삽질</h3>\n<p>그렇게 가벼운 마음으로 테스트의 테스트를 실행했는데 당황스런 결과가 나왔다.\n초당 요청 수가 5에 불과했는데 요청 하나를 빼고 다 실패했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXUlEQVR42pWOQQoAIQwD/UmtImpR0P8/LksK7lkPA01o0oYxBkjvHbVWtNau4b6ZeZ4zCTT23i5ijFDVa7ifc0Yp5c+GOSfWWm68IiJIKXkpZ3r+IUvPxVdYSI7+ABxEcQjH9+mAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"timeout\"\n        title=\"\"\n        src=\"/static/910c4729e696d952ae6907b8e7b637c8/37523/micro_test.png\"\n        srcset=\"/static/910c4729e696d952ae6907b8e7b637c8/e9ff0/micro_test.png 180w,\n/static/910c4729e696d952ae6907b8e7b637c8/f21e7/micro_test.png 360w,\n/static/910c4729e696d952ae6907b8e7b637c8/37523/micro_test.png 720w,\n/static/910c4729e696d952ae6907b8e7b637c8/302a4/micro_test.png 1080w,\n/static/910c4729e696d952ae6907b8e7b637c8/07a9c/micro_test.png 1440w,\n/static/910c4729e696d952ae6907b8e7b637c8/eff3b/micro_test.png 2072w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이유가 짐작하지 않아 요청 수를 계속 낮추면서 실행했는데, 결과적으로 <code class=\"language-text\">2tps</code>일 경우에만 안정적으로 처리됐다.\n너무나 예상 밖의 결과라 당황했다.\n결국 팀원의 도움을 받아 로깅을 보고 원인을 찾았는데, 목 서버에서 응답을 주지 못하고 있었다.\n앞에서 언급한 ‘모킹 인스턴스를 <code class=\"language-text\">t2.micro</code>로 설정해 생긴 문제’였다.\n목 서버의 인스턴스를 더 좋은 사양으로 업그레이드 하니 테스트가 정상적으로 수행되었다.</p>\n<p>테스트를 할 때 프로덕션과 최대한 비슷한 인프라 환경을 구축하는 것이 좋다고 생각하면서도, 이런 식으로 문제가 바로 생길 줄 몰랐다.\n그래서 목 클라이언트 인스턴스도 더 나은 사양으로 함께 변경했다.\n다만, 프로덕션 환경과 완전히 동일한 사양으로 올리는 것은 여전히 낭비라고 생각해 적당히 올렸다.</p>\n<br>\n<h3 id=\"그래도-예상-범위였던-문제-해결하기\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9E%98%EB%8F%84-%EC%98%88%EC%83%81-%EB%B2%94%EC%9C%84%EC%98%80%EB%8D%98-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\" aria-label=\"그래도 예상 범위였던 문제 해결하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그래도 예상 범위였던 문제 해결하기</h3>\n<p>그리고 테스트를 다시 시작했는데, 또다시 한자릿수 tps에 막혔다.\n아까와 달리 목 서버와 클라이언트에는 문제가 없었다.\n한자릿수의 요청을 1분간 보냈을 때, 약 10초 후 부터 DB 커넥션 풀이 고갈되는 현상이 발생했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAwklEQVR42i2PzYrDMBCD8/4PVtjzQs9LS+rfsTO2x2kCiRZPchDS2CD0TcdxYGGGdREpGcyvH1B8w3qCsQ4xZTgfESLB+QDjPJoIpPfb1zt3bNuO6TxP/UiZUUoEhSeYPSgzKGVwqcgLY+GClBdV76tKpKOvV9bCfcc0FpZa4QMhZw9nfnWpCwTrvBaMdZESwq1SG2oTlFLVa2369v1uV+FY8LEBRB+8/x4I4aX3bIyWDcyBPXw29kKVjtYudM0iivwPn4UwbxtjlgcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"connection timeout\"\n        title=\"\"\n        src=\"/static/7adff8ce79b62be9015efbeeca75f61e/37523/connection_timeout.png\"\n        srcset=\"/static/7adff8ce79b62be9015efbeeca75f61e/e9ff0/connection_timeout.png 180w,\n/static/7adff8ce79b62be9015efbeeca75f61e/f21e7/connection_timeout.png 360w,\n/static/7adff8ce79b62be9015efbeeca75f61e/37523/connection_timeout.png 720w,\n/static/7adff8ce79b62be9015efbeeca75f61e/302a4/connection_timeout.png 1080w,\n/static/7adff8ce79b62be9015efbeeca75f61e/07a9c/connection_timeout.png 1440w,\n/static/7adff8ce79b62be9015efbeeca75f61e/5b503/connection_timeout.png 1976w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  그래도 로그를 바로바로 확인할 수 있는 환경이라 원인 파악이 쉬웠다  \n</div>  \n<br>\n<br>\n<p>히카리 CP 설정은 모두 default 값이었기에, maximum pool size를 우선 default인 10에서 30으로 늘려보고 다시 실행했다.\n그러니 커넥션 고갈이 시작되는 시간을 미뤄졌지만 결국 특정 시간 이후에 고갈되는 현상은 그대로였다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIUlEQVR42o2Q2U7DMBBF8xdNaideEseTNFKohCioLCp9YRFLXwoFif//i4s8DSFIBfJwNZt85o4jIkLbtmiaBt57hPqgwswXg55neSJ4v+855xAZY5DnOay1CPlhKWhbIS2vYHTGdT/jWve9SCmFIK3171ISaT5HXL0gsw2kO4cslpDFAsKtoIxnaW0Q/QliGRglkeVHSOgJaXGKhDYQ5TWku0Rcv/GSsEyZcn/y/0DRATdIixMk9ABRrthpXG2R2RniescuozHuhL9hZ1N6ZGCIPbDeQjHwdQzQwqgEk9kHpLvoTl4goWeIct2dvGOHk/p9BNBYPndKd0iLY8hyjSyfMyx1Z+xW0C2UJQi6hzbuG/j1l8M4zK0d1Nz7+c528RNPJgD1bS+r7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pool-30\"\n        title=\"\"\n        src=\"/static/d3f34564ef856ca451951f5d8545c841/37523/pool-30.png\"\n        srcset=\"/static/d3f34564ef856ca451951f5d8545c841/e9ff0/pool-30.png 180w,\n/static/d3f34564ef856ca451951f5d8545c841/f21e7/pool-30.png 360w,\n/static/d3f34564ef856ca451951f5d8545c841/37523/pool-30.png 720w,\n/static/d3f34564ef856ca451951f5d8545c841/302a4/pool-30.png 1080w,\n/static/d3f34564ef856ca451951f5d8545c841/07a9c/pool-30.png 1440w,\n/static/d3f34564ef856ca451951f5d8545c841/8c48a/pool-30.png 2096w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  Hikari CP maximum pool size가 30, 인스턴스가 1개일 때   \n</div>  \n<br>\n<br>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAq0lEQVR42qWSzQrCMBCE8xRqk9hkg/kxQejVgyLYk1Xvff8HGUmrWAVBmsOwJLuZ7AfDUkpomga5hhCK5L0H01qDiJDrLJGBnrxns400gRSHcC2kPYCUGO4KDSvwcIVwZ1C9GA3n444bcn+BcCfUZgdFm3Jk7rsBeRV7KBPLkatwg7BHLGOP+mWYsX9pmoLPnoHREtK3WNs9xPYOZcJ/G35/8I5MPqvnzBibB5gd+3QKNNmaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pool-40\"\n        title=\"\"\n        src=\"/static/aa53a59e35db42d7b50567d2c1950edb/37523/pool40-instance2.png\"\n        srcset=\"/static/aa53a59e35db42d7b50567d2c1950edb/e9ff0/pool40-instance2.png 180w,\n/static/aa53a59e35db42d7b50567d2c1950edb/f21e7/pool40-instance2.png 360w,\n/static/aa53a59e35db42d7b50567d2c1950edb/37523/pool40-instance2.png 720w,\n/static/aa53a59e35db42d7b50567d2c1950edb/302a4/pool40-instance2.png 1080w,\n/static/aa53a59e35db42d7b50567d2c1950edb/07a9c/pool40-instance2.png 1440w,\n/static/aa53a59e35db42d7b50567d2c1950edb/87629/pool40-instance2.png 2076w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  Hikari CP maximum pool size가 40, 인스턴스가 2개일 때   \n</div> \n<br>\n<br>\n<p>우선 가장 빠른 해결법으로 DB 커넥션 수 늘리기가 있었다.\n신규 서버는 aws RDS를 사용했고, 바로 다음 사양으로 업그레이드하면 10배가 넘는 커넥션이 지원됐다.\n22년도와 동일한 패턴과 양의 트래픽이 들어온다면 일단 문제는 생기지 않는 해결법이다.</p>\n<p>다만 올해의 목표를 생각했을 때, 또 확장성을 고려했을 때 너무 불안한 해결법으로 느껴졌다.\n올해 여러가지 정책을 시도하게 될 것 같은데, 만약 해당 도메인의 요청이 늘어나는 이벤트라도 한다면 바로 문제가 된다.\n아직 오지 않을 일은 대게 영원히 오지 않는다고 하지만 그래도 최소 목표치인 <code class=\"language-text\">10*n tps</code>는 안정적으로 달성하고 싶었다.</p>\n<p>다른 하나는 신규 서버에서 DB 커넥션을 물고 있는 시간을 줄이기였다.\n신규 서버의 사양을 올리고, 커넥션을 최대한 써도 요청 시간을 늘리면 결국 커넥션 풀 고갈이 발생하는 걸 보고, 목 서버의 응답 시간을 2초에서 0.5초로 줄여보았다.\n그러니 tps가 문제없이 쭉쭉 올랐다.\n반대로 말하면 외부 서버의 응답 시간이 더 길어지면 tps가 더 내려갈 수도 있었다.\n신규 서버는 외부 서버의 응답을 최대 5초까지 대기하도록 설정했으니 가능성 있는 이야기다.</p>\n<p>신규 서버는 기존 DB와 새로운 DB에 동시에 접근한다.\n앞 인프라 구조에서 생략했던 DB를 추가하면 아래와 같다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABJklEQVR42nWRe0/CMBRH+f6fyT+I0ZiYaBR5g0xkT9Z2tDy2jm7HMCBCxJucpEl7T+7tr1UD1DX1BdZarC1Y5w69q9A7d0FFXtZUVYVzruHQc9TUtBoZ1/WdGCYLxWTpmCmOZOBlMBXgRRohUqIoQkrJfr//FTayylKsRuxkF5uvmCUFQWoIhWHsG8ajJf1ewKAbMPQ0XqxRUhLHMUqp/4R9tuKN7TptJGGyIko1nXFC72VO52nK4N3nYyT4DDOkEIS3JoTDv12vvLGOIFN4fkimdiizxU+XiM2Wja2RK4OUgiRJbkx4TOUUSNVc6ELxOLnnYdhmUxp8Pac9uON1/nx6WzXBlWXZcB3K6XDmUNZZfLVgoRaUrsTkhq/UIzHxnwDPde79AfCNGhc8FavBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"db infra\"\n        title=\"\"\n        src=\"/static/a8af77d7b5823086130af4e6c2b10c87/37523/db_infra.png\"\n        srcset=\"/static/a8af77d7b5823086130af4e6c2b10c87/e9ff0/db_infra.png 180w,\n/static/a8af77d7b5823086130af4e6c2b10c87/f21e7/db_infra.png 360w,\n/static/a8af77d7b5823086130af4e6c2b10c87/37523/db_infra.png 720w,\n/static/a8af77d7b5823086130af4e6c2b10c87/302a4/db_infra.png 1080w,\n/static/a8af77d7b5823086130af4e6c2b10c87/07a9c/db_infra.png 1440w,\n/static/a8af77d7b5823086130af4e6c2b10c87/9f9a4/db_infra.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>요청이 들어온 후 시간에 따라 각 자원에 접근하는 순서를 그려봤다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABhElEQVR42n2Ta2/aUAyG+f9/bLcP6yq0Sqx0aILSFkYDybnY5/g8U04JDRXDkiMrkR+9r+1MSin02UfbOJbzJ5YPa3brhn1omK5u+b2d08YDd+sps5cZph1x8wv/dIf5be0dOJMxsNkcuL9dMPvxwPPiL69+x+f7T/xcTTnEhm/zL9z8uaHInrD8Trf4irWPlDGQYwzQmEGCkHNCRHCxxUqu37IlrBgfY+jtY6SwkAwab0QfKkxVCeLJlilWSDlRKCeImdW+gXFSOACdgiYjdI4QAiF4nOvT4b2ndfsK7UE5Zyznd4VHxuRUU+gENJeqTFNGNCGqpJRq6lDnTJKIxfaaZarCx5dXVs9b1psdjVOsXJ4VJVPkIvDdcivgJRNFiZrQbNVe6fM4s5p9nfSywrcXR8vab7IQ3HiG7jTDzrUn26qCJbmusDsupd9yFCFGqVBRIWkiiKOMzsZK+Z/CN6AadNEQ7+vZiCg+dhTs7G84P5srwP65D4ZGPZvZ0DCuP8IH4D8ImazwsBaBUgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"long transaction\"\n        title=\"\"\n        src=\"/static/60cd8c13b1169fb637c32802836b02b8/37523/long_transaction.png\"\n        srcset=\"/static/60cd8c13b1169fb637c32802836b02b8/e9ff0/long_transaction.png 180w,\n/static/60cd8c13b1169fb637c32802836b02b8/f21e7/long_transaction.png 360w,\n/static/60cd8c13b1169fb637c32802836b02b8/37523/long_transaction.png 720w,\n/static/60cd8c13b1169fb637c32802836b02b8/302a4/long_transaction.png 1080w,\n/static/60cd8c13b1169fb637c32802836b02b8/07a9c/long_transaction.png 1440w,\n/static/60cd8c13b1169fb637c32802836b02b8/9f9a4/long_transaction.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>여기서 문제는 이 모든 접근이 하나의 트랜잭션으로 묶여있는 점이었다.\n트랜잭션 내에서 외부 서버에 요청을 보내서, 실제로 필요한 시간보다 훨씬 길게 커넥션을 점유했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABW0lEQVR42o2S207DMBBE+/8fhXjjDSEhkIpEi4DeSJu2juu7fZBNkqZVga4U7SaZHc2MPUopkSv3al4zf1symy5RjWYhZjzNH9mqDVWz4nnxSCUrUGsOqzF2M4FgSO1+rlFPGBPvLwvGDxNeHqaIjWRav3L7dMNKLPjcvnP7fMNs9wnig2Z6h5ndk7w8JaStodKYIiEGjDEYcyjfYwxYq3tcv/ez1L8Xhd2TyzmH1hrrHPag8Pt9WYrOkaTsaWKMAxGXLLfdWouUEqUUByGQ1RfKGOR+j9nWxEweAiGEE1e/Ws5A7z0+d2Nwux0+JbzWP3OM5X+OI6sc7l4k7EAt+9Fm8APLFNKrCUs+bW6hEcdZiGI5xViiuYowH0rOTxuDkg1qvUZbi2oaTF33ljPhef4XCTuwy10pbEuS53ziQ/xVhKcKJa7NLYVA1LoDn12bfxR24JLnhavxl8JvkNiturgaP00AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"long connection\"\n        title=\"\"\n        src=\"/static/27e5b1f0296266c89a66b4f5f2c98420/37523/long_connection.png\"\n        srcset=\"/static/27e5b1f0296266c89a66b4f5f2c98420/e9ff0/long_connection.png 180w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/f21e7/long_connection.png 360w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/37523/long_connection.png 720w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/302a4/long_connection.png 1080w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/07a9c/long_connection.png 1440w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/9f9a4/long_connection.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>그래서 외부 서버 요청 로직을 트랜잭션 밖으로 분리하는 리팩터링을 진행했다.\n다행히 외부 서버 요청 전 DB 접근은 조회가 대부분이었다.\n일부 값을 변경하는 로직도 있었지만, 외부 서버 요청 성공 여부와 무관하게 값이 변경되어도 비즈니스 로직 상 문제가 없았다.\n결론적으로 외부 서버 요청이 성공할 때만 트랜잭션을 시작하고 각 DB에 접근하도록 개선했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABc0lEQVR42nVS2WrDMBDM/39U6fFSaF7ah1BoKSZtTC7biSWtztUUyZHrknhhkbzaGc+stIgxImUKEhqHusW+btC3EtIKVO0XdmILsgrrrsLmvEH0BNv9QDcVou0ztvAspoTHusPq5SNn/bnHUR1wv7rD2/oVnW7x9P6AZbVENC2oeob4fAT33/8JcYlCmiJYP6zBQ+gzrDeIiFmlcWbsixNs2Y8KCyEzQwkJIoImDdISHDmfp7OpgPKdsZe8SSgvhIoUpJRQSoEUoVcn+OBzTwjhH2HBL4bCn+W0Omvhvc/pnLvehwDvDNiqq3FNZng9j6x40jwFggOiFbcJywxSmSyj3h1R7xpsDx2E9uMPeGItskc0s4R/Eo1jnM4SvaSckky2mtJaO9p2zoIvNz5jeSieNaPvFazR0MZAHQ8g0YOMATUN2LmsOF0Ic5xXWIrCDIRaE0hr6NMJ0Q+2WSnEEG4/mzmFqckblx9yAY1n0xnOEP4CIdutTJOWTOwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"refactoring\"\n        title=\"\"\n        src=\"/static/4ff969a3fdfb53f2ab0eebe033433dba/37523/refactor.png\"\n        srcset=\"/static/4ff969a3fdfb53f2ab0eebe033433dba/e9ff0/refactor.png 180w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/f21e7/refactor.png 360w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/37523/refactor.png 720w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/302a4/refactor.png 1080w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/07a9c/refactor.png 1440w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/9f9a4/refactor.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>구조를 개선하고 나니 원래 목표했던 <code class=\"language-text\">10*n tps</code>의 두 배까지 한 인스턴스로 안정적으로 처리 가능했다.\n커넥션 풀도 조정하며 테스트를 재차 수행한 결과, 30개로 충분해 30개로 줄였다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABuUlEQVR42o2SS2/UQBCE/QsQaHe9j6zdj/HMeDdrO3uLEBIcACEQIMQt5ASIAwoHIASUP19o2kOUhAMcSmOV3V9XT7sIIaDrOsQYoapgZojIfyl9e13JK9q2xX6/RzqdcyAiEAuIGMSj2Dz+27ulBDVg3/eW0HuPGANiUKTkMXjE0CCEmM+bXohZyc/1RRqzaRo4l6RQ50HtQ0srTQfxR3DK4+kctNlA/ACnYn6qSb69U0VxPS5TDRKPSX9uz8v2Febbd5B6Zh6xwyo8Rnn4AVrdxXx7glq2YKrsmmzkmxebgAHT/iuYyYCL7QmkLjEdfoCkwUF4gnL3Ea66g8nRJSq3h9AKQmswC4qrbYkzIyWc9t8MuMpANeA5+BYwNam1A0nE2t83aMGsEFpguXmDVXxhKaf99wx8+Q/gBUharP0DzLov0HqSgXVphcvNW+syGS7yyK8x354acDL8HEeOT1HuPo0jD79AusnAsz9AsYSrlLB9DuEKZffZgAfxWW4yHz1psA6PsDg8hVb3UPZnIG1RNceY795D69m4FNuy6CgmiDb5XhUi48+uLuTFib0nqiHqr7zULNX+BgazPe/oXHuQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"result\"\n        title=\"\"\n        src=\"/static/f2825b41a05d0a6153a288806aee1ac1/37523/result.png\"\n        srcset=\"/static/f2825b41a05d0a6153a288806aee1ac1/e9ff0/result.png 180w,\n/static/f2825b41a05d0a6153a288806aee1ac1/f21e7/result.png 360w,\n/static/f2825b41a05d0a6153a288806aee1ac1/37523/result.png 720w,\n/static/f2825b41a05d0a6153a288806aee1ac1/302a4/result.png 1080w,\n/static/f2825b41a05d0a6153a288806aee1ac1/07a9c/result.png 1440w,\n/static/f2825b41a05d0a6153a288806aee1ac1/38116/result.png 2086w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>1분간 초당 <code class=\"language-text\">20*n</code>명의 가상 유저가 요청을 연달아 2개씩 보내도 실패하지 않는 최종 테스트 결과다.</p>\n <br>\n<h2 id=\"-짧은-회고\" style=\"position:relative;\"><a href=\"#-%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\" aria-label=\" 짧은 회고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>💬 짧은 회고</h2>\n<p>글은 깔끔하게 썼지만 사실 많은 고비가 있었다.\n해당 작업에 2~3일이 걸릴 것이라 예상했는데, 실제로는 5~6일 정도를 소요했다.\n인프라 설정부터 쉽지 않았고, chat gpt와 함께 짠 테스트 스크립트는 돌아가지 않아 삽질을 반복했고,\n(결과적으로 chat gpt가 계속 없는 설정을 쓸 수 있다고 잘못 알려준 문제였다😡 공식 문서 링크를 달라고 하니 not found가 뜨는 링크만 계속 줬다!!!),\n원인 파악부터 리팩터링 후 다시 부하테스트, 스테이지 테스트, 이후 배포까지 생각보다 많은 일을 해야했다.</p>\n<p>돌이켜보았을 때, 앞으로 낯선 문제를 해결할 때 접근 방식을 개선해야겠다는 생각이 든다.\n글에서는 단순히 ‘목 서버에서 요청 응답을 하지 못해서 사양을 높였다’라고 나와있지만, 사실 그 때 나는 멘붕 상태였다.\n신규 서버가 문제인가? 왜 커넥션 풀 문제도 아닌데 응답이 안 오지? 인스턴스 CPU 상태도 괜찮은데? 하고 허둥대면서 팀원한테 도움을 요청했다.\n로깅을 본 팀원이 <code class=\"language-text\">분할 정복</code> 처럼 문제를 작은 단위로 나눠 보라고 했다.\n먼저 목 서버만 떼어서 문제를 해결해보고, 안되면 다른 방법을 찾아보라며, 자기가 볼 때는 사양이 너무 낮다는 힌트도 줬다.</p>\n<p>예상치 못한 문제, 또는 잘 모르는 영역의 문제에 부딪히면 늘 분할 정복을 잊게 된다.\n익숙한 스프링에서 문제를 만났다면 디버깅을 찍고, 예외 스택을 따라가며 해결했을 것 같은데, 익숙하지 않은 영역으로 오니 생각이 실타래처럼 엉켰다.\n지금 해결법도 결과적으로 목표한 tps를 달성하긴 했지만, 편하고 자신있는 방식으로 편향해 해결했다는 생각이 든다.\n인스턴스 모니터링을 분석하거나, 톰캣의 스레디풀 등을 조사하기 보다 알고 있는 문제에 먼저 덤볐다.\n이게 ‘진짜 문제’가 맞기를 빌면서…\n어쩌면 다른 문제 또한 있었고 함께 해결했다면 tps를 더 개선할 수 있었을 것 같다.\n문제 단위를 충분히 잘게 쪼개는 동시에, 컴포트존 너머의 영역에도 도전하기를 의식적으로 수행해야겠다.</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\">🏗 인프라 구조</a></p>\n<ul>\n<li><a href=\"#%EA%B8%B0%EC%A1%B4-%ED%94%84%EB%A1%9C%EB%8D%95%EC%85%98-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\">기존 프로덕션 인프라 구조</a></li>\n<li><a href=\"#%EC%8B%A0%EA%B7%9C-%EC%84%9C%EB%B2%84-%EB%8F%84%EC%9E%85-%ED%9B%84-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\">신규 서버 도입 후 인프라 구조</a></li>\n<li><a href=\"#%EB%B6%80%ED%95%98%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%9D%B8%ED%94%84%EB%9D%BC\">부하테스트 인프라</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-%EC%A7%9C%EA%B8%B0\">📝 테스트 시나리오 짜기</a></p>\n<ul>\n<li><a href=\"#%EB%AA%A9%ED%91%9C-%ED%8A%B8%EB%9E%98%ED%94%BD-%EC%B2%98%EB%A6%AC%EB%9F%89-%EC%84%A4%EC%A0%95\">목표 트래픽 처리량 설정</a></li>\n<li><a href=\"#%EC%9C%A0%EC%A0%80-%ED%96%89%EB%8F%99-%EC%84%A4%EC%A0%95\">유저 행동 설정</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%ED%85%8C%EC%8A%A4%ED%8C%85-%ED%88%B4-%EC%84%A0%EC%A0%95\">🧪 테스팅 툴 선정</a></p>\n<ul>\n<li><a href=\"#hey\">hey</a></li>\n<li><a href=\"#k6-%ED%95%98%EB%A0%A4%EB%8B%A4-%EB%AA%BB-%ED%95%A8\">k6 하려다 못 함</a></li>\n<li><a href=\"#%EF%B8%8F-artillery\">⭐️ artillery</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EF%B8%8F-yaml%EB%A1%9C-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-%EC%9E%91%EC%84%B1\">✍️ yaml로 시나리오 작성</a></p>\n</li>\n<li>\n<p><a href=\"#-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\">🛠 문제 해결하기</a></p>\n<ul>\n<li><a href=\"#%EC%98%88%EC%83%81%EC%B9%98-%EB%AA%BB%ED%95%9C-%EC%82%BD%EC%A7%88\">예상치 못한 삽질</a></li>\n<li><a href=\"#%EA%B7%B8%EB%9E%98%EB%8F%84-%EC%98%88%EC%83%81-%EB%B2%94%EC%9C%84%EC%98%80%EB%8D%98-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\">그래도 예상 범위였던 문제 해결하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\">💬 짧은 회고</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"March 12, 2023","title":"서버 오픈 전 부하테스트로 대비하기","categories":"트러블슈팅","author":"써머","emoji":"headers/load_test.png"},"fields":{"slug":"/load-test/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://hyewoncc.github.io","comments":{"utterances":{"repo":"hyewoncc/hyewoncc.github.io"}}}}},"pageContext":{"slug":"/fetch-join-and-entity-graph/","nextSlug":"/load-test/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437","3350743975"],"slicesMap":{}}