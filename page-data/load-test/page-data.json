{"componentChunkName":"component---src-templates-blog-template-js","path":"/load-test/","result":{"data":{"cur":{"id":"5a639548-89a6-57f0-87d9-f42c81b3037b","html":"<p>💡 해당 글은 사내에 작성한 문서를 허가 하에 개인 포스팅용으로 적절히 수정한 글입니다.</p>\n<p>디어에 입사하고 처음 맡은 일은 개발 중이던 신규 인터널 API 서버 개발을 마무리하고 프로덕션 환경에 올리는 것이었다.\n전체 사이클에서 내 생각에 한 80% 지점에 참여하게 되었다.\n현재 신규 서버는 프로덕션 환경에 올라간 채로 ‘회사 사람들이 디어 앱을 통해 하는 요청’ 이라는 티끌의 트래픽만 받고 있는데, 다음 2주 간의 스프린트에 전체 트래픽을 100% 전환하는 게 목표다.\n그래서 이번 스프린트 중에 이 서버의 성능을 테스트하고, 운영 환경에 적절한 인프라 설정값을 찾는 과제를 수행했다.</p>\n<br>\n<h2 id=\"-인프라-구조\" style=\"position:relative;\"><a href=\"#-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\" aria-label=\" 인프라 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🏗 인프라 구조</h2>\n<p>모든 인프라 구조도는 극히 단순화하여 그렸다.</p>\n<h3 id=\"기존-프로덕션-인프라-구조\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%EC%A1%B4-%ED%94%84%EB%A1%9C%EB%8D%95%EC%85%98-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\" aria-label=\"기존 프로덕션 인프라 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기존 프로덕션 인프라 구조</h3>\n<p>신규 인터널 서버는 기존 디어 서버에서 외부 API 연동이 잦은 특정 도메인을 분리한 서버다.\n기존에는 디어 앱에서 특정 요청이 들어오면, 디어 서버를 거쳐, 경우에 따라 또 다른 인터널 서버를 경유해 로직을 수행했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVR42m2RbU/CMBSF+f9/y8TElw9GAwEFh8BYu7UV5tbRjvYx28CIeJOTe5rcPDm3d0SMRCB2PYbO0R6PWGuxB0/tAtYFatdi/ZHq0OLacJqPhDB4ToxRHBy/q6w9ydawVJ7EwPNqy93igZvxLffJE4n8xBiDlLLvF8BzwuAUtR4TbIrceRJZkamSd1Ez3uyYCsUkzZlkmrW2GKN7oNa6T3kNbDKq/BG3n7MpKuZrRZZrZivNy0fJXLa8Cc9r1pKIL/JckqYpRVFcAv9bWdeRWR5ZqEHTbcNMHHpNM8dSVihVIIRAKfUnIXHgnT65ezc+sLeBsjkr/vh90x0pEkMghOujfAOJ9c41jQ0l0gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"production infra\"\n        title=\"\"\n        src=\"/static/5116c05fea8ebd0083f6ee7ce8a65f5d/37523/infra_production.png\"\n        srcset=\"/static/5116c05fea8ebd0083f6ee7ce8a65f5d/e9ff0/infra_production.png 180w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/f21e7/infra_production.png 360w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/37523/infra_production.png 720w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/302a4/infra_production.png 1080w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/07a9c/infra_production.png 1440w,\n/static/5116c05fea8ebd0083f6ee7ce8a65f5d/9f9a4/infra_production.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>신규 인터널 서버를 분리하면서 구조도 변했다.</p>\n <br>\n<h3 id=\"신규-서버-도입-후-인프라-구조\" style=\"position:relative;\"><a href=\"#%EC%8B%A0%EA%B7%9C-%EC%84%9C%EB%B2%84-%EB%8F%84%EC%9E%85-%ED%9B%84-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\" aria-label=\"신규 서버 도입 후 인프라 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>신규 서버 도입 후 인프라 구조</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA+klEQVR42mWR2W6DMBRE8/9/1oc+NFWrBgQhDS0Bgw1Z7NhgnworW5UrjWYsWUd37EUIgXlmD8HPiWnyGGM4W4exHmOnm7SdcFO43L/rylhcw+Mczch2p/huLbmETQ/FAJsB1gry3QnZddR1jZSScRzvwBvd9dghxesf2r2laAy10hSNZpX1JIkgSVpW64GsOqCUQggRgc65Z6A/N+x3L2j5yW97IN22VLUgLTuWbyXL15z3WR8VX1tJKwRlWUbovw0vicfSvQ6kIpC1kHewlhcpyDrIqmOs3DTNc+UIi7Tr4waM86jTRK991JzjObrncPaxprU2+uOn/AEd2s7io4pLGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"new production infra\"\n        title=\"\"\n        src=\"/static/8878210584397d26c1e40f1afa5bb478/37523/infra_new_production.png\"\n        srcset=\"/static/8878210584397d26c1e40f1afa5bb478/e9ff0/infra_new_production.png 180w,\n/static/8878210584397d26c1e40f1afa5bb478/f21e7/infra_new_production.png 360w,\n/static/8878210584397d26c1e40f1afa5bb478/37523/infra_new_production.png 720w,\n/static/8878210584397d26c1e40f1afa5bb478/302a4/infra_new_production.png 1080w,\n/static/8878210584397d26c1e40f1afa5bb478/07a9c/infra_new_production.png 1440w,\n/static/8878210584397d26c1e40f1afa5bb478/9f9a4/infra_new_production.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>앞으로 해당 도메인과 관련된 모든 요청은 신규 서버를 경유한다.\n신규 서버가 분리되면서 요청을 처리할 외부 서버를 간편하게 추가할 수 있게 되었다.\n실제로 이번에 D사 서버 연동을 추가해야 했는데, 첫 삽을 뜨기부터 스테이지 테스트를 완료하기 까지 단 이틀이 걸렸다.</p>\n<p>신규 서버를 도입하면서 목표는 ‘사용자 관점에서 아무 변화도 없어야 한다’ 였다.\n현재 디어 서버에서 이뤄지는 해당 도메인의 트래픽, 나아가서 회사가 올해 목표하는 트래픽 양을 문제없이 처리할 수 있어야 했다.\n이를 위해 부하테스트를 진행했다.</p>\n<br>\n<h3 id=\"부하테스트-인프라\" style=\"position:relative;\"><a href=\"#%EB%B6%80%ED%95%98%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%9D%B8%ED%94%84%EB%9D%BC\" aria-label=\"부하테스트 인프라 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>부하테스트 인프라</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA2klEQVR42o2RbWvCMBRG/f9/bTBw062d1lrtzEpdxL4kaUlzRtpFnfhhDzycfLgcuLkz5xw+gT7D4NBao5Sh0ZZG3VXbcT4Uz0nC7FYWaDrLVpxJS0N6glQycnuamB0HBq4JMs9ZkPR9T1VVtE1FrR0HUSA+nsizFXEiWb7sWcx3vEcF668OLfeofI46vEJ3HmXe9UdY1zVtU/8KBeXmmc/dmiiRxEtB5BuXrIRByxwjFnTFG+5W+GhlZSzJERIJG3ldOTT7/sfK0wdPA9YOtNpe2jx4X45xd5QfE1HQs9dDM70AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"test infra\"\n        title=\"\"\n        src=\"/static/1d71ef9c09a0917fca8e178b059b4318/37523/infra_test.png\"\n        srcset=\"/static/1d71ef9c09a0917fca8e178b059b4318/e9ff0/infra_test.png 180w,\n/static/1d71ef9c09a0917fca8e178b059b4318/f21e7/infra_test.png 360w,\n/static/1d71ef9c09a0917fca8e178b059b4318/37523/infra_test.png 720w,\n/static/1d71ef9c09a0917fca8e178b059b4318/302a4/infra_test.png 1080w,\n/static/1d71ef9c09a0917fca8e178b059b4318/07a9c/infra_test.png 1440w,\n/static/1d71ef9c09a0917fca8e178b059b4318/9f9a4/infra_test.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>앞선 구조도에서 볼 수 있듯이, 신규 서버는 디어 서버를 유일한 클라이언트로 가진다.\n즉, 외부에서 요청을 받을 일이 없다.\n따라서 실제와 비슷하며 프로덕션 보안정책을 준수하는 테스틀 위해 VPC 내에서 요청을 보낼 목 클라이언트가 필요하다.\n또한, 외부 서버와 통신을 해야하며, 이 요청의 응답 속도나 상태가 제어 밖이라는 점도 특징이다.\n그래서 외부 목 서버도 필요했다.\n더 정확한 테스트를 위해서라면 디어 앱을 모킹한 곳에서 요청을 보내야겠지만, 테스트의 주 목적을 생각해 내부 클라이언트(디어 서버)까지만 모킹하고 여기서 요청을 보냈다.</p>\n<p>외부 목 서버는 스프링으로 만들었다.\n며칠 간 쌓인 신규 서버 로그 데이터를 통해 외부 서버의 API 응답 속도를 대략 알 수 있었다.\n이 중 평균 소요시간이 제일 긴 서버의 경우 약 2초의 시간이 걸릴 때가 많았다.\n따라서 목 서버는 간단하게 스레드를 2초간 정지하고 응답하도록 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MockController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MockApiResponse</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MockApiRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2_000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MockApiResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<h2 id=\"-테스트-시나리오-짜기\" style=\"position:relative;\"><a href=\"#-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-%EC%A7%9C%EA%B8%B0\" aria-label=\" 테스트 시나리오 짜기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📝 테스트 시나리오 짜기</h2>\n<h3 id=\"목표-트래픽-처리량-설정\" style=\"position:relative;\"><a href=\"#%EB%AA%A9%ED%91%9C-%ED%8A%B8%EB%9E%98%ED%94%BD-%EC%B2%98%EB%A6%AC%EB%9F%89-%EC%84%A4%EC%A0%95\" aria-label=\"목표 트래픽 처리량 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>목표 트래픽 처리량 설정</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAADF0lEQVR42i3DW0+TBwCA4e9iP2BLtmTOaYbuaiRbsoM6HNmWRbrEyBRFMoQakylWwLFUoAUp1cIntRRpgR7WFuuggBRYZXKyXw/0QOkJaFMQEHUs283+xLubPckjWMbc9HvnMC6E6Akl6PZH0QcSGEKrGEJJzJE84+nXWJc30fhWkDYK+Ap/M5HbZyL1klB2l5X8SxK5V0SyOwhWtw2D4zf03qeIoQRd/gg9oRX0gTim6BqWwDo/ixbk9WouVlxAXlWJzvkYX+EfltI7SNltwhu7RNZ3CWa3EQY8w2j9cbqXlhH9MXT+KGIwTm84jTWc5/y1ZkplFXxReorDHxZz8vhXVNdc5llmh2DmOVJmCyn9/8xzhMFRJ3elVboXw3Q9i6BdimIIprDHNrGFcpSeruTQ4SN8+/kxDA0NzPXruN9QhWchyO+5fWYye4wndhiNbzMcySE8mhjh1+QejlgeZ3wT18oW7uQ2o6kXTKb2MOs0nCv7Dm2NHE+bGmlQ5I68jAGTnsdb/zK29iee9X3GNv5iZO01wuxShOnkC6ayr9AHtqjyJKkZX6V6MsNgIINpyEGzRuRG+WncLUr6FHLUl04xoJIzO/8H01IU86MZel3TGJxTCJqZFBcexqn1JJE5Y5TY45TYV1B4Eww8eYpueJJmZTtnTn7KpW9OoDjxGfdqZYg/ybjfpcI66sZktdDX78JoeogwEshhXtxgcGEdh1RAbZtC5ZjAlc7TYbVhHPJSV1tPpew4SlUjHrsVY8s1rLfl2M06up0uer2TuGf9+JYSCPq5LA7/Om5pjau+Aop2DQaFjAd3NHSW/0jXD5dp+riE1k+KMZaXY7hynXtnz+E4U4al5iztoo5Om43hYBQpvY1QbpBotC+jGY3zRt0iVxRNDF08gqr4I3rePEjH2+9z870i9G8dYOhQEfoPjtLzzkH07xah/fIYrZpWboh9TIezPInlEb5Xz9PQF0Y7vIrwtZuK2/MYHT6qazrpaHnArbq7NJ6/Tl3DLzTrRbTKJtS3lNRru7mpaaNN2YTZMs1Ai4hL3ct/hmpVrGW+WnQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"진짜같다짤\"\n        title=\"\"\n        src=\"/static/a182ce258762ffea712f6b392fd19d65/37523/realistic.png\"\n        srcset=\"/static/a182ce258762ffea712f6b392fd19d65/e9ff0/realistic.png 180w,\n/static/a182ce258762ffea712f6b392fd19d65/f21e7/realistic.png 360w,\n/static/a182ce258762ffea712f6b392fd19d65/37523/realistic.png 720w,\n/static/a182ce258762ffea712f6b392fd19d65/302a4/realistic.png 1080w,\n/static/a182ce258762ffea712f6b392fd19d65/07a9c/realistic.png 1440w,\n/static/a182ce258762ffea712f6b392fd19d65/14747/realistic.png 1914w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>시나리오 작성의 목표는 ‘최대한 현실과 비슷하게’였다.\n먼저 신규 서버가 감당해야 할 최소 트래픽을 계산했는데, 해상도를 제일 높여 잰다면 ‘디어를 운영한 모든 기간 중에 트래픽이 제일 많았던 시간의 순간 트래픽량’이 필요하다.\n하지만 몇 년 간의 데이터를 분석하기보다, 현실적으로 서비스가 계속 성장해왔음을 감안해 범위를 2022년도의 데이터로 한정하고, 다음과 같은 과정으로 간략히 구했다.</p>\n<ol>\n<li>2022년도의 365일 중, 해당 요청이 가장 많았던 날짜를 구한다.</li>\n<li>해당 날짜의 기록을 분당 group by 하여, 제일 트래팩이 많았던 시간의 요청 수를 구한다.</li>\n</ol>\n<p>데이터 전문가가 보면 킹받을지도 모른다는 걱정이 잠깐 들지만 나름 합리적인 계산이었다.\n2022년도의 x월 x일에 가장 많은 요청이 있었고, 특정 시간대에 요청이 제일 많았다.\n분당 최대 요청수를 초단위로 단순화해보면 신규 서버는 최소 <code class=\"language-text\">n tps</code>를 처리할 수 있어야 했다.\n다만 이번년도에 내가 속한 디어서비스팀은 모든 걸 10x로 목표하고 있다.\n따라서 신규 서버도 최소 <code class=\"language-text\">10*n tps</code>를 지원하는 것을 목표한다.</p>\n<br>\n<h3 id=\"유저-행동-설정\" style=\"position:relative;\"><a href=\"#%EC%9C%A0%EC%A0%80-%ED%96%89%EB%8F%99-%EC%84%A4%EC%A0%95\" aria-label=\"유저 행동 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>유저 행동 설정</h3>\n<p>디어에서 해당 도메인을 경유지로 이뤄지는 요청은 세 가지가 있다. 1.단순 요청  2.별도 요청  3.자동 요청<br>\n뭔가 최대한 정보를 마스킹하려다 보니 요상해지는데 꿋꿋하게 설명하겠다.\n3번 요청은 항상 1과 함께 이뤄지되, 3이 선행될 경우 1에서 외부 서버 요청이 일어나지 않는다는 특성이 있다.\n좋은 테스트를 위해 각 요청이 어떤 비율로 일어나는지 알아야 한다.\n만약 1번 요청과 2번 요청이 1:1 비율로 발생하는데, 1번 요청만 테스트 시나리오에 사용한다면 현실과 큰 괴리가 생기기 떄문이다.</p>\n<p>2022년도에 1번 유형 요쳥은 약 x건이 일어났다.\n2번 요청은 x건의 0.5% 정도가, 3번 요청은 0.6% 정도 발생했다.\n초당 요청량을 생각했을 때 이정도 비율은 큰 의미가 없을 것 같아 1번 요청을 단일한 시나리오로 작성하려 했다.\n다만 이미 테스트 DB에 3번-1번 요청을 연달하 하도록 설정된 유저 데이터가 있길래, 추후 테스트 대상 유저 데이터를 선정할 때 해당 비율로 섞고, 2번 요청은 제외했다.</p>\n<br>\n<h2 id=\"-테스팅-툴-선정\" style=\"position:relative;\"><a href=\"#-%ED%85%8C%EC%8A%A4%ED%8C%85-%ED%88%B4-%EC%84%A0%EC%A0%95\" aria-label=\" 테스팅 툴 선정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🧪 테스팅 툴 선정</h2>\n<p>테스팅 툴은 1.빠르게 실행가능 할 것  2.이용이 간단할 것을 중점으로 선정했다.\n2주간의 스프린트 계획을 짤 때 부하테스트에 약 2~3일을 배정했고, 목표 tps를 테스트 할 때 너무 상세하거나 복잡한 기능을 필요하지 않다고 생각했다.\n그래서 별도의 서버를 필요로 하는 툴은 제외하고, 코드나 설정 파일로 간단히 실행 가능한 <a href=\"https://github.com/rakyll/hey\">hey</a>, <a href=\"https://www.artillery.io/\">artillery</a>, <a href=\"https://k6.io/\">k6</a>를 후보로 골랐다.</p>\n<h3 id=\"hey\" style=\"position:relative;\"><a href=\"#hey\" aria-label=\"hey permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>hey</h3>\n<p>hey는 다음과 같이 커맨드라인에서 간단히 요청을 보낼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">hey <span class=\"token parameter variable\">-z</span> 10s <span class=\"token parameter variable\">-m</span> GET http://new-server.stage.com/actuator/health</code></pre></div>\n<br>\n<p>해당 명령어는 10초간 신규 서버의 헬스체크 주소로 요청을 보낸다.\n문서를 보면 요청 수, 초당 동시 실행할 worker의 수, 지속 시간, 헤더 등등을 설정할 수 있다.\ncurl 명령어와 비슷하다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.222222222222214%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA1klEQVR42n2R2wqDMBBENZJEo/F+V1Cw//+LU2aLUKn2YXAxm7OzkyAIAoRhiKqqEEURiqJAlmXg/2+dZ23bIk3Tn/MvfYqu6+CcwzRNcukcRJ3AYRiwbRvKsvwP5CVOjeMYWuvbRqUU6rrGsiy3G/w4ZCMdrOsqolNqnmf0fS+DCKQ7bpDnuUSgtYGNEygVXoGEUUmSwForMsbIlzA65ABC9n2X+nUcaPoRw7LBWnMFjuMoD/O0CoFN08B7L3kzItapc8i9l4wvQK7BhifgmTPFx3vK8A0VuZiu0j3AQwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"hey test\"\n        title=\"\"\n        src=\"/static/b5e7cdd93701ce85fc23475f803e5084/37523/hey.png\"\n        srcset=\"/static/b5e7cdd93701ce85fc23475f803e5084/e9ff0/hey.png 180w,\n/static/b5e7cdd93701ce85fc23475f803e5084/f21e7/hey.png 360w,\n/static/b5e7cdd93701ce85fc23475f803e5084/37523/hey.png 720w,\n/static/b5e7cdd93701ce85fc23475f803e5084/302a4/hey.png 1080w,\n/static/b5e7cdd93701ce85fc23475f803e5084/07a9c/hey.png 1440w,\n/static/b5e7cdd93701ce85fc23475f803e5084/2adcb/hey.png 1984w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>테스트 결과를 이런 형태로 출력해 보여준다.</p>\n<p>사용법은 제일 간단했지만, 일련의 요청 흐름을 실행할 수 없었다.\n1,2,3번 유형에 관계없이 모든 요청의 흐름은 디어 서버에서 신규 서버로 1. POST 요청을 보낸다  2. GET 요청으로 이전 요청의 결과값을 조회한다  두 가지 요청이 항상 묶음으로 보내졌기에, hey로는 원하는 시나리오 테스트를 할 수 없었다.</p>\n<br>\n<h3 id=\"k6-하려다-못-함\" style=\"position:relative;\"><a href=\"#k6-%ED%95%98%EB%A0%A4%EB%8B%A4-%EB%AA%BB-%ED%95%A8\" aria-label=\"k6 하려다 못 함 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>k6 하려다 못 함</h3>\n<p>두번째로 k6는 자바스크립트로 테스트를 작성할 수 있다는 점이 매력적이었다. 그런데 설치에 문제가 있었다.\n처음 목 클라이언트와 목 서버 인스턴스를 제일 저렴한 <code class=\"language-text\">t2.micro</code>로 생성했다.\n사실 현실과 가까운 테스틑가 목적이라면 실제 클라이언트인 디어 서버와 비슷한 스펙으로 설정해야 했다.\n하지만 당시에는 거기까지 생각하지 못했고, 후에 문제를 만나 바꾸게 된다.\n어쨌든 <code class=\"language-text\">t2.micro</code> 인스턴스는 스펙이 부족해 k6를 설치할 수 없었다… 그래서 우선 artillery로 넘어갔다.</p>\n<br>\n<h3 id=\"️-artillery\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-artillery\" aria-label=\"️ artillery permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⭐️ artillery</h3>\n<p>마지막으로 artillery는 node.js로 만들어진 툴이다.\nhey처럼 커맨드라인으로 간단한 테스트가 가능한 동시에, <code class=\"language-text\">json</code>, <code class=\"language-text\">yaml</code>로 자세한 시나리오 테스트를 작성할 수 있어 선택했다.\n테스팅 결과 역시 <code class=\"language-text\">json</code>과 <code class=\"language-text\">html</code> 파일로 출력 가능하다.\n<a href=\"https://blog.outsider.ne.kr/1238\">Artillery를 이용한 스트레스 테스트 - Outsider’s dev story</a> 해당 블로그 포스팅에서 많은 도움을 받았다.</p>\n<br>\n<h2 id=\"️-yaml로-시나리오-작성\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-yaml%EB%A1%9C-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-%EC%9E%91%EC%84%B1\" aria-label=\"️ yaml로 시나리오 작성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ yaml로 시나리오 작성</h2>\n<p>테스트 대상 신규 서버의 엔드포인트는 총 두 개다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">POST http://new-server.stage.com/deers\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"userId\"</span><span class=\"token builtin class-name\">:</span> 유저 아이디,\n  <span class=\"token string\">\"deerId\"</span><span class=\"token builtin class-name\">:</span> 생성할 엔티티와 관련된 아이디, \n  <span class=\"token string\">\"data\"</span><span class=\"token builtin class-name\">:</span> 특정값  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">GET http://new-server.stage.com/deers?userId<span class=\"token operator\">=</span>:userId<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">deerId</span><span class=\"token operator\">=</span>:deerId</code></pre></div>\n<br>\n<p>그런데 문제가 있다. 로직 상 한 번 POST 요청이 성공하면 동일한 <code class=\"language-text\">deerId</code>로 다시 요청할 수 없다.\n따라서 <code class=\"language-text\">deerId</code>가 요청마다 다르지 않으면 테스트가 불가능하다.\nartillery는 <a href=\"https://www.artillery.io/docs/guides/plugins/plugin-fuzzer\">매 요청마다 랜덤한 문자열을 생성하는 플러그인</a>을 지원하지만, 숫자는 찾지 못했다.\n대신 <code class=\"language-text\">csv</code> 파일에서 랜덤한 값을 요청마다 지정하는 기능이 있었다.</p>\n<p>그래서 자바스크립트로 간단히 1000부터 100000까지 숫자가 적힌 <code class=\"language-text\">numbers.csv</code> 파일을 아래와 같이 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"csv\"><pre class=\"language-csv\"><code class=\"language-csv\"><span class=\"token value\">1000</span>\n<span class=\"token value\">1001</span>\n<span class=\"token value\">...</span>\n<span class=\"token value\">99999</span>\n<span class=\"token value\">100000</span></code></pre></div>\n <br>\n<p>또, 디어 앱에서부터 유저 흐름을 생각하면, 한 유저는 대게 단일한 요청을 보낸다.\n짧은 시간 내 여러 요청을 보내는 경우는 외부 API 연동이 실패해 재요청하는 경우 뿐이다.\n궁금해서 외부 API 처리 실패율을 단순하게 ‘실패한 횟수 % 전체 횟수’로 계산했는데, 실패율이 가장 높은 외부 서버 기준으로 약 <code class=\"language-text\">0.2%</code>에 불과했다.\n적은 비율이라 테스트에서 한 유저는 한 번만 요청을 보낸다 가정했다.\n만약 요청 특성 상 특정 시간에 한 유저가 여러 요청을 보낼 수 있었다면, 유저가 평균 몇 번 요청을 보내는지 조사하고 반영해야 했을 것이다.</p>\n<p>테스트 DB에 존재하는 유저 데이터 id 목록을 조회해 마찬가지로 <code class=\"language-text\">users.csv</code>라는 파일로 만들고 시나리오를 <code class=\"language-text\">yaml</code>로 작성했다.\nartillery 공식 문서가 친절해서 조건을 하나씩 추가하며 작성하기 수월했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://new-server.stage.com\"</span>\n  <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token key atrule\">phases</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">duration</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n      <span class=\"token key atrule\">arrivalRate</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n  <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">expect</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">payload</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span>\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"users.csv\"</span>\n      <span class=\"token key atrule\">fields</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"userId\"</span>\n    <span class=\"token punctuation\">-</span>\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"numbers.csv\"</span>\n      <span class=\"token key atrule\">fields</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"deerId\"</span>\n\n<span class=\"token key atrule\">scenarios</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"specific scenario\"</span>\n    <span class=\"token key atrule\">flow</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">post</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/deers\"</span>\n          <span class=\"token key atrule\">json</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">userId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ userId }}\"</span>\n            <span class=\"token key atrule\">deerId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ deerId }}\"</span>\n            <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span>\n          <span class=\"token key atrule\">headers</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">Content-Type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span>\n            <span class=\"token key atrule\">capture</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">json</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"code\"</span>\n              <span class=\"token key atrule\">as</span><span class=\"token punctuation\">:</span> code\n          <span class=\"token key atrule\">expect</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">statusCode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">equals</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"{{ code }}\"</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"success\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">get</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/deers?deerId={{ deerId }}&amp;userId={{ userId }}\"</span>\n          <span class=\"token key atrule\">capture</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">json</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"code\"</span>\n              <span class=\"token key atrule\">as</span><span class=\"token punctuation\">:</span> code\n          <span class=\"token key atrule\">expect</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">statusCode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">equals</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"{{ code }}\"</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"success\"</span></code></pre></div>\n<br>\n<p>설정을 간략히 설명하자면, 신규 서버(target)로 60초간(duration) 초당 5명의 요청(arrivalRate)을 보낸다.\n응답이 10초간 오지 않을 시 요청이 실패(timeout)한 것으로 취급한다.</p>\n<p>해당 스크립트를 실행하면 POST, GET 요청이 각각 연달아 나간다.\n또한 요청마다 <code class=\"language-text\">csv</code> 파일에서 랜덤 지정된 <code class=\"language-text\">userId</code>와 <code class=\"language-text\">deerId</code>값이 각각 json 바디, url에 지정된다.\n<code class=\"language-text\">expect</code> 플러그인으로 응답 코드와 응답 바디값에 간단한 검증도 붙였다.\n실행 시 옵션을 주면 결과를 json 파일로 생성할 수 있고, 이를 보기 편한 html로 변환할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">npx artillery run <span class=\"token parameter variable\">--output</span> report.json script.yaml</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">artillery report ./report.json</code></pre></div>\n<br>\n<h2 id=\"-문제-해결하기\" style=\"position:relative;\"><a href=\"#-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\" aria-label=\" 문제 해결하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🛠 문제 해결하기</h2>\n<h3 id=\"예상치-못한-삽질\" style=\"position:relative;\"><a href=\"#%EC%98%88%EC%83%81%EC%B9%98-%EB%AA%BB%ED%95%9C-%EC%82%BD%EC%A7%88\" aria-label=\"예상치 못한 삽질 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>예상치 못한 삽질</h3>\n<p>그렇게 가벼운 마음으로 테스트의 테스트를 실행했는데 당황스런 결과가 나왔다.\n초당 요청 수가 5에 불과했는데 요청 하나를 빼고 다 실패했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXUlEQVR42pWOQQoAIQwD/UmtImpR0P8/LksK7lkPA01o0oYxBkjvHbVWtNau4b6ZeZ4zCTT23i5ijFDVa7ifc0Yp5c+GOSfWWm68IiJIKXkpZ3r+IUvPxVdYSI7+ABxEcQjH9+mAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"timeout\"\n        title=\"\"\n        src=\"/static/910c4729e696d952ae6907b8e7b637c8/37523/micro_test.png\"\n        srcset=\"/static/910c4729e696d952ae6907b8e7b637c8/e9ff0/micro_test.png 180w,\n/static/910c4729e696d952ae6907b8e7b637c8/f21e7/micro_test.png 360w,\n/static/910c4729e696d952ae6907b8e7b637c8/37523/micro_test.png 720w,\n/static/910c4729e696d952ae6907b8e7b637c8/302a4/micro_test.png 1080w,\n/static/910c4729e696d952ae6907b8e7b637c8/07a9c/micro_test.png 1440w,\n/static/910c4729e696d952ae6907b8e7b637c8/eff3b/micro_test.png 2072w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이유가 짐작하지 않아 요청 수를 계속 낮추면서 실행했는데, 결과적으로 <code class=\"language-text\">2tps</code>일 경우에만 안정적으로 처리됐다.\n너무나 예상 밖의 결과라 당황했다.\n결국 팀원의 도움을 받아 로깅을 보고 원인을 찾았는데, 목 서버에서 응답을 주지 못하고 있었다.\n앞에서 언급한 ‘모킹 인스턴스를 <code class=\"language-text\">t2.micro</code>로 설정해 생긴 문제’였다.\n목 서버의 인스턴스를 더 좋은 사양으로 업그레이드 하니 테스트가 정상적으로 수행되었다.</p>\n<p>테스트를 할 때 프로덕션과 최대한 비슷한 인프라 환경을 구축하는 것이 좋다고 생각하면서도, 이런 식으로 문제가 바로 생길 줄 몰랐다.\n그래서 목 클라이언트 인스턴스도 더 나은 사양으로 함께 변경했다.\n다만, 프로덕션 환경과 완전히 동일한 사양으로 올리는 것은 여전히 낭비라고 생각해 적당히 올렸다.</p>\n<br>\n<h3 id=\"그래도-예상-범위였던-문제-해결하기\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9E%98%EB%8F%84-%EC%98%88%EC%83%81-%EB%B2%94%EC%9C%84%EC%98%80%EB%8D%98-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\" aria-label=\"그래도 예상 범위였던 문제 해결하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그래도 예상 범위였던 문제 해결하기</h3>\n<p>그리고 테스트를 다시 시작했는데, 또다시 한자릿수 tps에 막혔다.\n아까와 달리 목 서버와 클라이언트에는 문제가 없었다.\n한자릿수의 요청을 1분간 보냈을 때, 약 10초 후 부터 DB 커넥션 풀이 고갈되는 현상이 발생했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAwklEQVR42i2PzYrDMBCD8/4PVtjzQs9LS+rfsTO2x2kCiRZPchDS2CD0TcdxYGGGdREpGcyvH1B8w3qCsQ4xZTgfESLB+QDjPJoIpPfb1zt3bNuO6TxP/UiZUUoEhSeYPSgzKGVwqcgLY+GClBdV76tKpKOvV9bCfcc0FpZa4QMhZw9nfnWpCwTrvBaMdZESwq1SG2oTlFLVa2369v1uV+FY8LEBRB+8/x4I4aX3bIyWDcyBPXw29kKVjtYudM0iivwPn4UwbxtjlgcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"connection timeout\"\n        title=\"\"\n        src=\"/static/7adff8ce79b62be9015efbeeca75f61e/37523/connection_timeout.png\"\n        srcset=\"/static/7adff8ce79b62be9015efbeeca75f61e/e9ff0/connection_timeout.png 180w,\n/static/7adff8ce79b62be9015efbeeca75f61e/f21e7/connection_timeout.png 360w,\n/static/7adff8ce79b62be9015efbeeca75f61e/37523/connection_timeout.png 720w,\n/static/7adff8ce79b62be9015efbeeca75f61e/302a4/connection_timeout.png 1080w,\n/static/7adff8ce79b62be9015efbeeca75f61e/07a9c/connection_timeout.png 1440w,\n/static/7adff8ce79b62be9015efbeeca75f61e/5b503/connection_timeout.png 1976w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  그래도 로그를 바로바로 확인할 수 있는 환경이라 원인 파악이 쉬웠다  \n</div>  \n<br>\n<br>\n<p>히카리 CP 설정은 모두 default 값이었기에, maximum pool size를 우선 default인 10에서 30으로 늘려보고 다시 실행했다.\n그러니 커넥션 고갈이 시작되는 시간을 미뤄졌지만 결국 특정 시간 이후에 고갈되는 현상은 그대로였다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIUlEQVR42o2Q2U7DMBBF8xdNaideEseTNFKohCioLCp9YRFLXwoFif//i4s8DSFIBfJwNZt85o4jIkLbtmiaBt57hPqgwswXg55neSJ4v+855xAZY5DnOay1CPlhKWhbIS2vYHTGdT/jWve9SCmFIK3171ISaT5HXL0gsw2kO4cslpDFAsKtoIxnaW0Q/QliGRglkeVHSOgJaXGKhDYQ5TWku0Rcv/GSsEyZcn/y/0DRATdIixMk9ABRrthpXG2R2RniescuozHuhL9hZ1N6ZGCIPbDeQjHwdQzQwqgEk9kHpLvoTl4goWeIct2dvGOHk/p9BNBYPndKd0iLY8hyjSyfMyx1Z+xW0C2UJQi6hzbuG/j1l8M4zK0d1Nz7+c528RNPJgD1bS+r7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pool-30\"\n        title=\"\"\n        src=\"/static/d3f34564ef856ca451951f5d8545c841/37523/pool-30.png\"\n        srcset=\"/static/d3f34564ef856ca451951f5d8545c841/e9ff0/pool-30.png 180w,\n/static/d3f34564ef856ca451951f5d8545c841/f21e7/pool-30.png 360w,\n/static/d3f34564ef856ca451951f5d8545c841/37523/pool-30.png 720w,\n/static/d3f34564ef856ca451951f5d8545c841/302a4/pool-30.png 1080w,\n/static/d3f34564ef856ca451951f5d8545c841/07a9c/pool-30.png 1440w,\n/static/d3f34564ef856ca451951f5d8545c841/8c48a/pool-30.png 2096w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  Hikari CP maximum pool size가 30, 인스턴스가 1개일 때   \n</div>  \n<br>\n<br>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAq0lEQVR42qWSzQrCMBCE8xRqk9hkg/kxQejVgyLYk1Xvff8HGUmrWAVBmsOwJLuZ7AfDUkpomga5hhCK5L0H01qDiJDrLJGBnrxns400gRSHcC2kPYCUGO4KDSvwcIVwZ1C9GA3n444bcn+BcCfUZgdFm3Jk7rsBeRV7KBPLkatwg7BHLGOP+mWYsX9pmoLPnoHREtK3WNs9xPYOZcJ/G35/8I5MPqvnzBibB5gd+3QKNNmaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pool-40\"\n        title=\"\"\n        src=\"/static/aa53a59e35db42d7b50567d2c1950edb/37523/pool40-instance2.png\"\n        srcset=\"/static/aa53a59e35db42d7b50567d2c1950edb/e9ff0/pool40-instance2.png 180w,\n/static/aa53a59e35db42d7b50567d2c1950edb/f21e7/pool40-instance2.png 360w,\n/static/aa53a59e35db42d7b50567d2c1950edb/37523/pool40-instance2.png 720w,\n/static/aa53a59e35db42d7b50567d2c1950edb/302a4/pool40-instance2.png 1080w,\n/static/aa53a59e35db42d7b50567d2c1950edb/07a9c/pool40-instance2.png 1440w,\n/static/aa53a59e35db42d7b50567d2c1950edb/87629/pool40-instance2.png 2076w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  Hikari CP maximum pool size가 40, 인스턴스가 2개일 때   \n</div> \n<br>\n<br>\n<p>우선 가장 빠른 해결법으로 DB 커넥션 수 늘리기가 있었다.\n신규 서버는 aws RDS를 사용했고, 바로 다음 사양으로 업그레이드하면 10배가 넘는 커넥션이 지원됐다.\n22년도와 동일한 패턴과 양의 트래픽이 들어온다면 일단 문제는 생기지 않는 해결법이다.</p>\n<p>다만 올해의 목표를 생각했을 때, 또 확장성을 고려했을 때 너무 불안한 해결법으로 느껴졌다.\n올해 여러가지 정책을 시도하게 될 것 같은데, 만약 해당 도메인의 요청이 늘어나는 이벤트라도 한다면 바로 문제가 된다.\n아직 오지 않을 일은 대게 영원히 오지 않는다고 하지만 그래도 최소 목표치인 <code class=\"language-text\">10*n tps</code>는 안정적으로 달성하고 싶었다.</p>\n<p>다른 하나는 신규 서버에서 DB 커넥션을 물고 있는 시간을 줄이기였다.\n신규 서버의 사양을 올리고, 커넥션을 최대한 써도 요청 시간을 늘리면 결국 커넥션 풀 고갈이 발생하는 걸 보고, 목 서버의 응답 시간을 2초에서 0.5초로 줄여보았다.\n그러니 tps가 문제없이 쭉쭉 올랐다.\n반대로 말하면 외부 서버의 응답 시간이 더 길어지면 tps가 더 내려갈 수도 있었다.\n신규 서버는 외부 서버의 응답을 최대 5초까지 대기하도록 설정했으니 가능성 있는 이야기다.</p>\n<p>신규 서버는 기존 DB와 새로운 DB에 동시에 접근한다.\n앞 인프라 구조에서 생략했던 DB를 추가하면 아래와 같다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABJklEQVR42nWRe0/CMBRH+f6fyT+I0ZiYaBR5g0xkT9Z2tDy2jm7HMCBCxJucpEl7T+7tr1UD1DX1BdZarC1Y5w69q9A7d0FFXtZUVYVzruHQc9TUtBoZ1/WdGCYLxWTpmCmOZOBlMBXgRRohUqIoQkrJfr//FTayylKsRuxkF5uvmCUFQWoIhWHsG8ajJf1ewKAbMPQ0XqxRUhLHMUqp/4R9tuKN7TptJGGyIko1nXFC72VO52nK4N3nYyT4DDOkEIS3JoTDv12vvLGOIFN4fkimdiizxU+XiM2Wja2RK4OUgiRJbkx4TOUUSNVc6ELxOLnnYdhmUxp8Pac9uON1/nx6WzXBlWXZcB3K6XDmUNZZfLVgoRaUrsTkhq/UIzHxnwDPde79AfCNGhc8FavBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"db infra\"\n        title=\"\"\n        src=\"/static/a8af77d7b5823086130af4e6c2b10c87/37523/db_infra.png\"\n        srcset=\"/static/a8af77d7b5823086130af4e6c2b10c87/e9ff0/db_infra.png 180w,\n/static/a8af77d7b5823086130af4e6c2b10c87/f21e7/db_infra.png 360w,\n/static/a8af77d7b5823086130af4e6c2b10c87/37523/db_infra.png 720w,\n/static/a8af77d7b5823086130af4e6c2b10c87/302a4/db_infra.png 1080w,\n/static/a8af77d7b5823086130af4e6c2b10c87/07a9c/db_infra.png 1440w,\n/static/a8af77d7b5823086130af4e6c2b10c87/9f9a4/db_infra.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>요청이 들어온 후 시간에 따라 각 자원에 접근하는 순서를 그려봤다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABhElEQVR42n2Ta2/aUAyG+f9/bLcP6yq0Sqx0aILSFkYDybnY5/g8U04JDRXDkiMrkR+9r+1MSin02UfbOJbzJ5YPa3brhn1omK5u+b2d08YDd+sps5cZph1x8wv/dIf5be0dOJMxsNkcuL9dMPvxwPPiL69+x+f7T/xcTTnEhm/zL9z8uaHInrD8Trf4irWPlDGQYwzQmEGCkHNCRHCxxUqu37IlrBgfY+jtY6SwkAwab0QfKkxVCeLJlilWSDlRKCeImdW+gXFSOACdgiYjdI4QAiF4nOvT4b2ndfsK7UE5Zyznd4VHxuRUU+gENJeqTFNGNCGqpJRq6lDnTJKIxfaaZarCx5dXVs9b1psdjVOsXJ4VJVPkIvDdcivgJRNFiZrQbNVe6fM4s5p9nfSywrcXR8vab7IQ3HiG7jTDzrUn26qCJbmusDsupd9yFCFGqVBRIWkiiKOMzsZK+Z/CN6AadNEQ7+vZiCg+dhTs7G84P5srwP65D4ZGPZvZ0DCuP8IH4D8ImazwsBaBUgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"long transaction\"\n        title=\"\"\n        src=\"/static/60cd8c13b1169fb637c32802836b02b8/37523/long_transaction.png\"\n        srcset=\"/static/60cd8c13b1169fb637c32802836b02b8/e9ff0/long_transaction.png 180w,\n/static/60cd8c13b1169fb637c32802836b02b8/f21e7/long_transaction.png 360w,\n/static/60cd8c13b1169fb637c32802836b02b8/37523/long_transaction.png 720w,\n/static/60cd8c13b1169fb637c32802836b02b8/302a4/long_transaction.png 1080w,\n/static/60cd8c13b1169fb637c32802836b02b8/07a9c/long_transaction.png 1440w,\n/static/60cd8c13b1169fb637c32802836b02b8/9f9a4/long_transaction.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>여기서 문제는 이 모든 접근이 하나의 트랜잭션으로 묶여있는 점이었다.\n트랜잭션 내에서 외부 서버에 요청을 보내서, 실제로 필요한 시간보다 훨씬 길게 커넥션을 점유했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABW0lEQVR42o2S207DMBBE+/8fhXjjDSEhkIpEi4DeSJu2juu7fZBNkqZVga4U7SaZHc2MPUopkSv3al4zf1symy5RjWYhZjzNH9mqDVWz4nnxSCUrUGsOqzF2M4FgSO1+rlFPGBPvLwvGDxNeHqaIjWRav3L7dMNKLPjcvnP7fMNs9wnig2Z6h5ndk7w8JaStodKYIiEGjDEYcyjfYwxYq3tcv/ez1L8Xhd2TyzmH1hrrHPag8Pt9WYrOkaTsaWKMAxGXLLfdWouUEqUUByGQ1RfKGOR+j9nWxEweAiGEE1e/Ws5A7z0+d2Nwux0+JbzWP3OM5X+OI6sc7l4k7EAt+9Fm8APLFNKrCUs+bW6hEcdZiGI5xViiuYowH0rOTxuDkg1qvUZbi2oaTF33ljPhef4XCTuwy10pbEuS53ziQ/xVhKcKJa7NLYVA1LoDn12bfxR24JLnhavxl8JvkNiturgaP00AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"long connection\"\n        title=\"\"\n        src=\"/static/27e5b1f0296266c89a66b4f5f2c98420/37523/long_connection.png\"\n        srcset=\"/static/27e5b1f0296266c89a66b4f5f2c98420/e9ff0/long_connection.png 180w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/f21e7/long_connection.png 360w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/37523/long_connection.png 720w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/302a4/long_connection.png 1080w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/07a9c/long_connection.png 1440w,\n/static/27e5b1f0296266c89a66b4f5f2c98420/9f9a4/long_connection.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>그래서 외부 서버 요청 로직을 트랜잭션 밖으로 분리하는 리팩터링을 진행했다.\n다행히 외부 서버 요청 전 DB 접근은 조회가 대부분이었다.\n일부 값을 변경하는 로직도 있었지만, 외부 서버 요청 성공 여부와 무관하게 값이 변경되어도 비즈니스 로직 상 문제가 없았다.\n결론적으로 외부 서버 요청이 성공할 때만 트랜잭션을 시작하고 각 DB에 접근하도록 개선했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABc0lEQVR42nVS2WrDMBDM/39U6fFSaF7ah1BoKSZtTC7biSWtztUUyZHrknhhkbzaGc+stIgxImUKEhqHusW+btC3EtIKVO0XdmILsgrrrsLmvEH0BNv9QDcVou0ztvAspoTHusPq5SNn/bnHUR1wv7rD2/oVnW7x9P6AZbVENC2oeob4fAT33/8JcYlCmiJYP6zBQ+gzrDeIiFmlcWbsixNs2Y8KCyEzQwkJIoImDdISHDmfp7OpgPKdsZe8SSgvhIoUpJRQSoEUoVcn+OBzTwjhH2HBL4bCn+W0Omvhvc/pnLvehwDvDNiqq3FNZng9j6x40jwFggOiFbcJywxSmSyj3h1R7xpsDx2E9uMPeGItskc0s4R/Eo1jnM4SvaSckky2mtJaO9p2zoIvNz5jeSieNaPvFazR0MZAHQ8g0YOMATUN2LmsOF0Ic5xXWIrCDIRaE0hr6NMJ0Q+2WSnEEG4/mzmFqckblx9yAY1n0xnOEP4CIdutTJOWTOwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"refactoring\"\n        title=\"\"\n        src=\"/static/4ff969a3fdfb53f2ab0eebe033433dba/37523/refactor.png\"\n        srcset=\"/static/4ff969a3fdfb53f2ab0eebe033433dba/e9ff0/refactor.png 180w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/f21e7/refactor.png 360w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/37523/refactor.png 720w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/302a4/refactor.png 1080w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/07a9c/refactor.png 1440w,\n/static/4ff969a3fdfb53f2ab0eebe033433dba/9f9a4/refactor.png 1560w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>구조를 개선하고 나니 원래 목표했던 <code class=\"language-text\">10*n tps</code>의 두 배까지 한 인스턴스로 안정적으로 처리 가능했다.\n커넥션 풀도 조정하며 테스트를 재차 수행한 결과, 30개로 충분해 30개로 줄였다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABuUlEQVR42o2SS2/UQBCE/QsQaHe9j6zdj/HMeDdrO3uLEBIcACEQIMQt5ASIAwoHIASUP19o2kOUhAMcSmOV3V9XT7sIIaDrOsQYoapgZojIfyl9e13JK9q2xX6/RzqdcyAiEAuIGMSj2Dz+27ulBDVg3/eW0HuPGANiUKTkMXjE0CCEmM+bXohZyc/1RRqzaRo4l6RQ50HtQ0srTQfxR3DK4+kctNlA/ACnYn6qSb69U0VxPS5TDRKPSX9uz8v2Febbd5B6Zh6xwyo8Rnn4AVrdxXx7glq2YKrsmmzkmxebgAHT/iuYyYCL7QmkLjEdfoCkwUF4gnL3Ea66g8nRJSq3h9AKQmswC4qrbYkzIyWc9t8MuMpANeA5+BYwNam1A0nE2t83aMGsEFpguXmDVXxhKaf99wx8+Q/gBUharP0DzLov0HqSgXVphcvNW+syGS7yyK8x354acDL8HEeOT1HuPo0jD79AusnAsz9AsYSrlLB9DuEKZffZgAfxWW4yHz1psA6PsDg8hVb3UPZnIG1RNceY795D69m4FNuy6CgmiDb5XhUi48+uLuTFib0nqiHqr7zULNX+BgazPe/oXHuQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"result\"\n        title=\"\"\n        src=\"/static/f2825b41a05d0a6153a288806aee1ac1/37523/result.png\"\n        srcset=\"/static/f2825b41a05d0a6153a288806aee1ac1/e9ff0/result.png 180w,\n/static/f2825b41a05d0a6153a288806aee1ac1/f21e7/result.png 360w,\n/static/f2825b41a05d0a6153a288806aee1ac1/37523/result.png 720w,\n/static/f2825b41a05d0a6153a288806aee1ac1/302a4/result.png 1080w,\n/static/f2825b41a05d0a6153a288806aee1ac1/07a9c/result.png 1440w,\n/static/f2825b41a05d0a6153a288806aee1ac1/38116/result.png 2086w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>1분간 초당 <code class=\"language-text\">20*n</code>명의 가상 유저가 요청을 연달아 2개씩 보내도 실패하지 않는 최종 테스트 결과다.</p>\n <br>\n<h2 id=\"-짧은-회고\" style=\"position:relative;\"><a href=\"#-%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\" aria-label=\" 짧은 회고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>💬 짧은 회고</h2>\n<p>글은 깔끔하게 썼지만 사실 많은 고비가 있었다.\n해당 작업에 2~3일이 걸릴 것이라 예상했는데, 실제로는 5~6일 정도를 소요했다.\n인프라 설정부터 쉽지 않았고, chat gpt와 함께 짠 테스트 스크립트는 돌아가지 않아 삽질을 반복했고,\n(결과적으로 chat gpt가 계속 없는 설정을 쓸 수 있다고 잘못 알려준 문제였다😡 공식 문서 링크를 달라고 하니 not found가 뜨는 링크만 계속 줬다!!!),\n원인 파악부터 리팩터링 후 다시 부하테스트, 스테이지 테스트, 이후 배포까지 생각보다 많은 일을 해야했다.</p>\n<p>돌이켜보았을 때, 앞으로 낯선 문제를 해결할 때 접근 방식을 개선해야겠다는 생각이 든다.\n글에서는 단순히 ‘목 서버에서 요청 응답을 하지 못해서 사양을 높였다’라고 나와있지만, 사실 그 때 나는 멘붕 상태였다.\n신규 서버가 문제인가? 왜 커넥션 풀 문제도 아닌데 응답이 안 오지? 인스턴스 CPU 상태도 괜찮은데? 하고 허둥대면서 팀원한테 도움을 요청했다.\n로깅을 본 팀원이 <code class=\"language-text\">분할 정복</code> 처럼 문제를 작은 단위로 나눠 보라고 했다.\n먼저 목 서버만 떼어서 문제를 해결해보고, 안되면 다른 방법을 찾아보라며, 자기가 볼 때는 사양이 너무 낮다는 힌트도 줬다.</p>\n<p>예상치 못한 문제, 또는 잘 모르는 영역의 문제에 부딪히면 늘 분할 정복을 잊게 된다.\n익숙한 스프링에서 문제를 만났다면 디버깅을 찍고, 예외 스택을 따라가며 해결했을 것 같은데, 익숙하지 않은 영역으로 오니 생각이 실타래처럼 엉켰다.\n지금 해결법도 결과적으로 목표한 tps를 달성하긴 했지만, 편하고 자신있는 방식으로 편향해 해결했다는 생각이 든다.\n인스턴스 모니터링을 분석하거나, 톰캣의 스레디풀 등을 조사하기 보다 알고 있는 문제에 먼저 덤볐다.\n이게 ‘진짜 문제’가 맞기를 빌면서…\n어쩌면 다른 문제 또한 있었고 함께 해결했다면 tps를 더 개선할 수 있었을 것 같다.\n문제 단위를 충분히 잘게 쪼개는 동시에, 컴포트존 너머의 영역에도 도전하기를 의식적으로 수행해야겠다.</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\">🏗 인프라 구조</a></p>\n<ul>\n<li><a href=\"#%EA%B8%B0%EC%A1%B4-%ED%94%84%EB%A1%9C%EB%8D%95%EC%85%98-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\">기존 프로덕션 인프라 구조</a></li>\n<li><a href=\"#%EC%8B%A0%EA%B7%9C-%EC%84%9C%EB%B2%84-%EB%8F%84%EC%9E%85-%ED%9B%84-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%A1%B0\">신규 서버 도입 후 인프라 구조</a></li>\n<li><a href=\"#%EB%B6%80%ED%95%98%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%9D%B8%ED%94%84%EB%9D%BC\">부하테스트 인프라</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-%EC%A7%9C%EA%B8%B0\">📝 테스트 시나리오 짜기</a></p>\n<ul>\n<li><a href=\"#%EB%AA%A9%ED%91%9C-%ED%8A%B8%EB%9E%98%ED%94%BD-%EC%B2%98%EB%A6%AC%EB%9F%89-%EC%84%A4%EC%A0%95\">목표 트래픽 처리량 설정</a></li>\n<li><a href=\"#%EC%9C%A0%EC%A0%80-%ED%96%89%EB%8F%99-%EC%84%A4%EC%A0%95\">유저 행동 설정</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%ED%85%8C%EC%8A%A4%ED%8C%85-%ED%88%B4-%EC%84%A0%EC%A0%95\">🧪 테스팅 툴 선정</a></p>\n<ul>\n<li><a href=\"#hey\">hey</a></li>\n<li><a href=\"#k6-%ED%95%98%EB%A0%A4%EB%8B%A4-%EB%AA%BB-%ED%95%A8\">k6 하려다 못 함</a></li>\n<li><a href=\"#%EF%B8%8F-artillery\">⭐️ artillery</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EF%B8%8F-yaml%EB%A1%9C-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-%EC%9E%91%EC%84%B1\">✍️ yaml로 시나리오 작성</a></p>\n</li>\n<li>\n<p><a href=\"#-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\">🛠 문제 해결하기</a></p>\n<ul>\n<li><a href=\"#%EC%98%88%EC%83%81%EC%B9%98-%EB%AA%BB%ED%95%9C-%EC%82%BD%EC%A7%88\">예상치 못한 삽질</a></li>\n<li><a href=\"#%EA%B7%B8%EB%9E%98%EB%8F%84-%EC%98%88%EC%83%81-%EB%B2%94%EC%9C%84%EC%98%80%EB%8D%98-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\">그래도 예상 범위였던 문제 해결하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\">💬 짧은 회고</a></p>\n</li>\n</ul>\n</div>","excerpt":"💡 해당 글은 사내에 작성한 문서를 허가 하에 개인 포스팅용으로 적절히 수정한 글입니다. 디어에 입사하고 처음 맡은 일은 개발 중이던 신규 인터널 API 서버 개발을 마무리하고 프로덕션 환경에 올리는 것이었다.\n전체 사이클에서 내 생각에 한 80% 지점에 참여하게 되었다.\n현재 신규 서버는 프로덕션 환경에 올라간 채로 ‘회사 사람들이 디어 앱을 통해 하는 요청’ 이라는 티끌의 트래픽만 받고 있는데, 다음 2주 간의 스프린트에 전체 트래픽을 100% 전환하는 게 목표다.\n그래서 이번 스프린트 중에 이 서버의 성능을 테스트하고, 운영 환경에 적절한 인프라 설정값을 찾는 과제를 수행했다. 🏗 인프라 구조 모든 인프라 구조도는 극히 단순화하여 그렸다. 기존 프로덕션 인프라 구조 신규 인터널 서버는 기존 디어 서버에서 외부 API 연동이 잦은 특정 도메인을 분리한 서버다.\n기존에는 디어 앱에서 특정 요청이 들어오면, 디어 서버를 거쳐, 경우에 따라 또 다른 인터널 서버를 경유해 로직을 수행…","frontmatter":{"date":"March 12, 2023","title":"서버 오픈 전 부하테스트로 대비하기","categories":"트러블슈팅","author":"써머","emoji":"headers/load_test.png"},"fields":{"slug":"/load-test/"}},"next":{"id":"fe825ea3-1c57-5d07-8923-05cfa619865f","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACtElEQVR42iWRXU9aBxiAz6/YVa/Wi8W4mi1rmjTNsmWJW3dhsjWxW5ptxsx0TqtDRcQDHhQ8eERBlCFwPIgioIB8iAhVRDS1kSixH2lNdEu2ZEn/xrN4evHcvBfP+z55BZNtmlGHG6tznnGXn8m5EMpCmJnFFXyRFOrGDtrmLqtbVWLFI2LFQ5318jHpvVM2Kw0y1TMy1QaFw5cIw7ZpzHY3FqcXSVlgYnYR2avi9C7hUWPs1t9SPbvk6PW/7Dx/Q6XxN5n9U33BeumYjfIJqad1krt18vsNBOPYFOaJWUYdHv1KSfFhdwcwiA6Mtikaf72jeHrF3tkVtRf/UL94R/7wHC1dJl6oES8csb79jPXiMdmndQSjxYlJUnSpRfbqUocnxFf323jU2c3J+Ss6jGN0mOwo8gTR1SD52jlqYptopkI0u08sd0A8XyO18wzBMDqJ0SJjsil6ujjpwebyc+/LVh51/kYsV2LFH6T9iza+aXuAqobZ3DslsJYnnCyxnCyzkt4jkq6Q2Koh9JvtDIgy1+mm8RnM9llE2cvtu5/zY0cXiXwFydLPnaYbfNB6nx9EN8ntQ3yRTUKxAqF4AW2jRHijzFpmH6FnSKJvxI5BlBm0TjFsc3H9qJZPb9P+06+kc3GGH3+N2yXRa+7js85BEsUjPKE4/tUsi6s5gmtbujySKiN0G0R6hySemMbR8yUFgzhJ08ctfPfwFw5qOYKqm6VoGm0pynKmRCRbxfVnhHktybyWYiF8TRotvv1e+PuAlZ5BK33DNgZFmV6jxEdNzXzb9j3P3/zHyctLEgE/fp9K+fiC0NoW8twSs4tRHXcghicYJ7CSReh6YuJx/yjvxRb+GLFzPWu+9Qkf3rzJnbv3EPu6sHX/zK3mZoasUzjcqo48p+Gc01Dml1EWIvjCSf4HAxMZK6ibklYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"book\"\n        title=\"\"\n        src=\"/static/b9bd507c2c6e68cf6dc43d174ee1440a/37523/book.png\"\n        srcset=\"/static/b9bd507c2c6e68cf6dc43d174ee1440a/e9ff0/book.png 180w,\n/static/b9bd507c2c6e68cf6dc43d174ee1440a/f21e7/book.png 360w,\n/static/b9bd507c2c6e68cf6dc43d174ee1440a/37523/book.png 720w,\n/static/b9bd507c2c6e68cf6dc43d174ee1440a/302a4/book.png 1080w,\n/static/b9bd507c2c6e68cf6dc43d174ee1440a/07a9c/book.png 1440w,\n/static/b9bd507c2c6e68cf6dc43d174ee1440a/ec5f6/book.png 1852w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이 책은 객체지향의 바이블일 것이다.\n책을 읽기 전부터 그런 생각을 했다.\n추상적인 표지와 무지막지한 두께에서 느껴지는 포스가 흡사 수학의 정석 같았기 때문이다.\n그래서 그렇게 어려운 책이 아니라는 주변의 말에도 쉽게 읽을 엄두를 못 냈다.</p>\n<p>그러다 회사에서 페어 프로그래밍을 할 때였다.\n클라이언트 입장에서 <code class=\"language-text\">PUT</code> 요청으로 엔티티 값을 변경 시키고, 다시 <code class=\"language-text\">GET</code> 요청으로 엔티티를 조회하도록 코드를 짜고 있었다.\n그래서 서비스의 엔티티 값을 변경 시키는 메서드가 해당 엔티티를 반환하게 만들면, 굳이 <code class=\"language-text\">GET</code> 요청을 다시 보낼 필요가 없지 않겠냐는 주장을 했다.\n그 때 팀원이 <code class=\"language-text\">명령-쿼리 분리 원칙</code> 이야기를 하면서 오브젝트 책을 추천했다.</p>\n<p>설날 전부터 읽기 시작했으니 다 읽기까지 약 한달이 걸렸다.\n책이 어려워서는 아니고 회사를 다니니 시간내서 공부하기가 쉽지 않았다.\n블로그 포스팅 해야한다고 글또를 신청해놓고 지각하고 있는 지금을 봐도 그렇다…\n어쨌든, 책에서 인상깊었던 부분을 간략하게 정리해봤다.</p>\n<br>\n<h2 id=\"-처음-만난-지식들\" style=\"position:relative;\"><a href=\"#-%EC%B2%98%EC%9D%8C-%EB%A7%8C%EB%82%9C-%EC%A7%80%EC%8B%9D%EB%93%A4\" aria-label=\" 처음 만난 지식들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>💎 처음 만난 지식들</h2>\n<h3 id=\"명령-쿼리-분리-원칙\" style=\"position:relative;\"><a href=\"#%EB%AA%85%EB%A0%B9-%EC%BF%BC%EB%A6%AC-%EB%B6%84%EB%A6%AC-%EC%9B%90%EC%B9%99\" aria-label=\"명령 쿼리 분리 원칙 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>명령-쿼리 분리 원칙</h3>\n<p>무엇보다 <code class=\"language-text\">명령-쿼리 분리 원칙</code> 키워드가 책을 읽게 된 계기다 보니 책에서 마주치니 참 반가웠다.</p>\n<blockquote>\n<p>객체의 상태를 수정하는 오퍼레이션을 명령이라고 부르고 객체와 관련된 정보를 반환하는 오퍼레이션을 쿼리라고 부른다.<br>\n…명령-쿼리 분리 원칙의 요지는 오퍼레이션은 부수효과를 발생시키는 명령이거나 부수효과를 발생시키지 않는 쿼리 중 하나여야 한다는 것이다. …다음의 두 가지 규칙을 준수해야 한다.</p>\n<p>객체의 상태를 변경하는 명령은 반환값을 가질 수 없다<br>\n객체의 정보를 반환하는 쿼리는 상태를 변경할 수 없다</p>\n<p>pp.202~203</p>\n</blockquote>\n<br>\n<p>키워드는 새롭지만 내용은 직관적으로 받아들이기 쉬웠다.\ngetter()를 호출했는데 나도 모르게 값이 바뀌면 곤란하다는 것 아닐까.\n메서드가 예상하지 못한 부작용을 해선 안된다는 일반적인 개념을 객체에 더 집중시킨 원칙이라 해석했다.\n비스무리한 키워드를 봤던 것 같아서 찾아보니, <a href=\"https://justhackem.wordpress.com/2016/09/17/what-is-cqrs/\">CQRS란 무엇인가?</a>라는 아주 좋은 포스팅이 있어 감사하게 읽었다.</p>\n<br>\n<h3 id=\"추상화-패키지는-클라이언트로\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EC%83%81%ED%99%94-%ED%8C%A8%ED%82%A4%EC%A7%80%EB%8A%94-%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EB%A1%9C\" aria-label=\"추상화 패키지는 클라이언트로 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추상화 패키지는 클라이언트로</h3>\n<p>멀티 모듈 프로젝트를 해 본 적이 없다 보니, 모듈 및 패키지 간의 의존성을 신경쓰지 않았다.\n의존성이 생길 것 같으면 이벤트로 끊으면 된다고 생각했다.\n그런데 그 이전의 중요한 원칙을 배울 수 있었고, 조만간 써먹을 때가 올 것 같다.</p>\n<blockquote>\n<p>추상화를 별도의 독립적인 패키지가 아니라 클라이언트가 속한 패키지에 포함시켜야 한다. 그리고 함께 재사용될 필요가 없는 클래스들은 별도의 독립적인 패키지에 모아야 한다. 마틴 파울러는 이 기법을 가리켜 SEPARATED INTERFACE 패턴[Fowler02]이라고 부른다.</p>\n<p>Movie와 추상 클래스인 DiscountPolicy를 하나의 패키지로 모으는 것은 Movie를 특정한 컨텍스트로부터 완벽하게 독립시킨다. Movie를 다른 컨텍스트에서 재사용하기 위해서는 단지 Movie와 DiscountPolicy가 포함된 패키지만 재사용하면 된다. 새로운 할인 정책을 위해 새로운 패키지를 추가하고 새로운 DiscountPolicy의 자식 클래스를 구현하기만 하면 상위 수준의 협력 관계를 재사용할 수 있다.</p>\n<p>p.304</p>\n</blockquote>\n<br>\n<h2 id=\"-이걸-왜-몰랐을까\" style=\"position:relative;\"><a href=\"#-%EC%9D%B4%EA%B1%B8-%EC%99%9C-%EB%AA%B0%EB%9E%90%EC%9D%84%EA%B9%8C\" aria-label=\" 이걸 왜 몰랐을까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>💧 이걸 왜 몰랐을까</h2>\n<p>이 항목은 반성을 위해 만들었다.\n사실 해당 개념을 잘 모르는데, 단순히 자주 들으니 귀에 익어버려서 잘 안다고 착각했던… 메타인지가 부족했던 것들이 있었다.</p>\n<h3 id=\"점을-어떻게-하나만-찍어\" style=\"position:relative;\"><a href=\"#%EC%A0%90%EC%9D%84-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%98%EB%82%98%EB%A7%8C-%EC%B0%8D%EC%96%B4\" aria-label=\"점을 어떻게 하나만 찍어 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>점을 어떻게 하나만 찍어?</h3>\n<p>우테코 피드백에서 <code class=\"language-text\">디미터의 법칙</code>을 언급하며, 객체지향 생활체조에 따라 <code class=\"language-text\">한 줄에 점 하나만 찍어라</code>고 한 적이 있었다.\n의외로 처음에는 이 말을 제대로 알아들었었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">judgeWin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Player</span> player<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>player<span class=\"token punctuation\">.</span>getCards<span class=\"token punctuation\">.</span><span class=\"token function\">getScore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">judgeWin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Player</span> player<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> player<span class=\"token punctuation\">.</span><span class=\"token function\">isWin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>여러개의 점을 거쳐 객체 내부의 프로퍼티에 접근하면, 올바른 캡슐화가 되지 않았다는 신호라는 의미였다.\n그런데 이 때는 자바 스트림을 몰랐고, 점이 줄줄이 이어지는 스트림을 쓰면서 혼란이 시작됐다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Player</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">makePlayers</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> names<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> names<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Playser</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>그래서 디미터 법칙을 지치려고 한 줄에 점 하나만 찍고 줄을 띄운다고 생각했었다…\n이런 착각이 흔한 것이지, 디미터의 법칙을 오해한 예시로 정확하게 자바 스트림이 나온다.</p>\n<br>\n<blockquote>\n<p>디미터 법칙은 “낯선 자에게 말하지 말라(don’t talk to strangers)[Larman04]” 또는 “오직 인접한 이웃하고만 말하라(only talk to your immediate neighbors)[Metz12]“로 요악할 수 있다. 자바나 C#과 같이 ‘도트(.)’를 이용해 메시지 전송을 표현하는 언어에서는 “오직 하나의 도트만 사용하라(use only one dot)[Metz12]“라는 말로 요약되기도 한다.</p>\n<p>p.181</p>\n</blockquote>\n<br>\n<blockquote>\n<p>따라서 대부분의 사람들은 자바 8의 IntStream을 사용한 아래의 코드가 기차 충돌을 초래하기 때문에 디미터 법칙을 위반한다고 생각할 것이다. …디미터 법칙은 결합도와 관련된 것이며, 이 결합도가 문제가 되는 것은 객체의 내부 구조가 외부로 노출되는 경우로 한정된다.</p>\n<p>스스로에게 다음과 같은 질문을 하기 바란다. 과연 여러 개의 도트를 사용한 코드가 객체의 내부 구조를 노출하고 있는가?</p>\n<p>pp.198~199</p>\n</blockquote>\n<br>\n<h3 id=\"프로그램의-정확성을-지켜라\" style=\"position:relative;\"><a href=\"#%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8%EC%9D%98-%EC%A0%95%ED%99%95%EC%84%B1%EC%9D%84-%EC%A7%80%EC%BC%9C%EB%9D%BC\" aria-label=\"프로그램의 정확성을 지켜라 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>프로그램의 정확성을 지켜라</h3>\n<p>포스팅을 쓰기 위해 접어놓은 페이지를 뒤적이다 정말 크게 뜨끔한 부분이 있다.</p>\n<blockquote>\n<p>하지만 이 경우에는 flyBird 메서드에 전달되는 인자의 타입에 따라 메서드가 실패하거나 성공하게 된다. …flyBird 메서드는 fly 메시지를 전송한 결과로 UnsupportedOperationException 예외가 던져질 것이라고는 기대하지 않았을 것이다. 따라서 이 방법 역시 클라이언트의 관점에서 Bird와 Penguin의 행동이 호환되지 않는다.</p>\n<p>p.447</p>\n</blockquote>\n<p>이 인용구의 예시는 펭귄이 날지 못한다고, Bird를 상속한 Penguin 클래스의 fly() 메서드의 구현을 비워두거나 예외를 던지게 하면 안된다는 맥락이었다.\n그러니까 프로그램의 정확성을 깨트리지 않으면서 하위 타입이 상위 타입을 대체할 수 있어야 한다는 리스코프 치환 원칙을 정면으로 위배하는 사례였다.\n때마침 그런 코드를 <strong>바로 어제</strong> 코틀린 블랙잭을 하며 짰었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">sealed</span> <span class=\"token keyword\">interface</span> Deck <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">draw</span><span class=\"token punctuation\">(</span>card<span class=\"token operator\">:</span> Card<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Deck\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">sealed</span> <span class=\"token keyword\">class</span> <span class=\"token function\">Running</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> cards<span class=\"token operator\">:</span> Cards<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> Deck <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">draw</span><span class=\"token punctuation\">(</span>card<span class=\"token operator\">:</span> Card<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cards<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">sealed</span> <span class=\"token keyword\">class</span> <span class=\"token function\">Finish</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> cards<span class=\"token operator\">:</span> Cards<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> Deck <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">draw</span><span class=\"token punctuation\">(</span>card<span class=\"token operator\">:</span> Card<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">throw</span> <span class=\"token function\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"더이상 카드를 추가할 수 없습니다\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>블랙잭에서 이미 턴이 끝난 카드덱은 카드를 더 추가할 수 없음을 구현하기 위해 예외를 던졌다.\n이렇게 하지 마세요 하는 완벽한 예시를 내가 어제 짰다니…</p>\n<br>\n<h2 id=\"-너의-이름은\" style=\"position:relative;\"><a href=\"#-%EB%84%88%EC%9D%98-%EC%9D%B4%EB%A6%84%EC%9D%80\" aria-label=\" 너의 이름은 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📛 너의 이름은</h2>\n<p>디미터 법칙을 지키기 위해 이런 식의 코드를 짤 때가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">Player</span><span class=\"token punctuation\">(</span>deck<span class=\"token operator\">:</span> Deck<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">cards</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>Card<span class=\"token operator\">></span> <span class=\"token operator\">=</span> deck<span class=\"token punctuation\">.</span><span class=\"token function\">cards</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>이는 물론, List&#x3C;Card>가 필요한 외부에서 점을 두 번 찍지 못하게 하려는 목적이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>player<span class=\"token punctuation\">.</span>deck<span class=\"token punctuation\">.</span>cards<span class=\"token punctuation\">.</span><span class=\"token function\">joinToString</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\", \"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">println</span><span class=\"token punctuation\">(</span>player<span class=\"token punctuation\">.</span><span class=\"token function\">cards</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">joinToString</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\", \"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<p>이걸 두고 단순히 호출 깊이를 줄이려고 메서드를 겹겹이 감싸는 게 무슨 의미가 있지? 하는 동시에 클라이언트에서 깔끔하니 된 건가 고민을 했었다.\n그런데 책에서 이 행위의 멋진 이름을 알게 되었다.</p>\n<blockquote>\n<p>…동일한 메서드 호출을 그대로 전달한다는 것을 알 수 있다. 이를 포워딩(forwarding)이라 부르고 동일한 메서드를 호출하기 위해 추가된 메서드를 포워딩 메서드(forwarding method)[Bloch08]라고 부른다.</p>\n<p>포워딩은 기존 클래스의 인터페이스를 그대로 외부에 제공하면서 구현에 대한 결합 없이 일부 작동 방식을 변경하고 싶은 경우에 사용할 수 있는 유용한 기법이다.</p>\n<p>p.352</p>\n</blockquote>\n<br> \n<p>의미없다 생각한 코드가 포워딩이라는 이름을 얻고 나니 그럴싸하게 보였다.\n반면 반대의 경우도 있었는데, <a href=\"https://kotlinlang.org/docs/extensions.html#extension-functions\">코틀린 확장함수</a>를 처음 접하고 자바에 없는 좋은 거 코틀린에 다 있네 한탄했는데 충격적인 칭호를 알게 됐다.</p>\n<blockquote>\n<p>몽키 패치(Monkey Patch)란 현재 실행중인 환경에만 영향을 미치도록 지역적으로 코드를 수정하거나 확장하는 것을 가리킨다.</p>\n<p>p.352</p>\n</blockquote>\n<p>확장 함수가 몽키 패치임을 알고 나니 코드는 그대로인데 전만큼 멋져보이지 않았다…</p>\n<br>\n<h2 id=\"-컴파일과-런타임을-구분해라\" style=\"position:relative;\"><a href=\"#-%EC%BB%B4%ED%8C%8C%EC%9D%BC%EA%B3%BC-%EB%9F%B0%ED%83%80%EC%9E%84%EC%9D%84-%EA%B5%AC%EB%B6%84%ED%95%B4%EB%9D%BC\" aria-label=\" 컴파일과 런타임을 구분해라 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>💾 컴파일과 런타임을 구분해라</h2>\n<p>토비의 스프링을 읽으면서 컴파일 타임 의존성과 런타임 의존성을 확실히 구분하는 것의 중요성을 배웠다.\n별 생각 없이 쓰던 스프링이 객체지향을 얼마나 갈고 닦은 프레임 워크인지도 깨달았다.\n거기서 접했던 맥락이 책의 어려곳에서 반복되고 있었다.</p>\n<blockquote>\n<p>상속이 가치 있는 이유는 부모 클래스가 제공하는 모든 인터페이스를 자식 클래스가 물려받을 수 있기 때문이다. …대부분의 사람들은 상속의 목적이 메서드나 인스턴스 변수를 재사용하는 것이라고 생각하기 때문이다.</p>\n<p>…상속을 통해 자식 클래스는 자신의 인터페이스에 부모 클래스의 인터페이스를 포함하게 된다. 결과적으로 자식 클래스는 부모 클래스가 수신할 수 있는 모든 메시지를 수신할 수 있기 때문에 외부 객체는 자식 클래스를 부모 클래스와 동일한 타입으로 간주할 수 있다.</p>\n<p>p.61</p>\n</blockquote>\n<br>\n<blockquote>\n<p>개방-폐쇄 원칙은 다음과 같은 문장으로 요약할 수 있다. 소프트웨어 개체(클래스, 모듈, 함수 등등)는 확장에 대해 열려 있어야 하고, 수정에 대해서는 닫혀 있어야 한다.</p>\n<p>…사실 개방-폐쇄 원칙은 런타임 의존성과 컴파일타임 의존성에 관한 이야기다. 런타임 의존성은 실행시에 협력에 참여하는 객체들 사이의 관계다. 컴파일타임 의존성은 코드에서 드러나는 클래스들 사이의 관계다. …유연하고 재사용 가능한 설계에서 런타임 의존성과 컴파일 타임 의존성은 서로 다른 구조를 가진다.</p>\n<p>pp.282~283</p>\n</blockquote>\n<br>\n<blockquote>\n<p>상속 관계는 클래스 사이의 정적인 관계인 데 비해 합성 관계는 객체 사이의 동적인 관계다. 이 차이점은 생각보다 중요한데, 코드 작성 시점에 결정한 상속 관계는 변경이 불가능하지만 합성 관계는 실행 시점에 동적으로 변경할 수 있기 때문이다.</p>\n<p>… 상속은 부모 클래스 안에 구현된 코드 자체를 재사용하지만 합성은 포함되는 객체의 퍼블릭 인터페이스를 재사용한다. 따라서 상속 대신 합성을 사용하면 구현에 대한 의존성을 인터페이스에 대한 의존성으로 변경할 수 있다.</p>\n<p>p.347</p>\n</blockquote>\n<br> \n<p>토프링에서 처음 이 개념을 접했을 때는, <code class=\"language-text\">실행 시점의 의존성이 다르다는 것이 도대체 무슨 뜻이지?</code>했다.\n왜냐면 인터페이스를 사용한다 쳐도 당연히 어딘가에서는 구현체를 생성해 주입해주고 있기 때문이다.\n코드를 따라가면 결국 런타임 의존성을 알 수 있는 것이 아닌가?\n토프링을 공부하며 이 관념을 배울 수 있었지만, 오브젝트에 나오는 아래의 사례를 먼저 읽었다면 더 쉽게 알게 되었을 것 같다.</p>\n<blockquote>\n<p>전통적인 언어에서 함수를 실행하는 방법은 함수를 호출하는 것이다. 객체지향 언어에서 메서드를 실행하는 방법은 메시지를 전송하는 것이다. 함수 호출과 메시지 전송 사이의 차이는 생각보다 큰데 프로그램 안에 작성된 함수 호출 구문과 실제로 실행되는 코드를 연결하는 언어적인 메커니즘이 완전히 다르기 때문이다.</p>\n<p>함수를 호출하는 전통적인 언어들은 호출될 함수를 컴파일타임에 결정한다. 코드 상에서 bar 함수를 호출하는 구문이 나타난다면 실제로 실행되는 코드는 바로 그 bar라는 함수다. …이를 정적 바인딩(static binding), 초기 바인딩(early binding), 또는 컴파일타임 바인딩(compile-time binding)이라고 부른다.</p>\n<p>객체지향 언어에서는 메시지를 수신했을 때 실행될 메서드가 런타임에 결정된다. foo.bar()라는 코드를 읽는 것만으로는 실행되는 bar가 어떤 클래스의 어떤 메서드인지를 판단하기 어렵다. …이를 동적 바인딩(dynamic binding) 또는 지연 바인딩(late binding)이라고 부른다.</p>\n<p>p.407</p>\n</blockquote>\n<br>\n<h2 id=\"-실용적인-지침\" style=\"position:relative;\"><a href=\"#-%EC%8B%A4%EC%9A%A9%EC%A0%81%EC%9D%B8-%EC%A7%80%EC%B9%A8\" aria-label=\" 실용적인 지침 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🧭 실용적인 지침</h2>\n<p>새로운 기능을 추가하거나, 변경이 생겼거나, 아니면 나에게 제일 흔한 이유로 요구사항을 잘못 파악했다는 걸 깨달아서 코드를 수정해야 했을 때, 한 곳만 건드렸는데 여러 곳에 빨간줄이 죽죽 그이는 경험이 많다.</p>\n<p>생성자 수정처럼 무념무상하게 수정하면 되는 경우도 있지만, 분명 설계상 허점이 있는 경우도 있었을 것이다.\n설계를 고치면 수정이 너무 커질 것 같으니 못본 척 하고 넘어가려 게 아냐? 하고 스스로를 의심하는 때가 종종 있다.\n그럴 때 고려하면 좋을 실용적인 지침들도 책에서 찾을 수 있었다.</p>\n<blockquote>\n<p>클래스가 다음과 같은 징후로 몸살을 앓고 있다면 클래스의 응집도는 낮은 것이다.\n클래스가 하나 이상의 이유로 변경돼야 한다면 응집도가 낮은 것이다. 변경의 이유를 기준으로 클래스를 분리하라.</p>\n<p>클래스의 인스턴스를 초기화하는 시점에 경우에 따라 서로 다른 속성들을 초기화하고 있다면 응집도가 낮은 것이다. 초기화되는 속성의 그룹을 기준으로 클래스를 분리하라.<br>\n메서드 그룹이 속성 그룹을 사용하는지 여부로 나뉜다면 응집도가 낮은 것이다. 이들 그룹을 기준으로 클래스를 분리하라.</p>\n<p>p.153</p>\n</blockquote>\n<br>\n<blockquote>\n<p>응집도는 모듈에 포함된 내부 요소들이 연관돼 있는 정도를 나타낸다. … 응집도는 객체 또는 클래스에 얼마나 관련 높은 책임들을 할당했는지를 나타낸다.</p>\n<p>결합도는 의존성의 정도를 나타내며 다른 모듈에 대해 얼마나 많은 지식을 갖고 있는지를 나타내는 척도다. …결합도는 객체 또는 클래스가 협력에 필요한 적절한 수준의 괸계만을 유지하고 있는지를 나타낸다.<br>\n어떤 설계를 쉽게 변경할 수 있다면 높은 응집도를 가진 요소들로 구성돼 있고 요소들 사이의 결합도가 낮을 확률이 높다.</p>\n<p>pp.110~112</p>\n</blockquote>\n<br>\n<h2 id=\"-멋진-문구들\" style=\"position:relative;\"><a href=\"#-%EB%A9%8B%EC%A7%84-%EB%AC%B8%EA%B5%AC%EB%93%A4\" aria-label=\" 멋진 문구들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🌈 멋진 문구들</h2>\n<p>글의 마무리로 유독 인상깊었던 두 문구를 남기겠다.</p>\n<blockquote>\n<p>이런 측면에서 객체지향이 실세계의 모방이라는 말은 옳지 않다. 객체지향 애플리케이션은 도메인 개념뿐만 아니라 설계자들이 임의적으로 창조한 인공적인 추상화들을 포함하고 있다.</p>\n<p>p.292</p>\n</blockquote>\n<p>객체지향과 실세계를 떠나 생각하기는 동일한 저자 조영호님의 <a href=\"http://www.yes24.com/Product/Goods/18249021\">객체지향의 사실과 오해</a>에도 강조되었던 내용이다.\n하지만 이와 동시에 실세계의 문제를 해결하기 위해 코드가 존재하니, 어쩔 수 없이 계속 실세계와 코드를 융합하게 된다.</p>\n<p>나머지 하나는 얼마전에 페어를 하다 리팩터링을 할 것인가 말 것이가의 고민하다 하지 말자고 결론을 내린 적이 있었다.\n그 때 팀원이 <code class=\"language-text\">그래, 코드에 금칠하지 말자</code>란 얘기를 해서 웃었다.</p>\n<p>실무에 들어오니 트레이드 오프라는 말을 지겹게 반복하게 되는데, 진리라고 인정하는 한편 그래서 그 트레이드 오프의 경계는 대체 어떻게 정하나 하는 답답함이 있었다.\n그러다 이 문구를 보니 왠지 위로가 됐다.</p>\n<blockquote>\n<p>유연한 설계라는 말의 이면에는 복잡한 설계라는 의미가 숨어 있다. …변경은 예상이 아니라 현실이어야 한다. 미래에 변경이 일어날지도 모른다는 막연한 불안감은 불필요하게 복잡한 설계를 낳는다. 아직 일어나지 않은 변경은 변경이 아니다.</p>\n<p>p.305</p>\n</blockquote>\n<br>\n<p>이미 너무 유명한 책이라 내가 뭐라고 추천한다는 말을 덧붙이겠나 싶다.\n그 대신 감상을 좀 더 남기자면, 책을 읽으면서 어… 이거 앞에서 했던 얘기 같은데? 란 생각이 종종 들었다.\n그리고 포스팅을 쓰기 위해 표시한 부분을 복기하는데 과연 같은 뜻을 전달하고자 하는 얘기가 여러 곳에서 다른 모습으로 반복되고 있었다.\n그런데 데자뷰를 느끼면서도, 나는 결국 핵심은 한 곳을 향하는 얘기를 읽을 때 마다 아 그렇구나! 이거구나! 그랬구나! 하고 똑같이 깨닫고 감탄하고 좋아했다.</p>\n<p>추상적인 패러다임을 완전히 익힌다는 건 어려운 일 같다.\n반복적으로 같은 얘기를 듣고 또 들어도 막상 내 손에서 나오는 코드가 하지 말라는 짓을 알뜰하게 저질러 놓은 걸 보면 그렇다.\n이런 나를 위해 친절하게 쉬운 얘기와 꼼꼼한 코드로 다채로운 반복 학습을 시켜주는, 수학의 정석보다 훨씬 좋은 책이었다!</p>\n<p>지금 회사에서 예전에 조영호님이 객체지향 세미나를 하신 적이 있다.\n책을 읽기 전에는 그냥 그랬구나~ 회사가 기술에 신경을 많이 쓰는구나~ 했는데, 책을 읽고 나니 어찌해도 내가 참석하긴 어려웠겠지만 괜히 너무너무 아쉬운 마음이 든다. 흑흑…</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EC%B2%98%EC%9D%8C-%EB%A7%8C%EB%82%9C-%EC%A7%80%EC%8B%9D%EB%93%A4\">💎 처음 만난 지식들</a></p>\n<ul>\n<li><a href=\"#%EB%AA%85%EB%A0%B9-%EC%BF%BC%EB%A6%AC-%EB%B6%84%EB%A6%AC-%EC%9B%90%EC%B9%99\">명령-쿼리 분리 원칙</a></li>\n<li><a href=\"#%EC%B6%94%EC%83%81%ED%99%94-%ED%8C%A8%ED%82%A4%EC%A7%80%EB%8A%94-%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EB%A1%9C\">추상화 패키지는 클라이언트로</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EC%9D%B4%EA%B1%B8-%EC%99%9C-%EB%AA%B0%EB%9E%90%EC%9D%84%EA%B9%8C\">💧 이걸 왜 몰랐을까</a></p>\n<ul>\n<li><a href=\"#%EC%A0%90%EC%9D%84-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%98%EB%82%98%EB%A7%8C-%EC%B0%8D%EC%96%B4\">점을 어떻게 하나만 찍어?</a></li>\n<li><a href=\"#%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8%EC%9D%98-%EC%A0%95%ED%99%95%EC%84%B1%EC%9D%84-%EC%A7%80%EC%BC%9C%EB%9D%BC\">프로그램의 정확성을 지켜라</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EB%84%88%EC%9D%98-%EC%9D%B4%EB%A6%84%EC%9D%80\">📛 너의 이름은</a></p>\n</li>\n<li>\n<p><a href=\"#-%EC%BB%B4%ED%8C%8C%EC%9D%BC%EA%B3%BC-%EB%9F%B0%ED%83%80%EC%9E%84%EC%9D%84-%EA%B5%AC%EB%B6%84%ED%95%B4%EB%9D%BC\">💾 컴파일과 런타임을 구분해라</a></p>\n</li>\n<li>\n<p><a href=\"#-%EC%8B%A4%EC%9A%A9%EC%A0%81%EC%9D%B8-%EC%A7%80%EC%B9%A8\">🧭 실용적인 지침</a></p>\n</li>\n<li>\n<p><a href=\"#-%EB%A9%8B%EC%A7%84-%EB%AC%B8%EA%B5%AC%EB%93%A4\">🌈 멋진 문구들</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"February 27, 2023","title":"열 번 들어 안 기억하는 나를 위한 친절한 오브젝트","categories":"독서","author":"써머","emoji":"headers/book-objects.png"},"fields":{"slug":"/book-objects/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://hyewoncc.github.io","comments":{"utterances":{"repo":"hyewoncc/hyewoncc.github.io"}}}}},"pageContext":{"slug":"/load-test/","nextSlug":"/book-objects/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437","3350743975"],"slicesMap":{}}