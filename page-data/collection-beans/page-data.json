{"componentChunkName":"component---src-templates-blog-template-js","path":"/collection-beans/","result":{"data":{"cur":{"id":"8ad80e3d-72fa-5a20-95b5-1908bea8dfd3","html":"<p>해당 포스팅은 <a href=\"https://github.com/woowacourse-teams/2022-pickpick\">줍줍</a> 개발 과정 중 맞딱뜨린 문제점과 답을 찾아가는 과정을 다른 방식으로 재구성한 글이다.<br>\n생각보다 글이 길어진 고로, 문제상황과 해결방안만 보고싶다면</p>\n<ul>\n<li><a href=\"https://hyewoncc.github.io/collection-beans/#%EC%8A%AC%EB%9E%99-rtm%EB%A6%AC%EC%96%BC%ED%83%80%EC%9E%84-%EB%A9%94%EC%8B%9C%EC%A7%80%EC%99%80%EC%9D%98-%EC%82%AC%ED%88%AC\">문제상황</a></li>\n<li><a href=\"https://github.com/hyewoncc/spring-sandbox/tree/spring/collection-beans\">빈 컬렉션 주입을 이용한 해결 예시코드</a></li>\n</ul>\n<p>이 둘을 보기를 권한다.</p>\n<h2 id=\"간단한-게시판-서비스를-상상하기\" style=\"position:relative;\"><a href=\"#%EA%B0%84%EB%8B%A8%ED%95%9C-%EA%B2%8C%EC%8B%9C%ED%8C%90-%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A5%BC-%EC%83%81%EC%83%81%ED%95%98%EA%B8%B0\" aria-label=\"간단한 게시판 서비스를 상상하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>간단한 게시판 서비스를 상상하기</h2>\n<h3 id=\"회원-가입과-탈퇴\" style=\"position:relative;\"><a href=\"#%ED%9A%8C%EC%9B%90-%EA%B0%80%EC%9E%85%EA%B3%BC-%ED%83%88%ED%87%B4\" aria-label=\"회원 가입과 탈퇴 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>회원 가입과 탈퇴</h3>\n<p>당신은 지나가던 고양이의 의뢰로 서버를 개발하게 되었다.\n고양이는 🐱 닉네임을 입력하면 가입이 가능하고, 탈퇴할 수 있는 서비스를 만들어 주세요 💬 라고 요구했다.\n그래서 나는 (그리고 이 글을 볼 대부분의 사람들은) 이건 쉽지~ 하고 간단한 컨트롤러를 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/members\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> memberService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">created</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URI</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/members/\"</span> <span class=\"token operator\">+</span> member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@DeleteMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/{id}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">leave</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        memberService<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">noContent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"그런데-이제-엔드포인트를-하나로-하고\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9F%B0%EB%8D%B0-%EC%9D%B4%EC%A0%9C-%EC%97%94%EB%93%9C%ED%8F%AC%EC%9D%B8%ED%8A%B8%EB%A5%BC-%ED%95%98%EB%82%98%EB%A1%9C-%ED%95%98%EA%B3%A0\" aria-label=\"그런데 이제 엔드포인트를 하나로 하고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그런데 이제 엔드포인트를 하나로 하고</h3>\n<p>이 코드를 본 고양이가 말했다.<br>\n🐱 엔드포인트를 하나로 통일할래요. 그리고 이게 <strong>회원 가입인지 탈퇴인지</strong>는 <strong>body</strong>안에 쓸게요. 이렇게요. 💬</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span> <span class=\"token comment\">// 회원 가입 시 </span>\n    <span class=\"token property\">\"event\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"join\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"cat\"</span>\n<span class=\"token punctuation\">}</span> \n<span class=\"token punctuation\">{</span> <span class=\"token comment\">// 회원 탈퇴 시</span>\n    <span class=\"token property\">\"event\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"leave\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>코드가 이상해지기 시작한다. 그래도 아직 납득 가능한 수준이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/members\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">event</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"join\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> memberService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">created</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URI</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/members/\"</span> <span class=\"token operator\">+</span> member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"leave\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            memberService<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">noContent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">internalServerError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"여기에-포스팅-기능도-몽땅-넣어줘\" style=\"position:relative;\"><a href=\"#%EC%97%AC%EA%B8%B0%EC%97%90-%ED%8F%AC%EC%8A%A4%ED%8C%85-%EA%B8%B0%EB%8A%A5%EB%8F%84-%EB%AA%BD%EB%95%85-%EB%84%A3%EC%96%B4%EC%A4%98\" aria-label=\"여기에 포스팅 기능도 몽땅 넣어줘 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>여기에 포스팅 기능도 몽땅 넣어줘</h3>\n<p>이 코드를 본 고양이가 또 요구했다.\n🐱 각자 게시글을 쓰고, 수정하고, 삭제하는 것도 가능하게 만들어주세요. 엔드포인트는 여전히 하나만 쓰고요. <strong>body</strong>는 이렇게 바꿀래요. 💬</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span> <span class=\"token comment\">// 회원 가입 시 </span>\n    <span class=\"token property\">\"event\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"member\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"join\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"cat\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{</span> <span class=\"token comment\">// 회원 탈퇴 시 </span>\n    <span class=\"token property\">\"event\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"member\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"leave\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{</span> <span class=\"token comment\">// 게시글 작성 시 </span>\n    <span class=\"token property\">\"event\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"posting\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"write\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"posting\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"memberId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"안녕하세요\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{</span> <span class=\"token comment\">// 게시글 수정 시 </span>\n    <span class=\"token property\">\"event\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"posting\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"edit\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"posting\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"안녕하세요, 반갑습니다\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{</span> <span class=\"token comment\">// 게시글 삭제 시 </span>\n    <span class=\"token property\">\"event\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"posting\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>이제 어떻게 해결할 지 정말 막막해졌다.\n이유를 추려보자.</p>\n<ol>\n<li>여러개의 도메인 x 여러개의 요구사항의 수많은 가짓수를 한 엔드포인트로 처리해야 한다</li>\n<li>요청값의 형태가 각자 다르므로 <code class=\"language-text\">DTO</code> 클래스로 받을 수 없다</li>\n<li>처리해야 할 도메인이 추가될 때 마다 주입될 서비스 클래스도 추가된다</li>\n<li>처리해야 할 도메인이나 요구사항이 추가될 때 마다 <code class=\"language-text\">if</code>문이 추가된다</li>\n</ol>\n<p>여기까지의 요구사항을 억지로나마 맞추면 코드를 이렇게 짤 수는 있겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@PostMapping</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">event</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span> event <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"event\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> content <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"member\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"type\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"join\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"type\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"leave\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"posting\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"type\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"write\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"type\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"edit\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"type\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">internalServerError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>몇가지 리팩토링을 통한 개선 여지는 보이지만 마음이 아픈 코드다.\n여기까지 읽었으면 <code class=\"language-text\">이런 억지 요구사항이 어딨나?</code>고 생각할 수도 있다.\n그런데 이게 <strong>슬랙이 우리에게 요구했던 사항</strong>이다.</p>\n<br>\n<h2 id=\"슬랙-rtm리얼타임-메시지와의-사투\" style=\"position:relative;\"><a href=\"#%EC%8A%AC%EB%9E%99-rtm%EB%A6%AC%EC%96%BC%ED%83%80%EC%9E%84-%EB%A9%94%EC%8B%9C%EC%A7%80%EC%99%80%EC%9D%98-%EC%82%AC%ED%88%AC\" aria-label=\"슬랙 rtm리얼타임 메시지와의 사투 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>슬랙 RTM(리얼타임 메시지)와의 사투</h2>\n<h3 id=\"url을-하나-제출하세요\" style=\"position:relative;\"><a href=\"#url%EC%9D%84-%ED%95%98%EB%82%98-%EC%A0%9C%EC%B6%9C%ED%95%98%EC%84%B8%EC%9A%94\" aria-label=\"url을 하나 제출하세요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>url을 하나 제출하세요</h3>\n<p>줍줍을 개발하면서 애증하게 된 슬랙의 애정하는 면 중 하나는 사용자에게 정말 폭넓은 편의를 제공한다는 것이다.\n처음 개발에 착수했을 때, 슬랙에서 발생하는 메시지 생성, 삭제, 채널명 수정 등의 사건을 어떻게 포착할지 막막했다.\n그런데 슬랙은 이미 봇을 통해 이를 리얼타임으로 제공한다. 와!</p>\n<p>하지만… 리얼타임 메세지를 한번 받아보니 바로 애정이 애증이 되었다.\n원래 물에서 건져주면 보따리 내놓으라고 한다고, 이 모든 걸 한 엔드포인트에 꽂아주는 게 문제였다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABh0lEQVQoz5VRbW6CQBDl5j1GL9EjeIHGH8YUFUMFRdt1ERZh+f56zYxCtalJO+RldmaWmfdmDfPNxHK5xGw2g2maWCwWmE6n7KMoQlVVKIriV5RFgZyRX+KyhEE/uo4La2XBsiys12vM53OsVqu7hnT5JyjfNy3QdmNsAEDXdXhkVHsEsn0UwD4JNG3Lww0pJTOybZvZORsHf7Gu79k/v07wNHlBUVeo6xpGGIZwXRee52G322HruuwJjuNwbYh33gHbg4DrfUD6PkKlEEcRQLKBC8Msy6ATjXN0RpwkSLSGviJNU8RxzD7VGlleQhcN0qLGlSB6/vDdkBgSk8N+j60v4IQSeVWOe+r7/mZv7QVti6ZpGCST0A47JIZCCEjpQ3wKHMUR8ig5p5RCnud3yG7O9LKn0wmb9w3HvEN66iRJRnl8Jrk6ZdkUD/IHP2CoE6lRMhXopYlNEIYIQgXlB9AHiUQGnFMEpS53gmA807ooph5jQ6LJU2hiXiLKaqRlg/8a7ZoafgFcM0pCbeJUAgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"url\"\n        title=\"url\"\n        src=\"/static/472998381523f6f149fb03cd311177f9/37523/url.png\"\n        srcset=\"/static/472998381523f6f149fb03cd311177f9/e9ff0/url.png 180w,\n/static/472998381523f6f149fb03cd311177f9/f21e7/url.png 360w,\n/static/472998381523f6f149fb03cd311177f9/37523/url.png 720w,\n/static/472998381523f6f149fb03cd311177f9/302a4/url.png 1080w,\n/static/472998381523f6f149fb03cd311177f9/4a00e/url.png 1406w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>여기를 통해서 다음과 같은 모든 이벤트를 처리해야 했다.</p>\n<ul>\n<li>메시지 관련\n<ul>\n<li>새로운 메시지 전송</li>\n<li>메시지 내용 수정</li>\n<li>메시지 삭제</li>\n<li>메시지 댓글을 채널로 다시 전송</li>\n</ul>\n</li>\n<li>공개 채널 관련\n<ul>\n<li>채널 정보(ex.이름) 수정</li>\n<li>채널 삭제</li>\n</ul>\n</li>\n<li>사용자 관련\n<ul>\n<li>사용자 정보(ex.이름, 프로필 사진) 수정</li>\n<li>워크스페이스에 새로운 사용자 입장</li>\n</ul>\n</li>\n</ul>\n<p>보면 알겠지만 전혀 다른 도메인과 그에 따른 요구사항이 섞여있다.</p>\n<h3 id=\"dto-만들-수-있으면-만들어-봐\" style=\"position:relative;\"><a href=\"#dto-%EB%A7%8C%EB%93%A4-%EC%88%98-%EC%9E%88%EC%9C%BC%EB%A9%B4-%EB%A7%8C%EB%93%A4%EC%96%B4-%EB%B4%90\" aria-label=\"dto 만들 수 있으면 만들어 봐 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DTO? 만들 수 있으면 만들어 봐</h3>\n<p>여기다가 형식이 통일됐다면 나았을텐데, 이벤트 특성이 달라서 그런가 들어오는 값이 달라도 너무 달랐다.\n<code class=\"language-text\">DTO</code> 클래스가 아닌 <code class=\"language-text\">Map&lt;String, Object></code>로 요청값을 받는 게 강제된 이유가 이것이다.\n(민감 정보 부분은 대치했다)</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">// 채널명 변경 시 들어오는 값  </span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"token\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"token string\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"team_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"team id string\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"api_app_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"app id string\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"event\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"subtype\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"channel_name\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"ts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1656920324.323089\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"user id string\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"채널 이름을 \\\"4기-공지사항\\\"에서 \\\"4기-공지사항-변경했지요\\\"(으)로 변경했습니다.\"</span><span class=\"token punctuation\">,</span> \n        <span class=\"token property\">\"old_name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4기-공지사항\"</span><span class=\"token punctuation\">,</span> \n        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4기-공지사항-변경했지요\"</span><span class=\"token punctuation\">,</span> \n        <span class=\"token property\">\"channel\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"channel id string\"</span><span class=\"token punctuation\">,</span> \n        <span class=\"token property\">\"event_tannel_type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"channel\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"event_callback\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token property\">\"event_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Ev03MS66TUQP\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token property\">\"event_time\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1656920324\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token property\">\"authorizations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"enterprise_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"null\"</span><span class=\"token punctuation\">,</span> \n            <span class=\"token property\">\"team_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"team id string\"</span><span class=\"token punctuation\">,</span> \n            <span class=\"token property\">\"user_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"user id string\"</span><span class=\"token punctuation\">,</span> \n            <span class=\"token property\">\"is_bot\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span> \n            <span class=\"token property\">\"is_enterprise_install\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"false\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> \n    <span class=\"token property\">\"is_ext_shared_channel\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"false\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token property\">\"event_context\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4-eyJldCI6Im1lc3NhZ2UiLCJ0aWQiOiJUMDNNUzhTOUUzViIsImFpZCI6IkEwM01WRE01UjdDIiwiY2lkIjoiQzAzTjdTU1RVTVAifQ\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 메시지 삭제 시 들어오는 값  </span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"token\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"token string\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token property\">\"team_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"team id string\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token property\">\"api_app_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"app id string\"</span><span class=\"token punctuation\">,</span>  \n    <span class=\"token property\">\"event\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> \n\t\t<span class=\"token property\">\"subtype\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message_deleted\"</span><span class=\"token punctuation\">,</span> \n        <span class=\"token property\">\"previous_message\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"client_msg_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"f226562b-81e0-42ae-ba24-2e68898a7d35\"</span><span class=\"token punctuation\">,</span> \n\t\t\t<span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> \n\t\t\t<span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"안녕하세요?\"</span><span class=\"token punctuation\">,</span> \n\t\t\t<span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"user id string\"</span><span class=\"token punctuation\">,</span> \n\t\t\t<span class=\"token property\">\"ts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1658055738.383439\"</span><span class=\"token punctuation\">,</span> \n\t\t\t<span class=\"token property\">\"team\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"T03MS8S9E3V\"</span><span class=\"token punctuation\">,</span> \n\t\t\t<span class=\"token property\">\"blocks\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n                    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rich_text\"</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token property\">\"block_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"9Ldl\"</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t<span class=\"token property\">\"elements\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n                            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rich_text_section\"</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t\t\t<span class=\"token property\">\"elements\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n                                    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"t\"</span><span class=\"token punctuation\">,</span> \n\t\t\t\t\t\t\t\t\t<span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"안녕하세요?\"</span>\n\t\t\t\t\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"channel\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"channel id string\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"hidden\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"deleted_ts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1658055738.383439\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"event_ts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1658055753.002600\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"ts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1658055753.002600\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"channel_type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"channel\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"event_callback\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"evend\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Ev03PTECHXLK\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"event_time\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1658055753\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"authorizations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"enterprise_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"null\"</span><span class=\"token punctuation\">,</span> \n\t\t<span class=\"token property\">\"team_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"team id string\"</span><span class=\"token punctuation\">,</span> \n\t\t<span class=\"token property\">\"user_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"user id string\"</span><span class=\"token punctuation\">,</span> \n\t\t<span class=\"token property\">\"is_bot\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span> \n\t\t<span class=\"token property\">\"is_enterprise_install\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"false\"</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"is_ext_shared_channel\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"false\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"event_context\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4-eyJldCI6Im1lc3NhZ2UiLCJ0aWQiOiJUMDNNUzhTOUUzViIsImFpZCI6IkEwM01WRE01UjdDIiwiY2lkIjoiQzAzTjdTU1RVTVAifQ\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<h2 id=\"줄줄이-if문을-막아라\" style=\"position:relative;\"><a href=\"#%EC%A4%84%EC%A4%84%EC%9D%B4-if%EB%AC%B8%EC%9D%84-%EB%A7%89%EC%95%84%EB%9D%BC\" aria-label=\"줄줄이 if문을 막아라 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>줄줄이 if문을 막아라</h2>\n<p>이 문제 해결을 위한 방안을 팀원 각자 고민해오기로 했다.\n얘기해보니 크게 두 갈래의 의견이 나왔다.</p>\n<h3 id=\"1-핸들러-이전에-엔드포인트를-분리\" style=\"position:relative;\"><a href=\"#1-%ED%95%B8%EB%93%A4%EB%9F%AC-%EC%9D%B4%EC%A0%84%EC%97%90-%EC%97%94%EB%93%9C%ED%8F%AC%EC%9D%B8%ED%8A%B8%EB%A5%BC-%EB%B6%84%EB%A6%AC\" aria-label=\"1 핸들러 이전에 엔드포인트를 분리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 핸들러 이전에 엔드포인트를 분리</h3>\n<p>첫번째로 제시된 방안은 아예 엔드포인트를 분리하기였다.\n<code class=\"language-text\">HandlerAdapter</code>를 구현하면 가능할 것 같다는 의견이 나왔었다.\n나도 이 방법으로 시도해보았으나, 잘 짜지지 않았다.\n핸들러 매핑 과정에 대한 이해가 부족했던 것 같다.</p>\n<p>다른 팀원은 <code class=\"language-text\">필터</code>로 헤더값을 추가하는 식으로 구현을 해왔다.\n이 방식을 이용하면 컨트롤러 코드는 대략 이렇게 바뀌었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span>headers <span class=\"token operator\">=</span> <span class=\"token string\">\"{type=member-join}\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">saveMember</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    memberService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">noContent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span>headers <span class=\"token operator\">=</span> <span class=\"token string\">\"{type=member-leave}\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">deleteMember</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberLeaveRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    memberService<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">noContent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span>headers <span class=\"token operator\">=</span> <span class=\"token string\">\"{type=posting-write}\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">savePosting</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">PostWriteRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    postService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">noContent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>아마 추가적인 작업으로 컨트롤러도 <code class=\"language-text\">MemberController, PostController...</code>하는 식으로 분리 가능했다.\n메서드를 명확하게 분리 가능하다는 점, <code class=\"language-text\">DTO</code>를 만들 수 있다는 점이 좋았다.</p>\n<br>\n<h3 id=\"2-어쨌든-동일-엔드포인트-내에서-분기-처리\" style=\"position:relative;\"><a href=\"#2-%EC%96%B4%EC%A8%8C%EB%93%A0-%EB%8F%99%EC%9D%BC-%EC%97%94%EB%93%9C%ED%8F%AC%EC%9D%B8%ED%8A%B8-%EB%82%B4%EC%97%90%EC%84%9C-%EB%B6%84%EA%B8%B0-%EC%B2%98%EB%A6%AC\" aria-label=\"2 어쨌든 동일 엔드포인트 내에서 분기 처리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 어쨌든 동일 엔드포인트 내에서 분기 처리</h3>\n<p>두번째로 제시된 방안은 ‘어쨌든 한 엔드포인트로 받은 후, 로직을 <em>깔끔하게</em> 분리 실행하자’였다.\n나는 이 방안을 선호했다.\n1안을 <code class=\"language-text\">HandlerAdapter</code>를 통해 구현 시도하면서 <code class=\"language-text\">inputStream</code>을 통해 읽은 <code class=\"language-text\">body</code>값을 다시 읽을 수 없다는 사실을 알게 되었기 때문이다.\n이를 위해선 <a href=\"https://meetup.toast.com/posts/44\">wrapper를 통해 다시 읽도록 처리</a>하는 추가 작업이 필요했다.\n간단한 방법(비록 if문이 늘어나지만)을 두고 돌아간다는 생각이 들었다.\n거기에 슬랙이 의도를 갖고 보낸 http 요청을 분기 처리를 위해 중간에 조작하는 것이 옳을까? 하는 측면도 있었다.</p>\n<p>얘기 끝에 2번을 시도해보고, 잘 안된다면 1번을 해보자고 결론이 났다.</p>\n<br>  \n<h2 id=\"그래서-어떻게-했느냐면\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9E%98%EC%84%9C-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%96%88%EB%8A%90%EB%83%90%EB%A9%B4\" aria-label=\"그래서 어떻게 했느냐면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그래서 어떻게 했느냐면…</h2>\n<h3 id=\"1-enum으로-이벤트-분리\" style=\"position:relative;\"><a href=\"#1-enum%EC%9C%BC%EB%A1%9C-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EB%B6%84%EB%A6%AC\" aria-label=\"1 enum으로 이벤트 분리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. enum으로 이벤트 분리</h3>\n<p>if문의 처리를 위해 <code class=\"language-text\">Events</code>라는 <code class=\"language-text\">enum</code>을 만들었다.\n<code class=\"language-text\">Map&lt;String, Object></code> 형태의 요청값을 넣어주면, 어떤 요청인지 식별할 수 있게 되었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">Events</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token function\">MEMBER_JOIN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"member\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"join\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">MEMBER_LEAVE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"member\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"leave\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token function\">POSTING_WRITE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"posting\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"write\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">POSTING_EDIT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"posting\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"edit\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">POSTING_DELETE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"posting\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> event<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> subtype<span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Events</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> event<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> subtype<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>event <span class=\"token operator\">=</span> event<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>subtype <span class=\"token operator\">=</span> subtype<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Events</span> <span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> requestBody<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> event <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>requestBody<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"event\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">String</span> type <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> requestBody<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"type\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>events <span class=\"token operator\">-></span> <span class=\"token function\">isSameEvent</span><span class=\"token punctuation\">(</span>events<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">findAny</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NoSuchElementException</span><span class=\"token operator\">::</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isSameEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Events</span> events<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> event<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> events<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> events<span class=\"token punctuation\">.</span>subtype<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"2-각-event를-처리할-객체들의-인터페이스-분리\" style=\"position:relative;\"><a href=\"#2-%EA%B0%81-event%EB%A5%BC-%EC%B2%98%EB%A6%AC%ED%95%A0-%EA%B0%9D%EC%B2%B4%EB%93%A4%EC%9D%98-%EC%9D%B8%ED%84%B0%ED%8E%98%EC%9D%B4%EC%8A%A4-%EB%B6%84%EB%A6%AC\" aria-label=\"2 각 event를 처리할 객체들의 인터페이스 분리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 각 event를 처리할 객체들의 인터페이스 분리</h3>\n<p>이 단계에서 조금 막혔는데, 팀원이 개발바닥 오픈톡방에 질문을 올렸다가 호돌맨님, 형덕님, 승일님이 큰 도움을 주셔서 잘 풀어나갈 수 있었다.\n각 이벤트를 처리할 객체들의 공통 인터페이스를 분리했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">EventService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">void</span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> requestBody<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">isSameEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Events</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"3-event-별로-구현체-작성\" style=\"position:relative;\"><a href=\"#3-event-%EB%B3%84%EB%A1%9C-%EA%B5%AC%ED%98%84%EC%B2%B4-%EC%9E%91%EC%84%B1\" aria-label=\"3 event 별로 구현체 작성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. event 별로 구현체 작성</h3>\n<p>이제 각 이벤트를 처리할 서비스 구현체를 하나씩 만든다.\n예시로 회원 가입을 처리할 구현체를 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberJoinService</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">EventService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> members<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MemberJoinService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> members<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>members <span class=\"token operator\">=</span> members<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> requestBody<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> name <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> requestBody<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isSameEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Events</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Events</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MEMBER_JOIN</span> <span class=\"token operator\">==</span> event<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">isSameEvent</code>로 이 서비스 객체가 <strong>회원 가입</strong>을 처리할 객체임을 식별한다.\n<code class=\"language-text\">execute</code>로 요청값에서 필요값을 추출해 필요한 작업을 한다.</p>\n<h3 id=\"4-모든-eventservice-빈을-컬렉션으로-주입받는-finder-만들기\" style=\"position:relative;\"><a href=\"#4-%EB%AA%A8%EB%93%A0-eventservice-%EB%B9%88%EC%9D%84-%EC%BB%AC%EB%A0%89%EC%85%98%EC%9C%BC%EB%A1%9C-%EC%A3%BC%EC%9E%85%EB%B0%9B%EB%8A%94-finder-%EB%A7%8C%EB%93%A4%EA%B8%B0\" aria-label=\"4 모든 eventservice 빈을 컬렉션으로 주입받는 finder 만들기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 모든 EventService 빈을 컬렉션으로 주입받는 Finder 만들기</h3>\n<p>이제 만들어진 모든 <code class=\"language-text\">EventService</code> 구현체를 <code class=\"language-text\">EventServiceFinder</code>라는 클래스에 모은다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EventServiceFinder</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">EventService</span><span class=\"token punctuation\">></span></span> eventServices<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">EventServiceFinder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">EventService</span><span class=\"token punctuation\">></span></span> eventServices<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>eventServices <span class=\"token operator\">=</span> eventServices<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">EventService</span> <span class=\"token function\">findByEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Events</span> events<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> eventServices<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>service <span class=\"token operator\">-></span> service<span class=\"token punctuation\">.</span><span class=\"token function\">isSameEvent</span><span class=\"token punctuation\">(</span>events<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">findAny</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NoSuchElementException</span><span class=\"token operator\">::</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>빈을 컬렉션으로 주입받는 걸 언제 쓰나 했더니 이럴 때 쓰는 것이었다.\n<a href=\"https://hyewoncc.github.io/wild-seed/\">죽은 지식이 살아나는</a> 또 다른 순간이었다.\n이제 <code class=\"language-text\">findByEvent()</code>를 호출하며 해당 이벤트 <code class=\"language-text\">enum</code>을 넣으면, <code class=\"language-text\">isSameEvent()</code>로 이벤트에 대응되는 서비스가 반환 될 것이다.</p>\n<h3 id=\"5-마침내-컨트롤러에서-사용하기\" style=\"position:relative;\"><a href=\"#5-%EB%A7%88%EC%B9%A8%EB%82%B4-%EC%BB%A8%ED%8A%B8%EB%A1%A4%EB%9F%AC%EC%97%90%EC%84%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"5 마침내 컨트롤러에서 사용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 마침내, 컨트롤러에서 사용하기</h3>\n<p>컨트롤러는 <code class=\"language-text\">EventFinder</code>만 주입받는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/event\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EventController</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">EventServiceFinder</span> serviceFinder<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">EventController</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">EventServiceFinder</span> serviceFinder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>serviceFinder <span class=\"token operator\">=</span> serviceFinder<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        serviceFinder<span class=\"token punctuation\">.</span><span class=\"token function\">findByEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Events</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">noContent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>각 요청값을 처리하는 건 각 서비스 객체의 <code class=\"language-text\">execute()</code>안에 구현되어 있으므로, <code class=\"language-text\">serviceFinder</code>로 찾은 객체에서 <code class=\"language-text\">execute()</code>만 호출하면 된다.\n북잡한 if문의 향연은 <code class=\"language-text\">enum</code>안으로 사라졌다.\n그리고 컨트롤러에서는 <strong>대응되는 서비스를 찾아 처리를 맡긴다</strong>는 깔끔한 맥락만 남았다.</p>\n<p><a href=\"https://github.com/hyewoncc/spring-sandbox/tree/spring/collection-beans\">전체 예제 코드</a>를 깃헙에서 볼 수 있다. <a href=\"https://github.com/hyewoncc/spring-sandbox/blob/spring/collection-beans/src/test/java/sandbox/EventsTest.java\">통합 테스트 코드</a> 실행 시 잘 동작한다.</p>\n<br>\n<h2 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<p>순수한 자체 서비스를 개발했다면 이런 경험을 할 일이 없었을 것이다. 그냥 엔드포인트 분리하고 끝내면 되니까.\n그런데 외부 데이터에 의존하는 기능을 만들다보니 이런 골치아프고 재밌는 일도 겪어본다.</p>\n<p>여담으로, 빈을 컬렉션으로 주입받을 수 있다는 사실이 김영한님 스프링 강의에 있었다고 한다.\n분명 나도 들은 강의인데 연관시켜 해결 할 생각은 전혀 하지 못했다.\n이런 지식 적용의 어려움은 어떻게 풀어나갈 수 있을까 고민이 든다.</p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EA%B0%84%EB%8B%A8%ED%95%9C-%EA%B2%8C%EC%8B%9C%ED%8C%90-%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A5%BC-%EC%83%81%EC%83%81%ED%95%98%EA%B8%B0\">간단한 게시판 서비스를 상상하기</a></p>\n<ul>\n<li><a href=\"#%ED%9A%8C%EC%9B%90-%EA%B0%80%EC%9E%85%EA%B3%BC-%ED%83%88%ED%87%B4\">회원 가입과 탈퇴</a></li>\n<li><a href=\"#%EA%B7%B8%EB%9F%B0%EB%8D%B0-%EC%9D%B4%EC%A0%9C-%EC%97%94%EB%93%9C%ED%8F%AC%EC%9D%B8%ED%8A%B8%EB%A5%BC-%ED%95%98%EB%82%98%EB%A1%9C-%ED%95%98%EA%B3%A0\">그런데 이제 엔드포인트를 하나로 하고</a></li>\n<li><a href=\"#%EC%97%AC%EA%B8%B0%EC%97%90-%ED%8F%AC%EC%8A%A4%ED%8C%85-%EA%B8%B0%EB%8A%A5%EB%8F%84-%EB%AA%BD%EB%95%85-%EB%84%A3%EC%96%B4%EC%A4%98\">여기에 포스팅 기능도 몽땅 넣어줘</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%8A%AC%EB%9E%99-rtm%EB%A6%AC%EC%96%BC%ED%83%80%EC%9E%84-%EB%A9%94%EC%8B%9C%EC%A7%80%EC%99%80%EC%9D%98-%EC%82%AC%ED%88%AC\">슬랙 RTM(리얼타임 메시지)와의 사투</a></p>\n<ul>\n<li><a href=\"#url%EC%9D%84-%ED%95%98%EB%82%98-%EC%A0%9C%EC%B6%9C%ED%95%98%EC%84%B8%EC%9A%94\">url을 하나 제출하세요</a></li>\n<li><a href=\"#dto-%EB%A7%8C%EB%93%A4-%EC%88%98-%EC%9E%88%EC%9C%BC%EB%A9%B4-%EB%A7%8C%EB%93%A4%EC%96%B4-%EB%B4%90\">DTO? 만들 수 있으면 만들어 봐</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%A4%84%EC%A4%84%EC%9D%B4-if%EB%AC%B8%EC%9D%84-%EB%A7%89%EC%95%84%EB%9D%BC\">줄줄이 if문을 막아라</a></p>\n<ul>\n<li><a href=\"#1-%ED%95%B8%EB%93%A4%EB%9F%AC-%EC%9D%B4%EC%A0%84%EC%97%90-%EC%97%94%EB%93%9C%ED%8F%AC%EC%9D%B8%ED%8A%B8%EB%A5%BC-%EB%B6%84%EB%A6%AC\">1. 핸들러 이전에 엔드포인트를 분리</a></li>\n<li><a href=\"#2-%EC%96%B4%EC%A8%8C%EB%93%A0-%EB%8F%99%EC%9D%BC-%EC%97%94%EB%93%9C%ED%8F%AC%EC%9D%B8%ED%8A%B8-%EB%82%B4%EC%97%90%EC%84%9C-%EB%B6%84%EA%B8%B0-%EC%B2%98%EB%A6%AC\">2. 어쨌든 동일 엔드포인트 내에서 분기 처리</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B7%B8%EB%9E%98%EC%84%9C-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%96%88%EB%8A%90%EB%83%90%EB%A9%B4\">그래서 어떻게 했느냐면…</a></p>\n<ul>\n<li><a href=\"#1-enum%EC%9C%BC%EB%A1%9C-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EB%B6%84%EB%A6%AC\">1. enum으로 이벤트 분리</a></li>\n<li><a href=\"#2-%EA%B0%81-event%EB%A5%BC-%EC%B2%98%EB%A6%AC%ED%95%A0-%EA%B0%9D%EC%B2%B4%EB%93%A4%EC%9D%98-%EC%9D%B8%ED%84%B0%ED%8E%98%EC%9D%B4%EC%8A%A4-%EB%B6%84%EB%A6%AC\">2. 각 event를 처리할 객체들의 인터페이스 분리</a></li>\n<li><a href=\"#3-event-%EB%B3%84%EB%A1%9C-%EA%B5%AC%ED%98%84%EC%B2%B4-%EC%9E%91%EC%84%B1\">3. event 별로 구현체 작성</a></li>\n<li><a href=\"#4-%EB%AA%A8%EB%93%A0-eventservice-%EB%B9%88%EC%9D%84-%EC%BB%AC%EB%A0%89%EC%85%98%EC%9C%BC%EB%A1%9C-%EC%A3%BC%EC%9E%85%EB%B0%9B%EB%8A%94-finder-%EB%A7%8C%EB%93%A4%EA%B8%B0\">4. 모든 EventService 빈을 컬렉션으로 주입받는 Finder 만들기</a></li>\n<li><a href=\"#5-%EB%A7%88%EC%B9%A8%EB%82%B4-%EC%BB%A8%ED%8A%B8%EB%A1%A4%EB%9F%AC%EC%97%90%EC%84%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0\">5. 마침내, 컨트롤러에서 사용하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B2%B0%EB%A1%A0\">결론</a></p>\n</li>\n</ul>\n</div>","excerpt":"해당 포스팅은 줍줍 개발 과정 중 맞딱뜨린 문제점과 답을 찾아가는 과정을 다른 방식으로 재구성한 글이다. 생각보다 글이 길어진 고로, 문제상황과 해결방안만 보고싶다면 문제상황 빈 컬렉션 주입을 이용한 해결 예시코드 이 둘을 보기를 권한다. 간단한 게시판 서비스를 상상하기 회원 가입과 탈퇴 당신은 지나가던 고양이의 의뢰로 서버를 개발하게 되었다.\n고양이는 🐱 닉네임을 입력하면 가입이 가능하고, 탈퇴할 수 있는 서비스를 만들어 주세요 💬 라고 요구했다.\n그래서 나는 (그리고 이 글을 볼 대부분의 사람들은) 이건 쉽지~ 하고 간단한 컨트롤러를 만들었다. 그런데 이제 엔드포인트를 하나로 하고 이 코드를 본 고양이가 말했다. 🐱 엔드포인트를 하나로 통일할래요. 그리고 이게 회원 가입인지 탈퇴인지는 body안에 쓸게요. 이렇게요. 💬 코드가 이상해지기 시작한다. 그래도 아직 납득 가능한 수준이다. 여기에 포스팅 기능도 몽땅 넣어줘 이 코드를 본 고양이가 또 요구했다.\n🐱 각자 게시글을 쓰고,…","frontmatter":{"date":"August 27, 2022","title":"[Spring] 모든 요구사항을 한 엔드포인트로 처리해보자! 😂","categories":"Spring 트러블슈팅","author":"써머","emoji":"headers/collection-beans.png"},"fields":{"slug":"/collection-beans/"}},"next":{"id":"5485e17d-94cb-5d24-89c6-9869ebf17fd4","html":"<h2 id=\"long-id--0l-\" style=\"position:relative;\"><a href=\"#long-id--0l-\" aria-label=\"long id  0l  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Long id = 0L ?</h2>\n<p>코틀린을 공부하다 참고하려고 <a href=\"https://github.com/woowacourse/service-apply\">우테코 지원 플랫폼</a>의 코드를 봤다.\n그 중 흥미로운 점을 발견했는데, 엔티티를 생성할 때 <code class=\"language-text\">id</code>를 <code class=\"language-text\">0L</code>로 초기화 하는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Entity</span>\n<span class=\"token keyword\">class</span> <span class=\"token function\">Member</span><span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n  id<span class=\"token operator\">:</span> Long <span class=\"token operator\">=</span> <span class=\"token number\">0L</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>이게 왜 흥미로웠냐면 <a href=\"https://hyewoncc.github.io/2022/08/13/jpa-static-fixture-trouble.html\">상수 픽스쳐 사용 주의</a> 포스팅에서 썼듯이 <code class=\"language-text\">id</code>가 <code class=\"language-text\">null</code>이 아니면 <code class=\"language-text\">merge()</code>를 시행한다고 생각했기 때문이다.\n굳이 <code class=\"language-text\">0L</code>로 초기화하면 <code class=\"language-text\">select</code> 비용만 추가로 들 것 같았다.  <!--more--></p>\n<p>그래서 자바 스프링에서 직접 간단한 엔티티를 만들고, id를 <code class=\"language-text\">0L</code>로 지정해 저장해봤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberJPATest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MemberRepository</span> members<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Long id = 0L 이라면\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token number\">0L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dog\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: \n    select\n        member0_.id as id1_0_0_,\n        member0_.name as name2_0_0_ \n    from\n        member member0_ \n    where\n        member0_.id=?\nHibernate: \n    insert \n    into\n        member\n        (id, name) \n    values\n        (default, ?)\n</code></pre></div>\n<p>실행된 SQL문을 보면, 역시나 <code class=\"language-text\">select</code>문이 <code class=\"language-text\">insert</code>문에 선행되었다.\n<code class=\"language-text\">persist()</code>대신 <code class=\"language-text\">merge()</code>가 수행된 것이다.</p>\n<br>\n<h2 id=\"jpa의-새로운-엔티티-식별법\" style=\"position:relative;\"><a href=\"#jpa%EC%9D%98-%EC%83%88%EB%A1%9C%EC%9A%B4-%EC%97%94%ED%8B%B0%ED%8B%B0-%EC%8B%9D%EB%B3%84%EB%B2%95\" aria-label=\"jpa의 새로운 엔티티 식별법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JPA의 새로운 엔티티 식별법</h2>\n<p><code class=\"language-text\">JPARepository</code> 상속 시 쓰게 되는 구현체인 <code class=\"language-text\">SimpleRepository</code>의 <code class=\"language-text\">save</code>를 다시 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">S</span> <span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">S</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Entity must not be null.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entityInformation<span class=\"token punctuation\">.</span><span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        em<span class=\"token punctuation\">.</span><span class=\"token function\">persist</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> entity<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> em<span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>참 명료한 언어로 잘 짜여있다.\n<code class=\"language-text\">if (entityInformation.isNew(entity))</code>니까 <strong>엔티티가 새로운 엔티티라면</strong> <code class=\"language-text\">persist()</code>를, 아니라면 <code class=\"language-text\">merge()</code>를 수행한다.\n그렇다면 이 <code class=\"language-text\">isNew()</code>는 어디서 가져오는 걸까?</p>\n<p><code class=\"language-text\">isNew()</code>를 구현한 몇 개의 클래스에 디버깅을 걸며 찾아보니 <code class=\"language-text\">AbstractEntityInformation</code>라는 낯선 이름의 클래스에 걸렸다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AbstractEntityInformation</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> ID<span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">EntityInformation</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> ID<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n        <span class=\"token class-name\">ID</span> id <span class=\"token operator\">=</span> <span class=\"token function\">getId</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>ID<span class=\"token punctuation\">></span></span> idType <span class=\"token operator\">=</span> <span class=\"token function\">getIdType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>idType<span class=\"token punctuation\">.</span><span class=\"token function\">isPrimitive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> id <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>id <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Number</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Number</span><span class=\"token punctuation\">)</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">longValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0L</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unsupported primitive id type %s\"</span><span class=\"token punctuation\">,</span> idType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>코드 상 <code class=\"language-text\">isNew()</code>를 판단하는 조건은 다음과 같다.</p>\n<ul>\n<li>엔티티의 <code class=\"language-text\">id</code>가 원시 타입이 아니라면\n<ul>\n<li><code class=\"language-text\">null</code>일 때 새로운 엔티티다</li>\n<li>값이 있을 때 새로운 엔티티가 아니다</li>\n</ul>\n</li>\n<li>엔티티의 <code class=\"language-text\">id</code>가 원시 타입이고, <code class=\"language-text\">getId</code>한 <code class=\"language-text\">id</code>가 래퍼 클래스의 인스턴스라면\n<ul>\n<li>값이 <code class=\"language-text\">0</code>일 때 새로운 엔티티다</li>\n<li>값이 <code class=\"language-text\">0</code>이 아니면 새로운 엔티티가 아니다</li>\n</ul>\n</li>\n</ul>\n<p>처음 읽었을 때 <code class=\"language-text\">id instanceof Number</code>라는 부분이 이상했다.\n위에서 원시값이 아닌 경우를 한번 분기처리 했는데, 왜 다시 <code class=\"language-text\">Number</code>의 인스턴스임을 확인하는 걸까?\n애초에 <code class=\"language-text\">id</code>가 원시값이면 <code class=\"language-text\">Number</code>의 인스턴스가 될 수 없지 않나?\n코드를 읽다 혼란이 와서 <code class=\"language-text\">Number</code>에 대한 정보도 찾아보고 왔다.</p>\n<p>이 의문의 답은 <code class=\"language-text\">Id id = getId(entity)</code>에 있었다. <code class=\"language-text\">getId</code>를 하면서 원시타입의 경우 래퍼 클래스로 바꿔준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">ID</span> <span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ID</span><span class=\"token punctuation\">)</span> persistentEntity<span class=\"token punctuation\">.</span><span class=\"token function\">getIdentifierAccessor</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getIdentifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>굳이 이렇게 번거롭게 처리한 이유는 찾아봤지만 사실 아직 잘 모르겠다…\n어쨌든 여기의 <code class=\"language-text\">ID</code>형은 <code class=\"language-text\">JPARepository</code>를 상속하면서 지정한 형태다.\n따라서 엔티티에서 <code class=\"language-text\">long</code>으로 정의된 <code class=\"language-text\">id</code>는, <code class=\"language-text\">getID</code>를 거쳐 자동으로 <code class=\"language-text\">Long</code>이 된다.</p>\n<p>그럼 <code class=\"language-text\">Long</code>이 아닌 <code class=\"language-text\">long id</code>를 <code class=\"language-text\">0L</code>로 초기화하면 <code class=\"language-text\">persist()</code>가 호출될까?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: \n    insert \n    into\n        member\n        (id, name) \n    values\n        (default, ?)\n</code></pre></div>\n<p>실행 결과 그런 것을 볼 수 있다.</p>\n<p>다시 코틀린 코드로 돌아와서, 코틀린의 <code class=\"language-text\">Long</code>은 자바의 <code class=\"language-text\">Long</code>과 다르게 <code class=\"language-text\">null</code>이 들어갈 수 없다.\n따라서 위 예제처럼 자바에서 <code class=\"language-text\">id</code>의 자료형을 <code class=\"language-text\">long</code>으로 하고, <code class=\"language-text\">0L</code>로 초기화 한 것과 동일하다.</p>\n<h3 id=\"숫자가-아닌-값을-id로-쓰려면\" style=\"position:relative;\"><a href=\"#%EC%88%AB%EC%9E%90%EA%B0%80-%EC%95%84%EB%8B%8C-%EA%B0%92%EC%9D%84-id%EB%A1%9C-%EC%93%B0%EB%A0%A4%EB%A9%B4\" aria-label=\"숫자가 아닌 값을 id로 쓰려면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>숫자가 아닌 값을 id로 쓰려면?</h3>\n<p>줍줍 서비스를 개발하다 슬랙은 식별값으로 문자열을 쓴다는 사실이 기억났다.\n(물론 내부적으로는 숫자 <code class=\"language-text\">id</code>를 쓸 수도 있겠으나…)\n메시지 같은 경우는 수가 많아서 그런지 <a href=\"https://ko.wikipedia.org/wiki/%EB%B2%94%EC%9A%A9_%EA%B3%A0%EC%9C%A0_%EC%8B%9D%EB%B3%84%EC%9E%90\">UUID</a>를 사용한다.\n해당 코드를 본다면 <code class=\"language-text\">id</code>로 UUID를 사용할 경우 <code class=\"language-text\">persist</code>가 호출되지 않을 것 같았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>columnDefinition <span class=\"token operator\">=</span> <span class=\"token string\">\"BINARY(16)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UUID</span> id <span class=\"token operator\">=</span> <span class=\"token constant\">UUID</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberJPATest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MemberRepository</span> members<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UUID id = UUID 랜덤값 이라면\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dog\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: \n    select\n        member0_.id as id1_0_0_,\n        member0_.name as name2_0_0_ \n    from\n        member member0_ \n    where\n        member0_.id=?\nHibernate: \n    insert \n    into\n        member\n        (name, id) \n    values\n        (?, ?)</code></pre></div>\n<p>역시나 <code class=\"language-text\">merge</code>가 호출되어 <code class=\"language-text\">select</code> 후 <code class=\"language-text\">insert</code>가 나갔다.\n그럼 숫자가 아닌 값을 <code class=\"language-text\">id</code>로 사용하려면 성능 저하를 필연적으로 안고 가야 하는 것일까?</p>\n<br>\n<h2 id=\"persistableid-구현으로-내-맘대로-식별시키기\" style=\"position:relative;\"><a href=\"#persistableid-%EA%B5%AC%ED%98%84%EC%9C%BC%EB%A1%9C-%EB%82%B4-%EB%A7%98%EB%8C%80%EB%A1%9C-%EC%8B%9D%EB%B3%84%EC%8B%9C%ED%82%A4%EA%B8%B0\" aria-label=\"persistableid 구현으로 내 맘대로 식별시키기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Persistable<ID> 구현으로 내 맘대로 식별시키기</h2>\n<p>당연히 그럴 리는 없다.\nJPA는 엔티티의 <code class=\"language-text\">isNew()</code>를 개발자 입맛대로 바꿀 수 있도록 <code class=\"language-text\">Persistable&lt;ID></code> 인터페이스를 제공한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Persistable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>UUID<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 모든 <code class=\"language-text\">Member</code>의 인스턴스는 <code class=\"language-text\">save</code> 될 때 마다 새 엔티티로 인식된다.\n실제로 테스트 코드 내에서 <code class=\"language-text\">save</code>를 두 번 호출하면 <code class=\"language-text\">PK</code> 중복으로 에러가 난다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"String id = UUID 랜덤값 이라면\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dog\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>org.springframework.dao.DataIntegrityViolationException: could not execute statement; SQL [n/a]; constraint [“PUBLIC.PRIMARY_KEY_8 ON PUBLIC.MEMBER(ID) VALUES ( /* 1 */ CAST(X’c63865c5bb6e4f16a3d44aa75244dc1a’ AS BINARY(16)) )”; SQL statement:</p>\n</blockquote>\n<p>insert into member (name, id) values (?, ?) [23505-214]]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement</p>\n<p>다른 조건인 <code class=\"language-text\">생성 일자</code>로 <code class=\"language-text\">isNew()</code>를 판단하도록 수정하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Persistable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>UUID<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@CreationTimestamp</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> createdAt<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> createdAt <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이러면 엔티티 최초 생성 시 <code class=\"language-text\">createdAt</code> 값이 생길 것이고, 이 값의 여부로 <code class=\"language-text\">isNew()</code>를 판단한다.\n해당 인터페이스를 구현하면 이제 <code class=\"language-text\">AbstractEntityInformation</code>의 <code class=\"language-text\">isNew()</code>를 완전히 우선해 대체함에 주의해야 한다.<br>\n<code class=\"language-text\">id</code>가 <code class=\"language-text\">null</code>이면 어쩌고… 는 더이상 적용되지 않는다는 뜻이다.</p>\n<h3 id=\"또는-조금-더-간단한-버전\" style=\"position:relative;\"><a href=\"#%EB%98%90%EB%8A%94-%EC%A1%B0%EA%B8%88-%EB%8D%94-%EA%B0%84%EB%8B%A8%ED%95%9C-%EB%B2%84%EC%A0%84\" aria-label=\"또는 조금 더 간단한 버전 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>또는, 조금 더 간단한 버전</h3>\n<p><code class=\"language-text\">isNew()</code> 구현을 위해 얘기하지 않았지만, 사실 UUID도 자동 생성 처리가 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>generator <span class=\"token operator\">=</span> <span class=\"token string\">\"uuid2\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@GenericGenerator</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"uuid2\"</span><span class=\"token punctuation\">,</span> strategy <span class=\"token operator\">=</span> <span class=\"token string\">\"uuid2\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>columnDefinition <span class=\"token operator\">=</span> <span class=\"token string\">\"BINARY(16)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UUID</span> id <span class=\"token operator\">=</span> <span class=\"token constant\">UUID</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>역시 있을 건 거의 이미 다 있다. 바퀴를 새로 발명하지 말자.</p>\n<br>\n<h2 id=\"그-외에도-식별에-영향을-주는-방법\" style=\"position:relative;\"><a href=\"#%EA%B7%B8-%EC%99%B8%EC%97%90%EB%8F%84-%EC%8B%9D%EB%B3%84%EC%97%90-%EC%98%81%ED%96%A5%EC%9D%84-%EC%A3%BC%EB%8A%94-%EB%B0%A9%EB%B2%95\" aria-label=\"그 외에도 식별에 영향을 주는 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그 외에도 식별에 영향을 주는 방법</h2>\n<h3 id=\"version\" style=\"position:relative;\"><a href=\"#version\" aria-label=\"version permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@Version</h3>\n<p>첫번쨰로 <code class=\"language-text\">@Version</code>이 있다. 이 어노테이션은 <code class=\"language-text\">isNew()</code>를 판별하는 용도로 붙이는 건 아니다.\n여기서 다른 클래스가 또 끼어들게 된다. <code class=\"language-text\">JpaMetamodelEntityInformation</code>라는 클래스다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaMetamodelEntityInformation</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> ID<span class=\"token punctuation\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaEntityInformationSupport</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> ID<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>versionAttribute<span class=\"token punctuation\">.</span><span class=\"token function\">isPresent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">||</span> versionAttribute<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Attribute</span><span class=\"token operator\">::</span><span class=\"token function\">getJavaType</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token operator\">::</span><span class=\"token function\">isPrimitive</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token class-name\">BeanWrapper</span> wrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DirectFieldAccessFallbackBeanWrapper</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> versionAttribute<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>it <span class=\"token operator\">-></span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getPropertyValue</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 클래스의 <code class=\"language-text\">if</code>문을 보자. <code class=\"language-text\">@Version</code>이 붙은 값이 존재하지 않거나, 이 값들이 원시 타입이라면 상위의 <code class=\"language-text\">isNew()</code>를 호출한다.\n이 상위 클래스가 <code class=\"language-text\">AbstractEntityInformation</code>이다. 앞서 <code class=\"language-text\">@Version</code>이 없던 경우에도 사실 이 메서드를 한 번 타고 왔던 것이다.</p>\n<p><code class=\"language-text\">@Version</code> 필드가 있고 원시 타입이 아니라면, 이제 이 값으로 <code class=\"language-text\">isNew()</code>를 판단하게 된다.\n이 때도 역시 <code class=\"language-text\">id</code>가 <code class=\"language-text\">null</code>이면 어쩌고… 는 더이상 적용되지 않는다.\n<code class=\"language-text\">@Version</code>이 붙은 필드 값이 <code class=\"language-text\">null</code>인가의 여부로 판단한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Version</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> version<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberJPATest</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MemberRepository</span> members<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id 값이 있어도 @Version이 null 이라면\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dog\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: \n    insert \n    into\n        member\n        (id, name, version) \n    values\n        (default, ?, ?)\n</code></pre></div>\n<p>이 <code class=\"language-text\">@Version</code>은 원래 <code class=\"language-text\">LOCK</code>을 위해 사용된다고 한다.\n<a href=\"https://reiphiel.tistory.com/entry/understanding-jpa-lock\">JPA 잠금(Lock) 이해하기</a> 라는 포스팅에서 상세한 설명을 볼 수 있다.</p>\n<h3 id=\"entityinformation-구현\" style=\"position:relative;\"><a href=\"#entityinformation-%EA%B5%AC%ED%98%84\" aria-label=\"entityinformation 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EntityInformation 구현</h3>\n<p>앞서 <code class=\"language-text\">isNew()</code>가 있었던 구현체들의 상위 인터페이스인 <code class=\"language-text\">EntityInformation</code>을 직접 구현해 <code class=\"language-text\">SimpleJpaRepository</code>에 주입하는 방법이다.\n이 방식은 아직 이해를 제대로 못했다.\n<code class=\"language-text\">SimpleJpaRepository</code>의 생성자에 어떤 방식으로 주입되는지 제대로 파악하고 나서 더 공부해보려 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">SimpleJpaRepository</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaEntityInformation</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> entityInformation<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EntityManager</span> entityManager<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \n    <span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>entityInformation<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JpaEntityInformation must not be null!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>entityManager<span class=\"token punctuation\">,</span> <span class=\"token string\">\"EntityManager must not be null!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// 이 부분을 자신의 구현체로 대체하라는 의미일까? 어떻게...?  </span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>entityInformation <span class=\"token operator\">=</span> entityInformation<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>em <span class=\"token operator\">=</span> entityManager<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>provider <span class=\"token operator\">=</span> <span class=\"token class-name\">PersistenceProvider</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromEntityManager</span><span class=\"token punctuation\">(</span>entityManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>참고한 다른 블로그 포스팅인 <a href=\"https://insanelysimple.tistory.com/300\">spring-data-jpa save 동작 원리</a>에 나와있다.</p>\n<br>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>실제 코드를 탐색한 순서대로 포스팅을 했더니 글이 길어졌다.\n<code class=\"language-text\">EntityInformation</code> 구현을 제외하고, 알아낸 <code class=\"language-text\">isNew()</code>결정 흐름을 정리하자면 다음과 같다.</p>\n<ul>\n<li>엔티티 클래스에서 <strong>Persistable&#x3C;ID></strong> 를 구현했다면, 엔티티 클래스 내의 <strong>isNew()</strong> 로 판단</li>\n<li><strong>JpaMetamodelEntityInformation</strong>의 <strong>isNew()</strong> 가 호출\n<ul>\n<li><strong>@Version</strong>필드가 있고, 해당 값이 원시 타입이 아니라면\n<ul>\n<li>필드가 <strong>null</strong>이라면 <strong>true</strong>, 아니라면 <strong>false</strong> 반환</li>\n</ul>\n</li>\n<li><strong>@Version</strong>필드가 없거나, 해당 값이 원시 타입이라면\n<ul>\n<li><strong>AbstractEntityInformation</strong>의 <strong>isNew()</strong> 가 호출\n<ul>\n<li><strong>id</strong>가 원시 타입이 아니라면\n<ul>\n<li>값이 <strong>null</strong>이라면 <strong>true</strong>, 아니라면 <strong>false</strong> 반환</li>\n</ul>\n</li>\n<li><strong>id</strong>가 숫자값이라면\n<ul>\n<li>값이 <strong>0</strong>이라면  <strong>true</strong>, 아니라면 <strong>false</strong> 반환</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>참으로 복잡한 과정이 숨겨져 있었다.</p>\n<h3 id=\"그-외의-호기심\" style=\"position:relative;\"><a href=\"#%EA%B7%B8-%EC%99%B8%EC%9D%98-%ED%98%B8%EA%B8%B0%EC%8B%AC\" aria-label=\"그 외의 호기심 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그 외의 호기심?</h3>\n<p>코드를 열어보면서 <code class=\"language-text\">IsNewStrategy</code>라는 인터페이스와 구현체들을 발견했는데, 정작 어디 쓰이는지는 알아내지 못했다.\n구현체에는 <code class=\"language-text\">AbstractEntityInformation</code>와 비슷한 로직이 들어있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IsNewStrategy</span> <span class=\"token punctuation\">{</span>\n  \n    <span class=\"token comment\">/**\n    * 새로운 엔티티인지 여부를 반환합니다. 다시 말해, 실제로 저장 됐었는지와는 별개입니다.\n\t  * @param entity must not be {@literal null}.\n\t  * @return\n\t  */</span>\n\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PersistentEntityIsNewStrategy</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IsNewStrategy</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n        <span class=\"token class-name\">Object</span> value <span class=\"token operator\">=</span> valueLookup<span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>valueType <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>valueType<span class=\"token punctuation\">.</span><span class=\"token function\">isPrimitive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Number</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Number</span><span class=\"token punctuation\">)</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">longValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span>\n              <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Could not determine whether %s is new; Unsupported identifier or version property\"</span><span class=\"token punctuation\">,</span> entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 친구들은 또 언제 쓰이는 것인지 더 알아봐야겠다.</p>\n<br>\n<h2 id=\"도움받은-곳들\" style=\"position:relative;\"><a href=\"#%EB%8F%84%EC%9B%80%EB%B0%9B%EC%9D%80-%EA%B3%B3%EB%93%A4\" aria-label=\"도움받은 곳들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>도움받은 곳들</h2>\n<ul>\n<li><a href=\"https://insanelysimple.tistory.com/300\">Simple is best - spring-data-jpa save 동작 원리</a></li>\n</ul>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#long-id--0l-\">Long id = 0L ?</a></p>\n</li>\n<li>\n<p><a href=\"#jpa%EC%9D%98-%EC%83%88%EB%A1%9C%EC%9A%B4-%EC%97%94%ED%8B%B0%ED%8B%B0-%EC%8B%9D%EB%B3%84%EB%B2%95\">JPA의 새로운 엔티티 식별법</a></p>\n<ul>\n<li><a href=\"#%EC%88%AB%EC%9E%90%EA%B0%80-%EC%95%84%EB%8B%8C-%EA%B0%92%EC%9D%84-id%EB%A1%9C-%EC%93%B0%EB%A0%A4%EB%A9%B4\">숫자가 아닌 값을 id로 쓰려면?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#persistableid-%EA%B5%AC%ED%98%84%EC%9C%BC%EB%A1%9C-%EB%82%B4-%EB%A7%98%EB%8C%80%EB%A1%9C-%EC%8B%9D%EB%B3%84%EC%8B%9C%ED%82%A4%EA%B8%B0\">Persistable<ID> 구현으로 내 맘대로 식별시키기</a></p>\n<ul>\n<li><a href=\"#%EB%98%90%EB%8A%94-%EC%A1%B0%EA%B8%88-%EB%8D%94-%EA%B0%84%EB%8B%A8%ED%95%9C-%EB%B2%84%EC%A0%84\">또는, 조금 더 간단한 버전</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B7%B8-%EC%99%B8%EC%97%90%EB%8F%84-%EC%8B%9D%EB%B3%84%EC%97%90-%EC%98%81%ED%96%A5%EC%9D%84-%EC%A3%BC%EB%8A%94-%EB%B0%A9%EB%B2%95\">그 외에도 식별에 영향을 주는 방법</a></p>\n<ul>\n<li><a href=\"#version\">@Version</a></li>\n<li><a href=\"#entityinformation-%EA%B5%AC%ED%98%84\">EntityInformation 구현</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></p>\n<ul>\n<li><a href=\"#%EA%B7%B8-%EC%99%B8%EC%9D%98-%ED%98%B8%EA%B8%B0%EC%8B%AC\">그 외의 호기심?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%8F%84%EC%9B%80%EB%B0%9B%EC%9D%80-%EA%B3%B3%EB%93%A4\">도움받은 곳들</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"August 24, 2022","title":"[JPA]는 새로운 엔티티를 어떻게 알아볼까?","categories":"JPA kotlin","author":"써머","emoji":"headers/jpa-is-new.png"},"fields":{"slug":"/jpa-is-new/"}},"prev":{"id":"ac08bf8d-e5ef-5d99-94e6-aabe22aa7e03","html":"<h1 id=\"문제상황\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\" aria-label=\"문제상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제상황</h1>\n<h2 id=\"초난감-find\" style=\"position:relative;\"><a href=\"#%EC%B4%88%EB%82%9C%EA%B0%90-find\" aria-label=\"초난감 find permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>초난감 find()</h2>\n<p>줍줍은 슬랙 메시지를 날짜이동, 윗방향 스크롤, 아랫방향 스크롤, 단어검색 등 여러 방식으로 볼 수 있다.\n사용자 편의를 위해 여러 복잡한 조회 조건을 주다 보니 백엔드에서 <code class=\"language-text\">Querydsl</code>을 도입했다.</p>\n<h2 id=\"sql과-parameterized-테스트\" style=\"position:relative;\"><a href=\"#sql%EA%B3%BC-parameterized-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"sql과 parameterized 테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@sql과 @Parameterized 테스트</h2>\n<p>해당 부분 개발은 다른 팀원들이 맡았다.\n그래서 올라온 PR을 봤는데, 동작은 잘 했으나 테스트가 알아보기 어려웠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Sql</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"/truncate.sql\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/message.sql\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MessageServiceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> <span class=\"token constant\">MEMBER_ID</span> <span class=\"token operator\">=</span> <span class=\"token number\">1L</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MessageService</span> messageService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"메시지 조회 요청에 따른 메시지가 응답된다\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@MethodSource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"slackMessageRequest\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@ParameterizedTest</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"{0}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">findMessages</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> description<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MessageRequest</span> messageRequest<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> expectedMessageIds<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> expectedLast<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">MessageResponses</span> messageResponses <span class=\"token operator\">=</span> messageService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEMBER_ID</span><span class=\"token punctuation\">,</span> messageRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// when</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MessageResponse</span><span class=\"token punctuation\">></span></span> messages <span class=\"token operator\">=</span> messageResponses<span class=\"token punctuation\">.</span><span class=\"token function\">getMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">boolean</span> last <span class=\"token operator\">=</span> messageResponses<span class=\"token punctuation\">.</span><span class=\"token function\">isLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token function\">assertAll</span><span class=\"token punctuation\">(</span>\n                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>messages<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">extracting</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>expectedMessageIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>last<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>expectedLast<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">slackMessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Stream</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n                <span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"5번 채널에서 메시지ID가 1인 메시지 이후에 작성된 메시지 7개 조회\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">5L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token number\">8L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"쿼리 파라미터가 전혀 전달되지 않았을 경우, 회원의 채널 정렬 상 첫번째 채널의 최신 20개 메시지를 작성시간 내림차순으로 응답해야 한다.\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">emptyList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token number\">38L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">19L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"쿼리 파라미터가 전혀 전달되지 않았을 경우, 회원의 채널 정렬 상 첫번째 채널의 최신 20개 메시지를 작성시간 내림차순으로 응답해야 한다.\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token number\">38L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">19L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> startInclusive<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> endInclusive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">LongStream</span><span class=\"token punctuation\">.</span><span class=\"token function\">rangeClosed</span><span class=\"token punctuation\">(</span>endInclusive<span class=\"token punctuation\">,</span> startInclusive<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">boxed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">sorted</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comparator</span><span class=\"token punctuation\">.</span><span class=\"token function\">reverseOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>처음 테스트를 읽었을 때 왜 읽기 어려웠을까?\n먼저 데이터가 <code class=\"language-text\">@Sql</code>문으로 들어가는 게 그랬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> channel <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> slack_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'임시 채널'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ABC1234'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'공지사항 채널'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'DEF5678'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> member <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> slack_id<span class=\"token punctuation\">,</span> thumbnail_url<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> first_login<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'U03MC231'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'https://summer.png'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'써머'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> channel_subscription<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> view_order<span class=\"token punctuation\">,</span> channel_id<span class=\"token punctuation\">,</span> member_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> message <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> modified_date<span class=\"token punctuation\">,</span> posted_date<span class=\"token punctuation\">,</span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span> member_id<span class=\"token punctuation\">,</span> channel_id<span class=\"token punctuation\">,</span> slack_message_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 14:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 14:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Sample Text'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ABC1231'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 15:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 15:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Sample Text'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ABC1232'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 16:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 16:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Sample Text'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ABC1233'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>콘솔의 한글 이름이 없으면 <code class=\"language-text\">MessageRequest</code>가 어떤 요청인지 알기 어렵다.\n<code class=\"language-text\">createExpectedMessageIds()</code>로 만들어진 메시지 id가 어떤 메시지를 나타내는 지 알기 어렵다.\n비즈니스 로직 상 메시지 내용물이 없는 경우가 있다.\n<code class=\"language-text\">sql</code>문의 데이터를 보기 전에는 어떤 기준으로 걸러지는지 알기가 힘들다.</p>\n<h2 id=\"1차-개선\" style=\"position:relative;\"><a href=\"#1%EC%B0%A8-%EA%B0%9C%EC%84%A0\" aria-label=\"1차 개선 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1차 개선</h2>\n<p>개선하며 아래 포커스를 중점으로 했다.</p>\n<ol>\n<li>복잡한 <code class=\"language-text\">MessageRequest</code> 생성 로직을 메서드로 빼 이름을 붙여, 해당 요청이 어떤 요청인지 알 수 있게 한다.</li>\n<li>비교 대상 메시지를 자바 코드 상으로 필터링 해, 어떤 메시지가 필터링 되었는지 보여준다.</li>\n</ol>\n<p>개별 테스트 케이스 마다 다른 데이터를 적재하고 있다.\n원래 테스트의 의도는 같은 데이터가 있을 때, 의도대로 필터링 되는지다.\n필요한 데이터만을 저장하면 엄격하지 않다.\n또, 비용 측면의 문제도 있다.</p>\n<h2 id=\"2차-개선\" style=\"position:relative;\"><a href=\"#2%EC%B0%A8-%EA%B0%9C%EC%84%A0\" aria-label=\"2차 개선 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2차 개선</h2>\n<p><code class=\"language-text\">@Nested</code>를 사용해 피드백 받은 내용을 개선했다.</p>\n<ol>\n<li>모든 테스트 케이스가 같은 데이터를 공유한다.</li>\n<li>최초 한 번만 데이터를 적재해 비용을 절감한다.</li>\n</ol>\n<p>아직 걸리는 점도 있다.</p>\n<h4 id=\"1-테스트-라이프-사이클을-바꾸면서-테스트-간-격리를-포기했다\" style=\"position:relative;\"><a href=\"#1-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EB%9D%BC%EC%9D%B4%ED%94%84-%EC%82%AC%EC%9D%B4%ED%81%B4%EC%9D%84-%EB%B0%94%EA%BE%B8%EB%A9%B4%EC%84%9C-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EA%B0%84-%EA%B2%A9%EB%A6%AC%EB%A5%BC-%ED%8F%AC%EA%B8%B0%ED%96%88%EB%8B%A4\" aria-label=\"1 테스트 라이프 사이클을 바꾸면서 테스트 간 격리를 포기했다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 테스트 라이프 사이클을 바꾸면서, 테스트 간 격리를 포기했다.</h4>\n<p><code class=\"language-text\">JUnit</code>의 기본 테스트 클래스 라이프 사이클은 <code class=\"language-text\">PER_METHOD</code>이다.\n개별 <code class=\"language-text\">@Test</code> 메서드 마다 새 클래스가 생성되는 전략이다.\n이를 <code class=\"language-text\">PER_CLASS</code>로 바꿔, <code class=\"language-text\">@Nested</code> 내부의 메소드들이 한 클래스 데이터를 공유한다.\n만약 하나의 테스트라도 이 공유 데이터를 수정한다면, 후에 실행되는 모든 테스트가 실패할 것이다.\n<code class=\"language-text\">@Nested</code>안에서 조회만 검증한다는 조건으로 저장에 걸리는 자원을 절약했다.\n팀 컨벤션으로 사용하는 레포지토리 메서드만 선언하기로 했고, <code class=\"language-text\">saveAll()</code>을 선언하지 않았기에, 절약의 의미가 더 컸다.</p>\n<h4 id=\"2-사용하지-않는-구독-변수를-할당했다\" style=\"position:relative;\"><a href=\"#2-%EC%82%AC%EC%9A%A9%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-%EA%B5%AC%EB%8F%85-%EB%B3%80%EC%88%98%EB%A5%BC-%ED%95%A0%EB%8B%B9%ED%96%88%EB%8B%A4\" aria-label=\"2 사용하지 않는 구독 변수를 할당했다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 사용하지 않는 구독 변수를 할당했다.</h4>\n<p><code class=\"language-text\">@BeforeAll</code>을 쓰는 대신에, 인스턴스 변수를 할당하며 필요 정보를 저장했다.\n구독을 저장하기 위해 사용하지 않는 변수를 할당했다.\n원래는 <code class=\"language-text\">subscription.getChannel().getId()</code>하는 식으로 할당된 변수를 사용하려고 했다.\n그런데 <code class=\"language-text\">JPA</code>의 지연 로딩을 사용하고 있었기에, 테스트 메서드 내로 들어와서 <code class=\"language-text\">getChannel()</code>을 호출할 수가 없었다.</p>","frontmatter":{"date":"August 27, 2022","title":"테스트 개선기","categories":"Spring 트러블슈팅","author":"써머","emoji":"headers/collection-beans.png"},"fields":{"slug":"/journey-to-cool-test/"}},"site":{"siteMetadata":{"siteUrl":"https://hyewoncc.github.io","comments":{"utterances":{"repo":"hyewoncc/hyewoncc.github.io"}}}}},"pageContext":{"slug":"/collection-beans/","nextSlug":"/jpa-is-new/","prevSlug":"/journey-to-cool-test/"}},"staticQueryHashes":["1073350324","1956554647","2938748437","3350743975"]}