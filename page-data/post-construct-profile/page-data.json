{"componentChunkName":"component---src-templates-blog-template-js","path":"/post-construct-profile/","result":{"data":{"cur":{"id":"a395fd88-90d0-58b2-8bf7-fe571ae7890e","html":"<h2 id=\"문제상황\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\" aria-label=\"문제상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제상황</h2>\n<h3 id=\"서비스-배경지식\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%B0%B0%EA%B2%BD%EC%A7%80%EC%8B%9D\" aria-label=\"서비스 배경지식 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서비스 배경지식</h3>\n<h4 id=\"첫번째-참고\" style=\"position:relative;\"><a href=\"#%EC%B2%AB%EB%B2%88%EC%A7%B8-%EC%B0%B8%EA%B3%A0\" aria-label=\"첫번째 참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>첫번째 참고</h4>\n<p>현재 개발중인 <a href=\"https://github.com/woowacourse-teams/2022-pickpick\">줍줍</a>은 슬랙 무료 워크스페이스의 사라지는 메세지들을 대신 저장하고 보여주는 서비스다.\n메세지 저장을 위해 최초 어플리케이션 구동 시, 해당 워크스페이스에 속한 모든 회원 정보를 가져온다.\n이 역할을 <code class=\"language-text\">MemberInicializer</code>라는 클래스의 <code class=\"language-text\">@PostContruct</code>안에 작성했다. 이유는 아래와 같았다.   <!--more--></p>\n<ol>\n<li>어플리케이션이 구동하는 동안 발생하는 신규 가입, 탈퇴 이벤트는 실시간 반영이 된다</li>\n<li>하지만 어플리케이션 최초 구동 전, 또는 업데이트 배포로 어플리케이션이 중지된 사이에 발생한 이벤트는 반영이 안된다</li>\n<li>따라서 재구동 시 한 번 슬랙 API를 호출하여, 유저 정보를 업데이트한다</li>\n</ol>\n<p>유저 정보를 메시지에서 참조하고 있어서 저장이 선행되어야 했다.\n또, 로그인 시 이 정보와 <code class=\"language-text\">OAuth</code> 슬랙 로그인으로 받은 정보를 대조해서 자체 토큰을 발급하는 까닭도 있다.</p>\n<br>\n<h4 id=\"두번째-참고\" style=\"position:relative;\"><a href=\"#%EB%91%90%EB%B2%88%EC%A7%B8-%EC%B0%B8%EA%B3%A0\" aria-label=\"두번째 참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>두번째 참고</h4>\n<p>슬랙은 <code class=\"language-text\">MethodClient</code>라는 이름으로 슬랙 API에 HTTP 요청을 보내고 응답을 받는 객체를 제공한다.\n그래서 슬랙 API 호출이 필요한 곳에서는 이 <code class=\"language-text\">MethodClient</code> 빈을 주입받아 사용한다.\n이렇게 만들어진 <code class=\"language-text\">MemberInitializer</code> 코드는 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberInitializer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MemberInitializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>slackClient <span class=\"token operator\">=</span> slackClient<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberRepository <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setupMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SlackApiException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> savedSlackIds <span class=\"token operator\">=</span> <span class=\"token function\">findSavedSlackIds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> currentWorkspaceMembers <span class=\"token operator\">=</span> <span class=\"token function\">fetchWorkspaceMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> membersToSave <span class=\"token operator\">=</span> <span class=\"token function\">filterMembersToSave</span><span class=\"token punctuation\">(</span>savedSlackIds<span class=\"token punctuation\">,</span> currentWorkspaceMembers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span>membersToSave<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">fetchWorkspaceMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SlackApiException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 실제로 슬랙 API 호출이 이뤄지는 부분</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">toMembers</span><span class=\"token punctuation\">(</span>slackClient<span class=\"token punctuation\">.</span><span class=\"token function\">usersList</span><span class=\"token punctuation\">(</span>request <span class=\"token operator\">-></span> request<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">getMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<br>\n<h3 id=\"테스트-시-외부-api-호출을-대체할-mockbean-사용\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C-%EC%99%B8%EB%B6%80-api-%ED%98%B8%EC%B6%9C%EC%9D%84-%EB%8C%80%EC%B2%B4%ED%95%A0-mockbean-%EC%82%AC%EC%9A%A9\" aria-label=\"테스트 시 외부 api 호출을 대체할 mockbean 사용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트 시 외부 API 호출을 대체할 @MockBean 사용</h3>\n<p>테스트에서 실제 슬랙 API를 호출하지 않기 위해 해당 <code class=\"language-text\">MethodClient</code>를 <code class=\"language-text\">@MockBean</code>을 통한 가짜 객체로 바꿔쳤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@AutoConfigureMockMvc</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthServiceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@MockBean</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">void</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SlackApiException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"slackId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"thumbnail.png\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">given</span><span class=\"token punctuation\">(</span>slackClient<span class=\"token punctuation\">.</span><span class=\"token function\">oauthV2Access</span><span class=\"token punctuation\">(</span><span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OAuthV2AccessRequest</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">willReturn</span><span class=\"token punctuation\">(</span><span class=\"token function\">generateOAuthV2AccessResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>사유는 다음과 같다.</p>\n<ol>\n<li>슬랙의 서버 상태에 의존하는 테스트가 된다</li>\n<li>원하는 특정 값 또는 상황을 테스트하기 어렵다</li>\n<li>(아직 걸린 적은 없지만) 호출 제한이 걸릴 수 있다</li>\n</ol>\n<p>참고로 <a href=\"https://api.slack.com/docs/rate-limits\">슬랙 API</a>는 명세 별로 등급에 따라 호출 횟수를 제한한다. <code class=\"language-text\">Tier2</code>의 경우 분당 약 20회로 제한되는데, 테스트가 늘어난다면 충분히 걸릴 수 있는 횟수로 보인다.</p>\n<p>그런데 한 인수테스트에서 <code class=\"language-text\">@MockBean</code>을 선언하자 <code class=\"language-text\">ApplicationContext</code> 로드가 실패했다.</p>\n<blockquote>\n<p>Failed to load ApplicationContext</p>\n</blockquote>\n<p>java.lang.IllegalStateException: Failed to load ApplicationContext\nat org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:132)\nat org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:124)\nat org.springframework.boot.test.mock.mockito.MockitoTestExecutionListener.postProcessFields(MockitoTestExecutionListener.java:110)</p>\n<blockquote>\n<p>…<br>\nCaused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name ‘memberInitializer’: Invocation of init method failed; nested exception is java.lang.NullPointerException</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">at app//org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor.postProcessBeforeInitialization(InitDestroyAnnotationBeanPostProcessor.java:160)  </code></pre></div>\n<blockquote>\n<p>…<br>\nCaused by: java.lang.NullPointerException</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">at com.pickpick.member.application.MemberInitializer.fetchWorkspaceMembers(MemberInitializer.java:46)\nat com.pickpick.member.application.MemberInitializer.setupMember(MemberInitializer.java:31)\nat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)  </code></pre></div>\n<blockquote>\n<p>…</p>\n</blockquote>\n<br>\n<h2 id=\"해결시도\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EC%8B%9C%EB%8F%84\" aria-label=\"해결시도 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결시도</h2>\n<h3 id=\"1-빈-재정의하기\" style=\"position:relative;\"><a href=\"#1-%EB%B9%88-%EC%9E%AC%EC%A0%95%EC%9D%98%ED%95%98%EA%B8%B0\" aria-label=\"1 빈 재정의하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 빈 재정의하기</h3>\n<p><a href=\"https://hyewoncc.github.io/2022/04/25/spring-study-1.html#%EC%9D%BC%EB%8B%A8-%ED%95%B4%EA%B2%B0%EC%9D%80-%ED%96%88%EC%9C%BC%EB%82%98\">예전에 DAO 객체를 테스트 할 때, 실제 DB 대신 HashMap을 이용한 가짜 객체를 사용</a>했다.\n이 때 추출한 인터페이스의 구현체를 빈으로 등록하고, 테스트에서 덮어 씌웠다. 그래서 <code class=\"language-text\">@PostConstruct</code> 내용물이 텅 빈 가짜 클래스를 만들어 해당 방식을 시도했다. 하지만 아랑곳않고 예외가 터졌다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FakeMemberInitializer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MemberInitializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>slackClient <span class=\"token operator\">=</span> slackClient<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberRepository <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setupMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SlackApiException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 텅 빈 메서드  </span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">@PostConstruct</code>의 실행 시점이 문제였다.\n이 방법을 시도하면서 기대한 실행 시점은 아래와 같았다.</p>\n<ol>\n<li><code class=\"language-text\">MemberInitializer</code>가 생성되고, 주입된다</li>\n<li><code class=\"language-text\">FakeMemberInitializer</code>가 덮어 씌워진다</li>\n<li><code class=\"language-text\">FakeMemberInitializer</code>의 텅 빈 <code class=\"language-text\">setupMember()</code>가 호출된다</li>\n</ol>\n<p>그런데 실제로는 <code class=\"language-text\">1-3-2</code>의 순서로 실행되는 것 같았다.\n테스트용 깡통 빈으로 덮어 씌우기 전에 <code class=\"language-text\">@MockBean</code>으로 대치된 <code class=\"language-text\">MethodClient</code>를 사용하니 <code class=\"language-text\">NullPointerException</code>이 발생한 것이었다.</p>\n<br>\n<h3 id=\"2-profile로-생성-막기\" style=\"position:relative;\"><a href=\"#2-profile%EB%A1%9C-%EC%83%9D%EC%84%B1-%EB%A7%89%EA%B8%B0\" aria-label=\"2 profile로 생성 막기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. @Profile로 생성 막기</h3>\n<p><code class=\"language-text\">@PostContruct</code>를 쓰는 한, 빈의 생성 자체를 막아야 한다고 판단했다.\n그래서 <code class=\"language-text\">@Profile</code>을 통해 해당 빈이 프로뎍션 환경에서만 생성되도록 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prod\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberInitializer</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodsClient</span> slackClient<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">@Profile</code>을 도입하는 동시에 다른 팀원의 도움으로 로컬, 개발, 운영 설정의 분리도 함께 이루어졌다. 각 환경에 필요한 <code class=\"language-text\">yml</code> 설정 파일을 지원 형식에 따라 명명했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/ElEQVR42oWQS07DMBRFO6adgMQWEIiAhNRJkzb+xGkauUn8SyCIAbD/PVyw4wZRBgyu9PR8fXzkRUY4Lh8JlgnF6oFimRBcryuspcWdcLhhGreFxdWTwMU9CZ1Vcp5pn/IKiy3l2Owo0pzN2eQUbH+AHt/QGIfWOJS1DPuUMGTE92hMnAlDsY9Av8hCkcZ4KAHnJd77V+h+gLIebNEog0oef9+JMy/PgKdXJyAFZwIfdoTun6Fsj844yE6hsw7HTiNnxWzn72wJ+wfoDd0YDSdg3bSzrTjUoZdFoDf9Azwd+mLBBT7tCDO8QLk+mMlWQbshAMO/7sgP8NvwC5Qq03DZqFV2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ymls\"\n        title=\"\"\n        src=\"/static/78c374a54f2c2f2667643e82d31eddbc/37523/ymls.png\"\n        srcset=\"/static/78c374a54f2c2f2667643e82d31eddbc/e9ff0/ymls.png 180w,\n/static/78c374a54f2c2f2667643e82d31eddbc/f21e7/ymls.png 360w,\n/static/78c374a54f2c2f2667643e82d31eddbc/37523/ymls.png 720w,\n/static/78c374a54f2c2f2667643e82d31eddbc/167b5/ymls.png 776w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그리고 각 배포 스크립트에서 명령어로 어떤 <code class=\"language-text\">profile</code>을 활성화 시킬 것인지 지정해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token parameter variable\">-Dspring.profiles.active</span><span class=\"token operator\">=</span>prod pickpick-0.0.1-SNAPSHOT.jar</code></pre></div>\n<p>생각해보면 이제까지 테스트에서 컨텍스트가 로딩될 때 마다 실제로 호출이 일어나고, 사용하지 않는 데이터가 적재되었다. 로컬 환경에서야 H2니 운영 데이터 오염이나 DB 비용 지불의 문제는 없었다. 하지만 테스트가 늘어났다면 호출 제한에 걸려 실제 운영에 지장을 초래할 수도 있었다. 더 큰 문제가 생기기 전에 <code class=\"language-text\">@Profile</code>을 도입해서 다행이었다.</p>\n<h2 id=\"앞으로의-과제\" style=\"position:relative;\"><a href=\"#%EC%95%9E%EC%9C%BC%EB%A1%9C%EC%9D%98-%EA%B3%BC%EC%A0%9C\" aria-label=\"앞으로의 과제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>앞으로의 과제?</h2>\n<p>보다 실제 상황과 비슷한 테스트를 하려면, 테스트 환경에서도 <code class=\"language-text\">MemberInitializer</code>가 생성되는 게 맞다고 생각한다. 특히 인수 테스트에서 컨텍스트가 처음 생성되었을 때 일부 유저가 저장되고, 이 유저에 대한 프로필 수정, 탈퇴 등의 이벤트가 발생했을 시, 제대로 작동되는지 보면 좋을 것 같다.</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\">문제상황</a></p>\n<ul>\n<li>\n<p><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%B0%B0%EA%B2%BD%EC%A7%80%EC%8B%9D\">서비스 배경지식</a></p>\n<ul>\n<li><a href=\"#%EC%B2%AB%EB%B2%88%EC%A7%B8-%EC%B0%B8%EA%B3%A0\">첫번째 참고</a></li>\n<li><a href=\"#%EB%91%90%EB%B2%88%EC%A7%B8-%EC%B0%B8%EA%B3%A0\">두번째 참고</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C-%EC%99%B8%EB%B6%80-api-%ED%98%B8%EC%B6%9C%EC%9D%84-%EB%8C%80%EC%B2%B4%ED%95%A0-mockbean-%EC%82%AC%EC%9A%A9\">테스트 시 외부 API 호출을 대체할 @MockBean 사용</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%95%B4%EA%B2%B0%EC%8B%9C%EB%8F%84\">해결시도</a></p>\n<ul>\n<li><a href=\"#1-%EB%B9%88-%EC%9E%AC%EC%A0%95%EC%9D%98%ED%95%98%EA%B8%B0\">1. 빈 재정의하기</a></li>\n<li><a href=\"#2-profile%EB%A1%9C-%EC%83%9D%EC%84%B1-%EB%A7%89%EA%B8%B0\">2. @Profile로 생성 막기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%95%9E%EC%9C%BC%EB%A1%9C%EC%9D%98-%EA%B3%BC%EC%A0%9C\">앞으로의 과제?</a></p>\n</li>\n</ul>\n</div>","excerpt":"문제상황 서비스 배경지식 첫번째 참고 현재 개발중인 줍줍은 슬랙 무료 워크스페이스의 사라지는 메세지들을 대신 저장하고 보여주는 서비스다.\n메세지 저장을 위해 최초 어플리케이션 구동 시, 해당 워크스페이스에 속한 모든 회원 정보를 가져온다.\n이 역할을 라는 클래스의 안에 작성했다. 이유는 아래와 같았다.    어플리케이션이 구동하는 동안 발생하는 신규 가입, 탈퇴 이벤트는 실시간 반영이 된다 하지만 어플리케이션 최초 구동 전, 또는 업데이트 배포로 어플리케이션이 중지된 사이에 발생한 이벤트는 반영이 안된다 따라서 재구동 시 한 번 슬랙 API를 호출하여, 유저 정보를 업데이트한다 유저 정보를 메시지에서 참조하고 있어서 저장이 선행되어야 했다.\n또, 로그인 시 이 정보와  슬랙 로그인으로 받은 정보를 대조해서 자체 토큰을 발급하는 까닭도 있다. 두번째 참고 슬랙은 라는 이름으로 슬랙 API에 HTTP 요청을 보내고 응답을 받는 객체를 제공한다.\n그래서 슬랙 API 호출이 필요한 곳에서…","frontmatter":{"date":"August 23, 2022","title":"[Spring] @PostConstruct를 막아라","categories":"Spring 트러블슈팅","author":"써머","emoji":"headers/post-construct-profile.png"},"fields":{"slug":"/post-construct-profile/"}},"next":{"id":"03c0fc33-5407-5104-919a-147585babc6a","html":"<h2 id=\"문제상황\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\" aria-label=\"문제상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제상황</h2>\n<p><a href=\"https://github.com/woowacourse/jwp-qna\">우테코 QNA 미션</a>에서 상수로 선언된 엔티티 픽스쳐가 있었다. 레벨3 같은 팀 크루인 봄이 해당 미션을 진행하다 테스트가 터져 어쩌다보니 같이 원인을 찾게 되었다. 상황을 비슷하게 복구해보자면 이런 구성이었다.  <!--more--></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BlogServiceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">BlogService</span> blogService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">User</span> <span class=\"token constant\">USER_A</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"새로운 회원 저장 후 포스트 저장 1\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">saveUser_savePost1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        blogService<span class=\"token punctuation\">.</span><span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span><span class=\"token constant\">USER_A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        blogService<span class=\"token punctuation\">.</span><span class=\"token function\">savePost</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포스팅1\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">USER_A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"새로운 회원 저장 후 포스트 저장 2\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">saveUser_savePost2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        blogService<span class=\"token punctuation\">.</span><span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span><span class=\"token constant\">USER_A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        blogService<span class=\"token punctuation\">.</span><span class=\"token function\">savePost</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포스팅2\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">USER_A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>원본 미션 코드에서는 픽스쳐가 <code class=\"language-text\">public static final</code>로 별도 클래스에 선언되어 있었다. 그런데 테스트 클래스 하나에서만 사용되고 있어서 해당 클래스로 옮겼던 것 같다. 나도 픽스쳐를 옮겼다가, 평소 쓰는 방식대로 한다고 지웠었다.</p>\n<p>어쨌든 <code class=\"language-text\">User</code>와 <code class=\"language-text\">Post</code>는 <code class=\"language-text\">Post -> User</code>의 단방향 연관관계였고, <code class=\"language-text\">BlogService</code>는 <code class=\"language-text\">UserRepository, PostRepository</code>를 통해 저장해주는 상태였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Post</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">500</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> contents<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">User</span> writer<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그러다 테스트가 터지며 의문의 에러메시지를 마주했다.</p>\n<blockquote>\n<p>org.springframework.dao.DataIntegrityViolationException: could not execute statement; SQL [n/a]; constraint [FK83S99F4KX8OIQM3RO0SASMPWW]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement</p>\n</blockquote>\n<p>좀 더 내려보니 <code class=\"language-text\">insert</code> 수행이 안 되는 상황이었다.</p>\n<blockquote>\n<p>Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Referential integrity constraint violation: “FK83S99F4KX8OIQM3RO0SASMPWW: PUBLIC.POST FOREIGN KEY(USERS_ID) REFERENCES PUBLIC.USERS(ID) (CAST(1 AS BIGINT))”; SQL statement:\ninsert into post (id, contents, user_id) values (default, ?, ?) [23506-214]</p>\n</blockquote>\n<p>무언가 <em><strong>외래키가 없어서 post에 insert가 안 되는 상황인가…?</strong></em> 하는 추측은 했지만 이유를 알 수가 없었다. 분명히 <code class=\"language-text\">@Transactional</code>로 변경을 롤백한 후에, <code class=\"language-text\">saveUser()</code>를 통해 <code class=\"language-text\">USER_A</code>를 저장해줬기 때문이다.</p>\n<br>\n<h3 id=\"추측-1persist와-merge-실행-차이\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EC%B8%A1-1persist%EC%99%80-merge-%EC%8B%A4%ED%96%89-%EC%B0%A8%EC%9D%B4\" aria-label=\"추측 1persist와 merge 실행 차이 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추측 1.persist()와 merge() 실행 차이?</h3>\n<p><code class=\"language-text\">Post</code>를 저장하는데 외래키가 없는 게 맞다면 <code class=\"language-text\">User</code>를 저장할 때 문제가 생기는 것이라 추측했다. 그래서 디버거를 찍으며 따라가다 보니 <code class=\"language-text\">SimpleJpaRepository</code>라는 클래스의 <code class=\"language-text\">save()</code> 메서드에 도착했다. 여기서 **먼저 실행돼 통과하는 테스트는 persist()**를, **나중에 실행돼 실패하는 테스트는 merge()**를 호출하고 있음을 확인했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAxUlEQVR42mXMWW6DMABFUZYSMTnYeLYDVasmIVlCVAHd/zpuBZHSSv04evfrFS5EvFF4p0muxzpDDBYfE9pajNEMXuBtRyfVP1L9UkpRhJDQvSaFzCm/c8pvpJhJKeG9w1qDcdtaoul2QT9tbbYjqejVUzGEQBQ1H7Jlip7PEBhVR+4ESTTEpiK1NamtGMSB8a/jgdSUhKYk7iqKPJ5pLjP69oWZHsj7N/K+0F5nxLQgbyvtddn7OK2IaaU8Ly/VZX6pLzM/Fo9+uwwods4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"call merge\"\n        title=\"\"\n        src=\"/static/26745027aaab5f8593b368764fd9910f/37523/merge.png\"\n        srcset=\"/static/26745027aaab5f8593b368764fd9910f/e9ff0/merge.png 180w,\n/static/26745027aaab5f8593b368764fd9910f/f21e7/merge.png 360w,\n/static/26745027aaab5f8593b368764fd9910f/37523/merge.png 720w,\n/static/26745027aaab5f8593b368764fd9910f/302a4/merge.png 1080w,\n/static/26745027aaab5f8593b368764fd9910f/07a9c/merge.png 1440w,\n/static/26745027aaab5f8593b368764fd9910f/e04e6/merge.png 2152w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그래서 실제로 저장된 적 없는 데이터인데 <code class=\"language-text\">merge()</code>로 처리되어서 들어가지 않는건가? 생각했다. 그런데 <code class=\"language-text\">show_sql</code>을 설정해 콘솔에서 sql문을 보니 <code class=\"language-text\">insert</code>가 실행되고 있었다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABGUlEQVR42lWRyW7DMBBD/TmR7GjfbMtL3AJFkFPPRX+k/XgWM4lT5zAQIBJPQ6q5fv3g4/sXsV+RU4QQEm3bwljH0ykNlSrebp8o7zc4H9CXAm0MrLVQSkEZA+M8zkqjGZcN47qhOyvEGOC9h3wAtbVs8n1FmTekuuKsFHJKCCHwMJSBjrVmWFYM84IQIkrOMMZASgkhBKQQvG1fJ9T1gmGaWc85I8bIGvukZC+dzbhcMMwrrHUIwbOp6zoeMrRthzJOnKLUGTElht219mVegMZapIeZYlOU3cjAZUM/LfwQbUj6Dt1P0p5A5z13QjCKpbVmw3HDvs73auhTtH7CdiDdMZCGCj2dTv+dHIzHyNY5flg8+j3Gpch/gZnewVcSZKYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sql\"\n        title=\"\"\n        src=\"/static/b80d694fac170b44fb688c4f2237ca6f/37523/sql.png\"\n        srcset=\"/static/b80d694fac170b44fb688c4f2237ca6f/e9ff0/sql.png 180w,\n/static/b80d694fac170b44fb688c4f2237ca6f/f21e7/sql.png 360w,\n/static/b80d694fac170b44fb688c4f2237ca6f/37523/sql.png 720w,\n/static/b80d694fac170b44fb688c4f2237ca6f/302a4/sql.png 1080w,\n/static/b80d694fac170b44fb688c4f2237ca6f/07a9c/sql.png 1440w,\n/static/b80d694fac170b44fb688c4f2237ca6f/0330c/sql.png 2458w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>알아보니 <code class=\"language-text\">merge()</code>는 아래 순서로 엔티티를 처리한다고 한다.</p>\n<ol>\n<li>id 값으로 1차 캐시 조회</li>\n<li>1차 캐시에 없다면 <code class=\"language-text\">select</code>문으로 DB에서 조회 후 있다면 1차 캐시에 저장</li>\n<li>조회 결과 마저 없으면 <code class=\"language-text\">insert</code>를 수행</li>\n</ol>\n<br>\n<h3 id=\"추측-2id값이-달라서\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EC%B8%A1-2id%EA%B0%92%EC%9D%B4-%EB%8B%AC%EB%9D%BC%EC%84%9C\" aria-label=\"추측 2id값이 달라서 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추측 2.id값이 달라서?</h3>\n<p>그럼 대체 왜 저장된 값의 PK가 없다고 하는 것일까?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABSUlEQVR42m3JyXKbQACEYV4lh4hNiNUSwwwDM4NYFJyDH8GyokPe//ynRJxKOfHhq67u9pT4wqnaURQRRR5xSAOSQ0iy94mCr4TBjjj0iYOHHdG7bfvHPgrwpHaoztJoQ9NqyrrjUGkyYSiFpTga4kIQV4r9U7tJjpqoaAhzQZAL/KzexGWNl7/cSec3suc7xXqlWq9k3x/9leN6J7tceXr5uUm+3cief2zS9Ua+3kgub4TzdRMvr3jLZWKaDJ1ukEoiGkHT1EzTxHkccFbSd4q2VUgpkLL5j1J/ec4tTJcZe3ao3qI6Q600dlw243Km7XtkZ37/79oH4z7QdsA7mZFUdOTSUCrDQWgK0SLMRCY60qYnV3bLh+xPyp6ytRTKUmpH2ToqPeBJN9PbmVyPZO2Af+zYnzTSTVg3U/UTuR6IhSU49R/4n/gFgq3sgfClNjsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ids\"\n        title=\"\"\n        src=\"/static/2508e47d6c3e3a11b8f2338a3974a28f/37523/different_ids.png\"\n        srcset=\"/static/2508e47d6c3e3a11b8f2338a3974a28f/e9ff0/different_ids.png 180w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/f21e7/different_ids.png 360w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/37523/different_ids.png 720w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/302a4/different_ids.png 1080w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/07a9c/different_ids.png 1440w,\n/static/2508e47d6c3e3a11b8f2338a3974a28f/ec5f6/different_ids.png 1852w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>디버거를 통해 찍어보니, 저장 된 뒤의 id는 <code class=\"language-text\">2L</code>인데 static 픽스쳐의 id는 <code class=\"language-text\">1L</code>이었다. FK로 1L의 값을 넣으니 찾을 수 없어 무결성 제약 조건에 위배되었던 것이다. <code class=\"language-text\">@Transactional</code>로 데이터는 초기화 되었지만, h2에서 id값은 초기화하지 않아서 생긴 문제였다. 생각보다 허망한 이유였다.</p>\n<br>\n<h2 id=\"해결안\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EC%95%88\" aria-label=\"해결안 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결안</h2>\n<h3 id=\"1-픽스쳐-공유하지-않기\" style=\"position:relative;\"><a href=\"#1-%ED%94%BD%EC%8A%A4%EC%B3%90-%EA%B3%B5%EC%9C%A0%ED%95%98%EC%A7%80-%EC%95%8A%EA%B8%B0\" aria-label=\"1 픽스쳐 공유하지 않기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 픽스쳐 공유하지 않기</h3>\n<p>평소 테스트를 할 때 일회용 인스턴트를 쓰고 버리는(?) 방식을 선호했다.</p>\n<ol>\n<li>테스트 격리를 위해 데이터도 격리한다</li>\n<li>생성되는 데이터를 메서드 내에서 바로 보고싶다</li>\n</ol>\n<p>그래서 같은 데이터를 쓰더라도 다 분리했기에 익숙한 형식으로 바꿨다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"새로운 회원 저장 후 포스트 저장 1\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">saveUser_savePost1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blogService<span class=\"token punctuation\">.</span><span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Post</span> post <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포스팅\"</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blogService<span class=\"token punctuation\">.</span><span class=\"token function\">savePost</span><span class=\"token punctuation\">(</span>post<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"새로운 회원 저장 후 포스트 저장 2\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">saveUser_savePost2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blogService<span class=\"token punctuation\">.</span><span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span>useer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Post</span> post <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"포스팅\"</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blogService<span class=\"token punctuation\">.</span><span class=\"token function\">savePost</span><span class=\"token punctuation\">(</span>post<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>솔직히 테스트 픽스쳐를 공유해서 쓰다가 실제로 문제를 마주쳐 봐서 이렇게 한 것은 아니었고… <a href=\"https://jojoldu.tistory.com/611\">테스트 픽스처 올바르게 사용하기 by.향로</a> 이 포스팅을 읽었어서가 크다. 어쨌든 상수 픽스쳐를 사용한 건 처음이었다.</p>\n<br>  \n<h3 id=\"2-generatedvalue-떼기\" style=\"position:relative;\"><a href=\"#2-generatedvalue-%EB%96%BC%EA%B8%B0\" aria-label=\"2 generatedvalue 떼기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. @GeneratedValue 떼기</h3>\n<p>그럼 <code class=\"language-text\">id</code>를 직접 지정해주면 되지 않을까 싶어서 static 픽스쳐에서 지정해주고 <code class=\"language-text\">@GeneratedValue</code>를 제거했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BlogServiceTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Member</span> <span class=\"token constant\">MEMBER_A</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이러니 테스트는 통과했지만 사실 이렇게 짤 일은 없다고 생각한다. 그냥 다른 방법으로도 통과시켜 보려고 해본 것이다.</p>\n<br>\n<h2 id=\"그럼-기존-코드는-왜-\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9F%BC-%EA%B8%B0%EC%A1%B4-%EC%BD%94%EB%93%9C%EB%8A%94-%EC%99%9C-\" aria-label=\"그럼 기존 코드는 왜  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그럼 기존 코드는 왜…? 🤔</h2>\n<p>상수 픽스쳐 선언이 근본적으로 좋지 않은 방식이라면 왜 기존 미션 코드에서 사용하고 있었을까?<br>\n<a href=\"https://github.com/woowacourse/jwp-qna/blob/main/src/test/java/qna/service/QnaServiceTest.java\">기존 서비스 테스트 코드</a>를 보면 서비스를 슬라이스 테스트 하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> delete_성공<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">when</span><span class=\"token punctuation\">(</span>questionRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndDeletedFalse</span><span class=\"token punctuation\">(</span>question<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">thenReturn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>question<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">when</span><span class=\"token punctuation\">(</span>answerRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByQuestionIdAndDeletedFalse</span><span class=\"token punctuation\">(</span>question<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">thenReturn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span>answer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">Repository</code>의 메서드를 모두 모킹하고 있기 때문에 <code class=\"language-text\">JPA</code>와 무관한 테스트였다. 따라서 정말 <em>고정된 값</em>으로써의 상수 픽스쳐를 사용해도 괜찮았던 것이다. 이를 통합 테스트로 바꾸면서 생긴 문제였다.</p>\n<p>테스트 간 데이터 격리가 중요하다는 말이 맞는 말이긴 하지만, 이전까진 고정관념처럼 무작정 받아들여 박혀있었다. 그런데 이번 문제를 맞딱드리면서 고정관념이 아닌 <em>진짜 나의 생각</em>이 된 것 같아 좋았다. 어쨌든, 테스트 격리 잘 하자.</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\">문제상황</a></p>\n<ul>\n<li><a href=\"#%EC%B6%94%EC%B8%A1-1persist%EC%99%80-merge-%EC%8B%A4%ED%96%89-%EC%B0%A8%EC%9D%B4\">추측 1.persist()와 merge() 실행 차이?</a></li>\n<li><a href=\"#%EC%B6%94%EC%B8%A1-2id%EA%B0%92%EC%9D%B4-%EB%8B%AC%EB%9D%BC%EC%84%9C\">추측 2.id값이 달라서?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%95%B4%EA%B2%B0%EC%95%88\">해결안</a></p>\n<ul>\n<li><a href=\"#1-%ED%94%BD%EC%8A%A4%EC%B3%90-%EA%B3%B5%EC%9C%A0%ED%95%98%EC%A7%80-%EC%95%8A%EA%B8%B0\">1. 픽스쳐 공유하지 않기</a></li>\n<li><a href=\"#2-generatedvalue-%EB%96%BC%EA%B8%B0\">2. @GeneratedValue 떼기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B7%B8%EB%9F%BC-%EA%B8%B0%EC%A1%B4-%EC%BD%94%EB%93%9C%EB%8A%94-%EC%99%9C-\">그럼 기존 코드는 왜…? 🤔</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"August 13, 2022","title":"[JPA] 상수 픽스쳐 사용 주의","categories":"JPA 트러블슈팅","author":"써머","emoji":"headers/jpa-static-fixture-trouble.png"},"fields":{"slug":"/jpa-static-fixture-trouble/"}},"prev":{"id":"1f626f64-8318-5c6b-94bd-c6195b09497f","html":"<h2 id=\"long-id--0l-\" style=\"position:relative;\"><a href=\"#long-id--0l-\" aria-label=\"long id  0l  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Long id = 0L ?</h2>\n<p>코틀린을 공부하다 참고하려고 <a href=\"https://github.com/woowacourse/service-apply\">우테코 지원 플랫폼</a>의 코드를 봤다.\n그 중 흥미로운 점을 발견했는데, 엔티티를 생성할 때 <code class=\"language-text\">id</code>를 <code class=\"language-text\">0L</code>로 초기화 하는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Entity</span>\n<span class=\"token keyword\">class</span> <span class=\"token function\">Member</span><span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n  id<span class=\"token operator\">:</span> Long <span class=\"token operator\">=</span> <span class=\"token number\">0L</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>이게 왜 흥미로웠냐면 <a href=\"https://hyewoncc.github.io/2022/08/13/jpa-static-fixture-trouble.html\">상수 픽스쳐 사용 주의</a> 포스팅에서 썼듯이 <code class=\"language-text\">id</code>가 <code class=\"language-text\">null</code>이 아니면 <code class=\"language-text\">merge()</code>를 시행한다고 생각했기 때문이다.\n굳이 <code class=\"language-text\">0L</code>로 초기화하면 <code class=\"language-text\">select</code> 비용만 추가로 들 것 같았다.  <!--more--></p>\n<p>그래서 자바 스프링에서 직접 간단한 엔티티를 만들고, id를 <code class=\"language-text\">0L</code>로 지정해 저장해봤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberJPATest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MemberRepository</span> members<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Long id = 0L 이라면\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token number\">0L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dog\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: \n    select\n        member0_.id as id1_0_0_,\n        member0_.name as name2_0_0_ \n    from\n        member member0_ \n    where\n        member0_.id=?\nHibernate: \n    insert \n    into\n        member\n        (id, name) \n    values\n        (default, ?)\n</code></pre></div>\n<p>실행된 SQL문을 보면, 역시나 <code class=\"language-text\">select</code>문이 <code class=\"language-text\">insert</code>문에 선행되었다.\n<code class=\"language-text\">persist()</code>대신 <code class=\"language-text\">merge()</code>가 수행된 것이다.</p>\n<br>\n<h2 id=\"jpa의-새로운-엔티티-식별법\" style=\"position:relative;\"><a href=\"#jpa%EC%9D%98-%EC%83%88%EB%A1%9C%EC%9A%B4-%EC%97%94%ED%8B%B0%ED%8B%B0-%EC%8B%9D%EB%B3%84%EB%B2%95\" aria-label=\"jpa의 새로운 엔티티 식별법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JPA의 새로운 엔티티 식별법</h2>\n<p><code class=\"language-text\">JPARepository</code> 상속 시 쓰게 되는 구현체인 <code class=\"language-text\">SimpleRepository</code>의 <code class=\"language-text\">save</code>를 다시 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">S</span> <span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">S</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Entity must not be null.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entityInformation<span class=\"token punctuation\">.</span><span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        em<span class=\"token punctuation\">.</span><span class=\"token function\">persist</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> entity<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> em<span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>참 명료한 언어로 잘 짜여있다.\n<code class=\"language-text\">if (entityInformation.isNew(entity))</code>니까 <strong>엔티티가 새로운 엔티티라면</strong> <code class=\"language-text\">persist()</code>를, 아니라면 <code class=\"language-text\">merge()</code>를 수행한다.\n그렇다면 이 <code class=\"language-text\">isNew()</code>는 어디서 가져오는 걸까?</p>\n<p><code class=\"language-text\">isNew()</code>를 구현한 몇 개의 클래스에 디버깅을 걸며 찾아보니 <code class=\"language-text\">AbstractEntityInformation</code>라는 낯선 이름의 클래스에 걸렸다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AbstractEntityInformation</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> ID<span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">EntityInformation</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> ID<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n        <span class=\"token class-name\">ID</span> id <span class=\"token operator\">=</span> <span class=\"token function\">getId</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>ID<span class=\"token punctuation\">></span></span> idType <span class=\"token operator\">=</span> <span class=\"token function\">getIdType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>idType<span class=\"token punctuation\">.</span><span class=\"token function\">isPrimitive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> id <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>id <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Number</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Number</span><span class=\"token punctuation\">)</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">longValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0L</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unsupported primitive id type %s\"</span><span class=\"token punctuation\">,</span> idType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>코드 상 <code class=\"language-text\">isNew()</code>를 판단하는 조건은 다음과 같다.</p>\n<ul>\n<li>엔티티의 <code class=\"language-text\">id</code>가 원시 타입이 아니라면\n<ul>\n<li><code class=\"language-text\">null</code>일 때 새로운 엔티티다</li>\n<li>값이 있을 때 새로운 엔티티가 아니다</li>\n</ul>\n</li>\n<li>엔티티의 <code class=\"language-text\">id</code>가 원시 타입이고, <code class=\"language-text\">getId</code>한 <code class=\"language-text\">id</code>가 래퍼 클래스의 인스턴스라면\n<ul>\n<li>값이 <code class=\"language-text\">0</code>일 때 새로운 엔티티다</li>\n<li>값이 <code class=\"language-text\">0</code>이 아니면 새로운 엔티티가 아니다</li>\n</ul>\n</li>\n</ul>\n<p>처음 읽었을 때 <code class=\"language-text\">id instanceof Number</code>라는 부분이 이상했다.\n위에서 원시값이 아닌 경우를 한번 분기처리 했는데, 왜 다시 <code class=\"language-text\">Number</code>의 인스턴스임을 확인하는 걸까?\n애초에 <code class=\"language-text\">id</code>가 원시값이면 <code class=\"language-text\">Number</code>의 인스턴스가 될 수 없지 않나?\n코드를 읽다 혼란이 와서 <code class=\"language-text\">Number</code>에 대한 정보도 찾아보고 왔다.</p>\n<p>이 의문의 답은 <code class=\"language-text\">Id id = getId(entity)</code>에 있었다. <code class=\"language-text\">getId</code>를 하면서 원시타입의 경우 래퍼 클래스로 바꿔준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">ID</span> <span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ID</span><span class=\"token punctuation\">)</span> persistentEntity<span class=\"token punctuation\">.</span><span class=\"token function\">getIdentifierAccessor</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getIdentifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>굳이 이렇게 번거롭게 처리한 이유는 찾아봤지만 사실 아직 잘 모르겠다…\n어쨌든 여기의 <code class=\"language-text\">ID</code>형은 <code class=\"language-text\">JPARepository</code>를 상속하면서 지정한 형태다.\n따라서 엔티티에서 <code class=\"language-text\">long</code>으로 정의된 <code class=\"language-text\">id</code>는, <code class=\"language-text\">getID</code>를 거쳐 자동으로 <code class=\"language-text\">Long</code>이 된다.</p>\n<p>그럼 <code class=\"language-text\">Long</code>이 아닌 <code class=\"language-text\">long id</code>를 <code class=\"language-text\">0L</code>로 초기화하면 <code class=\"language-text\">persist()</code>가 호출될까?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: \n    insert \n    into\n        member\n        (id, name) \n    values\n        (default, ?)\n</code></pre></div>\n<p>실행 결과 그런 것을 볼 수 있다.</p>\n<p>다시 코틀린 코드로 돌아와서, 코틀린의 <code class=\"language-text\">Long</code>은 자바의 <code class=\"language-text\">Long</code>과 다르게 <code class=\"language-text\">null</code>이 들어갈 수 없다.\n따라서 위 예제처럼 자바에서 <code class=\"language-text\">id</code>의 자료형을 <code class=\"language-text\">long</code>으로 하고, <code class=\"language-text\">0L</code>로 초기화 한 것과 동일하다.</p>\n<h3 id=\"숫자가-아닌-값을-id로-쓰려면\" style=\"position:relative;\"><a href=\"#%EC%88%AB%EC%9E%90%EA%B0%80-%EC%95%84%EB%8B%8C-%EA%B0%92%EC%9D%84-id%EB%A1%9C-%EC%93%B0%EB%A0%A4%EB%A9%B4\" aria-label=\"숫자가 아닌 값을 id로 쓰려면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>숫자가 아닌 값을 id로 쓰려면?</h3>\n<p>줍줍 서비스를 개발하다 슬랙은 식별값으로 문자열을 쓴다는 사실이 기억났다.\n(물론 내부적으로는 숫자 <code class=\"language-text\">id</code>를 쓸 수도 있겠으나…)\n메시지 같은 경우는 수가 많아서 그런지 <a href=\"https://ko.wikipedia.org/wiki/%EB%B2%94%EC%9A%A9_%EA%B3%A0%EC%9C%A0_%EC%8B%9D%EB%B3%84%EC%9E%90\">UUID</a>를 사용한다.\n해당 코드를 본다면 <code class=\"language-text\">id</code>로 UUID를 사용할 경우 <code class=\"language-text\">persist</code>가 호출되지 않을 것 같았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>columnDefinition <span class=\"token operator\">=</span> <span class=\"token string\">\"BINARY(16)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UUID</span> id <span class=\"token operator\">=</span> <span class=\"token constant\">UUID</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>length <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberJPATest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MemberRepository</span> members<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UUID id = UUID 랜덤값 이라면\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dog\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: \n    select\n        member0_.id as id1_0_0_,\n        member0_.name as name2_0_0_ \n    from\n        member member0_ \n    where\n        member0_.id=?\nHibernate: \n    insert \n    into\n        member\n        (name, id) \n    values\n        (?, ?)</code></pre></div>\n<p>역시나 <code class=\"language-text\">merge</code>가 호출되어 <code class=\"language-text\">select</code> 후 <code class=\"language-text\">insert</code>가 나갔다.\n그럼 숫자가 아닌 값을 <code class=\"language-text\">id</code>로 사용하려면 성능 저하를 필연적으로 안고 가야 하는 것일까?</p>\n<br>\n<h2 id=\"persistableid-구현으로-내-맘대로-식별시키기\" style=\"position:relative;\"><a href=\"#persistableid-%EA%B5%AC%ED%98%84%EC%9C%BC%EB%A1%9C-%EB%82%B4-%EB%A7%98%EB%8C%80%EB%A1%9C-%EC%8B%9D%EB%B3%84%EC%8B%9C%ED%82%A4%EA%B8%B0\" aria-label=\"persistableid 구현으로 내 맘대로 식별시키기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Persistable<ID> 구현으로 내 맘대로 식별시키기</h2>\n<p>당연히 그럴 리는 없다.\nJPA는 엔티티의 <code class=\"language-text\">isNew()</code>를 개발자 입맛대로 바꿀 수 있도록 <code class=\"language-text\">Persistable&lt;ID></code> 인터페이스를 제공한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Persistable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>UUID<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 모든 <code class=\"language-text\">Member</code>의 인스턴스는 <code class=\"language-text\">save</code> 될 때 마다 새 엔티티로 인식된다.\n실제로 테스트 코드 내에서 <code class=\"language-text\">save</code>를 두 번 호출하면 <code class=\"language-text\">PK</code> 중복으로 에러가 난다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"String id = UUID 랜덤값 이라면\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dog\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>org.springframework.dao.DataIntegrityViolationException: could not execute statement; SQL [n/a]; constraint [“PUBLIC.PRIMARY_KEY_8 ON PUBLIC.MEMBER(ID) VALUES ( /* 1 */ CAST(X’c63865c5bb6e4f16a3d44aa75244dc1a’ AS BINARY(16)) )”; SQL statement:</p>\n</blockquote>\n<p>insert into member (name, id) values (?, ?) [23505-214]]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement</p>\n<p>다른 조건인 <code class=\"language-text\">생성 일자</code>로 <code class=\"language-text\">isNew()</code>를 판단하도록 수정하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Persistable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>UUID<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@CreationTimestamp</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> createdAt<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> createdAt <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이러면 엔티티 최초 생성 시 <code class=\"language-text\">createdAt</code> 값이 생길 것이고, 이 값의 여부로 <code class=\"language-text\">isNew()</code>를 판단한다.\n해당 인터페이스를 구현하면 이제 <code class=\"language-text\">AbstractEntityInformation</code>의 <code class=\"language-text\">isNew()</code>를 완전히 우선해 대체함에 주의해야 한다.<br>\n<code class=\"language-text\">id</code>가 <code class=\"language-text\">null</code>이면 어쩌고… 는 더이상 적용되지 않는다는 뜻이다.</p>\n<h3 id=\"또는-조금-더-간단한-버전\" style=\"position:relative;\"><a href=\"#%EB%98%90%EB%8A%94-%EC%A1%B0%EA%B8%88-%EB%8D%94-%EA%B0%84%EB%8B%A8%ED%95%9C-%EB%B2%84%EC%A0%84\" aria-label=\"또는 조금 더 간단한 버전 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>또는, 조금 더 간단한 버전</h3>\n<p><code class=\"language-text\">isNew()</code> 구현을 위해 얘기하지 않았지만, 사실 UUID도 자동 생성 처리가 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>generator <span class=\"token operator\">=</span> <span class=\"token string\">\"uuid2\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@GenericGenerator</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"uuid2\"</span><span class=\"token punctuation\">,</span> strategy <span class=\"token operator\">=</span> <span class=\"token string\">\"uuid2\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>columnDefinition <span class=\"token operator\">=</span> <span class=\"token string\">\"BINARY(16)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UUID</span> id <span class=\"token operator\">=</span> <span class=\"token constant\">UUID</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>역시 있을 건 거의 이미 다 있다. 바퀴를 새로 발명하지 말자.</p>\n<br>\n<h2 id=\"그-외에도-식별에-영향을-주는-방법\" style=\"position:relative;\"><a href=\"#%EA%B7%B8-%EC%99%B8%EC%97%90%EB%8F%84-%EC%8B%9D%EB%B3%84%EC%97%90-%EC%98%81%ED%96%A5%EC%9D%84-%EC%A3%BC%EB%8A%94-%EB%B0%A9%EB%B2%95\" aria-label=\"그 외에도 식별에 영향을 주는 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그 외에도 식별에 영향을 주는 방법</h2>\n<h3 id=\"version\" style=\"position:relative;\"><a href=\"#version\" aria-label=\"version permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@Version</h3>\n<p>첫번쨰로 <code class=\"language-text\">@Version</code>이 있다. 이 어노테이션은 <code class=\"language-text\">isNew()</code>를 판별하는 용도로 붙이는 건 아니다.\n여기서 다른 클래스가 또 끼어들게 된다. <code class=\"language-text\">JpaMetamodelEntityInformation</code>라는 클래스다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaMetamodelEntityInformation</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> ID<span class=\"token punctuation\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaEntityInformationSupport</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> ID<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>versionAttribute<span class=\"token punctuation\">.</span><span class=\"token function\">isPresent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">||</span> versionAttribute<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Attribute</span><span class=\"token operator\">::</span><span class=\"token function\">getJavaType</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token operator\">::</span><span class=\"token function\">isPrimitive</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token class-name\">BeanWrapper</span> wrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DirectFieldAccessFallbackBeanWrapper</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> versionAttribute<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>it <span class=\"token operator\">-></span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getPropertyValue</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 클래스의 <code class=\"language-text\">if</code>문을 보자. <code class=\"language-text\">@Version</code>이 붙은 값이 존재하지 않거나, 이 값들이 원시 타입이라면 상위의 <code class=\"language-text\">isNew()</code>를 호출한다.\n이 상위 클래스가 <code class=\"language-text\">AbstractEntityInformation</code>이다. 앞서 <code class=\"language-text\">@Version</code>이 없던 경우에도 사실 이 메서드를 한 번 타고 왔던 것이다.</p>\n<p><code class=\"language-text\">@Version</code> 필드가 있고 원시 타입이 아니라면, 이제 이 값으로 <code class=\"language-text\">isNew()</code>를 판단하게 된다.\n이 때도 역시 <code class=\"language-text\">id</code>가 <code class=\"language-text\">null</code>이면 어쩌고… 는 더이상 적용되지 않는다.\n<code class=\"language-text\">@Version</code>이 붙은 필드 값이 <code class=\"language-text\">null</code>인가의 여부로 판단한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Version</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> version<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberJPATest</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MemberRepository</span> members<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id 값이 있어도 @Version이 null 이라면\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dog\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate: \n    insert \n    into\n        member\n        (id, name, version) \n    values\n        (default, ?, ?)\n</code></pre></div>\n<p>이 <code class=\"language-text\">@Version</code>은 원래 <code class=\"language-text\">LOCK</code>을 위해 사용된다고 한다.\n<a href=\"https://reiphiel.tistory.com/entry/understanding-jpa-lock\">JPA 잠금(Lock) 이해하기</a> 라는 포스팅에서 상세한 설명을 볼 수 있다.</p>\n<h3 id=\"entityinformation-구현\" style=\"position:relative;\"><a href=\"#entityinformation-%EA%B5%AC%ED%98%84\" aria-label=\"entityinformation 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EntityInformation 구현</h3>\n<p>앞서 <code class=\"language-text\">isNew()</code>가 있었던 구현체들의 상위 인터페이스인 <code class=\"language-text\">EntityInformation</code>을 직접 구현해 <code class=\"language-text\">SimpleJpaRepository</code>에 주입하는 방법이다.\n이 방식은 아직 이해를 제대로 못했다.\n<code class=\"language-text\">SimpleJpaRepository</code>의 생성자에 어떤 방식으로 주입되는지 제대로 파악하고 나서 더 공부해보려 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">SimpleJpaRepository</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaEntityInformation</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> entityInformation<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EntityManager</span> entityManager<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \n    <span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>entityInformation<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JpaEntityInformation must not be null!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>entityManager<span class=\"token punctuation\">,</span> <span class=\"token string\">\"EntityManager must not be null!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// 이 부분을 자신의 구현체로 대체하라는 의미일까? 어떻게...?  </span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>entityInformation <span class=\"token operator\">=</span> entityInformation<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>em <span class=\"token operator\">=</span> entityManager<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>provider <span class=\"token operator\">=</span> <span class=\"token class-name\">PersistenceProvider</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromEntityManager</span><span class=\"token punctuation\">(</span>entityManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>참고한 다른 블로그 포스팅인 <a href=\"https://insanelysimple.tistory.com/300\">spring-data-jpa save 동작 원리</a>에 나와있다.</p>\n<br>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>실제 코드를 탐색한 순서대로 포스팅을 했더니 글이 길어졌다.\n<code class=\"language-text\">EntityInformation</code> 구현을 제외하고, 알아낸 <code class=\"language-text\">isNew()</code>결정 흐름을 정리하자면 다음과 같다.</p>\n<ul>\n<li>엔티티 클래스에서 <strong>Persistable&#x3C;ID></strong> 를 구현했다면, 엔티티 클래스 내의 <strong>isNew()</strong> 로 판단</li>\n<li><strong>JpaMetamodelEntityInformation</strong>의 <strong>isNew()</strong> 가 호출\n<ul>\n<li><strong>@Version</strong>필드가 있고, 해당 값이 원시 타입이 아니라면\n<ul>\n<li>필드가 <strong>null</strong>이라면 <strong>true</strong>, 아니라면 <strong>false</strong> 반환</li>\n</ul>\n</li>\n<li><strong>@Version</strong>필드가 없거나, 해당 값이 원시 타입이라면\n<ul>\n<li><strong>AbstractEntityInformation</strong>의 <strong>isNew()</strong> 가 호출\n<ul>\n<li><strong>id</strong>가 원시 타입이 아니라면\n<ul>\n<li>값이 <strong>null</strong>이라면 <strong>true</strong>, 아니라면 <strong>false</strong> 반환</li>\n</ul>\n</li>\n<li><strong>id</strong>가 숫자값이라면\n<ul>\n<li>값이 <strong>0</strong>이라면  <strong>true</strong>, 아니라면 <strong>false</strong> 반환</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>참으로 복잡한 과정이 숨겨져 있었다.</p>\n<h3 id=\"그-외의-호기심\" style=\"position:relative;\"><a href=\"#%EA%B7%B8-%EC%99%B8%EC%9D%98-%ED%98%B8%EA%B8%B0%EC%8B%AC\" aria-label=\"그 외의 호기심 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그 외의 호기심?</h3>\n<p>코드를 열어보면서 <code class=\"language-text\">IsNewStrategy</code>라는 인터페이스와 구현체들을 발견했는데, 정작 어디 쓰이는지는 알아내지 못했다.\n구현체에는 <code class=\"language-text\">AbstractEntityInformation</code>와 비슷한 로직이 들어있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IsNewStrategy</span> <span class=\"token punctuation\">{</span>\n  \n    <span class=\"token comment\">/**\n    * 새로운 엔티티인지 여부를 반환합니다. 다시 말해, 실제로 저장 됐었는지와는 별개입니다.\n\t  * @param entity must not be {@literal null}.\n\t  * @return\n\t  */</span>\n\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PersistentEntityIsNewStrategy</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IsNewStrategy</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> entity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n        <span class=\"token class-name\">Object</span> value <span class=\"token operator\">=</span> valueLookup<span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>valueType <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>valueType<span class=\"token punctuation\">.</span><span class=\"token function\">isPrimitive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Number</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Number</span><span class=\"token punctuation\">)</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">longValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span>\n              <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Could not determine whether %s is new; Unsupported identifier or version property\"</span><span class=\"token punctuation\">,</span> entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 친구들은 또 언제 쓰이는 것인지 더 알아봐야겠다.</p>\n<br>\n<h2 id=\"도움받은-곳들\" style=\"position:relative;\"><a href=\"#%EB%8F%84%EC%9B%80%EB%B0%9B%EC%9D%80-%EA%B3%B3%EB%93%A4\" aria-label=\"도움받은 곳들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>도움받은 곳들</h2>\n<ul>\n<li><a href=\"https://insanelysimple.tistory.com/300\">Simple is best - spring-data-jpa save 동작 원리</a></li>\n</ul>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#long-id--0l-\">Long id = 0L ?</a></p>\n</li>\n<li>\n<p><a href=\"#jpa%EC%9D%98-%EC%83%88%EB%A1%9C%EC%9A%B4-%EC%97%94%ED%8B%B0%ED%8B%B0-%EC%8B%9D%EB%B3%84%EB%B2%95\">JPA의 새로운 엔티티 식별법</a></p>\n<ul>\n<li><a href=\"#%EC%88%AB%EC%9E%90%EA%B0%80-%EC%95%84%EB%8B%8C-%EA%B0%92%EC%9D%84-id%EB%A1%9C-%EC%93%B0%EB%A0%A4%EB%A9%B4\">숫자가 아닌 값을 id로 쓰려면?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#persistableid-%EA%B5%AC%ED%98%84%EC%9C%BC%EB%A1%9C-%EB%82%B4-%EB%A7%98%EB%8C%80%EB%A1%9C-%EC%8B%9D%EB%B3%84%EC%8B%9C%ED%82%A4%EA%B8%B0\">Persistable<ID> 구현으로 내 맘대로 식별시키기</a></p>\n<ul>\n<li><a href=\"#%EB%98%90%EB%8A%94-%EC%A1%B0%EA%B8%88-%EB%8D%94-%EA%B0%84%EB%8B%A8%ED%95%9C-%EB%B2%84%EC%A0%84\">또는, 조금 더 간단한 버전</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B7%B8-%EC%99%B8%EC%97%90%EB%8F%84-%EC%8B%9D%EB%B3%84%EC%97%90-%EC%98%81%ED%96%A5%EC%9D%84-%EC%A3%BC%EB%8A%94-%EB%B0%A9%EB%B2%95\">그 외에도 식별에 영향을 주는 방법</a></p>\n<ul>\n<li><a href=\"#version\">@Version</a></li>\n<li><a href=\"#entityinformation-%EA%B5%AC%ED%98%84\">EntityInformation 구현</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></p>\n<ul>\n<li><a href=\"#%EA%B7%B8-%EC%99%B8%EC%9D%98-%ED%98%B8%EA%B8%B0%EC%8B%AC\">그 외의 호기심?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%8F%84%EC%9B%80%EB%B0%9B%EC%9D%80-%EA%B3%B3%EB%93%A4\">도움받은 곳들</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"August 24, 2022","title":"[JPA]는 새로운 엔티티를 어떻게 알아볼까?","categories":"JPA kotlin","author":"써머","emoji":"headers/jpa-is-new.png"},"fields":{"slug":"/jpa-is-new/"}},"site":{"siteMetadata":{"siteUrl":"https://hyewoncc.github.io","comments":{"utterances":{"repo":"hyewoncc/hyewoncc.github.io"}}}}},"pageContext":{"slug":"/post-construct-profile/","nextSlug":"/jpa-static-fixture-trouble/","prevSlug":"/jpa-is-new/"}},"staticQueryHashes":["1073350324","1956554647","2938748437","3350743975"],"slicesMap":{}}