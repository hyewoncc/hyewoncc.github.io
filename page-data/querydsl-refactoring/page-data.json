{"componentChunkName":"component---src-templates-blog-template-js","path":"/querydsl-refactoring/","result":{"data":{"cur":{"id":"35f48c8a-6132-55b3-af5f-ffe41513fbd0","html":"","excerpt":"","frontmatter":{"date":"October 18, 2022","title":"Querydsl 코드 리팩토링","categories":"Spring 트러블슈팅 etc","author":"써머","emoji":"headers/querydsl-refactoring.png"},"fields":{"slug":"/querydsl-refactoring/"}},"next":{"id":"48a52cee-5a60-549e-9e68-7293d2b558b7","html":"<h2 id=\"-문제상황\" style=\"position:relative;\"><a href=\"#-%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\" aria-label=\" 문제상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>💣 문제상황</h2>\n<p><a href=\"https://github.com/woowacourse-teams/2022-pickpick\">줍줍</a>에는 북마크 설정한 메시지를 모아서 보는 기능이 있다.\n기존에는 이 북마크 목록을 보여줄 때, 북마크가 등록 된 <strong>메시지의 생성 시간</strong> 순서대로 보여줬다.\n그러다 사용자 편의를 위해 이를 <strong>북마크 등록 시간</strong> 순서대로 보여주기로 바꿨다.\n이 때, 북마크 등록 시간을 편하게 관리하기 위해 <code class=\"language-text\">JPA Auditing</code>을 도입했다.\n그리고 <a href=\"https://github.com/woowacourse-teams/2022-pickpick/pull/568\">해당 PR</a>은 순조롭게 머지 되었는데…</p>\n<p>팀원 봄이 진행한 <a href=\"https://github.com/woowacourse-teams/2022-pickpick/pull/570\">컨트롤러 테스트를 WebMvcTest로 개선하는 PR</a>에서 문제가 생겼다.\n봄의 로컬에서 테스트가 잘 돌아가는 상태였는데, PR의 <a href=\"https://github.com/woowacourse-teams/2022-pickpick/actions/runs/3179844507/jobs/5182750602\">github action</a>에서는 테스트가 실패했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA60lEQVQY062PfWuDQAzG7/t/t1FY5/pi9fSUVtmqtSaXO1t9xl3HGGywfxb4kRCeJE9U8rqB1gWquoapaqSHDLt9iqI0KE2F9UsSc5ZrbHd7MDNCLMvyK4qYQUQYR4K1gpEIXX+JvTB87joEDVuLyzBgmm5xcJ5nzPPyA3UlAtHj6n+E8s5HZ845TH6C9x4iArECEQdmCyaObsNhthL1wfH3OmjDJ6ppW6ye16iaFrqucXp7j5hTExmYIbd7hJ37WmAjAiuPpfKZ1bXvcXxagfMC4yED5RrWVOBcY0w28KWBTzO4LMf93P358gfXNs4R38PsUAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"깃헙 액션 실패\"\n        title=\"깃헙 액션 실패\"\n        src=\"/static/d4cfb4b4007765978f585ce48e18552c/37523/ci_fail.png\"\n        srcset=\"/static/d4cfb4b4007765978f585ce48e18552c/e9ff0/ci_fail.png 180w,\n/static/d4cfb4b4007765978f585ce48e18552c/f21e7/ci_fail.png 360w,\n/static/d4cfb4b4007765978f585ce48e18552c/37523/ci_fail.png 720w,\n/static/d4cfb4b4007765978f585ce48e18552c/302a4/ci_fail.png 1080w,\n/static/d4cfb4b4007765978f585ce48e18552c/07a9c/ci_fail.png 1440w,\n/static/d4cfb4b4007765978f585ce48e18552c/95e59/ci_fail.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">@WebMvcTest</code>로 변경한 모든 <code class=\"language-text\">RestDocs</code>용 컨트롤러 테스트가 같은 이유로 실패하고 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>IllegalStateException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Failed</span> <span class=\"token keyword\">to</span> <span class=\"token namespace\">load</span> <span class=\"token class-name\">ApplicationContext</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span></span>BeanCreationException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Error</span> creating bean <span class=\"token keyword\">with</span> <span class=\"token namespace\">name</span> 'jpaAuditingHandler'<span class=\"token operator\">:</span> <span class=\"token class-name\">Cannot</span> resolve reference <span class=\"token keyword\">to</span> <span class=\"token namespace\">bean</span> 'jpaMappingContext' <span class=\"token keyword\">while</span> setting constructor argument<span class=\"token punctuation\">;</span> \nnested exception is <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span></span>BeanCreationException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Error</span> creating bean <span class=\"token keyword\">with</span> <span class=\"token namespace\">name</span> 'jpaMappingContext'<span class=\"token operator\">:</span> <span class=\"token class-name\">Invocation</span> of init method failed<span class=\"token punctuation\">;</span> \nnested exception is <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>IllegalArgumentException</span><span class=\"token operator\">:</span> <span class=\"token constant\">JPA</span> metamodel must not be empty<span class=\"token operator\">!</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span></span>BeanCreationException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Error</span> creating bean <span class=\"token keyword\">with</span> <span class=\"token namespace\">name</span> 'jpaMappingContext'<span class=\"token operator\">:</span> <span class=\"token class-name\">Invocation</span> of init method failed<span class=\"token punctuation\">;</span> \nnested exception is <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>IllegalArgumentException</span><span class=\"token operator\">:</span> <span class=\"token constant\">JPA</span> metamodel must not be empty<span class=\"token operator\">!</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">JPA metamodel must not be empty</code>라는 문구가 눈에 띈다.\n해당 문구로 라이브러리를 검색해보면 <code class=\"language-text\">JpaMetamodelMappingContext</code>라는 클래스가 나온다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaMetamodelMappingContext</span>\n\t\t<span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractMappingContext</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">JpaPersistentEntityImpl</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">JpaPersistentProperty</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Metamodels</span> models<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PersistenceProvider</span> persistenceProvider<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">/**\n\t * Creates a new JPA {@link Metamodel} based {@link MappingContext}.\n\t *\n\t * @param models must not be {@literal null} or empty.\n\t */</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">JpaMetamodelMappingContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Metamodel</span><span class=\"token punctuation\">></span></span> models<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JPA metamodel must not be null!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notEmpty</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JPA metamodel must not be empty!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>사실 이 문구로 검색하면 많은 사람들이 해결법을 이미 올려두었다.\n그런데 여기까지 오니, <code class=\"language-text\">JPA metamodel</code>이 대체 뭔데? <code class=\"language-text\">null</code>도 아니고 <code class=\"language-text\">empty</code>라고?\n이거랑 <code class=\"language-text\">Auditing</code>은 무슨 상관이지? 등등 궁금한 점이 생겨서 코드를 조금 열어봤다.</p>\n<br>\n<h2 id=\"-jpa-metamodel\" style=\"position:relative;\"><a href=\"#-jpa-metamodel\" aria-label=\" jpa metamodel permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👾 JPA Metamodel</h2>\n<p>그렇다면 테스트가 잘 실행 될 때와, <code class=\"language-text\">@WebMvcTest</code>를 붙여 실행되지 않을 때, 저 <code class=\"language-text\">models</code>에는 무슨 값이 들어가있을까?\n정상적으로 실행되는 경우, <code class=\"language-text\">MetamodelImpl</code>이라는 클래스의 인스턴스에 엔티티 클래스와 관련된 정보가 담겨있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB4UlEQVQoz22Sy24UMRBF538gQmJDJsn0w+5uv8ru12QGERFNku+ABYsACiD++CB7JNiwuK5Sq+t03eveDIPiGAzWCNoKXZYT1OBpekfTWZTJveWq1v9XpehdwMWRzcX4BfXhM/b0jH78ze7+J+3pF+r0k/rjC93DD5r7F94s33g1PnMxfeVi/qfX83feTp/ofWTwgc27xiHieJgnbmXPLCsiK0NWXDFxxU0HtF9o7MS1Dmwby2Vj2bau1J327FrNdlezyUfyFY/Jcu+FxyA8SSQ5h7GWwTqM97gQ8CJISjRac1M33NQ1V7uKqlUFeFU1bC53LZO0PI2eUxh5iiN3ITJ5YXQB40KxYrxgJTF4oekG2t5wXbdsd02B5WeV6vKGDdYojjIwO2HNgy6gC0gwIeIkFVgOvbNne1kZkKV6Q6268oFNXrNqW5xVaOvLQB72cSROMz5NxGlBSj+Slj2dcajBMLj8fo4kUOUMs+UMrJUiOF1sZYshTaR5ZVpvGZd9qfP+3M/7Q6k2xAIbXKC3nptGnTM8b6gIXjGESO+FMC3EZc9yOBbAcntkPbwvfVYG5BhMkFJzxtluAW6rbFdzlwyrjxwlcYwjxzQhaSy55Y1lnItyn3/ifAmN7kutdf8X+AeTsHTWx+/SzwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"metamodel\"\n        title=\"metamodel\"\n        src=\"/static/723d9c45ddb107118ff118a946096b8c/37523/models_not_empty.png\"\n        srcset=\"/static/723d9c45ddb107118ff118a946096b8c/e9ff0/models_not_empty.png 180w,\n/static/723d9c45ddb107118ff118a946096b8c/f21e7/models_not_empty.png 360w,\n/static/723d9c45ddb107118ff118a946096b8c/37523/models_not_empty.png 720w,\n/static/723d9c45ddb107118ff118a946096b8c/302a4/models_not_empty.png 1080w,\n/static/723d9c45ddb107118ff118a946096b8c/07a9c/models_not_empty.png 1440w,\n/static/723d9c45ddb107118ff118a946096b8c/95e59/models_not_empty.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">@WebMvcTest</code>로 실행되지 않을 때는 해당 <code class=\"language-text\">models</code>가 비어있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.111111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAQklEQVQI10XISwqAMAwAUa9lBUvTTxJTt97/JiPYhYvHwGy9F55wTAPRi6pBtaX5pNn6ZThHrqQspK+//RRkODZvXqf9I/YqVpU1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"metamodel empty\"\n        title=\"metamodel empty\"\n        src=\"/static/9fccb72b921b1d2b7efe811c83d1dc54/37523/models_empty.png\"\n        srcset=\"/static/9fccb72b921b1d2b7efe811c83d1dc54/e9ff0/models_empty.png 180w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/f21e7/models_empty.png 360w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/37523/models_empty.png 720w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/302a4/models_empty.png 1080w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/07a9c/models_empty.png 1440w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/95e59/models_empty.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이 이슈를 검색하면 제일 자주 나오는 해결법이 <code class=\"language-text\">@WebMvcTest</code>를 쓰는 곳에 아래와 같이 <code class=\"language-text\">@MockBean</code>을 추가로 사용하는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@WebMvcTest</span>\n<span class=\"token annotation punctuation\">@MockBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaMetamodelMappingContext</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ControllerTest</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>일단 이 해결법을 적용했었지만, 내부 코드를 열고 보니 의문이 든다.\n이렇게 하면 <code class=\"language-text\">JpaMetamodelMappingContext</code> 생성자의 <code class=\"language-text\">Assert</code>문이 실행되지 않으니 터지지는 않는다.\n그런데 컨트롤러 슬라이스 테스트에서 사용하지 않을 JPA 관련 빈을 모킹해주는 것이 맞을까?</p>\n<p>어쨌든 이 <code class=\"language-text\">MetamodelImpl</code>이 어디서 생성되는가를 보자면…</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAqUlEQVQY022NbWrDMBAFfZt6JdCHV1qngbpgS3ba+99nSlxampIfs7AP3rzBOYd3nvpWWNaF1m9s/aCYclln1q2ff9sPtrbT+nFmWTNn1/sHhp8wTQmtilnFbCbGQNLIpMo0FerVKJdKne0kpPBceD/OO5w4RASREZEXYgoUjZT7UE6UkjDLhOAZZfyV/ZcOz1a8CHp95X1b+OiN2/7N596YNSPyKPvr+AKZAH5yRHyEYwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SessionFactoryObserver\"\n        title=\"SessionFactoryObserver\"\n        src=\"/static/6a7541ca966e3424be235b81315a3593/37523/sessionfactoryobserver.png\"\n        srcset=\"/static/6a7541ca966e3424be235b81315a3593/e9ff0/sessionfactoryobserver.png 180w,\n/static/6a7541ca966e3424be235b81315a3593/f21e7/sessionfactoryobserver.png 360w,\n/static/6a7541ca966e3424be235b81315a3593/37523/sessionfactoryobserver.png 720w,\n/static/6a7541ca966e3424be235b81315a3593/302a4/sessionfactoryobserver.png 1080w,\n/static/6a7541ca966e3424be235b81315a3593/07a9c/sessionfactoryobserver.png 1440w,\n/static/6a7541ca966e3424be235b81315a3593/95e59/sessionfactoryobserver.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Incubating</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TypeConfiguration</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">SessionFactoryObserver</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Serializable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MetamodelImplementor</span> <span class=\"token function\">scope</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SessionFactoryImplementor</span> sessionFactory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">debugf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"Scoping TypeConfiguration [%s] to SessionFactoryImpl [%s]\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> sessionFactory <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> importEntry <span class=\"token operator\">:</span> scope<span class=\"token punctuation\">.</span>metadataBuildingContext<span class=\"token punctuation\">.</span><span class=\"token function\">getMetadataCollector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getImports</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> importMap<span class=\"token punctuation\">.</span><span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span> importEntry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t\timportMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span> importEntry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importEntry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\tscope<span class=\"token punctuation\">.</span><span class=\"token function\">setSessionFactory</span><span class=\"token punctuation\">(</span> sessionFactory <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsessionFactory<span class=\"token punctuation\">.</span><span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">this</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MetamodelImpl</span><span class=\"token punctuation\">(</span> sessionFactory<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>  </code></pre></div>\n<p><code class=\"language-text\">SessionFactoryObserver</code>를 구현한 <code class=\"language-text\">TypeConfiguration</code> 클래스의 <code class=\"language-text\">scope</code>라는 메서드에서 생성해주고 있다.\n그리고 이 메서드를 호출하는 곳은 <code class=\"language-text\">Hibernate</code>의 <code class=\"language-text\">SessionFactoryImpl</code>라는 클래스다.\n이 클래스는 <code class=\"language-text\">JPA</code>의 <code class=\"language-text\">EntityManagerFactory</code>를 상속하고 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABIklEQVQoz31RW5KEIBDzOALy8gUICqhz/yNlCyzdnd2p/Qihi5BOVzeUUlBCUflfkMqEELCOYQ4TtpSQjhM+rGBFwxiarusglYQQooJzDiHLXVbctZSX5mYuOFSvoLSqmtKMFUPZCyzbgrjviPnAOI+Y/Ih4ZGwpo5972NUgph3pPBDzDu9X9EYjpBX5eGEYhit5MSzH3U1qWdMWqPGuBYQW9V3P+kokeB2bCQbK6JOucNNx9p0gH8jnif11Ih8n9vOFEDb0VsPHgLhnbDHVkdu2fUx+cnMvhVBSY9eOHb2YUahJYnYWxjmY4DAbC+sWKK3/mD0jv4EWwcUFetKwzsEtHsvqKxdo3b8ZfTT8LajpO44hBKxbrOOWRRljQUj78c8XcKH7CkIlBQUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SessionFactoryImpl\"\n        title=\"SessionFactoryImpl\"\n        src=\"/static/759d4349731893465904fe5e8d57ae45/37523/SessionFactoryImpl.png\"\n        srcset=\"/static/759d4349731893465904fe5e8d57ae45/e9ff0/SessionFactoryImpl.png 180w,\n/static/759d4349731893465904fe5e8d57ae45/f21e7/SessionFactoryImpl.png 360w,\n/static/759d4349731893465904fe5e8d57ae45/37523/SessionFactoryImpl.png 720w,\n/static/759d4349731893465904fe5e8d57ae45/302a4/SessionFactoryImpl.png 1080w,\n/static/759d4349731893465904fe5e8d57ae45/07a9c/SessionFactoryImpl.png 1440w,\n/static/759d4349731893465904fe5e8d57ae45/95e59/SessionFactoryImpl.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SessionFactoryImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">SessionFactoryImplementor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">SessionFactoryImpl</span><span class=\"token punctuation\">(</span>\n\t\t\t<span class=\"token keyword\">final</span> <span class=\"token class-name\">MetadataImplementor</span> metadata<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token class-name\">SessionFactoryOptions</span> options<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token class-name\">QueryPlanCache<span class=\"token punctuation\">.</span>QueryPlanCreator</span> queryPlanCacheFunction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">MetamodelImpl</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>metamodel <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span>\n\t\t\tmetadata<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token function\">determineJpaMetaModelPopulationSetting</span><span class=\"token punctuation\">(</span> properties <span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>여기서 <code class=\"language-text\">MetamodelImpl.initialize()</code>를 호출하고…</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MetamodelImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">MetamodelImplementor</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Serializable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MetadataImplementor</span> mappingMetadata<span class=\"token punctuation\">,</span> <span class=\"token class-name\">JpaMetaModelPopulationSetting</span> jpaMetaModelPopulationSetting<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>imports<span class=\"token punctuation\">.</span><span class=\"token function\">putAll</span><span class=\"token punctuation\">(</span> mappingMetadata<span class=\"token punctuation\">.</span><span class=\"token function\">getImports</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>파라미터로 전달받은 <code class=\"language-text\">mappingMetadata</code>에서 여러 값을 불러와 저장하게 된다.\n이 <code class=\"language-text\">mappingMetadata</code>는 <code class=\"language-text\">SessionFactoryBuilderImpl</code>을 통해 <code class=\"language-text\">SessionFactoryImpl</code>에 주입되고,\n<code class=\"language-text\">SessionFactoryBuilderImpl</code>은 <code class=\"language-text\">DefaultSessionFactoryBuilderService</code>을 통해 생성되는데…\n의 과정을 따라가다보니 어느새 <code class=\"language-text\">MetadataImpl</code>로 돌아오고 있었다. 😵</p>\n<p>결론은 이 <code class=\"language-text\">MetamodelImpl</code>은 엔티티 정보를 담은 JPA <code class=\"language-text\">Metamodel</code>의 하이버네이트의 구현체며, 그래서 <code class=\"language-text\">@WebMvcTest</code>에서 생성되지 않았던 것이다.\n원래 최초 생성 시점을 찾으려고 했는데 결국 찾지 못했다.</p>\n<p>JPA 관련 빈이 로딩되는 <code class=\"language-text\">@DataJpaTest</code>가 붙은 테스트는 <code class=\"language-text\">models</code>가 정상적으로 생성되어 있는 것을 볼 수 있었다.</p>\n<br>\n<h2 id=\"-enablejpaauditing\" style=\"position:relative;\"><a href=\"#-enablejpaauditing\" aria-label=\" enablejpaauditing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🎧 EnableJpaAuditing</h2>\n<p>그렇다면 어떤 경위로 이 <code class=\"language-text\">Metamodel</code>이 필요했던 걸까?\nAuditing을 위해 추가했던 <code class=\"language-text\">@EnableJpaAuditing</code> 어노테이션을 보면 <code class=\"language-text\">JpaAuditingRegistrar</code> 클래스를 import 하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Import</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaAuditingRegistrar</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token annotation punctuation\">@interface</span> <span class=\"token class-name\">EnableJpaAuditing</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">JpaAuditingRegistrar</code>는 spring data jpa에 들어있는데, spring의 <code class=\"language-text\">ImportBeanDefinitionRegistrar</code> 클래스를 상속하고 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAs0lEQVQY042P2w7CIBBE+zdYoGgv7LJQ2hf//5fGuLHaNDX6cDIJGU52Guccjlhr0V07RJkgUiD5Qy4zOAm899o7/m2OIs3WwnmLgQYwC1LOkFpU9JQSs3bf/Z24Ob0uBIxEIOIXBEqESIxIpDzfz678KpxEUMqMPFdIWSDLHVJmpdRFp/8U7idcjIH3DtPYg+OIlJImTQOcbWGM+X/ylqG/gXPGUitqrVjXVTOEDvbQ34QP1Xm6oawy5NYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JpaAuditingRegistrar\"\n        title=\"JpaAuditingRegistrar\"\n        src=\"/static/03cf5aa0426628543dec4b0843ee2d35/37523/JpaAuditingRegistrar.png\"\n        srcset=\"/static/03cf5aa0426628543dec4b0843ee2d35/e9ff0/JpaAuditingRegistrar.png 180w,\n/static/03cf5aa0426628543dec4b0843ee2d35/f21e7/JpaAuditingRegistrar.png 360w,\n/static/03cf5aa0426628543dec4b0843ee2d35/37523/JpaAuditingRegistrar.png 720w,\n/static/03cf5aa0426628543dec4b0843ee2d35/302a4/JpaAuditingRegistrar.png 1080w,\n/static/03cf5aa0426628543dec4b0843ee2d35/07a9c/JpaAuditingRegistrar.png 1440w,\n/static/03cf5aa0426628543dec4b0843ee2d35/95e59/JpaAuditingRegistrar.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><a href=\"https://javacan.tistory.com/entry/spring-at-enable-config\">스프링 @Enable 설정 세 가지 구현 방식 - 자바캔</a> 포스팅에서 해당 클래스 이해에 도움을 받았는데, 이 클래스를 구현해 빈 설정을 직접 등록할 수 있다고 한다.\n바로 상위의 <code class=\"language-text\">AuditingBeanDefinitionRegistrarSupport</code>에서 하위 <code class=\"language-text\">JpaAuditingRegistrar</code>의 <code class=\"language-text\">registerAuditListenerBeanDefinition</code>를 호출하고 있고…</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuditingBeanDefinitionRegistrarSupport</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ImportBeanDefinitionRegistrar</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">registerBeanDefinitions</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AnnotationMetadata</span> annotationMetadata<span class=\"token punctuation\">,</span> <span class=\"token class-name\">BeanDefinitionRegistry</span> registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>annotationMetadata<span class=\"token punctuation\">,</span> <span class=\"token string\">\"AnnotationMetadata must not be null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>registry<span class=\"token punctuation\">,</span> <span class=\"token string\">\"BeanDefinitionRegistry must not be null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token class-name\">AbstractBeanDefinition</span> ahbd <span class=\"token operator\">=</span> <span class=\"token function\">registerAuditHandlerBeanDefinition</span><span class=\"token punctuation\">(</span>registry<span class=\"token punctuation\">,</span> <span class=\"token function\">getConfiguration</span><span class=\"token punctuation\">(</span>annotationMetadata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">registerAuditListenerBeanDefinition</span><span class=\"token punctuation\">(</span>ahbd<span class=\"token punctuation\">,</span> registry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>이 메서드에서 포스팅 초반에 봤던 키워드를 발견할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaAuditingRegistrar</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AuditingBeanDefinitionRegistrarSupport</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">registerAuditListenerBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BeanDefinition</span> auditingHandlerDefinition<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token class-name\">BeanDefinitionRegistry</span> registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>registry<span class=\"token punctuation\">.</span><span class=\"token function\">containsBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JPA_MAPPING_CONTEXT_BEAN_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tregistry<span class=\"token punctuation\">.</span><span class=\"token function\">registerBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JPA_MAPPING_CONTEXT_BEAN_NAME</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//</span>\n\t\t\t\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">RootBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaMetamodelMappingContextFactoryBean</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">JPA metamodel must not be empty</code> 에러 문구가 있던 <code class=\"language-text\">JpaMetamodelMappingContext</code> 클래스가 기억나는가?\n<code class=\"language-text\">JpaMetamodelMappingContextFactoryBean</code>라는 정직한 이름의 팩토리 빈에서 해당 클래스를 생성해주고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaMetamodelMappingContextFactoryBean</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractFactoryBean</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">JpaMetamodelMappingContext</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ApplicationContextAware</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token class-name\">JpaMetamodelMappingContext</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">LOG</span><span class=\"token punctuation\">.</span><span class=\"token function\">isDebugEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token constant\">LOG</span><span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Initializing JpaMetamodelMappingContext…\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token class-name\">JpaMetamodelMappingContext</span> context <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JpaMetamodelMappingContext</span><span class=\"token punctuation\">(</span><span class=\"token function\">getMetamodels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        context<span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">LOG</span><span class=\"token punctuation\">.</span><span class=\"token function\">isDebugEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token constant\">LOG</span><span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Finished initializing JpaMetamodelMappingContext!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">return</span> context<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">/**\n\t * Obtains all {@link Metamodel} instances of the current {@link ApplicationContext}.\n\t **/</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Metamodel</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getMetamodels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>beanFactory <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"BeanFactory must not be null!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">EntityManagerFactory</span><span class=\"token punctuation\">></span></span> factories <span class=\"token operator\">=</span> <span class=\"token class-name\">BeanFactoryUtils</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">beansOfTypeIncludingAncestors</span><span class=\"token punctuation\">(</span>beanFactory<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EntityManagerFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> factories<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">EntityManagerFactory</span><span class=\"token operator\">::</span><span class=\"token function\">getMetamodel</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StreamUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">toUnmodifiableSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">getMetamodels()</code> 메서드에 친절하게 현재 애플리케이션 컨텍스트의 모든 <code class=\"language-text\">Metamodel</code> 인스턴스를 찾는다고 적혀있다.\n아까 보았던 <code class=\"language-text\">EntityManagerFactory</code>도 보인다.</p>\n<br>\n<h2 id=\"-더-나은-해결법\" style=\"position:relative;\"><a href=\"#-%EB%8D%94-%EB%82%98%EC%9D%80-%ED%95%B4%EA%B2%B0%EB%B2%95\" aria-label=\" 더 나은 해결법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👀 더 나은 해결법?</h2>\n<p><code class=\"language-text\">@WebMvcTest</code>로 실행할 때는 JPA 관련 빈이 로딩되지 않아서. 라는 이유를 납득하기 위해 많이 돌아왔다.\n<code class=\"language-text\">@MockBean</code>을 쓰면 <code class=\"language-text\">@WebMvcTest</code>를 사용하는 테스트가 늘어날 때 마다 붙여줘야 한다는 문제가 있다.\n하지만 이 사소한 귀찮음이 진짜 문제는 아니라고 생각한다.\n<strong>진짜 문제</strong>는 <code class=\"language-text\">@WebMvcTest</code>에서 의도한 대로 빈 설정이 분리되고 있지 않는 상황이 아닐까?</p>\n<p>Auditing을 도입할 때, <code class=\"language-text\">Application</code> 클래스에 <code class=\"language-text\">@EnableJpaAuditing</code>을 붙였었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EnableJpaAuditing</span>\n<span class=\"token annotation punctuation\">@ConfigurationPropertiesScan</span>\n<span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PickpickApplication</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PickpickApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">@MockBean</code> 해결법이 검색에 많이 나오는 걸 보면, 이렇게 설정한 사람들이 많은 듯 하다.\n이를 <code class=\"language-text\">@Configuration</code> 클래스를 분리해 <code class=\"language-text\">@EnableJpaAuditing</code>를 거기 붙이는 해결 방법이 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@ConfigurationPropertiesScan</span>\n<span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PickpickApplication</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PickpickApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@EnableJpaAuditing</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuditingConfig</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 하면 <code class=\"language-text\">@WebMvcTest</code>에서 <code class=\"language-text\">@MockBean</code>을 사용하지 않아도 된다.\n해당 방식으로 리팩토링 하기를 제안해봐야겠다.</p>\n<br>\n<h3 id=\"-부록---자바독을-잘-읽자\" style=\"position:relative;\"><a href=\"#-%EB%B6%80%EB%A1%9D---%EC%9E%90%EB%B0%94%EB%8F%85%EC%9D%84-%EC%9E%98-%EC%9D%BD%EC%9E%90\" aria-label=\" 부록   자바독을 잘 읽자 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📚 부록 - 자바독을 잘 읽자</h3>\n<p>추가로 볼만한 부분이 있다.\nAuditing을 사용할 엔티티에 붙이는 리스너 클래스다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@EntityListeners</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AuditingEntityListener</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Bookmark</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 리스너 클래스의 자바독 주석을 보면 <code class=\"language-text\">@Configuration</code> 클래스를 분리한 것을 볼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">\n<span class=\"token comment\">/**\n * JPA entity listener to capture auditing information on persiting and updating entities. To get this one flying be\n * sure you configure it as entity listener in your {@code orm.xml} as follows:\n * ...\n * After that it's just a matter of activating auditing in your Spring config:\n *\n * @Configuration\n * @EnableJpaAuditing\n * class ApplicationConfig {\n *\n * }\n */</span>\n<span class=\"token annotation punctuation\">@Configurable</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuditingEntityListener</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>물론 베스트 프랙티스라고 올려둔 것은 아니겠으나… 자바독을 챙겨보는 습관을 기르면 도움이 될 것 같다.</p>\n<p>로컬에서 잘 돌아가고, 머지 때 충돌도 나지 않는 코드가, 깃헙 액션에서 터지는 이번 같은 때가 종종 있다.\nCI 구축… 참 소중하다.</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\">💣 문제상황</a></p>\n</li>\n<li>\n<p><a href=\"#-jpa-metamodel\">👾 JPA Metamodel</a></p>\n</li>\n<li>\n<p><a href=\"#-enablejpaauditing\">🎧 EnableJpaAuditing</a></p>\n</li>\n<li>\n<p><a href=\"#-%EB%8D%94-%EB%82%98%EC%9D%80-%ED%95%B4%EA%B2%B0%EB%B2%95\">👀 더 나은 해결법?</a></p>\n<ul>\n<li><a href=\"#-%EB%B6%80%EB%A1%9D---%EC%9E%90%EB%B0%94%EB%8F%85%EC%9D%84-%EC%9E%98-%EC%9D%BD%EC%9E%90\">📚 부록 - 자바독을 잘 읽자</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"October 14, 2022","title":"[JPA] EnableJpaAuditing의 내부와 CI의 소중함","categories":"Spring JPA 트러블슈팅","author":"써머","emoji":"headers/jpa-auditing-and-ci.png"},"fields":{"slug":"/jpa-auditing-and-ci/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://hyewoncc.github.io","comments":{"utterances":{"repo":"hyewoncc/hyewoncc.github.io"}}}}},"pageContext":{"slug":"/querydsl-refactoring/","nextSlug":"/jpa-auditing-and-ci/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437","3350743975"]}