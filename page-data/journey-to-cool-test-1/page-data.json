{"componentChunkName":"component---src-templates-blog-template-js","path":"/journey-to-cool-test-1/","result":{"data":{"cur":{"id":"62337bb9-e2bd-5296-b033-b01c2f3d8bfc","html":"<h2 id=\"-메시지-조회-테스트-개선기\" style=\"position:relative;\"><a href=\"#-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A1%B0%ED%9A%8C-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EA%B0%9C%EC%84%A0%EA%B8%B0\" aria-label=\" 메시지 조회 테스트 개선기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🛠 메시지 조회 테스트 개선기</h2>\n<h2 id=\"초난감-메시지-조회\" style=\"position:relative;\"><a href=\"#%EC%B4%88%EB%82%9C%EA%B0%90-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A1%B0%ED%9A%8C\" aria-label=\"초난감 메시지 조회 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>초난감 메시지 조회</h2>\n<p>줍줍은 슬랙 메시지를 날짜이동, 윗방향 스크롤, 아래방향 스크롤, 단어검색, 특정 채널만 보기 등 여러 조건으로 조회할 수 있다.\n사용자 편의를 위해 이렇게 다양한 조회 조건을 지원하다 보니 동적 쿼리 생성이 필요해 <code class=\"language-text\">Querydsl</code>도 도입했다.</p>\n<!--more-->\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MessageResponse</span><span class=\"token punctuation\">></span></span> messageResponses <span class=\"token operator\">=</span> jpaQueryFactory\n    <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token function\">getMessageResponseConstructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">QMessage</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">leftJoin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">QMessage</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>member<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">leftJoin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">QBookmark</span><span class=\"token punctuation\">.</span>bookmark<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token function\">existsBookmark</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">leftJoin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">QReminder</span><span class=\"token punctuation\">.</span>reminder<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token function\">remainReminder</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token function\">meetAllConditions</span><span class=\"token punctuation\">(</span>channelIds<span class=\"token punctuation\">,</span> messageRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span><span class=\"token function\">arrangeDateByNeedPastMessage</span><span class=\"token punctuation\">(</span>needPastMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">limit</span><span class=\"token punctuation\">(</span>messageCount<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABlUlEQVQoz22S666bMBCE8/5v1x/tyUmEbfCdW2MoCpgkU+0moKqJpcVrA59ndn2w1qAoBKQqUVYVvk9nfB1PKIRAa34gpR6XNGAYR/yZJqSUcLkkDMPIe3keADzwoOfjgUOdFtRNi7pu0PU9+v432rbjdYgt2q6D8x4hRNRN88xj5LV1HpfUAy8YA49hhXYBxhg4H+BDgHUOWhtUWkMbg1jXr3eR39G85SRmHMcdevjpMgqlcTqfUVaarauy5JzsU0zTxB/f73eOdV1xu904tnwHnmKGqgy8D08lzvPJFASttNl/XJbMwE+DYDQOv1yGUBpCiB3AKl9KKZdKoet6jnme30AbjBV+hxWyNCjLigtNnRZSMdxYB2ufSpecd7s5Z54p/oWxwi+fcS4Uq6kIYizDqeiUq/J5AJWC9mmm/a3WOa/vQGqKkJLtUldJ6QbfOi6EZLiUCjHWWJYF13l+V3j0mS1LKflHYy1CrNkmwcg23T+qX9O2HNfr/LEhL4XLDuR7pw1fWLJHiipeO6Rh+NiM/xX+BWbkP8JUpTXcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"test_cases\"\n        title=\"test_cases\"\n        src=\"/static/69857245a60a8423c2c28b66f2354db1/37523/cases.png\"\n        srcset=\"/static/69857245a60a8423c2c28b66f2354db1/e9ff0/cases.png 180w,\n/static/69857245a60a8423c2c28b66f2354db1/f21e7/cases.png 360w,\n/static/69857245a60a8423c2c28b66f2354db1/37523/cases.png 720w,\n/static/69857245a60a8423c2c28b66f2354db1/302a4/cases.png 1080w,\n/static/69857245a60a8423c2c28b66f2354db1/07a9c/cases.png 1440w,\n/static/69857245a60a8423c2c28b66f2354db1/c0566/cases.png 1544w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">(분명히 빠진 경우의 수가 있을) 조회 테스트 케이스 모음</div>\n<br>\n<p>작성된 <code class=\"language-text\">Querydsl</code> 조회 코드와 테스트 작성을 위해 파악된 케이스만 봐도 복잡도가 짐작 갈 것이다.</p>\n<br>\n<h2 id=\"어떤-점을-개선하고-싶었나\" style=\"position:relative;\"><a href=\"#%EC%96%B4%EB%96%A4-%EC%A0%90%EC%9D%84-%EA%B0%9C%EC%84%A0%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%97%88%EB%82%98\" aria-label=\"어떤 점을 개선하고 싶었나 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>어떤 점을 개선하고 싶었나</h2>\n<p>해당 메시지 조회 기능 개발은 다른 팀원들이 맡았다.\n그래서 올라온 PR을 봤는데, 동작은 잘 했으나 코드 개발에 참여하지 않은 입장에서 테스트가 알아보기 어려웠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Sql</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"/truncate.sql\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/message.sql\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MessageServiceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> <span class=\"token constant\">MEMBER_ID</span> <span class=\"token operator\">=</span> <span class=\"token number\">1L</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MessageService</span> messageService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"메시지 조회 요청에 따른 메시지가 응답된다\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@MethodSource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"slackMessageRequest\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@ParameterizedTest</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"{0}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">findMessages</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> description<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MessageRequest</span> messageRequest<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> expectedMessageIds<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> expectedLast<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">MessageResponses</span> messageResponses <span class=\"token operator\">=</span> messageService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEMBER_ID</span><span class=\"token punctuation\">,</span> messageRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// when</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MessageResponse</span><span class=\"token punctuation\">></span></span> messages <span class=\"token operator\">=</span> messageResponses<span class=\"token punctuation\">.</span><span class=\"token function\">getMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">boolean</span> last <span class=\"token operator\">=</span> messageResponses<span class=\"token punctuation\">.</span><span class=\"token function\">isLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token function\">assertAll</span><span class=\"token punctuation\">(</span>\n                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>messages<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">extracting</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>expectedMessageIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>last<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>expectedLast<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">slackMessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Stream</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n                <span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"5번 채널에서 메시지ID가 1인 메시지 이후에 작성된 메시지 7개 조회\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">5L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token number\">8L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"쿼리 파라미터가 전혀 전달되지 않았을 경우, 회원의 채널 정렬 상 첫번째 채널의 최신 20개 메시지를 작성시간 내림차순으로 응답해야 한다.\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">emptyList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token number\">38L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">19L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">\"쿼리 파라미터가 전혀 전달되지 않았을 경우, 회원의 채널 정렬 상 첫번째 채널의 최신 20개 메시지를 작성시간 내림차순으로 응답해야 한다.\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token number\">38L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">19L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> startInclusive<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> endInclusive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">LongStream</span><span class=\"token punctuation\">.</span><span class=\"token function\">rangeClosed</span><span class=\"token punctuation\">(</span>endInclusive<span class=\"token punctuation\">,</span> startInclusive<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">boxed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">sorted</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comparator</span><span class=\"token punctuation\">.</span><span class=\"token function\">reverseOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>처음 테스트를 읽었을 때 왜 읽기 어렵다고 느껴졌을까?\n먼저 데이터가 <code class=\"language-text\">@Sql</code>문으로 들어가는 게 원인 중 하나였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> channel <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> slack_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'임시 채널'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ABC1234'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'공지사항 채널'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'DEF5678'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> member <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> slack_id<span class=\"token punctuation\">,</span> thumbnail_url<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> first_login<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'U03MC231'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'https://summer.png'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'써머'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> channel_subscription<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> view_order<span class=\"token punctuation\">,</span> channel_id<span class=\"token punctuation\">,</span> member_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> message <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> modified_date<span class=\"token punctuation\">,</span> posted_date<span class=\"token punctuation\">,</span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span> member_id<span class=\"token punctuation\">,</span> channel_id<span class=\"token punctuation\">,</span> slack_message_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 14:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 14:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Sample Text'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ABC1231'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 15:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 15:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Sample Text'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ABC1232'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 16:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2022-07-12 16:21:55'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Sample Text'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ABC1233'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>메시지 조회를 하려면 미리 저장된 <strong>1.멤버(사용자) 2.채널 3.채널 구독</strong> 데이터가 필수로 필요했다.\n기본적으로 메시지에 <code class=\"language-text\">멤버, 채널</code> 의존관계가 있고, 조회 시 구독하는 채널 메시지만 필터링 하는 분기가 기본으로 있었기 때문이다.\n특히 채널 구독인 <code class=\"language-text\">channel_subscription</code>을 보면 자바 코드에 비해 데이터 가독성이 떨어짐이 확실히 보인다.\n멤버 한 명, 채널 하나, 구독 하나를 기준으로 봤을 때 <code class=\"language-text\">sql</code>코드 보다 <code class=\"language-text\">java</code>코드가 흐름이 명확하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> member <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> slack_id<span class=\"token punctuation\">,</span> thumbnail_url<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> first_login<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'U00001'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'https://hope.png'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'호프'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> channel <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> slack_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'공지사항'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'C00001'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> channel_subscription<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> view_order<span class=\"token punctuation\">,</span> channel_id<span class=\"token punctuation\">,</span> member_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Member</span> hope <span class=\"token operator\">=</span> members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"U00001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"호프\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"https://hope.png\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Channel</span> notice <span class=\"token operator\">=</span> channels<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Channel</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"C00001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"공지사항\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsubscriptions<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ChannelSubscription</span><span class=\"token punctuation\">(</span>notice<span class=\"token punctuation\">,</span> hope<span class=\"token punctuation\">,</span> <span class=\"token constant\">VIEW_ORDER_FIRST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>그 다음으로, 조회 조건이 들어있는 <code class=\"language-text\">MessageRequest</code>의 값을 알기 어려웠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"5번 채널에서 메시지ID가 1인 메시지 이후에 작성된 메시지 7개 조회\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">5L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token number\">8L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"쿼리 파라미터가 전혀 전달되지 않았을 경우, 회원의 채널 정렬 상 첫번째 채널의 최신 20개 메시지를 작성시간 내림차순으로 응답해야 한다.\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">emptyList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token number\">38L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">19L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>테스트 케이스가 적은 것이 영향을 끼쳤겠지만, 한글 설명을 읽어도 요청 조건이 명확하지 않다.\n예를 들어 <code class=\"language-text\">\"\", \"\"</code>은 어떤 값이 비어있는 것을까?\n왜 세 개의 테스트 케이스에서 다 <code class=\"language-text\">빈 문자열</code>일까?\n하나는 검색 <code class=\"language-text\">키워드</code>, 다른 하나는 특정 <code class=\"language-text\">날짜(시간)</code>을 문자열로 받는 것이라는 걸 테스트 코드에서 유추할 수 있을까?</p>\n<p>마지막으로 <code class=\"language-text\">createExpectedMessageIds()</code>로 만들어진 메시지 id가 어떤 메시지를 나타내는지 알기 어려웠다.\n<code class=\"language-text\">38L, 37L... 19L</code>이라는 일련의 <code class=\"language-text\">pk</code>을 가진 메시지의 특성을 알려면 <code class=\"language-text\">sql</code>파일을 봐야 한다.\n현재 <code class=\"language-text\">MethodSource</code>에는 없는 테스트 케이스지만, 만약 <code class=\"language-text\">키워드 검색</code> 테스트 케이스가 추가된다면 어떻게 될까?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Arguments</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"키워드와 특정 채널로 검색하면, 해당 키워드가 존재하는 최신 20개 또는 그 이하 메시지를 작성시간 내림차순으로 응답해야 한다.\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">emptyList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">createExpectedMessageIds</span><span class=\"token punctuation\">(</span><span class=\"token number\">20L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>이러면 실제로 키워드 검색이 수행되었는지 알기 위헤 <code class=\"language-text\">sql</code>의 <code class=\"language-text\">20L, 19L, ..15L</code> 아이디 메시지 텍스트를 봐야 할 것이다.\n복잡한 테스트 케이스가 늘어난다면 이를 일일히 확인하는 건 더 어려워진다.\n게다가 인수 테스트, 컨트롤러 통합 테스트 등 여러 계층의 여러 테스트에서 동일한 <code class=\"language-text\">sql</code> 파일들을 공유하고 있기 때문에,\n데이터 하나를 고쳤다가 여러 테스트가 깨질 수 있었다.</p>\n<br>\n<h2 id=\"1차-개선---sql을-제거하고-요청-응답에-맥락을-부여하자\" style=\"position:relative;\"><a href=\"#1%EC%B0%A8-%EA%B0%9C%EC%84%A0---sql%EC%9D%84-%EC%A0%9C%EA%B1%B0%ED%95%98%EA%B3%A0-%EC%9A%94%EC%B2%AD-%EC%9D%91%EB%8B%B5%EC%97%90-%EB%A7%A5%EB%9D%BD%EC%9D%84-%EB%B6%80%EC%97%AC%ED%95%98%EC%9E%90\" aria-label=\"1차 개선   sql을 제거하고 요청 응답에 맥락을 부여하자 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1차 개선 - sql을 제거하고 요청, 응답에 맥락을 부여하자</h2>\n<p>1차 개선은 크게 네 가지 항목에서 진행되었다.</p>\n<h3 id=\"1-sql파일에서-자바-코드로\" style=\"position:relative;\"><a href=\"#1-sql%ED%8C%8C%EC%9D%BC%EC%97%90%EC%84%9C-%EC%9E%90%EB%B0%94-%EC%BD%94%EB%93%9C%EB%A1%9C\" aria-label=\"1 sql파일에서 자바 코드로 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. sql파일에서 자바 코드로</h3>\n<p><code class=\"language-text\">sql</code>내의 픽스쳐를 모두 자바 코드로 옮겼다.\n하나씩 필요한 <code class=\"language-text\">Member, Channel, ChannelSubscription</code>은 바로 생성하고, 메세지의 경우 <code class=\"language-text\">Enum</code>을 통해 생성했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">MessageFixtures</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token function\">PLAIN_20220712_14_00_00</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"일반 텍스트\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">2022</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">PLAIN_20220712_15_00_00</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"일반 텍스트\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">2022</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token function\">EMPTY_20220713_14_00_00</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">2022</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">13</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">EMPTY_20220713_15_00_00</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">2022</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">13</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token function\">KEYWORD_20220714_14_00_00</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"줍줍 텍스트\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">2022</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">KEYWORD_20220714_15_00_00</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"줍줍 텍스트\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">2022</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Message</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Channel</span> channel<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">(</span><span class=\"token constant\">UUID</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span> member<span class=\"token punctuation\">,</span> channel<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dateTime<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dateTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">MessageServiceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">findMessagesEmptyParameters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">Member</span> summer <span class=\"token operator\">=</span> members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">summer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Channel</span> notice <span class=\"token operator\">=</span> channels<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">notice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        messages<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span><span class=\"token function\">createMessages</span><span class=\"token punctuation\">(</span>notice<span class=\"token punctuation\">,</span> summer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Member</span> <span class=\"token function\">summer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"U00001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"써머\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"https://summer.png\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Channel</span> <span class=\"token function\">notice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Channel</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"C00001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"공지사항\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Message</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">createMessages</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Channel</span> channel<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageFixtures</span><span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>messageFixture <span class=\"token operator\">-></span> messageFixture<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>channel<span class=\"token punctuation\">,</span> member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<h3 id=\"2-복잡한-messagerequest는-팩토리-클래스로-만들기\" style=\"position:relative;\"><a href=\"#2-%EB%B3%B5%EC%9E%A1%ED%95%9C-messagerequest%EB%8A%94-%ED%8C%A9%ED%86%A0%EB%A6%AC-%ED%81%B4%EB%9E%98%EC%8A%A4%EB%A1%9C-%EB%A7%8C%EB%93%A4%EA%B8%B0\" aria-label=\"2 복잡한 messagerequest는 팩토리 클래스로 만들기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 복잡한 MessageRequest는 팩토리 클래스로 만들기</h3>\n<p><code class=\"language-text\">MessageRequest</code>를 만드는 팩토리 클래스 <code class=\"language-text\">MessageRequestFactory</code>를 만들었다.\n여기서 <code class=\"language-text\">메서드 이름</code>으로, 요청 케이스마다 어떤 맥락의 요청인지 드러나게 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MessageRequestFactory</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">MessageRequest</span> <span class=\"token function\">emptyQueryParams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">MessageRequest</span> <span class=\"token function\">emptyQueryParamsWithCount</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">MessageRequest</span> <span class=\"token function\">fromLatestInChannelIds</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> channelIds<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">MessageRequest</span> <span class=\"token function\">fromLatestInChannels</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Channel</span><span class=\"token punctuation\">></span></span> channels<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">MessageRequest</span> <span class=\"token function\">searchByKeywordInChannels</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Channel</span><span class=\"token punctuation\">></span></span> channels<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> keyword<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageRequest</span><span class=\"token punctuation\">(</span>keyword<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">extractChannelIds</span><span class=\"token punctuation\">(</span>channels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">MessageRequest</span> <span class=\"token function\">searchByKeywordInChannelIds</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> channelIds<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> keyword<span class=\"token punctuation\">,</span><span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 <code class=\"language-text\">MessageRequest</code>를 생성하는 곳에서는 복잡한 생성자 대신, 요청에 부합하는 팩토리 메서드를 사용하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"쿼리 파라미터가 없고 count가 있다면, 회원의 첫번째 순서 구독 채널의 최신 메시지를 count개 내림차순 조회한다\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">findMessagesEmptyParametersWithCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// given</span>\n    <span class=\"token class-name\">Member</span> summer <span class=\"token operator\">=</span> members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">summer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Channel</span> notice <span class=\"token operator\">=</span> channels<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">notice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    messages<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span><span class=\"token function\">createMessages</span><span class=\"token punctuation\">(</span>notice<span class=\"token punctuation\">,</span> summer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token class-name\">MessageRequest</span> request <span class=\"token operator\">=</span> <span class=\"token function\">emptyQueryParamsWithCount</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MESSAGE_COUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<h3 id=\"3-예상-응답은-고정된-특정-값이-아닌-실제-로직이-적용된-값으로\" style=\"position:relative;\"><a href=\"#3-%EC%98%88%EC%83%81-%EC%9D%91%EB%8B%B5%EC%9D%80-%EA%B3%A0%EC%A0%95%EB%90%9C-%ED%8A%B9%EC%A0%95-%EA%B0%92%EC%9D%B4-%EC%95%84%EB%8B%8C-%EC%8B%A4%EC%A0%9C-%EB%A1%9C%EC%A7%81%EC%9D%B4-%EC%A0%81%EC%9A%A9%EB%90%9C-%EA%B0%92%EC%9C%BC%EB%A1%9C\" aria-label=\"3 예상 응답은 고정된 특정 값이 아닌 실제 로직이 적용된 값으로 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 예상 응답은 고정된 특정 값이 아닌, 실제 로직이 적용된 값으로</h3>\n<p>예를 들어 <code class=\"language-text\">키워드 검색</code>시, 기존 방법인 <code class=\"language-text\">id</code>를 비교하는 대신,\n<strong>조회된 메시지가 모두 해당 키워드를 갖고 있는가?</strong> 를 검증했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"여러 채널의 특정 키워드로 조회 시, 해당 키워드가 존재하는 메시지만 조회된다\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">findMessagesInChannelsWithKeyword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// given</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token class-name\">MessageRequest</span> request <span class=\"token operator\">=</span> <span class=\"token function\">searchByKeywordInChannels</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>notice<span class=\"token punctuation\">,</span> freeChat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">MESSAGE_KEYWORD</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">MESSAGE_COUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// when</span>\n    <span class=\"token class-name\">MessageResponses</span> response <span class=\"token operator\">=</span> messageService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>summer<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// then</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MessageResponse</span><span class=\"token punctuation\">></span></span> foundMessages <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> isContainingKeyword <span class=\"token operator\">=</span> foundMessages<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">allMatch</span><span class=\"token punctuation\">(</span>message <span class=\"token operator\">-></span> message<span class=\"token punctuation\">.</span><span class=\"token function\">getText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MESSAGE_KEYWORD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>isContainingKeyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isTrue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>날짜순 정렬 같은 조회 조건도, <strong>로직 상 의도한 대로 필터링 한 메시지 값들의 id가 조회된 id값들과 일치하는가?</strong> 를 검증했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"쿼리 파라미터와 count가 없다면, 회원의 첫번째 순서 구독 채널의 최신 메시지를 20개 내림차순 조회한다\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">findMessagesEmptyParameters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// given</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token class-name\">MessageRequest</span> request <span class=\"token operator\">=</span> <span class=\"token function\">emptyQueryParams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// when</span>\n    <span class=\"token class-name\">MessageResponses</span> response <span class=\"token operator\">=</span> messageService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>summer<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// then</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MessageResponse</span><span class=\"token punctuation\">></span></span> foundMessages <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> expectedIds <span class=\"token operator\">=</span> <span class=\"token function\">expectedOrderedIds</span><span class=\"token punctuation\">(</span>messagesInFreeChat<span class=\"token punctuation\">,</span> <span class=\"token constant\">MESSAGE_COUNT_DEFAULT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertAll</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>foundMessages<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">extracting</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>expectedIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>foundMessages<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasSize</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MESSAGE_COUNT_DEFAULT</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">expectedOrderedIds</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Message</span><span class=\"token punctuation\">></span></span> savedMessages<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> count<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> foundPastMessagesIds <span class=\"token operator\">=</span> savedMessages<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>message <span class=\"token operator\">-></span> <span class=\"token operator\">!</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">getText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">sorted</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comparator</span><span class=\"token punctuation\">.</span><span class=\"token function\">comparing</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span><span class=\"token operator\">::</span><span class=\"token function\">getPostedDate</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reversed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> foundPastMessagesIds<span class=\"token punctuation\">.</span><span class=\"token function\">subList</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 하면 <code class=\"language-text\">Enum</code> 픽스쳐에 변경이 일어나도 부작용을 일으키지 않는다는 장점도 있다.\n중간에 필요한 메시지를 추가하거나 값을 바꿔도 의도한 로직대로 필터링한 예상값과 비교하기에, 수정에 대한 부담이 줄어들었다.</p>\n<br>\n<h3 id=\"4-검증-단위를-잘게-쪼개기\" style=\"position:relative;\"><a href=\"#4-%EA%B2%80%EC%A6%9D-%EB%8B%A8%EC%9C%84%EB%A5%BC-%EC%9E%98%EA%B2%8C-%EC%AA%BC%EA%B0%9C%EA%B8%B0\" aria-label=\"4 검증 단위를 잘게 쪼개기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 검증 단위를 잘게 쪼개기</h3>\n<p>테스트를 개선하면서 어떻게 해도 마음에 쏙 들지 않아 주변에 조언을 많이 구했다.\n<strong>로직을 잘 모르는 사람도 쉽게 읽을 수 있는 테스트</strong> 가 목적이어서 정말 많이 보여주고 다녔던 것 같다.</p>\n<p>그 중에 <code class=\"language-text\">한 번에 모든 조건을 검증하지 않아도 괜찮다</code>는 조언에 눈이 확 트이는 기분이었다.\n이전까지는 모든 조회 조건을 한 번에 검증하려 했다.</p>\n<blockquote>\n<p>복수의 채널에서 특정 메시지를 기준으로 과거 메시지를 조회하면, 텍스트가 빈 메시지는 걸러지고 해당 채널의 메시지만 나오며… 더 조회할 메시지 여부에 따라 isLast가 정해진다</p>\n</blockquote>\n<p>이렇게 검증하던 조건을 개별 테스트 케이스로 다 분해했다.</p>\n<blockquote>\n<p>텍스트가 빈 메시지는 걸러진다<br>\n더 조회할 메시지 여부에 따라 isLast가 정해진다<br>\n복수 채널에서 특정 메시지를 기준으로 과거 메시지를 조회하면, 작성시간이 더 늦은 메시지만 조회된다</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"더 이상 조회할 메시지가 없다면 isLast로 true를 반환한다\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">findMessagesIsLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token class-name\">MessageResponses</span> response <span class=\"token operator\">=</span> messageService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>summer<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> isLast <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">isLast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>isLast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"메시지 조회 시, 텍스트가 비어있는 메시지는 필터링된다\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">emptyMessagesShouldBeFiltered</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token class-name\">MessageResponses</span> messageResponses <span class=\"token operator\">=</span> messageService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>summer<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MessageResponse</span><span class=\"token punctuation\">></span></span> foundMessages <span class=\"token operator\">=</span> messageResponses<span class=\"token punctuation\">.</span><span class=\"token function\">getMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> isEmptyMessageFiltered <span class=\"token operator\">=</span> foundMessages<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">noneMatch</span><span class=\"token punctuation\">(</span>message <span class=\"token operator\">-></span> message<span class=\"token punctuation\">.</span><span class=\"token function\">getText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>isEmptyMessageFiltered<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isTrue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"여러 채널의 특정 키워드로 조회 시, 해당 키워드가 존재하는 메시지만 조회된다\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">findMessagesInChannelsWithKeyword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token class-name\">MessageResponses</span> response <span class=\"token operator\">=</span> messageService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>summer<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MessageResponse</span><span class=\"token punctuation\">></span></span> foundMessages <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> containsKeyword <span class=\"token operator\">=</span> foundMessages<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">allMatch</span><span class=\"token punctuation\">(</span>message <span class=\"token operator\">-></span> message<span class=\"token punctuation\">.</span><span class=\"token function\">getText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MESSAGE_KEYWORD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertAll</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>foundMessages<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>containsKeyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isTrue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br> \n<h2 id=\"-새로-생긴-문제들\" style=\"position:relative;\"><a href=\"#-%EC%83%88%EB%A1%9C-%EC%83%9D%EA%B8%B4-%EB%AC%B8%EC%A0%9C%EB%93%A4\" aria-label=\" 새로 생긴 문제들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 새로 생긴 문제들</h2>\n<p>해당 개선 후 <a href=\"https://github.com/woowacourse-teams/2022-pickpick/pull/421\">PR</a>을 올렸는데, 코드리뷰에서 생각하지 못한 의견을 좀 받았다.\n그중 가독성은 관점 차이라고 생각했고, 아래 문제들은 개선 필요성에 공감했다.</p>\n<h3 id=\"1-개별-테스트-케이스-마다-다른-데이터를-적재\" style=\"position:relative;\"><a href=\"#1-%EA%B0%9C%EB%B3%84-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BC%80%EC%9D%B4%EC%8A%A4-%EB%A7%88%EB%8B%A4-%EB%8B%A4%EB%A5%B8-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%A5%BC-%EC%A0%81%EC%9E%AC\" aria-label=\"1 개별 테스트 케이스 마다 다른 데이터를 적재 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 개별 테스트 케이스 마다 다른 데이터를 적재</h3>\n<p>검증 조건을 분해하면서, 검증에 필요한 최소 데이터만 저장했다.\n이유는 데이터 개수가 검증 유효성에 큰 영향을 끼치지 않는다고 생각했기 때문이다.\n예를 들어 <code class=\"language-text\">키워드 검색</code>의 경우, 키워드가 없는 메시지 하나, 키워드가 있는 메시지 두개만 저장했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"여러 채널의 특정 키워드로 조회 시, 해당 키워드가 존재하는 메시지만 조회된다\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">findMessagesInChannelsWithKeyword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// given</span>\n    <span class=\"token class-name\">Member</span> summer <span class=\"token operator\">=</span> members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">summer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Channel</span> notice <span class=\"token operator\">=</span> channels<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">notice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Channel</span> freeChat <span class=\"token operator\">=</span> channels<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">freeChat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    messages<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageFixtures</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PLAIN_20220712_15_00_00</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>freeChat<span class=\"token punctuation\">,</span> summer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    messages<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageFixtures</span><span class=\"token punctuation\">.</span><span class=\"token constant\">KEYWORD_20220714_14_00_00</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>notice<span class=\"token punctuation\">,</span> summer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    messages<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageFixtures</span><span class=\"token punctuation\">.</span><span class=\"token constant\">KEYWORD_20220714_14_00_00</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>freeChat<span class=\"token punctuation\">,</span> summer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>리팩토링 전 테스트 작성자의 주요 의도는 <strong>같은 데이터가 적재되어 있을 때, 의도대로 필터링 되는가</strong>였다.\n기존 코드를 작성했던 팀원에게 필요한 데이터만을 저장하면 엄격한 테스트가 아니게 된다는 의견을 들었고, 동의했다.</p>\n<br>\n<h3 id=\"2-저장-삭제-반복-비용-발생\" style=\"position:relative;\"><a href=\"#2-%EC%A0%80%EC%9E%A5-%EC%82%AD%EC%A0%9C-%EB%B0%98%EB%B3%B5-%EB%B9%84%EC%9A%A9-%EB%B0%9C%EC%83%9D\" aria-label=\"2 저장 삭제 반복 비용 발생 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 저장-삭제 반복 비용 발생</h3>\n<p>위와 연결점이 있는 얘기였는데, 많은 테스트 각각마다 데이터를 저장-삭제하고 있었다.\n특히 메시지를 반복 저장하는 부분이 문제였다.\n팀에서 <code class=\"language-text\">XXXRepository</code> 클래스를 만들 때, <code class=\"language-text\">JPARepository</code>대신 <code class=\"language-text\">Repository</code>를 상속해 사용하기로 했기에,\n<code class=\"language-text\">saveAll(Iterable&lt;Message> messages)</code>대신 <code class=\"language-text\">save(Message message)</code>로 단건 저장을 반복해야 했다.<br>\n그래서 테스트에서 쓰기 위한 목적으로 <code class=\"language-text\">saveAll(Iterable&lt;Message> messages)</code>을 추가했는데,\n테스트를 위한 코드가 프로덕션에 추가되어서는 안된다는 의견에 동의해서 삭제했다.\n결국 복수 메시지 저장을 <code class=\"language-text\">save(Message message)</code>를 <strong>메시지 수x테스트 수</strong>만큼 반복해 비효율적으로 하고 있었다.</p>\n<br>\n<h2 id=\"2차-개선---nested-테스트\" style=\"position:relative;\"><a href=\"#2%EC%B0%A8-%EA%B0%9C%EC%84%A0---nested-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"2차 개선   nested 테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2차 개선 - @Nested 테스트</h2>\n<p>어떻게 해야 픽스쳐 저장 비용을 아낄 수 있을까? 고민하다가 <code class=\"language-text\">@Nested</code>를 도입했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MessageServiceTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DatabaseCleaner</span> databaseCleaner<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"메시지 조회 시\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@TestInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Lifecycle</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PER_CLASS</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Nested</span>\n    <span class=\"token keyword\">class</span> find <span class=\"token punctuation\">{</span>\n\n        <span class=\"token annotation punctuation\">@AfterAll</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">afterAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            databaseCleaner<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token class-name\">Member</span> summer <span class=\"token operator\">=</span> members<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">summer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Channel</span> notice <span class=\"token operator\">=</span> channels<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">notice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Channel</span> freeChat <span class=\"token operator\">=</span> channels<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token function\">freeChat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Message</span><span class=\"token punctuation\">></span></span> noticeMessages <span class=\"token operator\">=</span> <span class=\"token function\">createAndSaveMessages</span><span class=\"token punctuation\">(</span>notice<span class=\"token punctuation\">,</span> summer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Message</span><span class=\"token punctuation\">></span></span> freeChatMessages <span class=\"token operator\">=</span> <span class=\"token function\">createAndSaveMessages</span><span class=\"token punctuation\">(</span>freeChat<span class=\"token punctuation\">,</span> summer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Message</span><span class=\"token punctuation\">></span></span> allMessages <span class=\"token operator\">=</span> messages<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">ChannelSubscription</span> first <span class=\"token operator\">=</span> subscriptions<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ChannelSubscription</span><span class=\"token punctuation\">(</span>notice<span class=\"token punctuation\">,</span> summer<span class=\"token punctuation\">,</span> <span class=\"token constant\">VIEW_ORDER_FIRST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ChannelSubscription</span> second <span class=\"token operator\">=</span> subscriptions<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ChannelSubscription</span><span class=\"token punctuation\">(</span>freeChat<span class=\"token punctuation\">,</span> summer<span class=\"token punctuation\">,</span> <span class=\"token constant\">VIEW_ORDER_SECOND</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"조회 조건과 관련없이\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token annotation punctuation\">@Nested</span>\n        <span class=\"token keyword\">class</span> alwaysFilter <span class=\"token punctuation\">{</span>\n\n            <span class=\"token class-name\">MessageRequest</span> request <span class=\"token operator\">=</span> <span class=\"token function\">fromLatestInChannels</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>notice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> allMessages<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">MessageResponses</span> response <span class=\"token operator\">=</span> messageService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>summer<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"텍스트가 비어있는 메시지는 제외된다\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token annotation punctuation\">@Test</span>\n            <span class=\"token keyword\">void</span> <span class=\"token function\">filterEmptyMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MessageResponse</span><span class=\"token punctuation\">></span></span> foundMessages <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">boolean</span> isEmptyMessageFiltered <span class=\"token operator\">=</span> foundMessages<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">noneMatch</span><span class=\"token punctuation\">(</span>message <span class=\"token operator\">-></span> message<span class=\"token punctuation\">.</span><span class=\"token function\">getText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>isEmptyMessageFiltered<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isTrue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"조회 할 과거 메시지가 남아 있다면\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token annotation punctuation\">@Nested</span>\n        <span class=\"token keyword\">class</span> pastMessagesRemain <span class=\"token punctuation\">{</span>\n\n            <span class=\"token class-name\">MessageRequest</span> request <span class=\"token operator\">=</span> <span class=\"token function\">onlyCount</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MESSAGE_COUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">MessageResponses</span> response <span class=\"token operator\">=</span> messageService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>summer<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hasPast는 true다\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token annotation punctuation\">@Test</span>\n            <span class=\"token keyword\">void</span> <span class=\"token function\">messagesHasPastTrue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">boolean</span> hasPast <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">hasPast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>hasPast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isTrue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>제일 바깥 <code class=\"language-text\">@Nested</code> 클래스 필드에 픽스쳐를 선언함으로써 아래 두 가지 목적을 달성했다.</p>\n<ol>\n<li>모든 테스트 케이스가 같은 데이터를 공유한다.</li>\n<li>데이터 적재 비용을 절감한다.</li>\n</ol>\n<p>덤으로 <code class=\"language-text\">@DisplayName</code>을 더 상세하게 적을 수 있어, 테스트 실행 시 이해하기 더 쉬워졌다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 96.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB9ElEQVQ4y6VUWZKjMBTLsSadBDAGDGbxwpb0/e+hqfccM3R3qErXfKjMZlmWhE9XkSPXCnaa0RmHph+QypKR5MWGm5Bf7j+S7AfOSYbTRyJwzlI0ZoAdZxg/obeeyTvroHuDdrB8P7iRr/VgIEqFrKggVQNZ1TyWtcbpkghc8gz96JiwNZYnkWI/r7yAmxa4eeH7cbnzGBef1kd4Py0o6ganSyqQKAm3LvzxtN6ZtKg1K6Ct70eCKMOYyXJTSrhmIhBeC4HOO16ZQFvLq5p9i9h7eb6lL0E+BoWlhDaGvbPjFLwy9p+f1vMzN82snCbSvFcIhJVEawMBKSS/6Jp8IiLyk56RJW8RpkrCzjPm+yfm+wPL45MnEwmlTAmSb3mpcM3yjfAV8abQTCEx/0wzpihVzR/+2fkUEUn3xEx4K/LNs9g5rtBgWREHl+U/cKywlOi9D5758RmE46KqtkfZtE9oKN1BtR2X+ZAwrQv4dWUPybtY3rrtGZXuUDXtRkag+rzycguFPCTC6B8VnJRSIHUX/u/vig4VkofcQzei6Q30YHmLyU7FEcFhytHD/lliUvb9NHmHdPuXqYfkHZWYCCmMVBb/oXD0fGIQGZWZTo49yTtkOw/DvxzPO0rwN6q+EiYCVyn4gGX//IimG7joddf/mvAvTPewwkgatnUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"display\"\n        title=\"display\"\n        src=\"/static/28e032868e4f2fb28a91423e0186570d/37523/nested_display.png\"\n        srcset=\"/static/28e032868e4f2fb28a91423e0186570d/e9ff0/nested_display.png 180w,\n/static/28e032868e4f2fb28a91423e0186570d/f21e7/nested_display.png 360w,\n/static/28e032868e4f2fb28a91423e0186570d/37523/nested_display.png 720w,\n/static/28e032868e4f2fb28a91423e0186570d/302a4/nested_display.png 1080w,\n/static/28e032868e4f2fb28a91423e0186570d/2cefc/nested_display.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>하지만 새로 생긴 고민거리도 있다.</p>\n<h3 id=\"1-테스트-라이프-사이클을-변경으로-인한-격리-저하\" style=\"position:relative;\"><a href=\"#1-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EB%9D%BC%EC%9D%B4%ED%94%84-%EC%82%AC%EC%9D%B4%ED%81%B4%EC%9D%84-%EB%B3%80%EA%B2%BD%EC%9C%BC%EB%A1%9C-%EC%9D%B8%ED%95%9C-%EA%B2%A9%EB%A6%AC-%EC%A0%80%ED%95%98\" aria-label=\"1 테스트 라이프 사이클을 변경으로 인한 격리 저하 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 테스트 라이프 사이클을 변경으로 인한 격리 저하</h3>\n<p><code class=\"language-text\">JUnit</code>의 기본 테스트 클래스 라이프 사이클은 <code class=\"language-text\">PER_METHOD</code>이다.\n개별 <code class=\"language-text\">@Test</code> 메서드 마다 새 클래스가 생성되는 전략이다.\n이를 <code class=\"language-text\">PER_CLASS</code>로 바꿔, <code class=\"language-text\">@Nested</code> 내부의 메소드들이 한 클래스 데이터를 공유하게 했다.\n철저하게 <code class=\"language-text\">조회</code>만 시도하는 테스트라 데이터 적재 비용과 비교해서 감수 가능한 부분이라 여겼다.</p>\n<h3 id=\"2-사용하지-않는-변수-할당\" style=\"position:relative;\"><a href=\"#2-%EC%82%AC%EC%9A%A9%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-%EB%B3%80%EC%88%98-%ED%95%A0%EB%8B%B9\" aria-label=\"2 사용하지 않는 변수 할당 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 사용하지 않는 변수 할당</h3>\n<p>픽스쳐 저장을 위한 사용하지 않는 필드 변수 할당이 생겼다.\n예를 들어 위의 코드에서는 두 개의 구독이 필요해, 두 개의 <code class=\"language-text\">ChannelSubscription</code> 객체를 저장했지만, 전체 코드에서 쓰지 않고 있다.\n변수를 할당하지 않으려면 테스트 메서드 안에서 저장해야 할텐데, 여러 테스트에 쓰이고 있어 불가능했다.\n<code class=\"language-text\">@BeforeAll</code>로 저장하는 방안도 있었지만, 다른 픽스쳐와 같은 레벨에서 선언되는 게 더 명확하게 느껴져 하지 않았다.</p>\n<p>이 두가지는 앞으로 더 나은 방안을 찾아보려 한다.</p>\n<br>\n<h2 id=\"짧은-회고\" style=\"position:relative;\"><a href=\"#%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\" aria-label=\"짧은 회고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>짧은 회고</h2>\n<p>해당 테스트 리팩토링은 생각했던 기간보다 훨씬 더 긴 기간을 작업했다.\n<a href=\"https://github.com/woowacourse-teams/2022-pickpick/pull/421\">첫 PR</a>만 해도 방학이 끼긴 했지만, 머지하기 까지 거의 한 달이 걸렸었다.\n그동안 다시 pull 받고, 또 받고… 커밋 내역이 너무 지저분해져서 정리해서 포스 푸시하고… 난리도 아니었다 😂\n무엇보다 긴 기간 동안 팀원들을 붙잡고 여러번 이건 어떻냐, 저건 괜찮냐 계속 물어봤는데…\n늘 성심성의껏 보고 의견 나눠준 팀원들에게 정말 고맙다!!🥺</p>\n<p>이 과정에서 테스트가 프로덕션 코드보다 더 각자의 관점과 우선순위가 다르다는 걸 느꼈다.\n우리 백엔드 팀은 의견이 갈릴 때, 충분히 의견을 나누고도 정해지지 않는다면, 이슈를 맡은 사람의 의견을 존중해 맡긴다는 컨벤션이 있다.\n그래서 첫 개선 때 approve는 다 받았기에 사실 빨리 머지를 해도 되는 상황이었다.\n그래도 어떻게든 명쾌한 동의를 받고싶다! LGTM를 받고싶다! 는 욕심으로 오래 끌었던 것 같다.\n처음에는 다른 의견을 납득하기 어려웠지만, 일단 이를 반영하려고 시도하는 과정에서 훨씬 나은 코드가 나왔다.\n이제까지 너무 내 스타일과 의견을 고수한 건 아닐까? 너무 좁은 시야로 보고 있었던 건 아닐까? 반성하는 계기가 되었다.\n백엔드는 남은 프로젝트 기간 동안 테스트 전체 개선을 최우선 과제로 잡았는데… 더 열린 마음으로 잘 할 수 있을 것 같다!!!</p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A1%B0%ED%9A%8C-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EA%B0%9C%EC%84%A0%EA%B8%B0\">🛠 메시지 조회 테스트 개선기</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B4%88%EB%82%9C%EA%B0%90-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A1%B0%ED%9A%8C\">초난감 메시지 조회</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%96%B4%EB%96%A4-%EC%A0%90%EC%9D%84-%EA%B0%9C%EC%84%A0%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%97%88%EB%82%98\">어떤 점을 개선하고 싶었나</a></p>\n</li>\n<li>\n<p><a href=\"#1%EC%B0%A8-%EA%B0%9C%EC%84%A0---sql%EC%9D%84-%EC%A0%9C%EA%B1%B0%ED%95%98%EA%B3%A0-%EC%9A%94%EC%B2%AD-%EC%9D%91%EB%8B%B5%EC%97%90-%EB%A7%A5%EB%9D%BD%EC%9D%84-%EB%B6%80%EC%97%AC%ED%95%98%EC%9E%90\">1차 개선 - sql을 제거하고 요청, 응답에 맥락을 부여하자</a></p>\n<ul>\n<li><a href=\"#1-sql%ED%8C%8C%EC%9D%BC%EC%97%90%EC%84%9C-%EC%9E%90%EB%B0%94-%EC%BD%94%EB%93%9C%EB%A1%9C\">1. sql파일에서 자바 코드로</a></li>\n<li><a href=\"#2-%EB%B3%B5%EC%9E%A1%ED%95%9C-messagerequest%EB%8A%94-%ED%8C%A9%ED%86%A0%EB%A6%AC-%ED%81%B4%EB%9E%98%EC%8A%A4%EB%A1%9C-%EB%A7%8C%EB%93%A4%EA%B8%B0\">2. 복잡한 MessageRequest는 팩토리 클래스로 만들기</a></li>\n<li><a href=\"#3-%EC%98%88%EC%83%81-%EC%9D%91%EB%8B%B5%EC%9D%80-%EA%B3%A0%EC%A0%95%EB%90%9C-%ED%8A%B9%EC%A0%95-%EA%B0%92%EC%9D%B4-%EC%95%84%EB%8B%8C-%EC%8B%A4%EC%A0%9C-%EB%A1%9C%EC%A7%81%EC%9D%B4-%EC%A0%81%EC%9A%A9%EB%90%9C-%EA%B0%92%EC%9C%BC%EB%A1%9C\">3. 예상 응답은 고정된 특정 값이 아닌, 실제 로직이 적용된 값으로</a></li>\n<li><a href=\"#4-%EA%B2%80%EC%A6%9D-%EB%8B%A8%EC%9C%84%EB%A5%BC-%EC%9E%98%EA%B2%8C-%EC%AA%BC%EA%B0%9C%EA%B8%B0\">4. 검증 단위를 잘게 쪼개기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EC%83%88%EB%A1%9C-%EC%83%9D%EA%B8%B4-%EB%AC%B8%EC%A0%9C%EB%93%A4\">🤔 새로 생긴 문제들</a></p>\n<ul>\n<li><a href=\"#1-%EA%B0%9C%EB%B3%84-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BC%80%EC%9D%B4%EC%8A%A4-%EB%A7%88%EB%8B%A4-%EB%8B%A4%EB%A5%B8-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%A5%BC-%EC%A0%81%EC%9E%AC\">1. 개별 테스트 케이스 마다 다른 데이터를 적재</a></li>\n<li><a href=\"#2-%EC%A0%80%EC%9E%A5-%EC%82%AD%EC%A0%9C-%EB%B0%98%EB%B3%B5-%EB%B9%84%EC%9A%A9-%EB%B0%9C%EC%83%9D\">2. 저장-삭제 반복 비용 발생</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#2%EC%B0%A8-%EA%B0%9C%EC%84%A0---nested-%ED%85%8C%EC%8A%A4%ED%8A%B8\">2차 개선 - @Nested 테스트</a></p>\n<ul>\n<li><a href=\"#1-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EB%9D%BC%EC%9D%B4%ED%94%84-%EC%82%AC%EC%9D%B4%ED%81%B4%EC%9D%84-%EB%B3%80%EA%B2%BD%EC%9C%BC%EB%A1%9C-%EC%9D%B8%ED%95%9C-%EA%B2%A9%EB%A6%AC-%EC%A0%80%ED%95%98\">1. 테스트 라이프 사이클을 변경으로 인한 격리 저하</a></li>\n<li><a href=\"#2-%EC%82%AC%EC%9A%A9%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-%EB%B3%80%EC%88%98-%ED%95%A0%EB%8B%B9\">2. 사용하지 않는 변수 할당</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\">짧은 회고</a></p>\n</li>\n</ul>\n</div>","excerpt":"🛠 메시지 조회 테스트 개선기 초난감 메시지 조회 줍줍은 슬랙 메시지를 날짜이동, 윗방향 스크롤, 아래방향 스크롤, 단어검색, 특정 채널만 보기 등 여러 조건으로 조회할 수 있다.\n사용자 편의를 위해 이렇게 다양한 조회 조건을 지원하다 보니 동적 쿼리 생성이 필요해 도 도입했다.  작성된  조회 코드와 테스트 작성을 위해 파악된 케이스만 봐도 복잡도가 짐작 갈 것이다. 어떤 점을 개선하고 싶었나 해당 메시지 조회 기능 개발은 다른 팀원들이 맡았다.\n그래서 올라온 PR을 봤는데, 동작은 잘 했으나 코드 개발에 참여하지 않은 입장에서 테스트가 알아보기 어려웠다. 처음 테스트를 읽었을 때 왜 읽기 어렵다고 느껴졌을까?\n먼저 데이터가 문으로 들어가는 게 원인 중 하나였다. 메시지 조회를 하려면 미리 저장된 1.멤버(사용자) 2.채널 3.채널 구독 데이터가 필수로 필요했다.\n기본적으로 메시지에  의존관계가 있고, 조회 시 구독하는 채널 메시지만 필터링 하는 분기가 기본으로 있었기 때문이다.…","frontmatter":{"date":"September 28, 2022","title":"메시지 조회 테스트 개선기","categories":"Spring 트러블슈팅","author":"써머","emoji":"headers/journey-to-cool-test-1.png"},"fields":{"slug":"/journey-to-cool-test-1/"}},"next":{"id":"c819eafd-4b3a-5670-a6fd-a46e61f069ab","html":"<p>해당 포스팅은 <a href=\"https://search.shopping.naver.com/book/catalog/32463364883?cat_id=50010881&#x26;frm=PBOKPRO&#x26;query=%ED%86%A0%EB%B9%84%EC%9D%98+%EC%8A%A4%ED%94%84%EB%A7%81&#x26;NaPm=ct%3Dl7xcl9rk%7Cci%3D2beb40c880925062f67b8f4c293f36caed990219%7Ctr%3Dboknx%7Csn%3D95694%7Chk%3De46d0a257b549c8d320d7074983959664f253dd5\">토비의 스프링 3.1</a>을 읽고 책 내용과 실습 코드 정리 및 스터디에서 나온 의견을 정리한 포스팅이다.</p>\n<h2 id=\"2장-테스트\" style=\"position:relative;\"><a href=\"#2%EC%9E%A5-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"2장 테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2장 테스트</h2>\n<p>스프링을 국비학원에서 처음 배운 나는 <code class=\"language-text\">테스트</code>가 존재하는 줄도 몰랐다.\n자잘한 코드 하나 고치는 데도 대소동이 일어났다.\n회원가입 기능을 만드는데 비밀번호 제한이 잘 안되는 것 같다면</p>\n<ul>\n<li>애플리케이션을 종료한다</li>\n<li>코드를 수정하고 break point를 걸거나 출력문을 써둔다</li>\n<li>다시 애플리케이션을 킨다</li>\n<li>크롬 시크릿 + 강력 새로고침으로 페이지에 들어간다</li>\n<li>회원가입을 시도하고 다시 확인한다</li>\n</ul>\n<p>이런 과정을 거쳐야 했다.</p>\n<p>테스트가 일상이 된 지금은 테스트가 없으면 불안하다. (레벨4 미션을 하면서 소홀해지긴 했지만…)\n테스트를 배운 처음엔 신기했고, 그 다음엔 조금 귀찮았는데, 지금은 테스트가 없으면 줄 없이 번지점프하는 기분이 든다.\n테스트는 나에게 자유롭고 재밌게 코드를 갖고 놀게 해주는 안전장치인 셈이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.444444444444446%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABMUlEQVQY0z2QW26DMBBFWUulVoJUMSGBYAzYJiFAeDTPtlKl7n8Xp8KN8nF052N0dGe89vZLff7Bjl9k+4GiHsjrgdS2bE2DtB2y+ietOvLDQHkYUbsjWdW5lI/d1DR4hbW0Y08/TnTDyPGRjn4g15asKCmMJdMGXxq01piyRCrFq8p430r0xqBjiydLQz30XD+/HefbJ9Plxni+0n+cyU1FVpr/1Ja3uCBTilwpEil5SVOCJKVcG/SmmoWaZuyd6HS7O3ZNhyz0k1lYPMR+uCaKIocIQ/zVioUIiZYRa7HBm5cOY8/l/sV0uTr2TYetG6pD6+SF3bmG8/kiXLFcLhFCOFZCEAqBH/gOb/5LOw3Phv10csJZtG+PblbaOqEqNesoIkmSJ3Ecu7ZBELBYLPgDAq/RUvjdFgAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"줍줍 전체 테스트\"\n        title=\"줍줍 전체 테스트\"\n        src=\"/static/86f4049f4ecc1b56359227228ba93b6b/37523/pickpick_test.png\"\n        srcset=\"/static/86f4049f4ecc1b56359227228ba93b6b/e9ff0/pickpick_test.png 180w,\n/static/86f4049f4ecc1b56359227228ba93b6b/f21e7/pickpick_test.png 360w,\n/static/86f4049f4ecc1b56359227228ba93b6b/37523/pickpick_test.png 720w,\n/static/86f4049f4ecc1b56359227228ba93b6b/302a4/pickpick_test.png 1080w,\n/static/86f4049f4ecc1b56359227228ba93b6b/07a9c/pickpick_test.png 1440w,\n/static/86f4049f4ecc1b56359227228ba93b6b/bf668/pickpick_test.png 2328w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  현재 개발중인 줍줍의 전체 테스트 실행 콘솔 화면. 편-안하다.  \n</div>\n<br>\n<h2 id=\"초난감-userdaotest-개선기\" style=\"position:relative;\"><a href=\"#%EC%B4%88%EB%82%9C%EA%B0%90-userdaotest-%EA%B0%9C%EC%84%A0%EA%B8%B0\" aria-label=\"초난감 userdaotest 개선기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>초난감 UserDaoTest 개선기</h2>\n<p>1장에서 만들었던 <code class=\"language-text\">UserDaoTest</code>는 내가 예전에 했던 휴먼-테스트보단 낫지만 여전히 초난감한 테스트다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDaoTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SQLException</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">UserDao</span> userDao <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DaoFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">userDao</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hyewoncc4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"최혜원\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        userDao<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"등록 성공\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> foundUser <span class=\"token operator\">=</span> userDao<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span><span class=\"token function\">getPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" 조회 성공\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<ol>\n<li>수동으로 결과를 확인해야 한다</li>\n</ol>\n<p>이 코드는 자동화가 덜 되었다.\n콘솔 창에 찍힌 <code class=\"language-text\">getName(), getPassword()</code>가 정말 저장 된 값과 일치하는지는 결국 사람이 보고 판단해야 한다.</p>\n<ol start=\"2\">\n<li>실행 작업이 번거롭다</li>\n</ol>\n<p>현재는 테스트 클래스가 하나뿐이지만, 이런 식으로 내부에 <code class=\"language-text\">main()</code>을 통해 테스트하는 클래스가 늘어난다면 일일히 실행하는 것도 보통 일이 아니게 될 것이다.</p>\n<p>첫번째 문제는 코드를 개선해 해결할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SQLException</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token class-name\">UserDao</span> userDao <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DaoFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">userDao</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    userDao<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hyewoncc4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"최혜원\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    \n    <span class=\"token class-name\">User</span> foundUser <span class=\"token operator\">=</span> userDao<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"테스트 실패 : name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span><span class=\"token function\">getPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"테스트 실패 : password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"조회 테스트 성공\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 콘솔창에서 값을 확인하지 않아도 된다.\n하지만 여전히 문제가 남아있다.</p>\n<br>\n<h3 id=\"junit-적용하기\" style=\"position:relative;\"><a href=\"#junit-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"junit 적용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Junit 적용하기</h3>\n<p>이 테스트를 <code class=\"language-text\">Junit</code> 프레임워크를 이용해 바꿔보자.\n책에서는 <code class=\"language-text\">Junit4</code>를 사용하고 있지만, <code class=\"language-text\">Junit5</code>로 예제를 따라했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">testImplementation(\"org.junit.jupiter:junit-jupiter-api\")</code></pre></div>\n<p>1장의 <code class=\"language-text\">xml</code>부분은 코드로 따라하지 않았고, <code class=\"language-text\">@Configuration</code>을 통해 빈을 생성해서 책과 다른 부분이 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDaoTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"사용자 추가 및 조회\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">addAndGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SQLException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ApplicationContext</span> applicationContext <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AnnotationConfigApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DaoFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">UserDao</span> userDao <span class=\"token operator\">=</span> applicationContext<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userDao\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserDao</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"yellow-cat\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"노란 고양이\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        userDao<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> foundUser <span class=\"token operator\">=</span> userDao<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertEquals</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> foundUser<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertEquals</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> foundUser<span class=\"token punctuation\">.</span><span class=\"token function\">getPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>테스트를 돌리면 <strong>한번만</strong> 정상적으로 돌아간다.\n다시 실행하면 유니크 값 중복으로 <code class=\"language-text\">insert</code>에 실패하기 때문이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAlElEQVQI13XMSw6CUBBEUfbi0ISJBoO8/sEDVFTA/e/lGjFx5uCkOqlUF/1t4rG+uD4XpnndSGRqczT3eB6Q6Eje/pzV/yqO7chhnKmGmb2M7KqgtCtlE6g7Xc54tJg7FoF5IGokUUR1u8Xsm2oU2vac3LgtK+N9RroB6y/UYjRNQ0oJFcE/Dz9DESKciEBVf8x069/mjmj/IxvTpgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"최초 테스트 성공\"\n        title=\"최초 테스트 성공\"\n        src=\"/static/3d243207804cb00506f8889227b14817/37523/test_success.png\"\n        srcset=\"/static/3d243207804cb00506f8889227b14817/e9ff0/test_success.png 180w,\n/static/3d243207804cb00506f8889227b14817/f21e7/test_success.png 360w,\n/static/3d243207804cb00506f8889227b14817/37523/test_success.png 720w,\n/static/3d243207804cb00506f8889227b14817/302a4/test_success.png 1080w,\n/static/3d243207804cb00506f8889227b14817/07a9c/test_success.png 1440w,\n/static/3d243207804cb00506f8889227b14817/ca3c3/test_success.png 1850w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAlUlEQVQI13XHSw6DIAAAUQ/TnZAm4KfRggJ+YjVFvf9dppF00U0XL5PJhtfKdpws7501HmzxwPgBa3uG3uM6j+k9TxcwLqQ2nfsra/2MGXeqKZKbmVvtuLsV1XoapWl0QXUpLmVSKE2pdKr+6SWzYSRYR4wn0xaxYaKfFhrTofKcSkjqRFAJkVpLyUPK9OX3CyHQQvABEPVlQhlun5EAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"중복 테스트 실패\"\n        title=\"중복 테스트 실패\"\n        src=\"/static/531f8bfc215aa9b12ba829a3b29349e5/37523/test_fail.png\"\n        srcset=\"/static/531f8bfc215aa9b12ba829a3b29349e5/e9ff0/test_fail.png 180w,\n/static/531f8bfc215aa9b12ba829a3b29349e5/f21e7/test_fail.png 360w,\n/static/531f8bfc215aa9b12ba829a3b29349e5/37523/test_fail.png 720w,\n/static/531f8bfc215aa9b12ba829a3b29349e5/302a4/test_fail.png 1080w,\n/static/531f8bfc215aa9b12ba829a3b29349e5/07a9c/test_fail.png 1440w,\n/static/531f8bfc215aa9b12ba829a3b29349e5/ca3c3/test_fail.png 1850w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>테스트를 성공시키려면 DB의 데이터를 비워줘야 한다.\n이를 <code class=\"language-text\">UserDao</code>에 <code class=\"language-text\">deleteAll(), getCount()</code> 메서드를 만듦으로써 보충했다.\n그리고 책 예제의 테스트 스타일이 맞지 않아, 결국 스프링 부트 스타터 테스트로 의존성을 변경하고 평소 스타일대로 작성했다…</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">testImplementation(\"org.springframework.boot:spring-boot-starter-test\")</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDaoTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"사용자 추가 및 조회\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">addAndGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SQLException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ApplicationContext</span> applicationContext <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AnnotationConfigApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DaoFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">UserDao</span> userDao <span class=\"token operator\">=</span> applicationContext<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userDao\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserDao</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        userDao<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>userDao<span class=\"token punctuation\">.</span><span class=\"token function\">getCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"yellow-cat\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"노란 고양이\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        userDao<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>userDao<span class=\"token punctuation\">.</span><span class=\"token function\">getCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> foundUser <span class=\"token operator\">=</span> userDao<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span><span class=\"token function\">getPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>책에는 <code class=\"language-text\">User</code>를 두 번 추가하고 <code class=\"language-text\">getCount()</code>의 값 증가를 확인하고, 두 <code class=\"language-text\">User</code>의 값을 각각 상세 검증하는 코드가 추가되어 있다.</p>\n<br>\n<h3 id=\"tdd로-개발하는-예외처리\" style=\"position:relative;\"><a href=\"#tdd%EB%A1%9C-%EA%B0%9C%EB%B0%9C%ED%95%98%EB%8A%94-%EC%98%88%EC%99%B8%EC%B2%98%EB%A6%AC\" aria-label=\"tdd로 개발하는 예외처리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TDD로 개발하는 예외처리</h3>\n<p>예외처리를 <code class=\"language-text\">TDD</code>로 소개한 부분이 인상깊었다.\n현재 코드에서 <code class=\"language-text\">userDao.get(존재하지 않는 id)</code>를 하면 <code class=\"language-text\">EmptyResultDataAccessException</code>을 발생시키는 기능을 추가하고 싶다고 하자.\n그럼 정상적으로 동작되어야 할 테스트를 먼저 작성한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"존재하지 않는 id 조회 시 예외\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">get_idDoesNotExists_throwException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SQLException</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">ApplicationContext</span> applicationContext <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AnnotationConfigApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DaoFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">UserDao</span> userDao <span class=\"token operator\">=</span> applicationContext<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userDao\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserDao</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    userDao<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assertThatThrownBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> userDao<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unknown_id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">isInstanceOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">EmptyResultDataAccessException</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 테스트는 다른 예외가 발생하면서 실패한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">java.lang.AssertionError: \nExpecting:\n  &lt;java.sql.SQLException: Illegal operation on empty result set.>\nto be an instance of:\n  &lt;org.springframework.dao.EmptyResultDataAccessException>\nbut was:\n  &lt;\"java.sql.SQLException: Illegal operation on empty result set.</code></pre></div>\n<p>이제 <strong>테스트를 통과시킬 코드</strong>를 개발하면 된다.\n<code class=\"language-text\">id</code>로 <code class=\"language-text\">User</code>를 조회했을 때 결과가 없다면 예외를 발생시키는 코드를 추가하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">User</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SQLException</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Connection</span> connection <span class=\"token operator\">=</span> dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">getConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">PreparedStatement</span> statement <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"select id, name, password from users where id = ?\"</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    statement<span class=\"token punctuation\">.</span><span class=\"token function\">setString</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">ResultSet</span> resultSet <span class=\"token operator\">=</span> statement<span class=\"token punctuation\">.</span><span class=\"token function\">executeQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>resultSet<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        user<span class=\"token punctuation\">.</span><span class=\"token function\">setId</span><span class=\"token punctuation\">(</span>resultSet<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        user<span class=\"token punctuation\">.</span><span class=\"token function\">setName</span><span class=\"token punctuation\">(</span>resultSet<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        user<span class=\"token punctuation\">.</span><span class=\"token function\">setPassword</span><span class=\"token punctuation\">(</span>resultSet<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n        resultSet<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        statement<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>user <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EmptyResultDataAccessException</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> user<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>테스트가 통과하는 것을 볼 수 있다.</p>\n<br>\n<h3 id=\"before과-junit-생명주기\" style=\"position:relative;\"><a href=\"#before%EA%B3%BC-junit-%EC%83%9D%EB%AA%85%EC%A3%BC%EA%B8%B0\" aria-label=\"before과 junit 생명주기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@Before과 Junit 생명주기</h3>\n<p>현재 테스트는 <code class=\"language-text\">userDao</code> 빈을 컨테이너에서 가져오는 과정이 중복되어있다.\n이 중복을 Junit의 <code class=\"language-text\">@Before, @BeforeEach</code>를 이용해 제거할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDaoTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserDao</span> userDao<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@BeforeEach</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ApplicationContext</span> applicationContext <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AnnotationConfigApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DaoFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        userDao <span class=\"token operator\">=</span> applicationContext<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userDao\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserDao</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">addAndGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">get_idDoesNotExists_throwException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>원래 <code class=\"language-text\">@Before</code>도 사용해보려고 했는데, <code class=\"language-text\">setUp()</code>이 호출되지 않는 문제가 있었다.\n<code class=\"language-text\">Junit4</code>에서는 모두 <code class=\"language-text\">public</code>이어야 했던 것 같아서 클래스와 메서드 접근제어자를 바꾸기 등등 시도해보았는데 잘 안됐다…\n어쨌든 <code class=\"language-text\">addAndGet(), get_idDoesNotExists_throwException()</code>이 각각 실행될 때 새로운 <code class=\"language-text\">UserDaoTest</code> 인스턴스가 생기고 <code class=\"language-text\">setUp()</code>이 호출된다.\n이는 테스트 간 격리를 위한 <code class=\"language-text\">Junit</code> 기본 스펙이다.\n만약 테스트가 하나의 인스턴스에서 이뤄져야 한다면 어노테이션으로 생명주기를 변경할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@TestInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Lifecycle</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PER_CLASS</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDaoTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>책에서는 생성되는 <code class=\"language-text\">User</code> 픽스쳐도 <code class=\"language-text\">setUp()</code>을 통해 설정하게 바꿔두었는데… 깃헙에 올리진 않았다.\n많은 경우에 픽스쳐와 이를 테스트하는 코드는 거리가 가까운 게 좋다는 생각 때문이다.\n아마 <code class=\"language-text\">@Before</code>로 중복 코드를 제거하는 방식을 보여주려고 여기에도 적용하신 것 같다.</p>\n<br>\n<h3 id=\"테스트-간-애플리케이션-컨텍스트-공유\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EA%B0%84-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8-%EA%B3%B5%EC%9C%A0\" aria-label=\"테스트 간 애플리케이션 컨텍스트 공유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트 간 애플리케이션 컨텍스트 공유</h3>\n<p>솔직히 이 부분은 괜히 익숙한 대로 하겠다고 하다가… 책의 설명을 잘 이해하지 못했다.\n<code class=\"language-text\">@RunWith(SpringJunit4ClassRunner.class)</code>와 <code class=\"language-text\">@SpringBootTest</code>가 비슷한 역할을 해주는 것 같다는 것만 추론했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 그리고 이쯤에서 DaoFactory 라는 이름이 몹시 잘못되었다는게 보여서 AppConfig로 바꿨다  </span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token annotation punctuation\">@ContextConfiguration</span><span class=\"token punctuation\">(</span>classes <span class=\"token operator\">=</span> <span class=\"token class-name\">DaoFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDaoTest</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ApplicationContext</span> applicationContext<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserDao</span> userDao<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token annotation punctuation\">@BeforeEach</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        userDao <span class=\"token operator\">=</span> applicationContext<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userDao\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserDao</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>콘솔로 각 테스트 메서드에서 <code class=\"language-text\">this(UserDaoTest의 인스턴스)</code>와 <code class=\"language-text\">applicationContext</code>를 찍어보면,\n<code class=\"language-text\">UserDaoTest</code>는 매번 새 인스턴스가 만들어짐에도 불구하고 <code class=\"language-text\">applicationContext</code>은 같은 인스턴스가 재활용됨을 볼 수 있다.\n<code class=\"language-text\">ApplicationContext</code>도 스프링 빈으로 등록되기 때문이다.\n만약 동일하게 <code class=\"language-text\">@ContextConfiguration(classes = DaoFactory.class)</code>만 사용하는 (그러니까 애플리케이션 컨텍스트 설정이 같은) 다른 테스트 클래스가 있다면,\n그 클래스의 인스턴스들과도 동일한 <code class=\"language-text\">applicationContext</code>를 공유한다.\n인수테스트를 배우며 알게된 <code class=\"language-text\">@DirtiesContext</code>로 새로운 애플리케이션 컨텍스트를 생성하도록 강제할 수 있다.</p>\n<p>아예 <code class=\"language-text\">UserDao</code>를 주입받도록 변경할 수도 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token annotation punctuation\">@ContextConfiguration</span><span class=\"token punctuation\">(</span>classes <span class=\"token operator\">=</span> <span class=\"token class-name\">AppConfig</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDaoTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserDao</span> userDao<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">DataSource</code>를 주입받아 테스트에서 다른 DB를 사용하도록 할 수도 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token annotation punctuation\">@ContextConfiguration</span><span class=\"token punctuation\">(</span>classes <span class=\"token operator\">=</span> <span class=\"token class-name\">TestAppConfig</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDaoTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DataSource</span> dataSource<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestAppConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DataSource</span> <span class=\"token function\">dataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SimpleDriverDataSource</span> dataSource <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleDriverDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        dataSource<span class=\"token punctuation\">.</span>set<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> dataSource<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>책과 같은 방식은 아니지만 예전에 <a href=\"https://hyewoncc.github.io/spring-study-1/\">테스트에서만 빈 갈아 끼우기</a>를 고민한 적 있어서 반가웠다.</p>\n<br>\n<h3 id=\"아니면-컨테이너를-없애버리기\" style=\"position:relative;\"><a href=\"#%EC%95%84%EB%8B%88%EB%A9%B4-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88%EB%A5%BC-%EC%97%86%EC%95%A0%EB%B2%84%EB%A6%AC%EA%B8%B0\" aria-label=\"아니면 컨테이너를 없애버리기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>아니면, 컨테이너를 없애버리기</h3>\n<p>순수하게 <code class=\"language-text\">UserDao</code>만 테스트 할 것이라면 이런 식으로 <code class=\"language-text\">DI</code>를 할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDaoTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserDao</span> userDao<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@BeforeEach</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        userDao <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserDao</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        userDao<span class=\"token punctuation\">.</span><span class=\"token function\">setDataSource</span><span class=\"token punctuation\">(</span><span class=\"token function\">dataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DataSource</span> <span class=\"token function\">dataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SimpleDriverDataSource</span> dataSource <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleDriverDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setDriverClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>mysql<span class=\"token punctuation\">.</span>cj<span class=\"token punctuation\">.</span>jdbc<span class=\"token punctuation\">.</span></span>Driver</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"jdbc:mysql://localhost:3306/springbook?serverTimezone=Asia/Seoul\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setUsername</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"spring\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setPassword</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"book\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> dataSource<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>우테코 레벨1에서 <a href=\"https://github.com/woowacourse/java-chess\">콘솔 체스 게임 만들기 미션</a>을 할 때,\n체스판을 뜻하는 <code class=\"language-text\">Board</code> 객체를 테스트에서 <code class=\"language-text\">DI</code>를 이용해 초기화해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">Board</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">PiecesSetup</span> piecesSetup<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pieces <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Pieces</span><span class=\"token punctuation\">(</span>piecesSetup<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">PiecesSetup</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Position</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Piece</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"폰은 상대기물이 목적지에 존재하면 대각선으로 움직일 수 있다\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">pawnCanMoveDiagonal_targetExist</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Piece</span> whitePawn <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Piece</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Color</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WHITE</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Pawn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Board</span> board <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Board</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Position</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Piece</span><span class=\"token punctuation\">></span></span> pieces <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pieces<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Position</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> whitePawn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pieces<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Position</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Piece</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Color</span><span class=\"token punctuation\">.</span><span class=\"token constant\">BLACK</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Pawn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> pieces<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    board<span class=\"token punctuation\">.</span><span class=\"token function\">move</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"b3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>board<span class=\"token punctuation\">.</span><span class=\"token function\">findPiece</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Position</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>whitePawn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 테스트 상황에 맞는 데이터를 주입해 생성할 수 있었다.\n<code class=\"language-text\">DI</code>가 스프링에 종속적인 기술이 아니라는 걸, 순수(?) 자바 애플리케이션 테스트를 통해 체득할 수 있었다.</p>\n<p>전체 실습 코드는 <a href=\"https://github.com/hyewoncc/topring/tree/chapter2\">깃헙 topring 레포</a>에서 볼 수 있다.</p>\n<br>\n<h2 id=\"학습테스트를-만들자\" style=\"position:relative;\"><a href=\"#%ED%95%99%EC%8A%B5%ED%85%8C%EC%8A%A4%ED%8A%B8%EB%A5%BC-%EB%A7%8C%EB%93%A4%EC%9E%90\" aria-label=\"학습테스트를 만들자 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>학습테스트를 만들자!</h2>\n<p>토프링 내용 요약은 위에서 거의 끝났고, 여기는 번외 느낌이다.\n학습테스트로 학습을 한번이라도 해 본 사람들은 학습테스트의 ✨멋짐✨을 알 것이다.\n나는 평소에 <code class=\"language-text\">XXX-sandbox</code>라는 이름으로 프로젝트를 만들어 공부한 코드를 정리하고, 블로그에 올릴 예제 코드를 깃헙에 올린다.\n솔직히 공부가 잘되는 건 둘째치고… 정말 훌륭한 커닝페이퍼가 되어준다.\n코틀린으로 given/when/then 테스트 어떻게 작성했더라? 하면 구글에서 검색하고 블로그의 코드블럭 긁어오고 할 필요 없이 그냥 프로젝트 켜서 보면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> BehaviorTest<span class=\"token operator\">:</span> <span class=\"token function\">BehaviorSpec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token function\">given</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"when으로 동물 소리룰 찾으면\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> grammar <span class=\"token operator\">=</span> <span class=\"token function\">Grammar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token function\">`when`</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"고양이는\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> name <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"cat\"</span></span>\n            <span class=\"token keyword\">val</span> sound <span class=\"token operator\">=</span> grammar<span class=\"token punctuation\">.</span><span class=\"token function\">whenAnimalSound</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"야옹이 나온다\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                sound shouldBe <span class=\"token string-literal singleline\"><span class=\"token string\">\"meow\"</span></span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">`when`</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"개는\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> name <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"dog\"</span></span>\n            <span class=\"token keyword\">val</span> sound <span class=\"token operator\">=</span> grammar<span class=\"token punctuation\">.</span><span class=\"token function\">whenAnimalSound</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"멍멍이 나온다\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                sound shouldBe <span class=\"token string-literal singleline\"><span class=\"token string\">\"woff\"</span></span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">`when`</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"이름 모를 동물은\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> name <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"x\"</span></span>\n            <span class=\"token keyword\">val</span> sound <span class=\"token operator\">=</span> grammar<span class=\"token punctuation\">.</span><span class=\"token function\">whenAnimalSound</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"unknown이 나온다\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                sound shouldBe <span class=\"token string-literal singleline\"><span class=\"token string\">\"unknown\"</span></span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>막상 올리려니 부끄럽긴한데 어쨌든 이런식으로 정리해두고 유용하게 베끼고 있다.</p>\n<br>\n<p>이번 장은 지난번 보다 가볍게 읽었다.\n테스트를 모르던 때 읽었다면 어땠을까?\n감동받아서 테스트 신봉자가 되었을까, 아니면 이런게 있구나 하고 넘어갔을까.\n어쨌든 지금은 테스트없는 개발이 부실공사로 보인다.\n그런 코드는 빨리 진행되는 것 같아도 한번 무너지면 겉잡을 수 없게 된다.\n테스트의 멋짐을 알게 되고 나서는 기능을 추가하거나 리팩터링 한 뒤에 전체 테스트를 돌리고 초록불이 일사분란하게 켜지는 걸 보는 재미로 코드를 짠다.\n다음장은 훑어보니 만만치 않은 것 같은데 다음주가 기대된다.</p>\n<p>그리고 포스팅 제목을 위트있게 짓고 싶었는데 아무 생각도 나지 않아서 이모지나 붙였다.\n테스트의 멋짐이 전해지면 좋겠다…</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#2%EC%9E%A5-%ED%85%8C%EC%8A%A4%ED%8A%B8\">2장 테스트</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B4%88%EB%82%9C%EA%B0%90-userdaotest-%EA%B0%9C%EC%84%A0%EA%B8%B0\">초난감 UserDaoTest 개선기</a></p>\n<ul>\n<li><a href=\"#junit-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\">Junit 적용하기</a></li>\n<li><a href=\"#tdd%EB%A1%9C-%EA%B0%9C%EB%B0%9C%ED%95%98%EB%8A%94-%EC%98%88%EC%99%B8%EC%B2%98%EB%A6%AC\">TDD로 개발하는 예외처리</a></li>\n<li><a href=\"#before%EA%B3%BC-junit-%EC%83%9D%EB%AA%85%EC%A3%BC%EA%B8%B0\">@Before과 Junit 생명주기</a></li>\n<li><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EA%B0%84-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8-%EA%B3%B5%EC%9C%A0\">테스트 간 애플리케이션 컨텍스트 공유</a></li>\n<li><a href=\"#%EC%95%84%EB%8B%88%EB%A9%B4-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88%EB%A5%BC-%EC%97%86%EC%95%A0%EB%B2%84%EB%A6%AC%EA%B8%B0\">아니면, 컨테이너를 없애버리기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%95%99%EC%8A%B5%ED%85%8C%EC%8A%A4%ED%8A%B8%EB%A5%BC-%EB%A7%8C%EB%93%A4%EC%9E%90\">학습테스트를 만들자!</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"September 18, 2022","title":"✨🌈💫테스트💫🌈✨ (토비의 스프링)","categories":"Spring","author":"써머","emoji":"headers/topring-chapter1.png"},"fields":{"slug":"/topring-chapter2/"}},"prev":{"id":"64b7ae52-9f74-5c76-abbd-81a0703ad323","html":"<h2 id=\"-줍줍-mysql-인덱스-탐험\" style=\"position:relative;\"><a href=\"#-%EC%A4%8D%EC%A4%8D-mysql-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%ED%83%90%ED%97%98\" aria-label=\" 줍줍 mysql 인덱스 탐험 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🧳 줍줍 MySQL 인덱스 탐험</h2>\n<p>❗️ 해당 포스팅에서 지칭하는 <strong>책</strong>은 모두 <a href=\"https://search.shopping.naver.com/book/catalog/32443973624?cat_id=50010586&#x26;frm=PBOKPRO&#x26;query=realmysql&#x26;NaPm=ct%3Dl8u5bsc0%7Cci%3D283e817c3ef615da4bb3c94f9385d94070cbbc93%7Ctr%3Dboknx%7Csn%3D95694%7Chk%3D702ada6411525c62218b0df3e900c84c33c4cdd2\">Real MySQL 8.0 1권</a>을 뜻합니다.</p>\n<p>우테코 팀 프로젝트 5차 스프린트에서 성능 테스트로 톰캣 설정 최적화 / 모든 쿼리 수집 후 DB 인덱스 설정 이라는 두 개의 백엔드 과제가 있었다.\n나는 이 중 <strong>DB 인덱스 설정</strong>을 맡게 되었다.\n줍줍의 전체 테이블 구조는 정석 ERD보다 간략하게 표현하자면 이렇다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB9ElEQVQozz2S23KbQBBE9QPiDiuW5bJACVlIJjJGFyzZqSR+cN78/x9zUrty/DBQw7Dd0729CIIAU47rsnQcPM+zvR8EuK5n+/Fw4DhNRFGE5/l2Zv/xfRzHwXXd735hHubDQ9cxX84opSx4FHrsu4KyrGhrzfXlhTwvSGOPJApZLh2klMzzzG63+15kIVOByiSFUoxPT7RtQxQKZByy60p+/f5D0zTcbldeX39SyJgsdml0bgG3260F/L/lQknBcXomEYJhGLjMZ5TUFCtDkjAdT+iq4vl5ZN1tyIRPXcUcxoHr9cZms2EcR9I0vQPGUWSZTBPHMUIkxNGKMpWkiYcfhF8+OTiuhxQBstUUTcvhcKCqKvq+tyqM7IUxPs9zu7oZdN2aXFUUaYqI7iB9v2W/31tw42FWKUsSBD5lWdqFviWnqwSlMrTWnM9n6+FK5OQric4TC7J92DBNE2EYkeUrsnWL47iEYWjPGLI7gQUUzPOF9XptD9V1jc5K+kozDz3zy9XKMR6mqUTlEv1QM/Qtdd1YyUadATe18P2AYfhhzTXSDKCIA5LQYdMWfH5+cjqdeH9/t2Uik8iEp/ORvx8fPD4+crvdyLLsvqEN9Vc4TRljDcnScdG6ssabG7xcLry9vdk0mJwa+UIIe5Fmbt4m2P8Av94QAZ/CxekAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"erd\"\n        title=\"erd\"\n        src=\"/static/04f240438cca4d0a360f7e62c155feaa/37523/jupjup_tables.png\"\n        srcset=\"/static/04f240438cca4d0a360f7e62c155feaa/e9ff0/jupjup_tables.png 180w,\n/static/04f240438cca4d0a360f7e62c155feaa/f21e7/jupjup_tables.png 360w,\n/static/04f240438cca4d0a360f7e62c155feaa/37523/jupjup_tables.png 720w,\n/static/04f240438cca4d0a360f7e62c155feaa/302a4/jupjup_tables.png 1080w,\n/static/04f240438cca4d0a360f7e62c155feaa/07a9c/jupjup_tables.png 1440w,\n/static/04f240438cca4d0a360f7e62c155feaa/95e59/jupjup_tables.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>쿼리 수집은 쉬웠다.\n줍줍의 모든 <code class=\"language-text\">Repository</code> 클래스들은 <code class=\"language-text\">Repository&lt;Domain, ID></code>를 상속했다.\n<code class=\"language-text\">JpaRepository</code>는 선언하지 않은 메서드도 사용 가능한 반면, <code class=\"language-text\">Repository</code>를 상속하면 선언한 메서드만 사용 가능하다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABpUlEQVQoz32S2Y7aQBBF+ZpkcC/esCcoGBizGe8bmCUj5f9/4kRu0Ix4ycPRvV1S3ypV98RVPxFvP5DWG1paKKVRWj9UCrSYopRCa42U0nj1VCkshPXKZHUoWO0Lfsd7vCDEmwV4QYAfhPjh+4Pg/fscfNdm4StjfTJfbtjGMfkxoTqs2K3n+GGAbTsPnP9gO2jbNozecT0mSgksYeEqF9f28GyfJMnYJ0eWqzXRckW0Wj/8k0d9zUe8YbPdEW+2rD9i02Qy7sLTUxwtULZm5vtcz3+4fv6l7QeKuqOoW9KiJiubF8qmoztfOF/uxjuuy0Qqxcy2iHyLefiLONoytFdO1ztt11O3PWXdUNYtSZqx2R3Y7RO2+4R9klJUNW13Is0LHGcMlJKpEEynFkIqlosFt9Od4f5JfzrT9icT1vVniqox5GXNMSs4HDN2hyNNdyIvq2egUgglzJOP3yVaRFy6mwkcLjeatqduOuq2M8FV05IVlZnsoY0JHBuYHUolzaMIM+UUR2mG9kI3XE3YOE2Wl+ZCkuZfmualaWCoGnZJitI2/wC8hzdG9GmzpQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JpaRepository\"\n        title=\"JpaRepository\"\n        src=\"/static/610e8798201278004b7fd531bea1d86f/37523/jpa_repository.png\"\n        srcset=\"/static/610e8798201278004b7fd531bea1d86f/e9ff0/jpa_repository.png 180w,\n/static/610e8798201278004b7fd531bea1d86f/f21e7/jpa_repository.png 360w,\n/static/610e8798201278004b7fd531bea1d86f/37523/jpa_repository.png 720w,\n/static/610e8798201278004b7fd531bea1d86f/302a4/jpa_repository.png 1080w,\n/static/610e8798201278004b7fd531bea1d86f/07a9c/jpa_repository.png 1440w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  JpaRepository를 상속했을 때\n</div>\n<br>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABiElEQVQoz32S247aMBRF8zUVkKsdOwnkSiiXMAQCYRhGpdNW6v//wqoSYAoP7cPS2Tq29tk+siFchyTNSdOEoixJJpp65rMqNXk2ZhxIpK/QgcZxbGz7jsVoNMI0zScM23HIsoJZEVHNE9K84OssZz7tzDx0GCGkRAgP0xz1Jv/DcGybsXIp0pB0IplmEWms8ZVGCInWGs+x+ul/0/0bY5LEBHFGMElwpUIr0eOJG15X5TWllL32HqqQz2dGuW5ZbvYsXmrKIiZJIoQOkErj6+AT+aAfe929O34QYjiOgxIWZZGymudMi5isyAnDCCklvu/fUA/6hlIEQYDSul+N67oY3buHlslgaPJlMMS2bF7bd96//2CzbVis1j3zZfWp76zWG7bNgX372tduPb1h5A1IlUkUhuRxzre3Dy6/fnP5+MnxdGa3b6mbA9umZV3veqrNjt3hyOF4oj2daQ7H6w4ty8KyTKQ9RHiCWbHgcnyjPV96k+qlfmK53rCsrnQJV7d+l7D7FX8A4/ctw+64JMEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Repository\"\n        title=\"Repository\"\n        src=\"/static/07fa46015009235d0a4b55a84bc7d699/37523/repository.png\"\n        srcset=\"/static/07fa46015009235d0a4b55a84bc7d699/e9ff0/repository.png 180w,\n/static/07fa46015009235d0a4b55a84bc7d699/f21e7/repository.png 360w,\n/static/07fa46015009235d0a4b55a84bc7d699/37523/repository.png 720w,\n/static/07fa46015009235d0a4b55a84bc7d699/302a4/repository.png 1080w,\n/static/07fa46015009235d0a4b55a84bc7d699/07a9c/repository.png 1440w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  Repository를 상속했을 때\n</div>\n<br>\n<p>뒤집어 말하면 <code class=\"language-text\">QueryDsl</code>사용을 제외하면, <code class=\"language-text\">Repository</code> 코드의 모든 메서드가 곧 프로젝트에 사용 중인 모든 쿼리였다.</p>\n<br>\n<h2 id=\"쿼리-최적화-by봄\" style=\"position:relative;\"><a href=\"#%EC%BF%BC%EB%A6%AC-%EC%B5%9C%EC%A0%81%ED%99%94-by%EB%B4%84\" aria-label=\"쿼리 최적화 by봄 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>쿼리 최적화 by.봄🌱</h2>\n<p>인덱스 최적화를 시작하기 전에 고맙게도 같은 팀 크루인 봄이 <a href=\"https://github.com/woowacourse-teams/2022-pickpick/pull/531\">불필요햔 left outer join을 제거하는 쿼리 최적화</a>를 해주었다!\n<code class=\"language-text\">Repository</code>에서 <code class=\"language-text\">B</code>의 PK를 FK로 가진 <code class=\"language-text\">A</code>가 해당 FK를 조건으로 조회할 때, <code class=\"language-text\">findByBId</code>로 하면 불필요한 <code class=\"language-text\">left outer join</code>이 발생하고 있었다.\n이를 이미 <code class=\"language-text\">B</code>를 조회한 곳에서는 <code class=\"language-text\">findByB</code>를 사용하도록 바꾸고, <code class=\"language-text\">B</code>를 조회하지 않는 곳에서는 <code class=\"language-text\">@Query</code>로 직접 쿼리문을 작성해 개선해주었다.\n고마워요 최고 봄!</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 멤버의 채널 구독을 화면 순서대로 가져오는 메서드</span>\n<span class=\"token comment\">// Before</span>\n<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ChannelSubscription</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findFirstByMemberIdOrderByViewOrderDesc</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// After</span>\n<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ChannelSubscription</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findFirstByMemberOrderByViewOrderDesc</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 멤버와 메시지로 일치하는 북마크를 찾는 메서드</span>\n<span class=\"token comment\">// Before</span>\n<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Bookmark</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByMessageIdAndMemberId</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> messageId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// After</span>\n<span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select b from Bookmark b WHERE b.message.id = :messageId and b.member.id = :memberId\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Bookmark</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByMessageIdAndMemberId</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> messageId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<h2 id=\"-실험-환경\" style=\"position:relative;\"><a href=\"#-%EC%8B%A4%ED%97%98-%ED%99%98%EA%B2%BD\" aria-label=\" 실험 환경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🧪 실험 환경</h2>\n<p>모든 테스트는 로컬 <code class=\"language-text\">docker</code>에 <code class=\"language-text\">mysql</code>을 띄워, 프로젝트와 동일하게 DB를 설정해 진행했다.<br>\n그리고 <code class=\"language-text\">프로시저</code>로 10만건의 <code class=\"language-text\">Member</code> 더미데이터를 넣으려고 했는데…\n느려도 <strong>너무</strong> 느렸다.\n찾아보니 유니크한 <code class=\"language-text\">slackId</code>를 부여하기 위해 <code class=\"language-text\">UUID</code> 값 생성 후 적당히 잘라서 쓰고 있었는데, 여기가 문제였다.\n그래서 <code class=\"language-text\">JdbcTemplate</code>의 <code class=\"language-text\">batchUpdate</code>로 데이터를 넣도록 간단한 코드를 짰다.\n10만건 삽입에 프로시저는 <strong>4분</strong> 전후, 자바 코드로는 16초가 걸렸다…\n<code class=\"language-text\">JdbcTemplate</code>으로 하는 게 훨씬 빠르다고 알려준 매트에게 고맙다.😭</p>\n<br>  \n<h2 id=\"️-mysql의-자동-생성-인덱스\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-mysql%EC%9D%98-%EC%9E%90%EB%8F%99-%EC%83%9D%EC%84%B1-%EC%9D%B8%EB%8D%B1%EC%8A%A4\" aria-label=\"️ mysql의 자동 생성 인덱스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⚙️ MySQL의 자동 생성 인덱스</h2>\n<p>사실 내가 모르는 새에 우리 DB에는 필요한 대부분의 인덱스가 설정되어 있었다.\n컬럼이 1.유니크하면서 2.null을 허용하지 않을 때, MySQL에서 자동으로 해당 컬럼으로 인덱스를 만들기 때문이다.\n마침 프로젝트에서 슬랙 정보를 이용하는 <code class=\"language-text\">member, channel, message</code> 테이블에는 해당 조건을 충족하는 <code class=\"language-text\">slack_id</code> 컬럼이 있었다.\n아래 그림에서 하이라이트 된 컬럼은 모두 자동 인덱스가 이미 설정 된 컬럼이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACnElEQVQozyWSzWscZQDGB2qx6e687zvvfM/u7OxmM5NM9qu7TbLZtHHTlMQmbtLQptVYba1EYiqCYrRa6KFV8ANPASmix/4lIoo3BS/FqyBePHn/SdbDc3g+Dg8Pj6G1RmsbKRVCSCxljfmJLqSgIE7R6tTpns+R+nmELIw9+yRj2UihUMrC1s5YNyzLwhRnybIai4tzRCUPU5rYusD8bJdR55jd3ne8eeV7Ru0nNErL2E6RglnADQQLgw4zjUkK4jksrTBKUUivfp2lbJ+NwT2GrbdJw1V8p0gv73B3+5i1zgP21j/j9uYxzaSP75xmfvol1vLP2el/zc7gCxbjT/CdCkYclbmx8piV9BHXLnzJ7RefsFC/SzlwqZRdunNNSonNuV5OLSsTeYKkItge3ufhzWccDH/ig9Gv3Dn/M5GbYbiOS7U8S9ltEvuzJFGDkpdTCQMiz8K2A5S0UVKjlEvJdwinqlRqM3TbC9SrszTzOaanzmFZGkNKSVBS1GcC0jymlnqEkUcSRnhOkQnzFFkekzcnKarT+E6BcjXGNAtIq0hcCfFDB1NMoLWFEQYB7ckr9GdusfnCWwyae6Tl4bhJltRplV5lrfcuW8vv0YlvkVa7hGmCkh6Bm3BxaZVuu49W3vgdRhzV+Ojqb3x46R8ebP3J0fBfbrSeMlURbMzt8PD6X7xz8Q+ONp9xb/5vBtP7RJngav9jDpZ+542FHzlc+YVXGj8QuSmG1g793mV6zVXm22u0s1WqQYZrn6WZ5uy//Jjt4fvsje7z2tYjEr+BHUouLb/O4e63XLvwFXc2vuFy/imeHWNY+v8fnmwwhjyDtARFYZJONlgfHNCt3WS0csju+hFJ1MIURbQtsT0TZU/g+ALlnMGyFP8BViM3exuWJ9oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"indexes\"\n        title=\"indexes\"\n        src=\"/static/d2fabf195ae1c7d0be2a4c9faeca315e/37523/db_indexes.png\"\n        srcset=\"/static/d2fabf195ae1c7d0be2a4c9faeca315e/e9ff0/db_indexes.png 180w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/f21e7/db_indexes.png 360w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/37523/db_indexes.png 720w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/302a4/db_indexes.png 1080w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/07a9c/db_indexes.png 1440w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/95e59/db_indexes.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그래도 궁금하니 한번 자동 생성된 인덱스를 삭제하고 <code class=\"language-text\">explain analyze</code> 쿼리를 통해 실행 시간을 재어 보았다.\n<code class=\"language-text\">member</code>에 10만개의 데이터를 넣고 99,998번째 row의 <code class=\"language-text\">slack_id</code>로 검색했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">explain</span> <span class=\"token keyword\">analyze</span>\n<span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> first_login<span class=\"token punctuation\">,</span> slack_id<span class=\"token punctuation\">,</span> thumbnail_url<span class=\"token punctuation\">,</span> username\n<span class=\"token keyword\">from</span> member\n<span class=\"token keyword\">where</span> slack_id <span class=\"token operator\">=</span> :slackId<span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAW0lEQVQI11WLSw6AIAxEuRO05VdYaox6/9uMoRCji+Z13mTcft7YjgvaOqq294oqStWfM7/c6Gvrk5/OEUdIymBJYIkgFmMghvcBHJN1gcT+4cdmUGJeeW58IDxruEMlyKijswAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인덱스 있을 떄\"\n        title=\"인덱스 있을 떄\"\n        src=\"/static/1a39f7c934454940377514a42a306e62/37523/time_auto_index_member.png\"\n        srcset=\"/static/1a39f7c934454940377514a42a306e62/e9ff0/time_auto_index_member.png 180w,\n/static/1a39f7c934454940377514a42a306e62/f21e7/time_auto_index_member.png 360w,\n/static/1a39f7c934454940377514a42a306e62/37523/time_auto_index_member.png 720w,\n/static/1a39f7c934454940377514a42a306e62/302a4/time_auto_index_member.png 1080w,\n/static/1a39f7c934454940377514a42a306e62/2cefc/time_auto_index_member.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAWklEQVQI102LURKFIAwDvZJAW2gL97/VvhF9o1/ZzCZHZOKRRE48YnPORa6FexBPv/3L/9+3X3nYcGoTRDul1M0jJp6T8yw0Ua6N9nE7z70VNWp7nHWaGmKdHxmTQqRt4VJdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인덱스 없을 때\"\n        title=\"인덱스 없을 때\"\n        src=\"/static/33cb14290223f0b53720a3ba42a4f52e/37523/time_no_index_member.png\"\n        srcset=\"/static/33cb14290223f0b53720a3ba42a4f52e/e9ff0/time_no_index_member.png 180w,\n/static/33cb14290223f0b53720a3ba42a4f52e/f21e7/time_no_index_member.png 360w,\n/static/33cb14290223f0b53720a3ba42a4f52e/37523/time_no_index_member.png 720w,\n/static/33cb14290223f0b53720a3ba42a4f52e/302a4/time_no_index_member.png 1080w,\n/static/33cb14290223f0b53720a3ba42a4f52e/2cefc/time_no_index_member.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>자동 생성된 인덱스를 두고 조회했을 때 <strong>0.017~0.025ms</strong>가,\n해당 인덱스를 삭제하고 조회했을 때 <strong>1857ms</strong>가 소요되었다.\n1.8초도 느리긴 하지만, <strong>10000배</strong> 차이난다고 생각하니 정말 많~이 느려졌다.</p>\n<p>그럼 프로젝트의 쿼리가 최적의 인덱스를 타고 있는지 일단 <strong>모두</strong> 확인해보자.</p>\n<ul>\n<li>Member\n<ul>\n<li>✅ findById(Long id)</li>\n<li>✅ findBySlackId(String slackId)</li>\n</ul>\n</li>\n<li>Channel\n<ul>\n<li>✅ findById(Long id)</li>\n<li>✅ findBySlackId(String slackId)</li>\n<li>⬜️ findAllByOrderByName()</li>\n</ul>\n</li>\n<li>ChannelSubscription\n<ul>\n<li>✅ findAllByMemberId(Long memberId)</li>\n<li>⬜️ findAllByMemberIdOrderByViewOrder(Long memberId)</li>\n<li>⬜️ findFirstByMemberOrderByViewOrderDesc(Member member)</li>\n<li>⬜️ findFirstByMemberIdOrderByViewOrderAsc(Long memberId)</li>\n<li>⬜️ existsByChannelAndMember(Channel channel, Member member)</li>\n</ul>\n</li>\n<li>Message\n<ul>\n<li>✅ findById(long id)</li>\n<li>✅ findBySlackId(String slackMessageId)</li>\n<li>⬜️ Querydsl을 이용한 복잡한 조회쿼리</li>\n</ul>\n</li>\n<li>Bookmark\n<ul>\n<li>✅ findById(Long id)</li>\n<li>⬜️ findByMessageIdAndMemberId(Long messageId, Long memberId)</li>\n<li>⬜️ Querydsl을 이용한 복잡한 조회쿼리</li>\n</ul>\n</li>\n<li>Reminder\n<ul>\n<li>✅ findById(Long id)</li>\n<li>⬜️ findByMessageIdAndMemberId(Long messageId, Long memberId)</li>\n<li>⬜️ findAllByRemindDate(LocalDateTime remindDate)</li>\n<li>⬜️ Querydsl을 이용한 복잡한 조회쿼리</li>\n</ul>\n</li>\n</ul>\n<p>이미 최적의 인덱스를 사용하고 있을 쿼리는 체크해줬다.\n위에서부터 하나씩 제거해보자.</p>\n<h2 id=\"-channel\" style=\"position:relative;\"><a href=\"#-channel\" aria-label=\" channel permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📺 Channel</h2>\n<p>채널의 <code class=\"language-text\">findAllByOderByName()</code>은 워크스페이스의 모든 채널 목록을 반환한다.\n현재 1.한 워크스페이스만 지원하고있고 2.공개 채널만 저장되기 떄문에, 별다른 조건을 주지 않고 모두 조회중이다.\n그래서 넉넉하게 500개의 데이터를 넣고 조회했는데, <code class=\"language-text\">name</code> 컬럼에 인덱스를 설정 한 것과 안 한 것의 차이가 없었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> channel\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name <span class=\"token keyword\">asc</span>\n<span class=\"token keyword\">limit</span> <span class=\"token number\">500</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXElEQVQI11WKRwqAMBQFPZIpv8Q0d4qS+x/niQlBXAwzvyzn3XBcDaXuSLkgptQ9yaX+5knMeXT5dltMWJwnsASQaLe1DsQCFu3WEEGs/e5JRvPbPP40DCRgNQYPa0VDHytJ0mgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인덱스 없음\"\n        title=\"인덱스 없음\"\n        src=\"/static/d31fb8ed49d623f761fac015c0265def/37523/channel_name_no_index.png\"\n        srcset=\"/static/d31fb8ed49d623f761fac015c0265def/e9ff0/channel_name_no_index.png 180w,\n/static/d31fb8ed49d623f761fac015c0265def/f21e7/channel_name_no_index.png 360w,\n/static/d31fb8ed49d623f761fac015c0265def/37523/channel_name_no_index.png 720w,\n/static/d31fb8ed49d623f761fac015c0265def/302a4/channel_name_no_index.png 1080w,\n/static/d31fb8ed49d623f761fac015c0265def/2cefc/channel_name_no_index.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAWUlEQVQI133KNw6AMBBEUR8Jhw3GiQ4E8v2PM0g2FDQUX0+rWXNcHfvZUduGXCpSzsO3Utvn/mtNGcYHAksEiQ6d8yAWsOhQYwKxjj2QTFmefwVrnEnEYi1ubElDJ21QWRcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인덱스 있음\"\n        title=\"인덱스 있음\"\n        src=\"/static/e54bad9215158cf816ce4b318c933763/37523/channel_name_index.png\"\n        srcset=\"/static/e54bad9215158cf816ce4b318c933763/e9ff0/channel_name_index.png 180w,\n/static/e54bad9215158cf816ce4b318c933763/f21e7/channel_name_index.png 360w,\n/static/e54bad9215158cf816ce4b318c933763/37523/channel_name_index.png 720w,\n/static/e54bad9215158cf816ce4b318c933763/302a4/channel_name_index.png 1080w,\n/static/e54bad9215158cf816ce4b318c933763/2cefc/channel_name_index.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>name 인덱스 X</th>\n<th>name 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>15~34ms</td>\n<td>15~33ms</td>\n</tr>\n</tbody>\n</table>\n<p><code class=\"language-text\">order by</code>는 원래 인덱스를 이용하지 않나 싶어서 책이랑 구글도 찾아봤는데 이유를 잘 모르겠다.\n데이터가 너무 적어서 그럴 수도 있겠다.\n어쨌든 추가로 인덱스를 설정하지 않았다.</p>\n<h2 id=\"-channelsubscription\" style=\"position:relative;\"><a href=\"#-channelsubscription\" aria-label=\" channelsubscription permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🔖 ChannelSubscription</h2>\n<p>채널 구독은 2000명의 멤버가 500개의 채널을 각각 구독하는 상황을 가정해 <strong>10만개</strong>의 더미데이터를 삽입했다.\n우선 쿼리가 비슷한 아래 세 메서드를 보자.</p>\n<ul>\n<li>findAllByMemberIdOrderByViewOrder(Long memberId)</li>\n<li>findFirstByMemberOrderByViewOrderDesc(Member member)</li>\n<li>findFirstByMemberIdOrderByViewOrderAsc(Long memberId)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> channel_subscription\n<span class=\"token keyword\">where</span> member_id <span class=\"token operator\">=</span> :memberId\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> view_order<span class=\"token punctuation\">;</span> <span class=\"token comment\">#desc;</span>\n<span class=\"token keyword\">limit</span> <span class=\"token number\">500</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">#limit 1; </span></code></pre></div>\n<p>구독은 멤버에 종속적인 개념이기에, 항상 <code class=\"language-text\">memberId</code>를 기준으로 조회된다.\n그리고 <code class=\"language-text\">view_order</code> 순서대로 모두 조회하기 또는 첫번째 값을 가져오기기에,\n<code class=\"language-text\">memberId</code>와 <code class=\"language-text\">view_order</code>로 복합 인덱스를 설정해봤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> member_view_order <span class=\"token keyword\">on</span> channel_subscription <span class=\"token punctuation\">(</span>member_id<span class=\"token punctuation\">,</span> view_order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>복합 인덱스를 설정했을 떄, 실제로 해당 인덱스를 이용해 쿼리가 실행된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAdElEQVQI1x2LWRKCMBBEOVISKqBmMhMUKZaS0vsf5lnMVy+vu7M2UYogVZFaKSKuqsay7SzbwfScPR/nj/e6O79++/lFraFmrMeH6TXTVW08pCJqSDXuRbg60UbOAzEmYoyklHxTRJ0N48193/fOQwjkYeQP4UJEkmuOp8wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 전\"\n        title=\"복합 인덱스 설정 전\"\n        src=\"/static/08f9887cb6960baf9eda7bd0ac3b125d/37523/subs_explain_no_index.png\"\n        srcset=\"/static/08f9887cb6960baf9eda7bd0ac3b125d/e9ff0/subs_explain_no_index.png 180w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/f21e7/subs_explain_no_index.png 360w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/37523/subs_explain_no_index.png 720w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/302a4/subs_explain_no_index.png 1080w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/07a9c/subs_explain_no_index.png 1440w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/95e59/subs_explain_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAdklEQVQI1z3KWw6CMBRFUQbUiyJtAWkLlVeFaJz/ZLahMX6d7JVThDHSe48PA/P2ZFo2nA/s7w9hGOmdz7umnce8/n6JOC0MMZKOV7bzc3phbIttO4xtqLWhLC+IlNydz2abDm0s16pCRFBK5a5udW6t9d+VCF+wN0MXUyQZPgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 후\"\n        title=\"복합 인덱스 설정 후\"\n        src=\"/static/378940d78a6f24c78f34d64c660e2bc8/37523/subs_explain_index.png\"\n        srcset=\"/static/378940d78a6f24c78f34d64c660e2bc8/e9ff0/subs_explain_index.png 180w,\n/static/378940d78a6f24c78f34d64c660e2bc8/f21e7/subs_explain_index.png 360w,\n/static/378940d78a6f24c78f34d64c660e2bc8/37523/subs_explain_index.png 720w,\n/static/378940d78a6f24c78f34d64c660e2bc8/302a4/subs_explain_index.png 1080w,\n/static/378940d78a6f24c78f34d64c660e2bc8/07a9c/subs_explain_index.png 1440w,\n/static/378940d78a6f24c78f34d64c660e2bc8/95e59/subs_explain_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  복합 인덱스 설정하기 전과 후\n</div>\n<br> \n<p>하지만 실행시간에서 유의미한 차이를 볼 수 없었다.\n의문인 점은 복합 인덱스 설정 전에는 <code class=\"language-text\">Extra</code> 필드에 <code class=\"language-text\">Using filesort</code>가 표기된다는 점이다.\n이건 <code class=\"language-text\">order by</code> 처리 시, 적합한 인덱스를 사용하지 못해 MySQL 서버가 조회된 레코드를 다시 정렬한다는 뜻이다.\n복합 인덱스 설정 시 해당 인덱스를 사용하기에 <code class=\"language-text\">Extra</code>는 <code class=\"language-text\">null</code>이 된다.\n그럼에도 실행시간이 뚜렷하게 개선되지 않았다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAU0lEQVQI112Lxw3AMAwDvZGRZksitf9YDFw+yeMA1sJMAVQAAvkF3N3yZC6N34brPygelAV03Y/Moe6h1l0OqpnPrnWbPphTz3xvB47UcZyqteoFJcxC5vOdpXkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 전\"\n        title=\"복합 인덱스 설정 전\"\n        src=\"/static/cf3cfd9d769e010b40df197d8f90b2a5/37523/subs_analyze_no_index.png\"\n        srcset=\"/static/cf3cfd9d769e010b40df197d8f90b2a5/e9ff0/subs_analyze_no_index.png 180w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/f21e7/subs_analyze_no_index.png 360w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/37523/subs_analyze_no_index.png 720w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/302a4/subs_analyze_no_index.png 1080w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/07a9c/subs_analyze_no_index.png 1440w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/95e59/subs_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAUklEQVQI11WLXQ6AMAyCd6IlTl1/aO9/LMyaLOoDAfJBi0wCQQfKEUlEvCq2e37yf7v+S808qA6e10010BCcauWiXmyKVi8mVrstqU/yGIO9dz4pjkL2PzM53AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 후\"\n        title=\"복합 인덱스 설정 후\"\n        src=\"/static/219b4b8a0c225664a54f99441075114e/37523/subs_analyze_index.png\"\n        srcset=\"/static/219b4b8a0c225664a54f99441075114e/e9ff0/subs_analyze_index.png 180w,\n/static/219b4b8a0c225664a54f99441075114e/f21e7/subs_analyze_index.png 360w,\n/static/219b4b8a0c225664a54f99441075114e/37523/subs_analyze_index.png 720w,\n/static/219b4b8a0c225664a54f99441075114e/302a4/subs_analyze_index.png 1080w,\n/static/219b4b8a0c225664a54f99441075114e/07a9c/subs_analyze_index.png 1440w,\n/static/219b4b8a0c225664a54f99441075114e/95e59/subs_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>캡쳐는 시간 차이가 조굼 나는 걸로 찍혔지만, 여러번 수행했을 때 평균치는 차이가 없었다.\n채널이 500개나 있는 과장된 상황에서도 차이가 없는 것이라 적용하지 않기로 정했다.</p>\n<br>\n<p>나머지 한 메서드는 처음에는 추가 인덱스 설정이 필요하지 않을 것이라 생각했다.</p>\n<ul>\n<li>existsByChannelAndMember(Channel channel, Member member)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> channel_subscription<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">from</span> channel_subscription\n<span class=\"token keyword\">where</span> channel_subscription<span class=\"token punctuation\">.</span>channel_id <span class=\"token operator\">=</span> :channelId\n  <span class=\"token operator\">and</span> channel_subscription<span class=\"token punctuation\">.</span>member_id <span class=\"token operator\">=</span> :memberId\n<span class=\"token keyword\">limit</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">FK</code>인 <code class=\"language-text\">channel_id</code>와 <code class=\"language-text\">member_id</code>에 이미 각각 인덱스가 걸려있었기 때문이다.\n그래서 실행 계획을 보면, <code class=\"language-text\">type</code>이 <code class=\"language-text\">index_merge</code>로 나온다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAcklEQVQI1y2LWw7CMBADe6HyBelmH0kpJdAC4v6nmUqBj5Eljz3U+cr2+TIvN1QN88DcMfOeHoGa4VEopbKsjbbtrO3Jst557G/a9iJK7Z/hnCYkG+qFJJmsjqiTJvn1Ubkk6X6SzDiOf06IGtmi7zpqHKpbQ/8zpZW5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 전 실행계획\"\n        title=\"복합 인덱스 설정 전 실행계획\"\n        src=\"/static/0c50a3ac4e02025aa7ca1e5fee8b190b/37523/subs_channel_member_no_index.png\"\n        srcset=\"/static/0c50a3ac4e02025aa7ca1e5fee8b190b/e9ff0/subs_channel_member_no_index.png 180w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/f21e7/subs_channel_member_no_index.png 360w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/37523/subs_channel_member_no_index.png 720w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/302a4/subs_channel_member_no_index.png 1080w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/07a9c/subs_channel_member_no_index.png 1440w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/95e59/subs_channel_member_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그런데 <code class=\"language-text\">index_merge</code>를 책에서 찾아보니 개선이 필요했다.\n아래는 해당 책의 설명이다.</p>\n<p><code class=\"language-text\">index_merge</code>는 2개 이상의 인덱스를 이용해 각각의 검색 결과를 만들어낸 후, 그 결과를 병합하는 처리 방식이며 다음과 같은 특징이 있다.</p>\n<ul>\n<li>여러 인덱스를 읽어야 하므로 일반적으로 <code class=\"language-text\">range</code> 접근 방식보다 효율성이 떨어진다</li>\n<li>AND와 OR 연산이 복잡하게 연결된 쿼리에서는 제대로 최적화되지 못할 때가 많다</li>\n<li>전문 검색 인덱스를 사용하는 쿼리에서는 <code class=\"language-text\">index_merge</code>가 적용되지 않는다</li>\n<li><code class=\"language-text\">index_merge</code> 접근 방식으로 처리된 결과는 항상 2개 이상의 집합이 되기 떄문에 그 두 집합의 교집합이나 합집합 또는 중복 제거와 같은 부가적인 작업이 더 필요하다</li>\n</ul>\n<p>현재 <code class=\"language-text\">Extra</code>에 표시된 <code class=\"language-text\">Using intersect...</code>는 각 처리 결과에서 교집합을 추출해내는 작업을 수행했다는 의미다.\n더 효율적인 수행을 위해 <code class=\"language-text\">channel_id</code>와 <code class=\"language-text\">member_id</code>로 복합 인덱스를 생성했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> subscription_channel_and_member <span class=\"token keyword\">on</span> channel_subscription <span class=\"token punctuation\">(</span>member_id<span class=\"token punctuation\">,</span> channel_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeUlEQVQI1yXLSxKCMBBFURYEhcU3pDskGj6aAnX/m7mWYfBG577Ch0A6P/hwx4og6hBRRBV1jr+/jjdx3XHeE5eVPR3ZwiOSzi9x2XK/PRNFXd+wOmOsMk7CJC7PTILMgX4Yabueqqooy5Kmaa/WWLphxNjr0/VD9h/G1kQHdvqeGgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 후 실행계획\"\n        title=\"복합 인덱스 설정 후 실행계획\"\n        src=\"/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/37523/subs_channel_member_index.png\"\n        srcset=\"/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/e9ff0/subs_channel_member_index.png 180w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/f21e7/subs_channel_member_index.png 360w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/37523/subs_channel_member_index.png 720w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/302a4/subs_channel_member_index.png 1080w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/07a9c/subs_channel_member_index.png 1440w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/95e59/subs_channel_member_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>실행 계획에서 해당 인덱스를 사용함을 볼 수 있다.\n사진 상 실수로 이름을 잘못 설정했는데, <code class=\"language-text\">subscription_channel_and_member</code>가 맞다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAT0lEQVQI112LSwoAIQxDvZELdbRp69z/VBEVQVw8EvIJ3n8KlNCDXf7Nb54eexO+2gh15lIIc1YBG3QjoKhRYFTrazf90dmpd6aUGWNcnwEeM0MNkavd8QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 전 실행시간\"\n        title=\"복합 인덱스 설정 전 실행시간\"\n        src=\"/static/470210ea686d16f132bd85ea92134ab6/37523/subs_analyze_channel_member_no_index.png\"\n        srcset=\"/static/470210ea686d16f132bd85ea92134ab6/e9ff0/subs_analyze_channel_member_no_index.png 180w,\n/static/470210ea686d16f132bd85ea92134ab6/f21e7/subs_analyze_channel_member_no_index.png 360w,\n/static/470210ea686d16f132bd85ea92134ab6/37523/subs_analyze_channel_member_no_index.png 720w,\n/static/470210ea686d16f132bd85ea92134ab6/302a4/subs_analyze_channel_member_no_index.png 1080w,\n/static/470210ea686d16f132bd85ea92134ab6/07a9c/subs_analyze_channel_member_no_index.png 1440w,\n/static/470210ea686d16f132bd85ea92134ab6/95e59/subs_analyze_channel_member_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAUklEQVQI11WMUQqAMAxDd6EJKq5d2nn/W0VqHcyPR8hLaYEZzTzxxH38uvlIt/Q1ATD+xE1ROK8mvEQpHRQFwzXRN2fvNnL/iH26Wjfux0n4zQcmpkLwP/+25gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 후 실행시간\"\n        title=\"복합 인덱스 설정 후 실행시간\"\n        src=\"/static/ec8b2dacd32c44f9da0581dfb211fe0e/37523/subs_anaylze_channel_member_index.png\"\n        srcset=\"/static/ec8b2dacd32c44f9da0581dfb211fe0e/e9ff0/subs_anaylze_channel_member_index.png 180w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/f21e7/subs_anaylze_channel_member_index.png 360w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/37523/subs_anaylze_channel_member_index.png 720w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/302a4/subs_anaylze_channel_member_index.png 1080w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/07a9c/subs_anaylze_channel_member_index.png 1440w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/95e59/subs_anaylze_channel_member_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0.386ms</td>\n<td>0.015ms</td>\n</tr>\n</tbody>\n</table>\n<p>실행 시간은 약 0.386ms에서 0.015ms로 <strong>95%</strong> 가량 감소했다.</p>\n<h2 id=\"️bookmark--reminder\" style=\"position:relative;\"><a href=\"#%EF%B8%8Fbookmark--reminder\" aria-label=\"️bookmark  reminder permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⭐️Bookmark &#x26; ⏰Reminder</h2>\n<p>바로 위 사례와 비슷한 쿼리가 북마크와 리마인더에도 각각 존재한다.</p>\n<ul>\n<li>Optional<Bookmark> findByMessageIdAndMemberId(Long messageId, Long memberId)</li>\n<li>Optional<Reminder> findByMessageIdAndMemberId(Long messageId, Long memberId)</li>\n</ul>\n<p>북마크와 리마인더는 100만개의 메시지를 바탕으로 2000명의 멤버가 각각을 300개씩 등록한 것을 가정해, 각 60만개 더미데이터를 넣었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> bookmark\n<span class=\"token keyword\">where</span> message_id <span class=\"token operator\">=</span> :messageId <span class=\"token operator\">and</span> member_id <span class=\"token operator\">=</span> :memberId<span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeElEQVQI1zXKSwqDMAAAUc+jwU+tmsT8MMZatELvf5gpBrp4MIspfAgc15ewRPQ8MxuDtQ6lNVJKnPfs50VcN4x1xLSxHx+U0hhjSa93tqyJuCaKpmmZlEYbxzjJ7O627SjLkrpuuJ+qqrLu0TOMMrcQIvt3/xz4AY2zQqCZAk/yAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 실행계획\"\n        title=\"북마크 실행계획\"\n        src=\"/static/9828735c2d4adf1e8827d01c7d1e57ac/37523/bookmark_explain_no_index.png\"\n        srcset=\"/static/9828735c2d4adf1e8827d01c7d1e57ac/e9ff0/bookmark_explain_no_index.png 180w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/f21e7/bookmark_explain_no_index.png 360w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/37523/bookmark_explain_no_index.png 720w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/302a4/bookmark_explain_no_index.png 1080w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/07a9c/bookmark_explain_no_index.png 1440w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/95e59/bookmark_explain_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>아까와 달리 <code class=\"language-text\">Extra</code> 필드에 <code class=\"language-text\">Using where</code>가 표기된다.\n<code class=\"language-text\">Using where</code>은 스토리지 엔진으로부터 받은 레코드를 MySQL 엔진 레이어에서 별도의 가공을 통해 필터링 작업을 거쳤음을 나타낸다.\n또, <code class=\"language-text\">filtered</code> 필드에 <code class=\"language-text\">5</code>가 적혀있다.\n이는 스토리지 엔진으로부터 100건의 레코드를 받아 95건을 걸러내고 5건만 남았다는 의미다.\n결국 조회된 데이터 중 <strong>95%</strong> 를 버린 것이다.<br>\n이번에는 <code class=\"language-text\">index_merge</code>를 쓰지 않았는데, 데이터 양의 차이로 추측된다.\n현재 더미데이터는 계산 시 각 메시지에 평균 1건 이하의 북마크가 등록되어 있다.\n보통 중요한 메시지에 북마크 생성이 치중될 것을 생각하면, 실제 상황과 조금 괴리가 있는 데이터 셋업이다.\n운영 데이터가 더 쌓이면 이를 분석해서 더 적절한 실험 상황으로 개선해야 할 것 같다.</p>\n<p>어쨌든 <code class=\"language-text\">message_id</code>와 <code class=\"language-text\">member_id</code>로 복합 인덱스 설정 시, 해당 인덱스를 이용하며 속도도 개선된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> bookmark_message_and_member <span class=\"token keyword\">on</span> bookmark <span class=\"token punctuation\">(</span>message_id<span class=\"token punctuation\">,</span> member_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeElEQVQI1x2MWw6DIBQF3Y9iTVpb4F6oVST46v53M035OJmcTDKNqFKOi7XseBFEAyJaqSGQy07eDqZ5IcTIdn6ZPgsiwpxy9SkX5rRS9pOmbVusVzROvJxHwrvSa8R64f4YuQ0DXWcwxmCdVD8+bf3/9X1fG04CP8kFQ+ag0cbwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 실행계획\"\n        title=\"북마크 복합 인덱스 실행계획\"\n        src=\"/static/ff564d0002316fb7eedcfe35d3c91f38/37523/bookmark_explain_index.png\"\n        srcset=\"/static/ff564d0002316fb7eedcfe35d3c91f38/e9ff0/bookmark_explain_index.png 180w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/f21e7/bookmark_explain_index.png 360w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/37523/bookmark_explain_index.png 720w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/302a4/bookmark_explain_index.png 1080w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/07a9c/bookmark_explain_index.png 1440w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/95e59/bookmark_explain_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAUklEQVQI10WL2w3AMAjEslOT8Dq6/1ZXQVTlw0IYMwIg8m0CSY8gMln+3PKC6/+/u59mmIPqoEVSLfjMSTHnXMK1pZ2ot6u51Q6itEA31Zar9gM1akMSQztJnwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 기본 수행시간\"\n        title=\"북마크 기본 수행시간\"\n        src=\"/static/8cfef3b0b61fbad1d50c84620e2e806f/37523/bookmark_analyze_no_index.png\"\n        srcset=\"/static/8cfef3b0b61fbad1d50c84620e2e806f/e9ff0/bookmark_analyze_no_index.png 180w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/f21e7/bookmark_analyze_no_index.png 360w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/37523/bookmark_analyze_no_index.png 720w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/302a4/bookmark_analyze_no_index.png 1080w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/07a9c/bookmark_analyze_no_index.png 1440w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/95e59/bookmark_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXUlEQVQI102LSQ6AMAwDeRFJoUmbluX/rxoEiOVgWR7bg2hiFEVEGUUQVTRNN9OPnf7Xs3+znvvE0JYN80JtCyU6JRp93cnmRF/vLjqz+cXMK9kKXoM5O17bxZ/vAcReP/hJx9DSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 수행시간\"\n        title=\"북마크 복합 인덱스 수행시간\"\n        src=\"/static/c051125079ad15a29c01454795e6bc41/37523/bookmark_analyze_index.png\"\n        srcset=\"/static/c051125079ad15a29c01454795e6bc41/e9ff0/bookmark_analyze_index.png 180w,\n/static/c051125079ad15a29c01454795e6bc41/f21e7/bookmark_analyze_index.png 360w,\n/static/c051125079ad15a29c01454795e6bc41/37523/bookmark_analyze_index.png 720w,\n/static/c051125079ad15a29c01454795e6bc41/302a4/bookmark_analyze_index.png 1080w,\n/static/c051125079ad15a29c01454795e6bc41/07a9c/bookmark_analyze_index.png 1440w,\n/static/c051125079ad15a29c01454795e6bc41/95e59/bookmark_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0.161ms</td>\n<td>0.041ms</td>\n</tr>\n</tbody>\n</table>\n<p>더미데이터와 달리 한 메시지에 북마크가 몰리는 상황을 생각하면, 복합 인덱스 설정 시 조금 더 큰폭으로 효율이 개선될 것 같다.</p>\n<p>리마인더도 완전히 동일한 포맷의 sql문을 사용중이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> reminder\n<span class=\"token keyword\">where</span> message_id <span class=\"token operator\">=</span> :messageId <span class=\"token operator\">and</span> member_id <span class=\"token operator\">=</span> :memberId<span class=\"token punctuation\">;</span> </code></pre></div>\n<p>복합 인덱스 설정 전/후에 북마크와 동일한 설정의 실행계획이 나오는 것을 확인했고, 실행시간을 비교해보았다.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>북마크</th>\n<th>리마인더</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>복합 인덱스 설정 전</td>\n<td>0.161ms</td>\n<td>0.023ms</td>\n</tr>\n<tr>\n<td>복합 인덱스 설정 후</td>\n<td>0.041ms</td>\n<td>0.017ms</td>\n</tr>\n</tbody>\n</table>\n<p>북마크 수행 시간이 더 극적으로 차이나는 것은…\n북마크를 테스트하고 맥북이 좀 느려졌길래 재부팅을 한번 해서 그런 것 같다 🙃</p>\n<p><code class=\"language-text\">Querydsl</code>을 제외하고 남은 마지막 쿼리는 리마인더 발송을 위해 10분마다 실행되는 쿼리다.</p>\n<ul>\n<li>findAllByRemindDate(LocalDateTime remindDate)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> reminder\n<span class=\"token keyword\">where</span> remind_date <span class=\"token operator\">=</span> <span class=\"token string\">'2022-10-03 00:10:30'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">#이해를 돕기 위해 아무 시각이나 넣었다 </span></code></pre></div>\n<p>예상 가능한 부분이지만 사용할 수 있는 인덱스가 없어서 <strong>풀 테이블 스캔</strong>이 일어나고 있다.\n시간도 앞선 쿼리들에 비하면 아주 길다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAd0lEQVQI1x2KXQ6DIBjAvBCfDzpgAwTnD+Kcu/9pusBD06RpF8LEXk6c98SUKNePLZ+subDlgnOeZds5Pl9imlnz0fq6H8zvhXLd7Q1TJJ8XnYig7ZNqpRRaa4ZhQInQ931rFWNf+CkhUpu0XxuLC7HxMJZxHPkD4T5D4W1pOxUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"리마인더 실행계획\"\n        title=\"리마인더 실행계획\"\n        src=\"/static/33afadc187330a6b1211d0e9f8621881/37523/reminder_no_index.png\"\n        srcset=\"/static/33afadc187330a6b1211d0e9f8621881/e9ff0/reminder_no_index.png 180w,\n/static/33afadc187330a6b1211d0e9f8621881/f21e7/reminder_no_index.png 360w,\n/static/33afadc187330a6b1211d0e9f8621881/37523/reminder_no_index.png 720w,\n/static/33afadc187330a6b1211d0e9f8621881/302a4/reminder_no_index.png 1080w,\n/static/33afadc187330a6b1211d0e9f8621881/07a9c/reminder_no_index.png 1440w,\n/static/33afadc187330a6b1211d0e9f8621881/95e59/reminder_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAWUlEQVQI102LWQrAIBBDPVKVOlvG3v9WKQ4V+vFIyNKQSffg1lxPASQzVxFAdSc7vvTH7jyCTS149UExp2Mx8uFUowVokbyncm+mKM1B+fzORK1+ol7b3gdfIk9C1zN7twgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"리마인더 수행시간\"\n        title=\"리마인더 수행시간\"\n        src=\"/static/f9674b1a18e7d4ee6c48b1fba93b90ad/37523/reminder_analyze_no_index.png\"\n        srcset=\"/static/f9674b1a18e7d4ee6c48b1fba93b90ad/e9ff0/reminder_analyze_no_index.png 180w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/f21e7/reminder_analyze_no_index.png 360w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/37523/reminder_analyze_no_index.png 720w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/302a4/reminder_analyze_no_index.png 1080w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/07a9c/reminder_analyze_no_index.png 1440w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/95e59/reminder_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">remind_date</code>에 인덱스를 설정했다.\n정상적으로 해당 인덱스를 이용하고, 실행시간도 1/1000 이하로 줄어들었다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeklEQVQI1x2LSxKDIBQEPZAipoJBHv5QAY3J/W/TqbCYRU/PVDFfeD9y3l/2mHFOWNZAfn8Kj9PMdiTSeeNE2I5Ium7mNbDHxJGvsgvbXvqq6x7UdY11HpkWrBPMy6J1h2rb4p7GYAehaZqS/2dcAkqpwq3WDOIxfc8P8IdD7sDooZwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"리마인더 인덱스 실행계획\"\n        title=\"리마인더 인덱스 실행계획\"\n        src=\"/static/30330ca05bd0eabdf60e8bf01b1d468a/37523/remider_explain_index.png\"\n        srcset=\"/static/30330ca05bd0eabdf60e8bf01b1d468a/e9ff0/remider_explain_index.png 180w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/f21e7/remider_explain_index.png 360w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/37523/remider_explain_index.png 720w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/302a4/remider_explain_index.png 1080w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/07a9c/remider_explain_index.png 1440w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/95e59/remider_explain_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 5.555555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAQUlEQVQI1yXLwRWAMAjAUFeyQKFAdf+p4lNv+Yccfd2sarI2HonNILLwVUwPzF835xCGKGqOTkfU/jb/nqFG9uYBJT8g4PFfUq0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"리마인더 인덱스 수행시간\"\n        title=\"리마인더 인덱스 수행시간\"\n        src=\"/static/4afb3decc1f56222258deacaf80128bc/37523/reminder_analyze_index.png\"\n        srcset=\"/static/4afb3decc1f56222258deacaf80128bc/e9ff0/reminder_analyze_index.png 180w,\n/static/4afb3decc1f56222258deacaf80128bc/f21e7/reminder_analyze_index.png 360w,\n/static/4afb3decc1f56222258deacaf80128bc/37523/reminder_analyze_index.png 720w,\n/static/4afb3decc1f56222258deacaf80128bc/302a4/reminder_analyze_index.png 1080w,\n/static/4afb3decc1f56222258deacaf80128bc/07a9c/reminder_analyze_index.png 1440w,\n/static/4afb3decc1f56222258deacaf80128bc/95e59/reminder_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>remind_date 인덱스 X</th>\n<th>remind_date 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>554ms</td>\n<td>0.139ms</td>\n</tr>\n</tbody>\n</table>\n<br>\n<h2 id=\"️-querydsl을-이용한-복잡한-쿼리들\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-querydsl%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B3%B5%EC%9E%A1%ED%95%9C-%EC%BF%BC%EB%A6%AC%EB%93%A4\" aria-label=\"️ querydsl을 이용한 복잡한 쿼리들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✉️ Querydsl을 이용한 복잡한 쿼리들</h2>\n<p>이제 글 초반에 적었던 체크리스트에서 세 쿼리만 남았다!</p>\n<ul>\n<li>Message의 Querydsl을 이용한 복잡한 조회쿼리</li>\n<li>Bookmark의 Querydsl을 이용한 복잡한 조회쿼리</li>\n<li>Reminder의 Querydsl을 이용한 복잡한 조회쿼리</li>\n</ul>\n<p>메시지부터 보자면 동적으로 조건이 변화하지만, 결국 아래 네 가지로 수렴한다.</p>\n<ul>\n<li>특정 한 채널에서 최신으로부터 n개를 작성시간 내림차순 조회</li>\n<li>특정 한 채널에서 특정 시각을 기준으로 작성시간이 과거/미래인 n개를 작성시간 내림차순 조회 (페이지네이션 대체)</li>\n<li>특정 한 채널에서 특정 시각을 기준으로 작성시간이 과거/미래인 메시지가 존재하는지 조회 (페이지네이션 대체)</li>\n<li>특정 여러 채널에서 특정 키워드를 포함한 메시지를 특정 시간 기준으로 n개를 작성시간 내림차순 조회</li>\n</ul>\n<p>여기서 1,2,3번 쿼리는 <code class=\"language-text\">특정 여러 채널</code> 조건으로 실행할 수도 있게 코드가 짜여있다.\n하지만 처음 구상과 달리 현재 서비스에서 사용하고 있지 않기에, <code class=\"language-text\">특정 한 채널</code>로만 진행했다.\n키워드 검색은 <code class=\"language-text\">like %keyword%</code> 방식이라 인덱스를 적용할 수 없어 제외했다.\n결국 나머지 셋의 공통점을 보자면 <code class=\"language-text\">채널, 쟉셩시간</code> 조건으로 조회하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> \n    message<span class=\"token punctuation\">.</span>id            <span class=\"token keyword\">as</span> message_id<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>member_id     <span class=\"token keyword\">as</span> member_id<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>username       <span class=\"token keyword\">as</span> username<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>thumbnail_url  <span class=\"token keyword\">as</span> thumbnail<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span><span class=\"token keyword\">text</span>          <span class=\"token keyword\">as</span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>posted_date   <span class=\"token keyword\">as</span> posted_date<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>modified_date <span class=\"token keyword\">as</span> modified_date<span class=\"token punctuation\">,</span>\n    bookmark<span class=\"token punctuation\">.</span>id           <span class=\"token keyword\">as</span> bookmark_id<span class=\"token punctuation\">,</span>\n    reminder<span class=\"token punctuation\">.</span>id           <span class=\"token keyword\">as</span> reminder_id<span class=\"token punctuation\">,</span>\n    reminder<span class=\"token punctuation\">.</span>remind_date  <span class=\"token keyword\">as</span> remind_date\n<span class=\"token keyword\">from</span>\n    message\n    <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n        member <span class=\"token keyword\">on</span> message<span class=\"token punctuation\">.</span>member_id <span class=\"token operator\">=</span> member<span class=\"token punctuation\">.</span>id\n    <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n        bookmark\n        <span class=\"token keyword\">on</span> <span class=\"token punctuation\">(</span>bookmark<span class=\"token punctuation\">.</span>member_id <span class=\"token operator\">=</span> :memberId\n              <span class=\"token operator\">and</span> bookmark<span class=\"token punctuation\">.</span>message_id <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span>id\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n        reminder\n        <span class=\"token keyword\">on</span> <span class=\"token punctuation\">(</span>reminder<span class=\"token punctuation\">.</span>member_id <span class=\"token operator\">=</span> :memberId\n              <span class=\"token operator\">and</span> reminder<span class=\"token punctuation\">.</span>message_id <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span>id\n              <span class=\"token operator\">and</span> reminder<span class=\"token punctuation\">.</span>remind_date <span class=\"token operator\">></span> :remindDate\n        <span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">where</span>\n    message<span class=\"token punctuation\">.</span>channel_id <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span>:channelId<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span><span class=\"token keyword\">text</span> <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">and</span> length<span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span><span class=\"token keyword\">text</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;></span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>\n    message<span class=\"token punctuation\">.</span>posted_date <span class=\"token keyword\">desc</span>\n<span class=\"token keyword\">limit</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>참고로 <code class=\"language-text\">channel_id</code>는 위에서 말했듯 복수의 값이 들어올 수도 있어서, 하나라도 <code class=\"language-text\">in()</code> 형태로 조회한다.\n여기서 결국 중요한 건 <code class=\"language-text\">where</code>안의 <code class=\"language-text\">channel_id</code>와 <code class=\"language-text\">order by</code>의 <code class=\"language-text\">posted_date</code>이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAoklEQVQI1y2La66CMBhEWY4a8Aqtpf1o6RON+1/QuaH64ySTMzNDe3/wYSe3g7BHSjuIqeCc4ES6OzchJpxsyOY7uTZ8iCil0FqjtcIYw7Cnyt9jRmnDdL+zOmHPjUVplH4yLwtmtb+sOo/561Yr6OeKsa7/zm6orw/GCmZ1jNPEFiKnC7EQUu3jkAo+ZsZx5Ha7cr1csOKJ5SDVF7m9O048/5TZZFWfVb69AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 전\"\n        title=\"메시지 복합 인덱스 추가 전\"\n        src=\"/static/526249afe0f3ea91e120bdd4e4dcd11e/37523/message_explain_no_index.png\"\n        srcset=\"/static/526249afe0f3ea91e120bdd4e4dcd11e/e9ff0/message_explain_no_index.png 180w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/f21e7/message_explain_no_index.png 360w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/37523/message_explain_no_index.png 720w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/302a4/message_explain_no_index.png 1080w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/07a9c/message_explain_no_index.png 1440w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/95e59/message_explain_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>실행계획을 보면, 제일 먼저 적용되는 <code class=\"language-text\">channel_id</code> 외래키 인덱스의 <code class=\"language-text\">Extra</code>에 <code class=\"language-text\">Using filesort</code>가 보인다.\n이는 <code class=\"language-text\">channel</code> 기준으로 조회한 레코드를 엔진에서 <code class=\"language-text\">posted_date</code>로 다시 정렬하고 있기 때문이다.\n따라서 <code class=\"language-text\">channel_id</code>와 <code class=\"language-text\">posted_date</code>로 복합 인덱스를 걸어준다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAnklEQVQI1yWMUQ6DIBBEPY4oKCgIywJimzb96P2vM43bj5dsZt/M0PoDuVRQzuBSEVPCeT1BmZEoIxHJXVtH65d4mYtkArP0bi+EgKE/3wiRYN0GHyK0MXh9vsilwR8RkRhOfge4NOw+wDonrNbBbTuMMVDjiHmeMRAXHIlg7V8wZgFxFe68tC6FbffgesqwUiOmaYJSSvxlXWVMa40f7fZhqEP7nI0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 후\"\n        title=\"메시지 복합 인덱스 추가 후\"\n        src=\"/static/5ee440445c195369d3fad1d32aa6b18a/37523/message_explain_index.png\"\n        srcset=\"/static/5ee440445c195369d3fad1d32aa6b18a/e9ff0/message_explain_index.png 180w,\n/static/5ee440445c195369d3fad1d32aa6b18a/f21e7/message_explain_index.png 360w,\n/static/5ee440445c195369d3fad1d32aa6b18a/37523/message_explain_index.png 720w,\n/static/5ee440445c195369d3fad1d32aa6b18a/302a4/message_explain_index.png 1080w,\n/static/5ee440445c195369d3fad1d32aa6b18a/07a9c/message_explain_index.png 1440w,\n/static/5ee440445c195369d3fad1d32aa6b18a/95e59/message_explain_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>해당 복합 인덱스를 사용함과 실행시간이 줄어듬을 확인할 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXElEQVQI12WLSQqAMBRDPZBD+7V/qNWFiPe/UcQIblw8MpB0x3lhbdtH2/YfT59lJikLkgiVWV6dUiadWsCiYikKNYfXxmwe9OpBX9RQzLl7mIuy488D4zihHwbcvxdBegme1I8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 전\"\n        title=\"메시지 복합 인덱스 추가 전\"\n        src=\"/static/dc9141a4838919dda5d2589ded95bd44/37523/message_analyze_no_index.png\"\n        srcset=\"/static/dc9141a4838919dda5d2589ded95bd44/e9ff0/message_analyze_no_index.png 180w,\n/static/dc9141a4838919dda5d2589ded95bd44/f21e7/message_analyze_no_index.png 360w,\n/static/dc9141a4838919dda5d2589ded95bd44/37523/message_analyze_no_index.png 720w,\n/static/dc9141a4838919dda5d2589ded95bd44/302a4/message_analyze_no_index.png 1080w,\n/static/dc9141a4838919dda5d2589ded95bd44/07a9c/message_analyze_no_index.png 1440w,\n/static/dc9141a4838919dda5d2589ded95bd44/95e59/message_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXUlEQVQI11XISQqAMBBEUe+ThRm7O51BEPH+NypJhIiLR1F/O68bpbal9gO19Z+sBdb5xfmwWP+23dr5N+IMzoqYCMQCLQ0sCpIM0Tp3SCTwIU6J+MOjBxhjEBPjAbvNQXWMYNBDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 후\"\n        title=\"메시지 복합 인덱스 추가 후\"\n        src=\"/static/4a0e76d36dc54ffc27da97f7d0330a32/37523/message_analyze_index.png\"\n        srcset=\"/static/4a0e76d36dc54ffc27da97f7d0330a32/e9ff0/message_analyze_index.png 180w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/f21e7/message_analyze_index.png 360w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/37523/message_analyze_index.png 720w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/302a4/message_analyze_index.png 1080w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/07a9c/message_analyze_index.png 1440w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/95e59/message_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>여기서 보면 거의 처음으로  <code class=\"language-text\">actual time</code>값이 <code class=\"language-text\">...</code>을 두고 유의미하게 서로 다른 값이 표시됐다.\n이는 <code class=\"language-text\">첫 레코드를 읽은 시간...마지막 레코드를 읽은 시간</code>이라는 뜻이다.</p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>425…433ms</td>\n<td>4.1…24.6ms</td>\n</tr>\n</tbody>\n</table>\n<p>마지막 레코드를 읽은 시간 기준으로 거의 <strong>95%</strong> 감소했다.\n키워드 검색의 경우도 <code class=\"language-text\">like</code> 부분을 제외하면 동일한 검색조건이라, 시간이 줄어듬을 확인할 수 있었다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAYElEQVQI13WLSwqAMBBDe59itbXzqe3oTgTvf54Io1sXIY9HEs7rxrAdfRh6H87D7OvX235grYQll9/MS8aUEkIlBktDZUFZK7R1sKg7aZszicJ32kAsviWPfqz+jTHiAbxEQWfwjW2uAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 전\"\n        title=\"메시지 복합 인덱스 추가 전\"\n        src=\"/static/a0f4299e7c72890c79ade4faedbdb30d/37523/message_keyword_analyze_no_index.png\"\n        srcset=\"/static/a0f4299e7c72890c79ade4faedbdb30d/e9ff0/message_keyword_analyze_no_index.png 180w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/f21e7/message_keyword_analyze_no_index.png 360w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/37523/message_keyword_analyze_no_index.png 720w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/302a4/message_keyword_analyze_no_index.png 1080w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/07a9c/message_keyword_analyze_no_index.png 1440w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/95e59/message_keyword_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAa0lEQVQI112MSQ4DMQgE50OTWQzGGLBzixQp/39ORya3HEql6kNvr/cHMZ8wD/iY8BjJ6kVfewwQV1x3wVXozyV93j9vFhOiHU0NxIxuAe0OaZpnTTvUPA+5CogFhTibVlcB14bjOLHvD3wB59pB4nu3tX0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 후\"\n        title=\"메시지 복합 인덱스 추가 후\"\n        src=\"/static/b6d48655f45f28424856fab49b52230d/37523/message_keyword_analyze_index.png\"\n        srcset=\"/static/b6d48655f45f28424856fab49b52230d/e9ff0/message_keyword_analyze_index.png 180w,\n/static/b6d48655f45f28424856fab49b52230d/f21e7/message_keyword_analyze_index.png 360w,\n/static/b6d48655f45f28424856fab49b52230d/37523/message_keyword_analyze_index.png 720w,\n/static/b6d48655f45f28424856fab49b52230d/302a4/message_keyword_analyze_index.png 1080w,\n/static/b6d48655f45f28424856fab49b52230d/07a9c/message_keyword_analyze_index.png 1440w,\n/static/b6d48655f45f28424856fab49b52230d/95e59/message_keyword_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>502…628ms</td>\n<td>19…263ms</td>\n</tr>\n</tbody>\n</table>\n<br>\n<p>북마크 조회는 메시지보다 간단하다.\n메시지는 특정 날짜로 이동해서 앞/뒤 어디든 볼 수 있게 해야했는데, 북마크는 무조건 <code class=\"language-text\">create_date</code>를 최신 또는 특정 시간부터 역순으로 조회한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span>\n    bookmark<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> bookmark_id<span class=\"token punctuation\">,</span>\n    bookmark<span class=\"token punctuation\">.</span>created_date <span class=\"token keyword\">as</span> created_date<span class=\"token punctuation\">,</span>\n    bookmark<span class=\"token punctuation\">.</span>member_id <span class=\"token keyword\">as</span> member_id<span class=\"token punctuation\">,</span>\n    bookmark<span class=\"token punctuation\">.</span>message_id <span class=\"token keyword\">as</span> message_id<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>channel_id <span class=\"token keyword\">as</span> channel_id<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>modified_date <span class=\"token keyword\">as</span> modified_date<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>posted_date <span class=\"token keyword\">as</span> posted_date<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>slack_message_id <span class=\"token keyword\">as</span> message_slack_id<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span><span class=\"token keyword\">text</span> <span class=\"token keyword\">as</span> message_text<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>first_login <span class=\"token keyword\">as</span> member_first_login<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>slack_id <span class=\"token keyword\">as</span> member_slack_id<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>thumbnail_url <span class=\"token keyword\">as</span> member_thumbnail_url<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>username <span class=\"token keyword\">as</span> member_username\n<span class=\"token keyword\">from</span>\n    bookmark\n        <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n    message <span class=\"token keyword\">on</span> bookmark<span class=\"token punctuation\">.</span>message_id<span class=\"token operator\">=</span>message<span class=\"token punctuation\">.</span>id\n        <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n    member <span class=\"token keyword\">on</span> bookmark<span class=\"token punctuation\">.</span>member_id<span class=\"token operator\">=</span>member<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">where</span>\n        bookmark<span class=\"token punctuation\">.</span>member_id<span class=\"token operator\">=</span>:memberId\n        <span class=\"token operator\">and</span> bookmark<span class=\"token punctuation\">.</span>created_date <span class=\"token operator\">&lt;</span> :createdDate\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>\n    bookmark<span class=\"token punctuation\">.</span>created_date <span class=\"token keyword\">desc</span> \n<span class=\"token keyword\">limit</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>차이점이 있다면 메시지와 달리 북마크는 개인이 소유한 북마크만 보여주기에, <code class=\"language-text\">member_id</code> 일치 조건이 항상 걸려있다는 것이다.\n이쯤 되니 <code class=\"language-text\">member_id</code> FK 인덱스를 사용하고 있을 것이며, <code class=\"language-text\">Using filesort</code>가 표기될 것이 짐작간다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.333333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAApUlEQVQI1yWN25KDIBBE/R1QsIIXEJQQb2uy+/+/c1LOPnRN9Zyu7uq4PqR5Yf95s+Qn5bWxnZf8Yprl5lJYj5N1P3mWF+f7j7JuxJhIaZbckjN3V1XWA2tb/JSw1tKPnv36JcRE1w/4KWKMQWvFw3XMucjI6AP9MIoGH3BdL6waQ6Su6//CtsW5jlw2mqZBKYVWSvitxhgZcM6Jv5nWWnK3D1PiC/lxYtcvmOgZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 적용 전\"\n        title=\"북마크 복합 인덱스 적용 전\"\n        src=\"/static/ee57f7956bae015ec87cbe43f1351057/37523/bookmark_explain_no_index2.png\"\n        srcset=\"/static/ee57f7956bae015ec87cbe43f1351057/e9ff0/bookmark_explain_no_index2.png 180w,\n/static/ee57f7956bae015ec87cbe43f1351057/f21e7/bookmark_explain_no_index2.png 360w,\n/static/ee57f7956bae015ec87cbe43f1351057/37523/bookmark_explain_no_index2.png 720w,\n/static/ee57f7956bae015ec87cbe43f1351057/302a4/bookmark_explain_no_index2.png 1080w,\n/static/ee57f7956bae015ec87cbe43f1351057/07a9c/bookmark_explain_no_index2.png 1440w,\n/static/ee57f7956bae015ec87cbe43f1351057/95e59/bookmark_explain_no_index2.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>예상이 맞았다.\n추가 정렬과 읽었지만 버려지는 레코드를 없앨 수 있도록 복합 인덱스를 걸어주자.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> bookmark_member_and_created_date <span class=\"token keyword\">on</span> bookmark <span class=\"token punctuation\">(</span>member_id<span class=\"token punctuation\">,</span> created_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>create index message_channel_and_posted_date on message (channel_id, posted_date);</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.333333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmElEQVQI1z2MaxKDIBCDvQ44WLXycgFR1Gq9/3nSEbU/MpvNfEmxbF8QOaz7AR8GxCkhrRvIOZDz6Mn9vfMB0/LBmGbEMWH+7Pl/mPMWcVogqgouRLzqBkobzNsBbQlSG3RSQSoNZSzqpkVZluCcg/wA8gHa2Iu52UJpmyFt+jzcvjv4mHLGGMtlzln2Z/YoD3QSQoibu9gf3upiem4ynaoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 적용 후\"\n        title=\"북마크 복합 인덱스 적용 후\"\n        src=\"/static/3c203afa6cca2fb45105ffd697f66327/37523/bookmark_explain_index2.png\"\n        srcset=\"/static/3c203afa6cca2fb45105ffd697f66327/e9ff0/bookmark_explain_index2.png 180w,\n/static/3c203afa6cca2fb45105ffd697f66327/f21e7/bookmark_explain_index2.png 360w,\n/static/3c203afa6cca2fb45105ffd697f66327/37523/bookmark_explain_index2.png 720w,\n/static/3c203afa6cca2fb45105ffd697f66327/302a4/bookmark_explain_index2.png 1080w,\n/static/3c203afa6cca2fb45105ffd697f66327/07a9c/bookmark_explain_index2.png 1440w,\n/static/3c203afa6cca2fb45105ffd697f66327/95e59/bookmark_explain_index2.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAT0lEQVQI12WJSQ6AMAwD+yF6gTaLE/j/q4ygohJwGGk8Lg7wAYgf4/tuvHziYHEk161RDfTYKeY0j+lXvxuS6mAXo+johmBXI/Jg68KlVp4d70L2vv6A8wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 적용 전\"\n        title=\"북마크 복합 인덱스 적용 전\"\n        src=\"/static/c9e220c3f8257d251cc32bbe969cc6fa/37523/bookmark_analyze_no_index2.png\"\n        srcset=\"/static/c9e220c3f8257d251cc32bbe969cc6fa/e9ff0/bookmark_analyze_no_index2.png 180w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/f21e7/bookmark_analyze_no_index2.png 360w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/37523/bookmark_analyze_no_index2.png 720w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/302a4/bookmark_analyze_no_index2.png 1080w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/07a9c/bookmark_analyze_no_index2.png 1440w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/95e59/bookmark_analyze_no_index2.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAVElEQVQI13WKSw7AIBBCPZErPzMw2t7/UjTV1F0XLwQeyQGBFMCVZOy+iLOfTv4DKhlCjlApVYghZ8hAxbz1uW4ujmv/alMzlznEMdf2utq6cs56ABinQv+A/1mlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 적용 후\"\n        title=\"북마크 복합 인덱스 적용 후\"\n        src=\"/static/43b3bf753be7018e44d6d744454c6ef3/37523/bookmark_analyze_index2.png\"\n        srcset=\"/static/43b3bf753be7018e44d6d744454c6ef3/e9ff0/bookmark_analyze_index2.png 180w,\n/static/43b3bf753be7018e44d6d744454c6ef3/f21e7/bookmark_analyze_index2.png 360w,\n/static/43b3bf753be7018e44d6d744454c6ef3/37523/bookmark_analyze_index2.png 720w,\n/static/43b3bf753be7018e44d6d744454c6ef3/302a4/bookmark_analyze_index2.png 1080w,\n/static/43b3bf753be7018e44d6d744454c6ef3/07a9c/bookmark_analyze_index2.png 1440w,\n/static/43b3bf753be7018e44d6d744454c6ef3/95e59/bookmark_analyze_index2.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>의도한 인덱스를 타고, 실행시간이 줄어들었다.</p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>11.9…12.2ms</td>\n<td>6.7…7.2ms</td>\n</tr>\n</tbody>\n</table>\n<p>더미데이터는 한 멤버당 300개의 북마크 데이터를 넣었다.\n북마크 데이터 수가 늘어난다면, 실행시간의 차이도 더 커질 것이다.</p>\n<br>\n<p>마지막으로 리마인더는!\n북마크와 조건이 똑같다.\n멤버와 <code class=\"language-text\">remind_date</code>라는 알람 지정 시각을 기준으로 조회한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">where</span>\n    reminder<span class=\"token punctuation\">.</span>member_id<span class=\"token operator\">=</span>:memberId\n    <span class=\"token operator\">and</span> reminder<span class=\"token punctuation\">.</span>remind_date <span class=\"token operator\">&lt;</span> :remindDate\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>\n    reminder<span class=\"token punctuation\">.</span>remind_date <span class=\"token keyword\">desc</span> </code></pre></div>\n<p><code class=\"language-text\">member_id</code> FK 인덱스를 사용하고 <code class=\"language-text\">Using filesort</code> 표기까지 다~ 똑같았다.\n그래서 <code class=\"language-text\">member_id, remind_date</code>로 걸어줬고, 실행시간 차이만 적고 마치겠다.</p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>15.8…19.2ms</td>\n<td>3.4…8.0ms</td>\n</tr>\n</tbody>\n</table>\n<p>차이점이 있다면 리마인더는 알람을 발송하면 바로바로 데이터를 지우기 때문에, 실상황에서 효율은 더 낮지 않을까 싶은 점이다.</p>\n<br>\n<h2 id=\"finally\" style=\"position:relative;\"><a href=\"#finally\" aria-label=\"finally permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>finally</h2>\n<p>그래서 줍줍에는 추가로 이런 인덱스가 걸리게 되었다!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACM0lEQVQoz1WSS2/aQBSFvU6FZ8YvsDGYVwghGEMDtgMhpgpppbyQmiitFCmt+pBStYtuuuiv/6pxmkpdzOKee8/RPeeOYVkW+gkhqFQqSCl5xqRUKKVI4pg8y6hWq//1lbIwTbPkPmOGJphC0O12ybKMKIpKksYD38PzXDqtFuM4xvf9f4KmMPFqHmmeEidjpPXEMVzXwXMdWs0m02RcCuqGEJK93TZ5nlEPQ+ZpymKxwPM8pJI0/IBABYx6I+J+TGAFOJaD4ddcloucWs1nPB5TFAVBEJQ2vGqVs7MzBoNBKbZarbBtG6EkrxZbLt5+Y1bccXr1mf78mn5jiuHYNs1moxx0XZcwDP/mo0pM19qm3kzXSkqkUvRmK4q7j+xvrphd3DLcXOO2+hjamt5OZ6jtttttAj8oBfVRdOhR1KTT6eA4TolbykIoQUWaSMdC2hbCVkhLYTiuTdRq0O31KNYFySTBq3oIKQn8KqYp2B8MKYo1juOV2ZYOhIldqXCcpsyTBPViB0sKjNDxeT/bsu4tOY83nLSPiM09atLjcBrx7uaYZd5le5mSz5sMB0+i04OMg/iU0WRDvtxSb2fU/V0MW9qsx8csRzlH+ynZ3oyu3cK1bGYv6/z8fsGH+xWfHtY8fjklPQzZqQjO31zz4/cvrh7uuX/8yvr2hng4w1CWwpRmeTn9HXQOyraoaKt7EcVJRqcdcrLKuLx8TSuqYQpJqxcwmXQ5iNskSY9R0qEWevwB3V8ZV7EnE74AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"줍줍 추가 인덱스\"\n        title=\"줍줍 추가 인덱스\"\n        src=\"/static/1d3da01279e1099504af950bde40a98a/37523/final.png\"\n        srcset=\"/static/1d3da01279e1099504af950bde40a98a/e9ff0/final.png 180w,\n/static/1d3da01279e1099504af950bde40a98a/f21e7/final.png 360w,\n/static/1d3da01279e1099504af950bde40a98a/37523/final.png 720w,\n/static/1d3da01279e1099504af950bde40a98a/302a4/final.png 1080w,\n/static/1d3da01279e1099504af950bde40a98a/07a9c/final.png 1440w,\n/static/1d3da01279e1099504af950bde40a98a/95e59/final.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"짧은-회고\" style=\"position:relative;\"><a href=\"#%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\" aria-label=\"짧은 회고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>짧은 회고</h2>\n<p>5차 스프린트 발표에 아쉬움이 많다.\n발표를 마치고부터 해당 포스팅을 적기 시작했는데… 하면 할 수록 발표 때 잘못 얘기한 부분만 보여서 유튜브에 올라올 것이 두려울 정도다 🥲\n그래도 깃허브 위키에 올려, 다른 백엔드 팀원들에게 공유해주려고 더 꼼꼼히 글을 쓰게 되었던건데…\n팀원들에게 잘못된 지식을 전하지 않아서 다행이다 😇</p>\n<p>별개로 인덱스 테스트에도 아쉬움이 있다.\n더미데이터를 적당히 넣으면 된다고 생각했는데, 실행계획을 분석할수록 <strong>실제 데이터가 어떻게 쌓이는가</strong>에 따라 결과가 많이 달라질 것 같아서였다.\n실사용 데이터가 좀 쌓인다면, 이번에 인덱스 과제를 하지 않은 다른 백엔드 팀원들이랑 함께, 한단계 더 최적화를 시도해보고 싶다🔥</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#-%EC%A4%8D%EC%A4%8D-mysql-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%ED%83%90%ED%97%98\">🧳 줍줍 MySQL 인덱스 탐험</a></li>\n<li><a href=\"#%EC%BF%BC%EB%A6%AC-%EC%B5%9C%EC%A0%81%ED%99%94-by%EB%B4%84\">쿼리 최적화 by.봄🌱</a></li>\n<li><a href=\"#-%EC%8B%A4%ED%97%98-%ED%99%98%EA%B2%BD\">🧪 실험 환경</a></li>\n<li><a href=\"#%EF%B8%8F-mysql%EC%9D%98-%EC%9E%90%EB%8F%99-%EC%83%9D%EC%84%B1-%EC%9D%B8%EB%8D%B1%EC%8A%A4\">⚙️ MySQL의 자동 생성 인덱스</a></li>\n<li><a href=\"#-channel\">📺 Channel</a></li>\n<li><a href=\"#-channelsubscription\">🔖 ChannelSubscription</a></li>\n<li><a href=\"#%EF%B8%8Fbookmark--reminder\">⭐️Bookmark &#x26; ⏰Reminder</a></li>\n<li><a href=\"#%EF%B8%8F-querydsl%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B3%B5%EC%9E%A1%ED%95%9C-%EC%BF%BC%EB%A6%AC%EB%93%A4\">✉️ Querydsl을 이용한 복잡한 쿼리들</a></li>\n<li><a href=\"#finally\">finally</a></li>\n<li><a href=\"#%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\">짧은 회고</a></li>\n</ul>\n</div>","frontmatter":{"date":"October 04, 2022","title":"줍줍 MySQL 인덱스 탐험","categories":"etc 우아한테크코스 트러블슈팅","author":"써머","emoji":"headers/db_index.png"},"fields":{"slug":"/db_index/"}},"site":{"siteMetadata":{"siteUrl":"https://hyewoncc.github.io","comments":{"utterances":{"repo":"hyewoncc/hyewoncc.github.io"}}}}},"pageContext":{"slug":"/journey-to-cool-test-1/","nextSlug":"/topring-chapter2/","prevSlug":"/db_index/"}},"staticQueryHashes":["1073350324","1956554647","2938748437","3350743975"]}