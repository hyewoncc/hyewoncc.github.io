{"componentChunkName":"component---src-templates-blog-template-js","path":"/jpa-auditing-and-ci/","result":{"data":{"cur":{"id":"48a52cee-5a60-549e-9e68-7293d2b558b7","html":"<h2 id=\"-문제상황\" style=\"position:relative;\"><a href=\"#-%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\" aria-label=\" 문제상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>💣 문제상황</h2>\n<p><a href=\"https://github.com/woowacourse-teams/2022-pickpick\">줍줍</a>에는 북마크 설정한 메시지를 모아서 보는 기능이 있다.\n기존에는 이 북마크 목록을 보여줄 때, 북마크가 등록 된 <strong>메시지의 생성 시간</strong> 순서대로 보여줬다.\n그러다 사용자 편의를 위해 이를 <strong>북마크 등록 시간</strong> 순서대로 보여주기로 바꿨다.\n이 때, 북마크 등록 시간을 편하게 관리하기 위해 <code class=\"language-text\">JPA Auditing</code>을 도입했다.\n그리고 <a href=\"https://github.com/woowacourse-teams/2022-pickpick/pull/568\">해당 PR</a>은 순조롭게 머지 되었는데…</p>\n<p>팀원 봄이 진행한 <a href=\"https://github.com/woowacourse-teams/2022-pickpick/pull/570\">컨트롤러 테스트를 WebMvcTest로 개선하는 PR</a>에서 문제가 생겼다.\n봄의 로컬에서 테스트가 잘 돌아가는 상태였는데, PR의 <a href=\"https://github.com/woowacourse-teams/2022-pickpick/actions/runs/3179844507/jobs/5182750602\">github action</a>에서는 테스트가 실패했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA60lEQVQY062PfWuDQAzG7/t/t1FY5/pi9fSUVtmqtSaXO1t9xl3HGGywfxb4kRCeJE9U8rqB1gWquoapaqSHDLt9iqI0KE2F9UsSc5ZrbHd7MDNCLMvyK4qYQUQYR4K1gpEIXX+JvTB87joEDVuLyzBgmm5xcJ5nzPPyA3UlAtHj6n+E8s5HZ845TH6C9x4iArECEQdmCyaObsNhthL1wfH3OmjDJ6ppW6ye16iaFrqucXp7j5hTExmYIbd7hJ37WmAjAiuPpfKZ1bXvcXxagfMC4yED5RrWVOBcY0w28KWBTzO4LMf93P358gfXNs4R38PsUAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"깃헙 액션 실패\"\n        title=\"깃헙 액션 실패\"\n        src=\"/static/d4cfb4b4007765978f585ce48e18552c/37523/ci_fail.png\"\n        srcset=\"/static/d4cfb4b4007765978f585ce48e18552c/e9ff0/ci_fail.png 180w,\n/static/d4cfb4b4007765978f585ce48e18552c/f21e7/ci_fail.png 360w,\n/static/d4cfb4b4007765978f585ce48e18552c/37523/ci_fail.png 720w,\n/static/d4cfb4b4007765978f585ce48e18552c/302a4/ci_fail.png 1080w,\n/static/d4cfb4b4007765978f585ce48e18552c/07a9c/ci_fail.png 1440w,\n/static/d4cfb4b4007765978f585ce48e18552c/95e59/ci_fail.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">@WebMvcTest</code>로 변경한 모든 <code class=\"language-text\">RestDocs</code>용 컨트롤러 테스트가 같은 이유로 실패하고 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>IllegalStateException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Failed</span> <span class=\"token keyword\">to</span> <span class=\"token namespace\">load</span> <span class=\"token class-name\">ApplicationContext</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span></span>BeanCreationException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Error</span> creating bean <span class=\"token keyword\">with</span> <span class=\"token namespace\">name</span> 'jpaAuditingHandler'<span class=\"token operator\">:</span> <span class=\"token class-name\">Cannot</span> resolve reference <span class=\"token keyword\">to</span> <span class=\"token namespace\">bean</span> 'jpaMappingContext' <span class=\"token keyword\">while</span> setting constructor argument<span class=\"token punctuation\">;</span> \nnested exception is <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span></span>BeanCreationException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Error</span> creating bean <span class=\"token keyword\">with</span> <span class=\"token namespace\">name</span> 'jpaMappingContext'<span class=\"token operator\">:</span> <span class=\"token class-name\">Invocation</span> of init method failed<span class=\"token punctuation\">;</span> \nnested exception is <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>IllegalArgumentException</span><span class=\"token operator\">:</span> <span class=\"token constant\">JPA</span> metamodel must not be empty<span class=\"token operator\">!</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span></span>BeanCreationException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Error</span> creating bean <span class=\"token keyword\">with</span> <span class=\"token namespace\">name</span> 'jpaMappingContext'<span class=\"token operator\">:</span> <span class=\"token class-name\">Invocation</span> of init method failed<span class=\"token punctuation\">;</span> \nnested exception is <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>IllegalArgumentException</span><span class=\"token operator\">:</span> <span class=\"token constant\">JPA</span> metamodel must not be empty<span class=\"token operator\">!</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">JPA metamodel must not be empty</code>라는 문구가 눈에 띈다.\n해당 문구로 라이브러리를 검색해보면 <code class=\"language-text\">JpaMetamodelMappingContext</code>라는 클래스가 나온다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaMetamodelMappingContext</span>\n\t\t<span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractMappingContext</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">JpaPersistentEntityImpl</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">JpaPersistentProperty</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Metamodels</span> models<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PersistenceProvider</span> persistenceProvider<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">/**\n\t * Creates a new JPA {@link Metamodel} based {@link MappingContext}.\n\t *\n\t * @param models must not be {@literal null} or empty.\n\t */</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">JpaMetamodelMappingContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Metamodel</span><span class=\"token punctuation\">></span></span> models<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JPA metamodel must not be null!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notEmpty</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JPA metamodel must not be empty!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>사실 이 문구로 검색하면 많은 사람들이 해결법을 이미 올려두었다.\n그런데 여기까지 오니, <code class=\"language-text\">JPA metamodel</code>이 대체 뭔데? <code class=\"language-text\">null</code>도 아니고 <code class=\"language-text\">empty</code>라고?\n이거랑 <code class=\"language-text\">Auditing</code>은 무슨 상관이지? 등등 궁금한 점이 생겨서 코드를 조금 열어봤다.</p>\n<br>\n<h2 id=\"-jpa-metamodel\" style=\"position:relative;\"><a href=\"#-jpa-metamodel\" aria-label=\" jpa metamodel permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👾 JPA Metamodel</h2>\n<p>그렇다면 테스트가 잘 실행 될 때와, <code class=\"language-text\">@WebMvcTest</code>를 붙여 실행되지 않을 때, 저 <code class=\"language-text\">models</code>에는 무슨 값이 들어가있을까?\n정상적으로 실행되는 경우, <code class=\"language-text\">MetamodelImpl</code>이라는 클래스의 인스턴스에 엔티티 클래스와 관련된 정보가 담겨있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB4UlEQVQoz22Sy24UMRBF538gQmJDJsn0w+5uv8ru12QGERFNku+ABYsACiD++CB7JNiwuK5Sq+t03eveDIPiGAzWCNoKXZYT1OBpekfTWZTJveWq1v9XpehdwMWRzcX4BfXhM/b0jH78ze7+J+3pF+r0k/rjC93DD5r7F94s33g1PnMxfeVi/qfX83feTp/ofWTwgc27xiHieJgnbmXPLCsiK0NWXDFxxU0HtF9o7MS1Dmwby2Vj2bau1J327FrNdlezyUfyFY/Jcu+FxyA8SSQ5h7GWwTqM97gQ8CJISjRac1M33NQ1V7uKqlUFeFU1bC53LZO0PI2eUxh5iiN3ITJ5YXQB40KxYrxgJTF4oekG2t5wXbdsd02B5WeV6vKGDdYojjIwO2HNgy6gC0gwIeIkFVgOvbNne1kZkKV6Q6268oFNXrNqW5xVaOvLQB72cSROMz5NxGlBSj+Slj2dcajBMLj8fo4kUOUMs+UMrJUiOF1sZYshTaR5ZVpvGZd9qfP+3M/7Q6k2xAIbXKC3nptGnTM8b6gIXjGESO+FMC3EZc9yOBbAcntkPbwvfVYG5BhMkFJzxtluAW6rbFdzlwyrjxwlcYwjxzQhaSy55Y1lnItyn3/ifAmN7kutdf8X+AeTsHTWx+/SzwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"metamodel\"\n        title=\"metamodel\"\n        src=\"/static/723d9c45ddb107118ff118a946096b8c/37523/models_not_empty.png\"\n        srcset=\"/static/723d9c45ddb107118ff118a946096b8c/e9ff0/models_not_empty.png 180w,\n/static/723d9c45ddb107118ff118a946096b8c/f21e7/models_not_empty.png 360w,\n/static/723d9c45ddb107118ff118a946096b8c/37523/models_not_empty.png 720w,\n/static/723d9c45ddb107118ff118a946096b8c/302a4/models_not_empty.png 1080w,\n/static/723d9c45ddb107118ff118a946096b8c/07a9c/models_not_empty.png 1440w,\n/static/723d9c45ddb107118ff118a946096b8c/95e59/models_not_empty.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">@WebMvcTest</code>로 실행되지 않을 때는 해당 <code class=\"language-text\">models</code>가 비어있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.111111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAQklEQVQI10XISwqAMAwAUa9lBUvTTxJTt97/JiPYhYvHwGy9F55wTAPRi6pBtaX5pNn6ZThHrqQspK+//RRkODZvXqf9I/YqVpU1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"metamodel empty\"\n        title=\"metamodel empty\"\n        src=\"/static/9fccb72b921b1d2b7efe811c83d1dc54/37523/models_empty.png\"\n        srcset=\"/static/9fccb72b921b1d2b7efe811c83d1dc54/e9ff0/models_empty.png 180w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/f21e7/models_empty.png 360w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/37523/models_empty.png 720w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/302a4/models_empty.png 1080w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/07a9c/models_empty.png 1440w,\n/static/9fccb72b921b1d2b7efe811c83d1dc54/95e59/models_empty.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이 이슈를 검색하면 제일 자주 나오는 해결법이 <code class=\"language-text\">@WebMvcTest</code>를 쓰는 곳에 아래와 같이 <code class=\"language-text\">@MockBean</code>을 추가로 사용하는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@WebMvcTest</span>\n<span class=\"token annotation punctuation\">@MockBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaMetamodelMappingContext</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ControllerTest</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>일단 이 해결법을 적용했었지만, 내부 코드를 열고 보니 의문이 든다.\n이렇게 하면 <code class=\"language-text\">JpaMetamodelMappingContext</code> 생성자의 <code class=\"language-text\">Assert</code>문이 실행되지 않으니 터지지는 않는다.\n그런데 컨트롤러 슬라이스 테스트에서 사용하지 않을 JPA 관련 빈을 모킹해주는 것이 맞을까?</p>\n<p>어쨌든 이 <code class=\"language-text\">MetamodelImpl</code>이 어디서 생성되는가를 보자면…</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAqUlEQVQY022NbWrDMBAFfZt6JdCHV1qngbpgS3ba+99nSlxampIfs7AP3rzBOYd3nvpWWNaF1m9s/aCYclln1q2ff9sPtrbT+nFmWTNn1/sHhp8wTQmtilnFbCbGQNLIpMo0FerVKJdKne0kpPBceD/OO5w4RASREZEXYgoUjZT7UE6UkjDLhOAZZfyV/ZcOz1a8CHp95X1b+OiN2/7N596YNSPyKPvr+AKZAH5yRHyEYwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SessionFactoryObserver\"\n        title=\"SessionFactoryObserver\"\n        src=\"/static/6a7541ca966e3424be235b81315a3593/37523/sessionfactoryobserver.png\"\n        srcset=\"/static/6a7541ca966e3424be235b81315a3593/e9ff0/sessionfactoryobserver.png 180w,\n/static/6a7541ca966e3424be235b81315a3593/f21e7/sessionfactoryobserver.png 360w,\n/static/6a7541ca966e3424be235b81315a3593/37523/sessionfactoryobserver.png 720w,\n/static/6a7541ca966e3424be235b81315a3593/302a4/sessionfactoryobserver.png 1080w,\n/static/6a7541ca966e3424be235b81315a3593/07a9c/sessionfactoryobserver.png 1440w,\n/static/6a7541ca966e3424be235b81315a3593/95e59/sessionfactoryobserver.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Incubating</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TypeConfiguration</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">SessionFactoryObserver</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Serializable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MetamodelImplementor</span> <span class=\"token function\">scope</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SessionFactoryImplementor</span> sessionFactory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">debugf</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"Scoping TypeConfiguration [%s] to SessionFactoryImpl [%s]\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> sessionFactory <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> importEntry <span class=\"token operator\">:</span> scope<span class=\"token punctuation\">.</span>metadataBuildingContext<span class=\"token punctuation\">.</span><span class=\"token function\">getMetadataCollector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getImports</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> importMap<span class=\"token punctuation\">.</span><span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span> importEntry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t\timportMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span> importEntry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importEntry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\tscope<span class=\"token punctuation\">.</span><span class=\"token function\">setSessionFactory</span><span class=\"token punctuation\">(</span> sessionFactory <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsessionFactory<span class=\"token punctuation\">.</span><span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">this</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MetamodelImpl</span><span class=\"token punctuation\">(</span> sessionFactory<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>  </code></pre></div>\n<p><code class=\"language-text\">SessionFactoryObserver</code>를 구현한 <code class=\"language-text\">TypeConfiguration</code> 클래스의 <code class=\"language-text\">scope</code>라는 메서드에서 생성해주고 있다.\n그리고 이 메서드를 호출하는 곳은 <code class=\"language-text\">Hibernate</code>의 <code class=\"language-text\">SessionFactoryImpl</code>라는 클래스다.\n이 클래스는 <code class=\"language-text\">JPA</code>의 <code class=\"language-text\">EntityManagerFactory</code>를 상속하고 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABIklEQVQoz31RW5KEIBDzOALy8gUICqhz/yNlCyzdnd2p/Qihi5BOVzeUUlBCUflfkMqEELCOYQ4TtpSQjhM+rGBFwxiarusglYQQooJzDiHLXVbctZSX5mYuOFSvoLSqmtKMFUPZCyzbgrjviPnAOI+Y/Ih4ZGwpo5972NUgph3pPBDzDu9X9EYjpBX5eGEYhit5MSzH3U1qWdMWqPGuBYQW9V3P+kokeB2bCQbK6JOucNNx9p0gH8jnif11Ih8n9vOFEDb0VsPHgLhnbDHVkdu2fUx+cnMvhVBSY9eOHb2YUahJYnYWxjmY4DAbC+sWKK3/mD0jv4EWwcUFetKwzsEtHsvqKxdo3b8ZfTT8LajpO44hBKxbrOOWRRljQUj78c8XcKH7CkIlBQUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SessionFactoryImpl\"\n        title=\"SessionFactoryImpl\"\n        src=\"/static/759d4349731893465904fe5e8d57ae45/37523/SessionFactoryImpl.png\"\n        srcset=\"/static/759d4349731893465904fe5e8d57ae45/e9ff0/SessionFactoryImpl.png 180w,\n/static/759d4349731893465904fe5e8d57ae45/f21e7/SessionFactoryImpl.png 360w,\n/static/759d4349731893465904fe5e8d57ae45/37523/SessionFactoryImpl.png 720w,\n/static/759d4349731893465904fe5e8d57ae45/302a4/SessionFactoryImpl.png 1080w,\n/static/759d4349731893465904fe5e8d57ae45/07a9c/SessionFactoryImpl.png 1440w,\n/static/759d4349731893465904fe5e8d57ae45/95e59/SessionFactoryImpl.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SessionFactoryImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">SessionFactoryImplementor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">SessionFactoryImpl</span><span class=\"token punctuation\">(</span>\n\t\t\t<span class=\"token keyword\">final</span> <span class=\"token class-name\">MetadataImplementor</span> metadata<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token class-name\">SessionFactoryOptions</span> options<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token class-name\">QueryPlanCache<span class=\"token punctuation\">.</span>QueryPlanCreator</span> queryPlanCacheFunction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">MetamodelImpl</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>metamodel <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span>\n\t\t\tmetadata<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token function\">determineJpaMetaModelPopulationSetting</span><span class=\"token punctuation\">(</span> properties <span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>여기서 <code class=\"language-text\">MetamodelImpl.initialize()</code>를 호출하고…</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MetamodelImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">MetamodelImplementor</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Serializable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MetadataImplementor</span> mappingMetadata<span class=\"token punctuation\">,</span> <span class=\"token class-name\">JpaMetaModelPopulationSetting</span> jpaMetaModelPopulationSetting<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>imports<span class=\"token punctuation\">.</span><span class=\"token function\">putAll</span><span class=\"token punctuation\">(</span> mappingMetadata<span class=\"token punctuation\">.</span><span class=\"token function\">getImports</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>파라미터로 전달받은 <code class=\"language-text\">mappingMetadata</code>에서 여러 값을 불러와 저장하게 된다.\n이 <code class=\"language-text\">mappingMetadata</code>는 <code class=\"language-text\">SessionFactoryBuilderImpl</code>을 통해 <code class=\"language-text\">SessionFactoryImpl</code>에 주입되고,\n<code class=\"language-text\">SessionFactoryBuilderImpl</code>은 <code class=\"language-text\">DefaultSessionFactoryBuilderService</code>을 통해 생성되는데…\n의 과정을 따라가다보니 어느새 <code class=\"language-text\">MetadataImpl</code>로 돌아오고 있었다. 😵</p>\n<p>결론은 이 <code class=\"language-text\">MetamodelImpl</code>은 엔티티 정보를 담은 JPA <code class=\"language-text\">Metamodel</code>의 하이버네이트의 구현체며, 그래서 <code class=\"language-text\">@WebMvcTest</code>에서 생성되지 않았던 것이다.\n원래 최초 생성 시점을 찾으려고 했는데 결국 찾지 못했다.</p>\n<p>JPA 관련 빈이 로딩되는 <code class=\"language-text\">@DataJpaTest</code>가 붙은 테스트는 <code class=\"language-text\">models</code>가 정상적으로 생성되어 있는 것을 볼 수 있었다.</p>\n<br>\n<h2 id=\"-enablejpaauditing\" style=\"position:relative;\"><a href=\"#-enablejpaauditing\" aria-label=\" enablejpaauditing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🎧 EnableJpaAuditing</h2>\n<p>그렇다면 어떤 경위로 이 <code class=\"language-text\">Metamodel</code>이 필요했던 걸까?\nAuditing을 위해 추가했던 <code class=\"language-text\">@EnableJpaAuditing</code> 어노테이션을 보면 <code class=\"language-text\">JpaAuditingRegistrar</code> 클래스를 import 하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Import</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaAuditingRegistrar</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token annotation punctuation\">@interface</span> <span class=\"token class-name\">EnableJpaAuditing</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">JpaAuditingRegistrar</code>는 spring data jpa에 들어있는데, spring의 <code class=\"language-text\">ImportBeanDefinitionRegistrar</code> 클래스를 상속하고 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAs0lEQVQY042P2w7CIBBE+zdYoGgv7LJQ2hf//5fGuLHaNDX6cDIJGU52Guccjlhr0V07RJkgUiD5Qy4zOAm899o7/m2OIs3WwnmLgQYwC1LOkFpU9JQSs3bf/Z24Ob0uBIxEIOIXBEqESIxIpDzfz678KpxEUMqMPFdIWSDLHVJmpdRFp/8U7idcjIH3DtPYg+OIlJImTQOcbWGM+X/ylqG/gXPGUitqrVjXVTOEDvbQ34QP1Xm6oawy5NYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JpaAuditingRegistrar\"\n        title=\"JpaAuditingRegistrar\"\n        src=\"/static/03cf5aa0426628543dec4b0843ee2d35/37523/JpaAuditingRegistrar.png\"\n        srcset=\"/static/03cf5aa0426628543dec4b0843ee2d35/e9ff0/JpaAuditingRegistrar.png 180w,\n/static/03cf5aa0426628543dec4b0843ee2d35/f21e7/JpaAuditingRegistrar.png 360w,\n/static/03cf5aa0426628543dec4b0843ee2d35/37523/JpaAuditingRegistrar.png 720w,\n/static/03cf5aa0426628543dec4b0843ee2d35/302a4/JpaAuditingRegistrar.png 1080w,\n/static/03cf5aa0426628543dec4b0843ee2d35/07a9c/JpaAuditingRegistrar.png 1440w,\n/static/03cf5aa0426628543dec4b0843ee2d35/95e59/JpaAuditingRegistrar.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><a href=\"https://javacan.tistory.com/entry/spring-at-enable-config\">스프링 @Enable 설정 세 가지 구현 방식 - 자바캔</a> 포스팅에서 해당 클래스 이해에 도움을 받았는데, 이 클래스를 구현해 빈 설정을 직접 등록할 수 있다고 한다.\n바로 상위의 <code class=\"language-text\">AuditingBeanDefinitionRegistrarSupport</code>에서 하위 <code class=\"language-text\">JpaAuditingRegistrar</code>의 <code class=\"language-text\">registerAuditListenerBeanDefinition</code>를 호출하고 있고…</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuditingBeanDefinitionRegistrarSupport</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ImportBeanDefinitionRegistrar</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">registerBeanDefinitions</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AnnotationMetadata</span> annotationMetadata<span class=\"token punctuation\">,</span> <span class=\"token class-name\">BeanDefinitionRegistry</span> registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>annotationMetadata<span class=\"token punctuation\">,</span> <span class=\"token string\">\"AnnotationMetadata must not be null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>registry<span class=\"token punctuation\">,</span> <span class=\"token string\">\"BeanDefinitionRegistry must not be null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token class-name\">AbstractBeanDefinition</span> ahbd <span class=\"token operator\">=</span> <span class=\"token function\">registerAuditHandlerBeanDefinition</span><span class=\"token punctuation\">(</span>registry<span class=\"token punctuation\">,</span> <span class=\"token function\">getConfiguration</span><span class=\"token punctuation\">(</span>annotationMetadata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">registerAuditListenerBeanDefinition</span><span class=\"token punctuation\">(</span>ahbd<span class=\"token punctuation\">,</span> registry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>이 메서드에서 포스팅 초반에 봤던 키워드를 발견할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaAuditingRegistrar</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AuditingBeanDefinitionRegistrarSupport</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">registerAuditListenerBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BeanDefinition</span> auditingHandlerDefinition<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token class-name\">BeanDefinitionRegistry</span> registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>registry<span class=\"token punctuation\">.</span><span class=\"token function\">containsBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JPA_MAPPING_CONTEXT_BEAN_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tregistry<span class=\"token punctuation\">.</span><span class=\"token function\">registerBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JPA_MAPPING_CONTEXT_BEAN_NAME</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//</span>\n\t\t\t\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">RootBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaMetamodelMappingContextFactoryBean</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">JPA metamodel must not be empty</code> 에러 문구가 있던 <code class=\"language-text\">JpaMetamodelMappingContext</code> 클래스가 기억나는가?\n<code class=\"language-text\">JpaMetamodelMappingContextFactoryBean</code>라는 정직한 이름의 팩토리 빈에서 해당 클래스를 생성해주고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaMetamodelMappingContextFactoryBean</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractFactoryBean</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">JpaMetamodelMappingContext</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ApplicationContextAware</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token class-name\">JpaMetamodelMappingContext</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">LOG</span><span class=\"token punctuation\">.</span><span class=\"token function\">isDebugEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token constant\">LOG</span><span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Initializing JpaMetamodelMappingContext…\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token class-name\">JpaMetamodelMappingContext</span> context <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JpaMetamodelMappingContext</span><span class=\"token punctuation\">(</span><span class=\"token function\">getMetamodels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        context<span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">LOG</span><span class=\"token punctuation\">.</span><span class=\"token function\">isDebugEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token constant\">LOG</span><span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Finished initializing JpaMetamodelMappingContext!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">return</span> context<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">/**\n\t * Obtains all {@link Metamodel} instances of the current {@link ApplicationContext}.\n\t **/</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Metamodel</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getMetamodels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>beanFactory <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"BeanFactory must not be null!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">EntityManagerFactory</span><span class=\"token punctuation\">></span></span> factories <span class=\"token operator\">=</span> <span class=\"token class-name\">BeanFactoryUtils</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">beansOfTypeIncludingAncestors</span><span class=\"token punctuation\">(</span>beanFactory<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EntityManagerFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> factories<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">EntityManagerFactory</span><span class=\"token operator\">::</span><span class=\"token function\">getMetamodel</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StreamUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">toUnmodifiableSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">getMetamodels()</code> 메서드에 친절하게 현재 애플리케이션 컨텍스트의 모든 <code class=\"language-text\">Metamodel</code> 인스턴스를 찾는다고 적혀있다.\n아까 보았던 <code class=\"language-text\">EntityManagerFactory</code>도 보인다.</p>\n<br>\n<h2 id=\"-더-나은-해결법\" style=\"position:relative;\"><a href=\"#-%EB%8D%94-%EB%82%98%EC%9D%80-%ED%95%B4%EA%B2%B0%EB%B2%95\" aria-label=\" 더 나은 해결법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👀 더 나은 해결법?</h2>\n<p><code class=\"language-text\">@WebMvcTest</code>로 실행할 때는 JPA 관련 빈이 로딩되지 않아서. 라는 이유를 납득하기 위해 많이 돌아왔다.\n<code class=\"language-text\">@MockBean</code>을 쓰면 <code class=\"language-text\">@WebMvcTest</code>를 사용하는 테스트가 늘어날 때 마다 붙여줘야 한다는 문제가 있다.\n하지만 이 사소한 귀찮음이 진짜 문제는 아니라고 생각한다.\n<strong>진짜 문제</strong>는 <code class=\"language-text\">@WebMvcTest</code>에서 의도한 대로 빈 설정이 분리되고 있지 않는 상황이 아닐까?</p>\n<p>Auditing을 도입할 때, <code class=\"language-text\">Application</code> 클래스에 <code class=\"language-text\">@EnableJpaAuditing</code>을 붙였었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EnableJpaAuditing</span>\n<span class=\"token annotation punctuation\">@ConfigurationPropertiesScan</span>\n<span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PickpickApplication</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PickpickApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">@MockBean</code> 해결법이 검색에 많이 나오는 걸 보면, 이렇게 설정한 사람들이 많은 듯 하다.\n이를 <code class=\"language-text\">@Configuration</code> 클래스를 분리해 <code class=\"language-text\">@EnableJpaAuditing</code>를 거기 붙이는 해결 방법이 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@ConfigurationPropertiesScan</span>\n<span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PickpickApplication</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PickpickApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@EnableJpaAuditing</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuditingConfig</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 하면 <code class=\"language-text\">@WebMvcTest</code>에서 <code class=\"language-text\">@MockBean</code>을 사용하지 않아도 된다.\n해당 방식으로 리팩토링 하기를 제안해봐야겠다.</p>\n<br>\n<h3 id=\"-부록---자바독을-잘-읽자\" style=\"position:relative;\"><a href=\"#-%EB%B6%80%EB%A1%9D---%EC%9E%90%EB%B0%94%EB%8F%85%EC%9D%84-%EC%9E%98-%EC%9D%BD%EC%9E%90\" aria-label=\" 부록   자바독을 잘 읽자 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📚 부록 - 자바독을 잘 읽자</h3>\n<p>추가로 볼만한 부분이 있다.\nAuditing을 사용할 엔티티에 붙이는 리스너 클래스다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@EntityListeners</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AuditingEntityListener</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Bookmark</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 리스너 클래스의 자바독 주석을 보면 <code class=\"language-text\">@Configuration</code> 클래스를 분리한 것을 볼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">\n<span class=\"token comment\">/**\n * JPA entity listener to capture auditing information on persiting and updating entities. To get this one flying be\n * sure you configure it as entity listener in your {@code orm.xml} as follows:\n * ...\n * After that it's just a matter of activating auditing in your Spring config:\n *\n * @Configuration\n * @EnableJpaAuditing\n * class ApplicationConfig {\n *\n * }\n */</span>\n<span class=\"token annotation punctuation\">@Configurable</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuditingEntityListener</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>물론 베스트 프랙티스라고 올려둔 것은 아니겠으나… 자바독을 챙겨보는 습관을 기르면 도움이 될 것 같다.</p>\n<p>로컬에서 잘 돌아가고, 머지 때 충돌도 나지 않는 코드가, 깃헙 액션에서 터지는 이번 같은 때가 종종 있다.\nCI 구축… 참 소중하다.</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\">💣 문제상황</a></p>\n</li>\n<li>\n<p><a href=\"#-jpa-metamodel\">👾 JPA Metamodel</a></p>\n</li>\n<li>\n<p><a href=\"#-enablejpaauditing\">🎧 EnableJpaAuditing</a></p>\n</li>\n<li>\n<p><a href=\"#-%EB%8D%94-%EB%82%98%EC%9D%80-%ED%95%B4%EA%B2%B0%EB%B2%95\">👀 더 나은 해결법?</a></p>\n<ul>\n<li><a href=\"#-%EB%B6%80%EB%A1%9D---%EC%9E%90%EB%B0%94%EB%8F%85%EC%9D%84-%EC%9E%98-%EC%9D%BD%EC%9E%90\">📚 부록 - 자바독을 잘 읽자</a></li>\n</ul>\n</li>\n</ul>\n</div>","excerpt":"💣 문제상황 줍줍에는 북마크 설정한 메시지를 모아서 보는 기능이 있다.\n기존에는 이 북마크 목록을 보여줄 때, 북마크가 등록 된 메시지의 생성 시간 순서대로 보여줬다.\n그러다 사용자 편의를 위해 이를 북마크 등록 시간 순서대로 보여주기로 바꿨다.\n이 때, 북마크 등록 시간을 편하게 관리하기 위해 을 도입했다.\n그리고 해당 PR은 순조롭게 머지 되었는데… 팀원 봄이 진행한 컨트롤러 테스트를 WebMvcTest로 개선하는 PR에서 문제가 생겼다.\n봄의 로컬에서 테스트가 잘 돌아가는 상태였는데, PR의 github action에서는 테스트가 실패했다.  로 변경한 모든 용 컨트롤러 테스트가 같은 이유로 실패하고 있었다. 라는 문구가 눈에 띈다.\n해당 문구로 라이브러리를 검색해보면 라는 클래스가 나온다. 사실 이 문구로 검색하면 많은 사람들이 해결법을 이미 올려두었다.\n그런데 여기까지 오니, 이 대체 뭔데? 도 아니고 라고?\n이거랑 은 무슨 상관이지? 등등 궁금한 점이 생겨서 코드를 조금…","frontmatter":{"date":"October 14, 2022","title":"[JPA] EnableJpaAuditing의 내부와 CI의 소중함","categories":"Spring JPA 트러블슈팅","author":"써머","emoji":"headers/jpa-auditing-and-ci.png"},"fields":{"slug":"/jpa-auditing-and-ci/"}},"next":{"id":"64b7ae52-9f74-5c76-abbd-81a0703ad323","html":"<h2 id=\"-줍줍-mysql-인덱스-탐험\" style=\"position:relative;\"><a href=\"#-%EC%A4%8D%EC%A4%8D-mysql-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%ED%83%90%ED%97%98\" aria-label=\" 줍줍 mysql 인덱스 탐험 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🧳 줍줍 MySQL 인덱스 탐험</h2>\n<p>❗️ 해당 포스팅에서 지칭하는 <strong>책</strong>은 모두 <a href=\"https://search.shopping.naver.com/book/catalog/32443973624?cat_id=50010586&#x26;frm=PBOKPRO&#x26;query=realmysql&#x26;NaPm=ct%3Dl8u5bsc0%7Cci%3D283e817c3ef615da4bb3c94f9385d94070cbbc93%7Ctr%3Dboknx%7Csn%3D95694%7Chk%3D702ada6411525c62218b0df3e900c84c33c4cdd2\">Real MySQL 8.0 1권</a>을 뜻합니다.</p>\n<p>우테코 팀 프로젝트 5차 스프린트에서 성능 테스트로 톰캣 설정 최적화 / 모든 쿼리 수집 후 DB 인덱스 설정 이라는 두 개의 백엔드 과제가 있었다.\n나는 이 중 <strong>DB 인덱스 설정</strong>을 맡게 되었다.\n줍줍의 전체 테이블 구조는 정석 ERD보다 간략하게 표현하자면 이렇다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB9ElEQVQozz2S23KbQBBE9QPiDiuW5bJACVlIJjJGFyzZqSR+cN78/x9zUrty/DBQw7Dd0729CIIAU47rsnQcPM+zvR8EuK5n+/Fw4DhNRFGE5/l2Zv/xfRzHwXXd735hHubDQ9cxX84opSx4FHrsu4KyrGhrzfXlhTwvSGOPJApZLh2klMzzzG63+15kIVOByiSFUoxPT7RtQxQKZByy60p+/f5D0zTcbldeX39SyJgsdml0bgG3260F/L/lQknBcXomEYJhGLjMZ5TUFCtDkjAdT+iq4vl5ZN1tyIRPXcUcxoHr9cZms2EcR9I0vQPGUWSZTBPHMUIkxNGKMpWkiYcfhF8+OTiuhxQBstUUTcvhcKCqKvq+tyqM7IUxPs9zu7oZdN2aXFUUaYqI7iB9v2W/31tw42FWKUsSBD5lWdqFviWnqwSlMrTWnM9n6+FK5OQric4TC7J92DBNE2EYkeUrsnWL47iEYWjPGLI7gQUUzPOF9XptD9V1jc5K+kozDz3zy9XKMR6mqUTlEv1QM/Qtdd1YyUadATe18P2AYfhhzTXSDKCIA5LQYdMWfH5+cjqdeH9/t2Uik8iEp/ORvx8fPD4+crvdyLLsvqEN9Vc4TRljDcnScdG6ssabG7xcLry9vdk0mJwa+UIIe5Fmbt4m2P8Av94QAZ/CxekAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"erd\"\n        title=\"erd\"\n        src=\"/static/04f240438cca4d0a360f7e62c155feaa/37523/jupjup_tables.png\"\n        srcset=\"/static/04f240438cca4d0a360f7e62c155feaa/e9ff0/jupjup_tables.png 180w,\n/static/04f240438cca4d0a360f7e62c155feaa/f21e7/jupjup_tables.png 360w,\n/static/04f240438cca4d0a360f7e62c155feaa/37523/jupjup_tables.png 720w,\n/static/04f240438cca4d0a360f7e62c155feaa/302a4/jupjup_tables.png 1080w,\n/static/04f240438cca4d0a360f7e62c155feaa/07a9c/jupjup_tables.png 1440w,\n/static/04f240438cca4d0a360f7e62c155feaa/95e59/jupjup_tables.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>쿼리 수집은 쉬웠다.\n줍줍의 모든 <code class=\"language-text\">Repository</code> 클래스들은 <code class=\"language-text\">Repository&lt;Domain, ID></code>를 상속했다.\n<code class=\"language-text\">JpaRepository</code>는 선언하지 않은 메서드도 사용 가능한 반면, <code class=\"language-text\">Repository</code>를 상속하면 선언한 메서드만 사용 가능하다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABpUlEQVQoz32S2Y7aQBBF+ZpkcC/esCcoGBizGe8bmCUj5f9/4kRu0Ix4ycPRvV1S3ypV98RVPxFvP5DWG1paKKVRWj9UCrSYopRCa42U0nj1VCkshPXKZHUoWO0Lfsd7vCDEmwV4QYAfhPjh+4Pg/fscfNdm4StjfTJfbtjGMfkxoTqs2K3n+GGAbTsPnP9gO2jbNozecT0mSgksYeEqF9f28GyfJMnYJ0eWqzXRckW0Wj/8k0d9zUe8YbPdEW+2rD9i02Qy7sLTUxwtULZm5vtcz3+4fv6l7QeKuqOoW9KiJiubF8qmoztfOF/uxjuuy0Qqxcy2iHyLefiLONoytFdO1ztt11O3PWXdUNYtSZqx2R3Y7RO2+4R9klJUNW13Is0LHGcMlJKpEEynFkIqlosFt9Od4f5JfzrT9icT1vVniqox5GXNMSs4HDN2hyNNdyIvq2egUgglzJOP3yVaRFy6mwkcLjeatqduOuq2M8FV05IVlZnsoY0JHBuYHUolzaMIM+UUR2mG9kI3XE3YOE2Wl+ZCkuZfmualaWCoGnZJitI2/wC8hzdG9GmzpQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JpaRepository\"\n        title=\"JpaRepository\"\n        src=\"/static/610e8798201278004b7fd531bea1d86f/37523/jpa_repository.png\"\n        srcset=\"/static/610e8798201278004b7fd531bea1d86f/e9ff0/jpa_repository.png 180w,\n/static/610e8798201278004b7fd531bea1d86f/f21e7/jpa_repository.png 360w,\n/static/610e8798201278004b7fd531bea1d86f/37523/jpa_repository.png 720w,\n/static/610e8798201278004b7fd531bea1d86f/302a4/jpa_repository.png 1080w,\n/static/610e8798201278004b7fd531bea1d86f/07a9c/jpa_repository.png 1440w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  JpaRepository를 상속했을 때\n</div>\n<br>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABiElEQVQoz32S247aMBRF8zUVkKsdOwnkSiiXMAQCYRhGpdNW6v//wqoSYAoP7cPS2Tq29tk+siFchyTNSdOEoixJJpp65rMqNXk2ZhxIpK/QgcZxbGz7jsVoNMI0zScM23HIsoJZEVHNE9K84OssZz7tzDx0GCGkRAgP0xz1Jv/DcGybsXIp0pB0IplmEWms8ZVGCInWGs+x+ul/0/0bY5LEBHFGMElwpUIr0eOJG15X5TWllL32HqqQz2dGuW5ZbvYsXmrKIiZJIoQOkErj6+AT+aAfe929O34QYjiOgxIWZZGymudMi5isyAnDCCklvu/fUA/6hlIEQYDSul+N67oY3buHlslgaPJlMMS2bF7bd96//2CzbVis1j3zZfWp76zWG7bNgX372tduPb1h5A1IlUkUhuRxzre3Dy6/fnP5+MnxdGa3b6mbA9umZV3veqrNjt3hyOF4oj2daQ7H6w4ty8KyTKQ9RHiCWbHgcnyjPV96k+qlfmK53rCsrnQJV7d+l7D7FX8A4/ctw+64JMEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Repository\"\n        title=\"Repository\"\n        src=\"/static/07fa46015009235d0a4b55a84bc7d699/37523/repository.png\"\n        srcset=\"/static/07fa46015009235d0a4b55a84bc7d699/e9ff0/repository.png 180w,\n/static/07fa46015009235d0a4b55a84bc7d699/f21e7/repository.png 360w,\n/static/07fa46015009235d0a4b55a84bc7d699/37523/repository.png 720w,\n/static/07fa46015009235d0a4b55a84bc7d699/302a4/repository.png 1080w,\n/static/07fa46015009235d0a4b55a84bc7d699/07a9c/repository.png 1440w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  Repository를 상속했을 때\n</div>\n<br>\n<p>뒤집어 말하면 <code class=\"language-text\">QueryDsl</code>사용을 제외하면, <code class=\"language-text\">Repository</code> 코드의 모든 메서드가 곧 프로젝트에 사용 중인 모든 쿼리였다.</p>\n<br>\n<h2 id=\"쿼리-최적화-by봄\" style=\"position:relative;\"><a href=\"#%EC%BF%BC%EB%A6%AC-%EC%B5%9C%EC%A0%81%ED%99%94-by%EB%B4%84\" aria-label=\"쿼리 최적화 by봄 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>쿼리 최적화 by.봄🌱</h2>\n<p>인덱스 최적화를 시작하기 전에 고맙게도 같은 팀 크루인 봄이 <a href=\"https://github.com/woowacourse-teams/2022-pickpick/pull/531\">불필요햔 left outer join을 제거하는 쿼리 최적화</a>를 해주었다!\n<code class=\"language-text\">Repository</code>에서 <code class=\"language-text\">B</code>의 PK를 FK로 가진 <code class=\"language-text\">A</code>가 해당 FK를 조건으로 조회할 때, <code class=\"language-text\">findByBId</code>로 하면 불필요한 <code class=\"language-text\">left outer join</code>이 발생하고 있었다.\n이를 이미 <code class=\"language-text\">B</code>를 조회한 곳에서는 <code class=\"language-text\">findByB</code>를 사용하도록 바꾸고, <code class=\"language-text\">B</code>를 조회하지 않는 곳에서는 <code class=\"language-text\">@Query</code>로 직접 쿼리문을 작성해 개선해주었다.\n고마워요 최고 봄!</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 멤버의 채널 구독을 화면 순서대로 가져오는 메서드</span>\n<span class=\"token comment\">// Before</span>\n<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ChannelSubscription</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findFirstByMemberIdOrderByViewOrderDesc</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// After</span>\n<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ChannelSubscription</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findFirstByMemberOrderByViewOrderDesc</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 멤버와 메시지로 일치하는 북마크를 찾는 메서드</span>\n<span class=\"token comment\">// Before</span>\n<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Bookmark</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByMessageIdAndMemberId</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> messageId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// After</span>\n<span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select b from Bookmark b WHERE b.message.id = :messageId and b.member.id = :memberId\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Bookmark</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByMessageIdAndMemberId</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> messageId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<h2 id=\"-실험-환경\" style=\"position:relative;\"><a href=\"#-%EC%8B%A4%ED%97%98-%ED%99%98%EA%B2%BD\" aria-label=\" 실험 환경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🧪 실험 환경</h2>\n<p>모든 테스트는 로컬 <code class=\"language-text\">docker</code>에 <code class=\"language-text\">mysql</code>을 띄워, 프로젝트와 동일하게 DB를 설정해 진행했다.<br>\n그리고 <code class=\"language-text\">프로시저</code>로 10만건의 <code class=\"language-text\">Member</code> 더미데이터를 넣으려고 했는데…\n느려도 <strong>너무</strong> 느렸다.\n찾아보니 유니크한 <code class=\"language-text\">slackId</code>를 부여하기 위해 <code class=\"language-text\">UUID</code> 값 생성 후 적당히 잘라서 쓰고 있었는데, 여기가 문제였다.\n그래서 <code class=\"language-text\">JdbcTemplate</code>의 <code class=\"language-text\">batchUpdate</code>로 데이터를 넣도록 간단한 코드를 짰다.\n10만건 삽입에 프로시저는 <strong>4분</strong> 전후, 자바 코드로는 16초가 걸렸다…\n<code class=\"language-text\">JdbcTemplate</code>으로 하는 게 훨씬 빠르다고 알려준 매트에게 고맙다.😭</p>\n<br>  \n<h2 id=\"️-mysql의-자동-생성-인덱스\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-mysql%EC%9D%98-%EC%9E%90%EB%8F%99-%EC%83%9D%EC%84%B1-%EC%9D%B8%EB%8D%B1%EC%8A%A4\" aria-label=\"️ mysql의 자동 생성 인덱스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⚙️ MySQL의 자동 생성 인덱스</h2>\n<p>사실 내가 모르는 새에 우리 DB에는 필요한 대부분의 인덱스가 설정되어 있었다.\n컬럼이 1.유니크하면서 2.null을 허용하지 않을 때, MySQL에서 자동으로 해당 컬럼으로 인덱스를 만들기 때문이다.\n마침 프로젝트에서 슬랙 정보를 이용하는 <code class=\"language-text\">member, channel, message</code> 테이블에는 해당 조건을 충족하는 <code class=\"language-text\">slack_id</code> 컬럼이 있었다.\n아래 그림에서 하이라이트 된 컬럼은 모두 자동 인덱스가 이미 설정 된 컬럼이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACnElEQVQozyWSzWscZQDGB2qx6e687zvvfM/u7OxmM5NM9qu7TbLZtHHTlMQmbtLQptVYba1EYiqCYrRa6KFV8ANPASmix/4lIoo3BS/FqyBePHn/SdbDc3g+Dg8Pj6G1RmsbKRVCSCxljfmJLqSgIE7R6tTpns+R+nmELIw9+yRj2UihUMrC1s5YNyzLwhRnybIai4tzRCUPU5rYusD8bJdR55jd3ne8eeV7Ru0nNErL2E6RglnADQQLgw4zjUkK4jksrTBKUUivfp2lbJ+NwT2GrbdJw1V8p0gv73B3+5i1zgP21j/j9uYxzaSP75xmfvol1vLP2el/zc7gCxbjT/CdCkYclbmx8piV9BHXLnzJ7RefsFC/SzlwqZRdunNNSonNuV5OLSsTeYKkItge3ufhzWccDH/ig9Gv3Dn/M5GbYbiOS7U8S9ltEvuzJFGDkpdTCQMiz8K2A5S0UVKjlEvJdwinqlRqM3TbC9SrszTzOaanzmFZGkNKSVBS1GcC0jymlnqEkUcSRnhOkQnzFFkekzcnKarT+E6BcjXGNAtIq0hcCfFDB1NMoLWFEQYB7ckr9GdusfnCWwyae6Tl4bhJltRplV5lrfcuW8vv0YlvkVa7hGmCkh6Bm3BxaZVuu49W3vgdRhzV+Ojqb3x46R8ebP3J0fBfbrSeMlURbMzt8PD6X7xz8Q+ONp9xb/5vBtP7RJngav9jDpZ+542FHzlc+YVXGj8QuSmG1g793mV6zVXm22u0s1WqQYZrn6WZ5uy//Jjt4fvsje7z2tYjEr+BHUouLb/O4e63XLvwFXc2vuFy/imeHWNY+v8fnmwwhjyDtARFYZJONlgfHNCt3WS0csju+hFJ1MIURbQtsT0TZU/g+ALlnMGyFP8BViM3exuWJ9oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"indexes\"\n        title=\"indexes\"\n        src=\"/static/d2fabf195ae1c7d0be2a4c9faeca315e/37523/db_indexes.png\"\n        srcset=\"/static/d2fabf195ae1c7d0be2a4c9faeca315e/e9ff0/db_indexes.png 180w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/f21e7/db_indexes.png 360w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/37523/db_indexes.png 720w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/302a4/db_indexes.png 1080w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/07a9c/db_indexes.png 1440w,\n/static/d2fabf195ae1c7d0be2a4c9faeca315e/95e59/db_indexes.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그래도 궁금하니 한번 자동 생성된 인덱스를 삭제하고 <code class=\"language-text\">explain analyze</code> 쿼리를 통해 실행 시간을 재어 보았다.\n<code class=\"language-text\">member</code>에 10만개의 데이터를 넣고 99,998번째 row의 <code class=\"language-text\">slack_id</code>로 검색했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">explain</span> <span class=\"token keyword\">analyze</span>\n<span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> first_login<span class=\"token punctuation\">,</span> slack_id<span class=\"token punctuation\">,</span> thumbnail_url<span class=\"token punctuation\">,</span> username\n<span class=\"token keyword\">from</span> member\n<span class=\"token keyword\">where</span> slack_id <span class=\"token operator\">=</span> :slackId<span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAW0lEQVQI11WLSw6AIAxEuRO05VdYaox6/9uMoRCji+Z13mTcft7YjgvaOqq294oqStWfM7/c6Gvrk5/OEUdIymBJYIkgFmMghvcBHJN1gcT+4cdmUGJeeW58IDxruEMlyKijswAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인덱스 있을 떄\"\n        title=\"인덱스 있을 떄\"\n        src=\"/static/1a39f7c934454940377514a42a306e62/37523/time_auto_index_member.png\"\n        srcset=\"/static/1a39f7c934454940377514a42a306e62/e9ff0/time_auto_index_member.png 180w,\n/static/1a39f7c934454940377514a42a306e62/f21e7/time_auto_index_member.png 360w,\n/static/1a39f7c934454940377514a42a306e62/37523/time_auto_index_member.png 720w,\n/static/1a39f7c934454940377514a42a306e62/302a4/time_auto_index_member.png 1080w,\n/static/1a39f7c934454940377514a42a306e62/2cefc/time_auto_index_member.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAWklEQVQI102LURKFIAwDvZJAW2gL97/VvhF9o1/ZzCZHZOKRRE48YnPORa6FexBPv/3L/9+3X3nYcGoTRDul1M0jJp6T8yw0Ua6N9nE7z70VNWp7nHWaGmKdHxmTQqRt4VJdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인덱스 없을 때\"\n        title=\"인덱스 없을 때\"\n        src=\"/static/33cb14290223f0b53720a3ba42a4f52e/37523/time_no_index_member.png\"\n        srcset=\"/static/33cb14290223f0b53720a3ba42a4f52e/e9ff0/time_no_index_member.png 180w,\n/static/33cb14290223f0b53720a3ba42a4f52e/f21e7/time_no_index_member.png 360w,\n/static/33cb14290223f0b53720a3ba42a4f52e/37523/time_no_index_member.png 720w,\n/static/33cb14290223f0b53720a3ba42a4f52e/302a4/time_no_index_member.png 1080w,\n/static/33cb14290223f0b53720a3ba42a4f52e/2cefc/time_no_index_member.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>자동 생성된 인덱스를 두고 조회했을 때 <strong>0.017~0.025ms</strong>가,\n해당 인덱스를 삭제하고 조회했을 때 <strong>1857ms</strong>가 소요되었다.\n1.8초도 느리긴 하지만, <strong>10000배</strong> 차이난다고 생각하니 정말 많~이 느려졌다.</p>\n<p>그럼 프로젝트의 쿼리가 최적의 인덱스를 타고 있는지 일단 <strong>모두</strong> 확인해보자.</p>\n<ul>\n<li>Member\n<ul>\n<li>✅ findById(Long id)</li>\n<li>✅ findBySlackId(String slackId)</li>\n</ul>\n</li>\n<li>Channel\n<ul>\n<li>✅ findById(Long id)</li>\n<li>✅ findBySlackId(String slackId)</li>\n<li>⬜️ findAllByOrderByName()</li>\n</ul>\n</li>\n<li>ChannelSubscription\n<ul>\n<li>✅ findAllByMemberId(Long memberId)</li>\n<li>⬜️ findAllByMemberIdOrderByViewOrder(Long memberId)</li>\n<li>⬜️ findFirstByMemberOrderByViewOrderDesc(Member member)</li>\n<li>⬜️ findFirstByMemberIdOrderByViewOrderAsc(Long memberId)</li>\n<li>⬜️ existsByChannelAndMember(Channel channel, Member member)</li>\n</ul>\n</li>\n<li>Message\n<ul>\n<li>✅ findById(long id)</li>\n<li>✅ findBySlackId(String slackMessageId)</li>\n<li>⬜️ Querydsl을 이용한 복잡한 조회쿼리</li>\n</ul>\n</li>\n<li>Bookmark\n<ul>\n<li>✅ findById(Long id)</li>\n<li>⬜️ findByMessageIdAndMemberId(Long messageId, Long memberId)</li>\n<li>⬜️ Querydsl을 이용한 복잡한 조회쿼리</li>\n</ul>\n</li>\n<li>Reminder\n<ul>\n<li>✅ findById(Long id)</li>\n<li>⬜️ findByMessageIdAndMemberId(Long messageId, Long memberId)</li>\n<li>⬜️ findAllByRemindDate(LocalDateTime remindDate)</li>\n<li>⬜️ Querydsl을 이용한 복잡한 조회쿼리</li>\n</ul>\n</li>\n</ul>\n<p>이미 최적의 인덱스를 사용하고 있을 쿼리는 체크해줬다.\n위에서부터 하나씩 제거해보자.</p>\n<h2 id=\"-channel\" style=\"position:relative;\"><a href=\"#-channel\" aria-label=\" channel permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📺 Channel</h2>\n<p>채널의 <code class=\"language-text\">findAllByOderByName()</code>은 워크스페이스의 모든 채널 목록을 반환한다.\n현재 1.한 워크스페이스만 지원하고있고 2.공개 채널만 저장되기 떄문에, 별다른 조건을 주지 않고 모두 조회중이다.\n그래서 넉넉하게 500개의 데이터를 넣고 조회했는데, <code class=\"language-text\">name</code> 컬럼에 인덱스를 설정 한 것과 안 한 것의 차이가 없었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> channel\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name <span class=\"token keyword\">asc</span>\n<span class=\"token keyword\">limit</span> <span class=\"token number\">500</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXElEQVQI11WKRwqAMBQFPZIpv8Q0d4qS+x/niQlBXAwzvyzn3XBcDaXuSLkgptQ9yaX+5knMeXT5dltMWJwnsASQaLe1DsQCFu3WEEGs/e5JRvPbPP40DCRgNQYPa0VDHytJ0mgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인덱스 없음\"\n        title=\"인덱스 없음\"\n        src=\"/static/d31fb8ed49d623f761fac015c0265def/37523/channel_name_no_index.png\"\n        srcset=\"/static/d31fb8ed49d623f761fac015c0265def/e9ff0/channel_name_no_index.png 180w,\n/static/d31fb8ed49d623f761fac015c0265def/f21e7/channel_name_no_index.png 360w,\n/static/d31fb8ed49d623f761fac015c0265def/37523/channel_name_no_index.png 720w,\n/static/d31fb8ed49d623f761fac015c0265def/302a4/channel_name_no_index.png 1080w,\n/static/d31fb8ed49d623f761fac015c0265def/2cefc/channel_name_no_index.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAWUlEQVQI133KNw6AMBBEUR8Jhw3GiQ4E8v2PM0g2FDQUX0+rWXNcHfvZUduGXCpSzsO3Utvn/mtNGcYHAksEiQ6d8yAWsOhQYwKxjj2QTFmefwVrnEnEYi1ubElDJ21QWRcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"인덱스 있음\"\n        title=\"인덱스 있음\"\n        src=\"/static/e54bad9215158cf816ce4b318c933763/37523/channel_name_index.png\"\n        srcset=\"/static/e54bad9215158cf816ce4b318c933763/e9ff0/channel_name_index.png 180w,\n/static/e54bad9215158cf816ce4b318c933763/f21e7/channel_name_index.png 360w,\n/static/e54bad9215158cf816ce4b318c933763/37523/channel_name_index.png 720w,\n/static/e54bad9215158cf816ce4b318c933763/302a4/channel_name_index.png 1080w,\n/static/e54bad9215158cf816ce4b318c933763/2cefc/channel_name_index.png 1400w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>name 인덱스 X</th>\n<th>name 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>15~34ms</td>\n<td>15~33ms</td>\n</tr>\n</tbody>\n</table>\n<p><code class=\"language-text\">order by</code>는 원래 인덱스를 이용하지 않나 싶어서 책이랑 구글도 찾아봤는데 이유를 잘 모르겠다.\n데이터가 너무 적어서 그럴 수도 있겠다.\n어쨌든 추가로 인덱스를 설정하지 않았다.</p>\n<h2 id=\"-channelsubscription\" style=\"position:relative;\"><a href=\"#-channelsubscription\" aria-label=\" channelsubscription permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🔖 ChannelSubscription</h2>\n<p>채널 구독은 2000명의 멤버가 500개의 채널을 각각 구독하는 상황을 가정해 <strong>10만개</strong>의 더미데이터를 삽입했다.\n우선 쿼리가 비슷한 아래 세 메서드를 보자.</p>\n<ul>\n<li>findAllByMemberIdOrderByViewOrder(Long memberId)</li>\n<li>findFirstByMemberOrderByViewOrderDesc(Member member)</li>\n<li>findFirstByMemberIdOrderByViewOrderAsc(Long memberId)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> channel_subscription\n<span class=\"token keyword\">where</span> member_id <span class=\"token operator\">=</span> :memberId\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> view_order<span class=\"token punctuation\">;</span> <span class=\"token comment\">#desc;</span>\n<span class=\"token keyword\">limit</span> <span class=\"token number\">500</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">#limit 1; </span></code></pre></div>\n<p>구독은 멤버에 종속적인 개념이기에, 항상 <code class=\"language-text\">memberId</code>를 기준으로 조회된다.\n그리고 <code class=\"language-text\">view_order</code> 순서대로 모두 조회하기 또는 첫번째 값을 가져오기기에,\n<code class=\"language-text\">memberId</code>와 <code class=\"language-text\">view_order</code>로 복합 인덱스를 설정해봤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> member_view_order <span class=\"token keyword\">on</span> channel_subscription <span class=\"token punctuation\">(</span>member_id<span class=\"token punctuation\">,</span> view_order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>복합 인덱스를 설정했을 떄, 실제로 해당 인덱스를 이용해 쿼리가 실행된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAdElEQVQI1x2LWRKCMBBEOVISKqBmMhMUKZaS0vsf5lnMVy+vu7M2UYogVZFaKSKuqsay7SzbwfScPR/nj/e6O79++/lFraFmrMeH6TXTVW08pCJqSDXuRbg60UbOAzEmYoyklHxTRJ0N48193/fOQwjkYeQP4UJEkmuOp8wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 전\"\n        title=\"복합 인덱스 설정 전\"\n        src=\"/static/08f9887cb6960baf9eda7bd0ac3b125d/37523/subs_explain_no_index.png\"\n        srcset=\"/static/08f9887cb6960baf9eda7bd0ac3b125d/e9ff0/subs_explain_no_index.png 180w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/f21e7/subs_explain_no_index.png 360w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/37523/subs_explain_no_index.png 720w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/302a4/subs_explain_no_index.png 1080w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/07a9c/subs_explain_no_index.png 1440w,\n/static/08f9887cb6960baf9eda7bd0ac3b125d/95e59/subs_explain_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAdklEQVQI1z3KWw6CMBRFUQbUiyJtAWkLlVeFaJz/ZLahMX6d7JVThDHSe48PA/P2ZFo2nA/s7w9hGOmdz7umnce8/n6JOC0MMZKOV7bzc3phbIttO4xtqLWhLC+IlNydz2abDm0s16pCRFBK5a5udW6t9d+VCF+wN0MXUyQZPgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 후\"\n        title=\"복합 인덱스 설정 후\"\n        src=\"/static/378940d78a6f24c78f34d64c660e2bc8/37523/subs_explain_index.png\"\n        srcset=\"/static/378940d78a6f24c78f34d64c660e2bc8/e9ff0/subs_explain_index.png 180w,\n/static/378940d78a6f24c78f34d64c660e2bc8/f21e7/subs_explain_index.png 360w,\n/static/378940d78a6f24c78f34d64c660e2bc8/37523/subs_explain_index.png 720w,\n/static/378940d78a6f24c78f34d64c660e2bc8/302a4/subs_explain_index.png 1080w,\n/static/378940d78a6f24c78f34d64c660e2bc8/07a9c/subs_explain_index.png 1440w,\n/static/378940d78a6f24c78f34d64c660e2bc8/95e59/subs_explain_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<div style=\"text-align:center; font-style:italic; color:grey;\">\n  복합 인덱스 설정하기 전과 후\n</div>\n<br> \n<p>하지만 실행시간에서 유의미한 차이를 볼 수 없었다.\n의문인 점은 복합 인덱스 설정 전에는 <code class=\"language-text\">Extra</code> 필드에 <code class=\"language-text\">Using filesort</code>가 표기된다는 점이다.\n이건 <code class=\"language-text\">order by</code> 처리 시, 적합한 인덱스를 사용하지 못해 MySQL 서버가 조회된 레코드를 다시 정렬한다는 뜻이다.\n복합 인덱스 설정 시 해당 인덱스를 사용하기에 <code class=\"language-text\">Extra</code>는 <code class=\"language-text\">null</code>이 된다.\n그럼에도 실행시간이 뚜렷하게 개선되지 않았다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAU0lEQVQI112Lxw3AMAwDvZGRZksitf9YDFw+yeMA1sJMAVQAAvkF3N3yZC6N34brPygelAV03Y/Moe6h1l0OqpnPrnWbPphTz3xvB47UcZyqteoFJcxC5vOdpXkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 전\"\n        title=\"복합 인덱스 설정 전\"\n        src=\"/static/cf3cfd9d769e010b40df197d8f90b2a5/37523/subs_analyze_no_index.png\"\n        srcset=\"/static/cf3cfd9d769e010b40df197d8f90b2a5/e9ff0/subs_analyze_no_index.png 180w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/f21e7/subs_analyze_no_index.png 360w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/37523/subs_analyze_no_index.png 720w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/302a4/subs_analyze_no_index.png 1080w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/07a9c/subs_analyze_no_index.png 1440w,\n/static/cf3cfd9d769e010b40df197d8f90b2a5/95e59/subs_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAUklEQVQI11WLXQ6AMAyCd6IlTl1/aO9/LMyaLOoDAfJBi0wCQQfKEUlEvCq2e37yf7v+S808qA6e10010BCcauWiXmyKVi8mVrstqU/yGIO9dz4pjkL2PzM53AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 후\"\n        title=\"복합 인덱스 설정 후\"\n        src=\"/static/219b4b8a0c225664a54f99441075114e/37523/subs_analyze_index.png\"\n        srcset=\"/static/219b4b8a0c225664a54f99441075114e/e9ff0/subs_analyze_index.png 180w,\n/static/219b4b8a0c225664a54f99441075114e/f21e7/subs_analyze_index.png 360w,\n/static/219b4b8a0c225664a54f99441075114e/37523/subs_analyze_index.png 720w,\n/static/219b4b8a0c225664a54f99441075114e/302a4/subs_analyze_index.png 1080w,\n/static/219b4b8a0c225664a54f99441075114e/07a9c/subs_analyze_index.png 1440w,\n/static/219b4b8a0c225664a54f99441075114e/95e59/subs_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>캡쳐는 시간 차이가 조굼 나는 걸로 찍혔지만, 여러번 수행했을 때 평균치는 차이가 없었다.\n채널이 500개나 있는 과장된 상황에서도 차이가 없는 것이라 적용하지 않기로 정했다.</p>\n<br>\n<p>나머지 한 메서드는 처음에는 추가 인덱스 설정이 필요하지 않을 것이라 생각했다.</p>\n<ul>\n<li>existsByChannelAndMember(Channel channel, Member member)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> channel_subscription<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">from</span> channel_subscription\n<span class=\"token keyword\">where</span> channel_subscription<span class=\"token punctuation\">.</span>channel_id <span class=\"token operator\">=</span> :channelId\n  <span class=\"token operator\">and</span> channel_subscription<span class=\"token punctuation\">.</span>member_id <span class=\"token operator\">=</span> :memberId\n<span class=\"token keyword\">limit</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">FK</code>인 <code class=\"language-text\">channel_id</code>와 <code class=\"language-text\">member_id</code>에 이미 각각 인덱스가 걸려있었기 때문이다.\n그래서 실행 계획을 보면, <code class=\"language-text\">type</code>이 <code class=\"language-text\">index_merge</code>로 나온다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAcklEQVQI1y2LWw7CMBADe6HyBelmH0kpJdAC4v6nmUqBj5Eljz3U+cr2+TIvN1QN88DcMfOeHoGa4VEopbKsjbbtrO3Jst557G/a9iJK7Z/hnCYkG+qFJJmsjqiTJvn1Ubkk6X6SzDiOf06IGtmi7zpqHKpbQ/8zpZW5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 전 실행계획\"\n        title=\"복합 인덱스 설정 전 실행계획\"\n        src=\"/static/0c50a3ac4e02025aa7ca1e5fee8b190b/37523/subs_channel_member_no_index.png\"\n        srcset=\"/static/0c50a3ac4e02025aa7ca1e5fee8b190b/e9ff0/subs_channel_member_no_index.png 180w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/f21e7/subs_channel_member_no_index.png 360w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/37523/subs_channel_member_no_index.png 720w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/302a4/subs_channel_member_no_index.png 1080w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/07a9c/subs_channel_member_no_index.png 1440w,\n/static/0c50a3ac4e02025aa7ca1e5fee8b190b/95e59/subs_channel_member_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>그런데 <code class=\"language-text\">index_merge</code>를 책에서 찾아보니 개선이 필요했다.\n아래는 해당 책의 설명이다.</p>\n<p><code class=\"language-text\">index_merge</code>는 2개 이상의 인덱스를 이용해 각각의 검색 결과를 만들어낸 후, 그 결과를 병합하는 처리 방식이며 다음과 같은 특징이 있다.</p>\n<ul>\n<li>여러 인덱스를 읽어야 하므로 일반적으로 <code class=\"language-text\">range</code> 접근 방식보다 효율성이 떨어진다</li>\n<li>AND와 OR 연산이 복잡하게 연결된 쿼리에서는 제대로 최적화되지 못할 때가 많다</li>\n<li>전문 검색 인덱스를 사용하는 쿼리에서는 <code class=\"language-text\">index_merge</code>가 적용되지 않는다</li>\n<li><code class=\"language-text\">index_merge</code> 접근 방식으로 처리된 결과는 항상 2개 이상의 집합이 되기 떄문에 그 두 집합의 교집합이나 합집합 또는 중복 제거와 같은 부가적인 작업이 더 필요하다</li>\n</ul>\n<p>현재 <code class=\"language-text\">Extra</code>에 표시된 <code class=\"language-text\">Using intersect...</code>는 각 처리 결과에서 교집합을 추출해내는 작업을 수행했다는 의미다.\n더 효율적인 수행을 위해 <code class=\"language-text\">channel_id</code>와 <code class=\"language-text\">member_id</code>로 복합 인덱스를 생성했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> subscription_channel_and_member <span class=\"token keyword\">on</span> channel_subscription <span class=\"token punctuation\">(</span>member_id<span class=\"token punctuation\">,</span> channel_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeUlEQVQI1yXLSxKCMBBFURYEhcU3pDskGj6aAnX/m7mWYfBG577Ch0A6P/hwx4og6hBRRBV1jr+/jjdx3XHeE5eVPR3ZwiOSzi9x2XK/PRNFXd+wOmOsMk7CJC7PTILMgX4Yabueqqooy5Kmaa/WWLphxNjr0/VD9h/G1kQHdvqeGgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 후 실행계획\"\n        title=\"복합 인덱스 설정 후 실행계획\"\n        src=\"/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/37523/subs_channel_member_index.png\"\n        srcset=\"/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/e9ff0/subs_channel_member_index.png 180w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/f21e7/subs_channel_member_index.png 360w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/37523/subs_channel_member_index.png 720w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/302a4/subs_channel_member_index.png 1080w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/07a9c/subs_channel_member_index.png 1440w,\n/static/353aa567f1b2dcfa8e9ab1d4fc86f37c/95e59/subs_channel_member_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>실행 계획에서 해당 인덱스를 사용함을 볼 수 있다.\n사진 상 실수로 이름을 잘못 설정했는데, <code class=\"language-text\">subscription_channel_and_member</code>가 맞다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAT0lEQVQI112LSwoAIQxDvZELdbRp69z/VBEVQVw8EvIJ3n8KlNCDXf7Nb54eexO+2gh15lIIc1YBG3QjoKhRYFTrazf90dmpd6aUGWNcnwEeM0MNkavd8QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 전 실행시간\"\n        title=\"복합 인덱스 설정 전 실행시간\"\n        src=\"/static/470210ea686d16f132bd85ea92134ab6/37523/subs_analyze_channel_member_no_index.png\"\n        srcset=\"/static/470210ea686d16f132bd85ea92134ab6/e9ff0/subs_analyze_channel_member_no_index.png 180w,\n/static/470210ea686d16f132bd85ea92134ab6/f21e7/subs_analyze_channel_member_no_index.png 360w,\n/static/470210ea686d16f132bd85ea92134ab6/37523/subs_analyze_channel_member_no_index.png 720w,\n/static/470210ea686d16f132bd85ea92134ab6/302a4/subs_analyze_channel_member_no_index.png 1080w,\n/static/470210ea686d16f132bd85ea92134ab6/07a9c/subs_analyze_channel_member_no_index.png 1440w,\n/static/470210ea686d16f132bd85ea92134ab6/95e59/subs_analyze_channel_member_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAUklEQVQI11WMUQqAMAxDd6EJKq5d2nn/W0VqHcyPR8hLaYEZzTzxxH38uvlIt/Q1ATD+xE1ROK8mvEQpHRQFwzXRN2fvNnL/iH26Wjfux0n4zQcmpkLwP/+25gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"복합 인덱스 설정 후 실행시간\"\n        title=\"복합 인덱스 설정 후 실행시간\"\n        src=\"/static/ec8b2dacd32c44f9da0581dfb211fe0e/37523/subs_anaylze_channel_member_index.png\"\n        srcset=\"/static/ec8b2dacd32c44f9da0581dfb211fe0e/e9ff0/subs_anaylze_channel_member_index.png 180w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/f21e7/subs_anaylze_channel_member_index.png 360w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/37523/subs_anaylze_channel_member_index.png 720w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/302a4/subs_anaylze_channel_member_index.png 1080w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/07a9c/subs_anaylze_channel_member_index.png 1440w,\n/static/ec8b2dacd32c44f9da0581dfb211fe0e/95e59/subs_anaylze_channel_member_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0.386ms</td>\n<td>0.015ms</td>\n</tr>\n</tbody>\n</table>\n<p>실행 시간은 약 0.386ms에서 0.015ms로 <strong>95%</strong> 가량 감소했다.</p>\n<h2 id=\"️bookmark--reminder\" style=\"position:relative;\"><a href=\"#%EF%B8%8Fbookmark--reminder\" aria-label=\"️bookmark  reminder permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⭐️Bookmark &#x26; ⏰Reminder</h2>\n<p>바로 위 사례와 비슷한 쿼리가 북마크와 리마인더에도 각각 존재한다.</p>\n<ul>\n<li>Optional<Bookmark> findByMessageIdAndMemberId(Long messageId, Long memberId)</li>\n<li>Optional<Reminder> findByMessageIdAndMemberId(Long messageId, Long memberId)</li>\n</ul>\n<p>북마크와 리마인더는 100만개의 메시지를 바탕으로 2000명의 멤버가 각각을 300개씩 등록한 것을 가정해, 각 60만개 더미데이터를 넣었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> bookmark\n<span class=\"token keyword\">where</span> message_id <span class=\"token operator\">=</span> :messageId <span class=\"token operator\">and</span> member_id <span class=\"token operator\">=</span> :memberId<span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeElEQVQI1zXKSwqDMAAAUc+jwU+tmsT8MMZatELvf5gpBrp4MIspfAgc15ewRPQ8MxuDtQ6lNVJKnPfs50VcN4x1xLSxHx+U0hhjSa93tqyJuCaKpmmZlEYbxzjJ7O627SjLkrpuuJ+qqrLu0TOMMrcQIvt3/xz4AY2zQqCZAk/yAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 실행계획\"\n        title=\"북마크 실행계획\"\n        src=\"/static/9828735c2d4adf1e8827d01c7d1e57ac/37523/bookmark_explain_no_index.png\"\n        srcset=\"/static/9828735c2d4adf1e8827d01c7d1e57ac/e9ff0/bookmark_explain_no_index.png 180w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/f21e7/bookmark_explain_no_index.png 360w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/37523/bookmark_explain_no_index.png 720w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/302a4/bookmark_explain_no_index.png 1080w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/07a9c/bookmark_explain_no_index.png 1440w,\n/static/9828735c2d4adf1e8827d01c7d1e57ac/95e59/bookmark_explain_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>아까와 달리 <code class=\"language-text\">Extra</code> 필드에 <code class=\"language-text\">Using where</code>가 표기된다.\n<code class=\"language-text\">Using where</code>은 스토리지 엔진으로부터 받은 레코드를 MySQL 엔진 레이어에서 별도의 가공을 통해 필터링 작업을 거쳤음을 나타낸다.\n또, <code class=\"language-text\">filtered</code> 필드에 <code class=\"language-text\">5</code>가 적혀있다.\n이는 스토리지 엔진으로부터 100건의 레코드를 받아 95건을 걸러내고 5건만 남았다는 의미다.\n결국 조회된 데이터 중 <strong>95%</strong> 를 버린 것이다.<br>\n이번에는 <code class=\"language-text\">index_merge</code>를 쓰지 않았는데, 데이터 양의 차이로 추측된다.\n현재 더미데이터는 계산 시 각 메시지에 평균 1건 이하의 북마크가 등록되어 있다.\n보통 중요한 메시지에 북마크 생성이 치중될 것을 생각하면, 실제 상황과 조금 괴리가 있는 데이터 셋업이다.\n운영 데이터가 더 쌓이면 이를 분석해서 더 적절한 실험 상황으로 개선해야 할 것 같다.</p>\n<p>어쨌든 <code class=\"language-text\">message_id</code>와 <code class=\"language-text\">member_id</code>로 복합 인덱스 설정 시, 해당 인덱스를 이용하며 속도도 개선된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> bookmark_message_and_member <span class=\"token keyword\">on</span> bookmark <span class=\"token punctuation\">(</span>message_id<span class=\"token punctuation\">,</span> member_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeElEQVQI1x2MWw6DIBQF3Y9iTVpb4F6oVST46v53M035OJmcTDKNqFKOi7XseBFEAyJaqSGQy07eDqZ5IcTIdn6ZPgsiwpxy9SkX5rRS9pOmbVusVzROvJxHwrvSa8R64f4YuQ0DXWcwxmCdVD8+bf3/9X1fG04CP8kFQ+ag0cbwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 실행계획\"\n        title=\"북마크 복합 인덱스 실행계획\"\n        src=\"/static/ff564d0002316fb7eedcfe35d3c91f38/37523/bookmark_explain_index.png\"\n        srcset=\"/static/ff564d0002316fb7eedcfe35d3c91f38/e9ff0/bookmark_explain_index.png 180w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/f21e7/bookmark_explain_index.png 360w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/37523/bookmark_explain_index.png 720w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/302a4/bookmark_explain_index.png 1080w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/07a9c/bookmark_explain_index.png 1440w,\n/static/ff564d0002316fb7eedcfe35d3c91f38/95e59/bookmark_explain_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAUklEQVQI10WL2w3AMAjEslOT8Dq6/1ZXQVTlw0IYMwIg8m0CSY8gMln+3PKC6/+/u59mmIPqoEVSLfjMSTHnXMK1pZ2ot6u51Q6itEA31Zar9gM1akMSQztJnwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 기본 수행시간\"\n        title=\"북마크 기본 수행시간\"\n        src=\"/static/8cfef3b0b61fbad1d50c84620e2e806f/37523/bookmark_analyze_no_index.png\"\n        srcset=\"/static/8cfef3b0b61fbad1d50c84620e2e806f/e9ff0/bookmark_analyze_no_index.png 180w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/f21e7/bookmark_analyze_no_index.png 360w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/37523/bookmark_analyze_no_index.png 720w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/302a4/bookmark_analyze_no_index.png 1080w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/07a9c/bookmark_analyze_no_index.png 1440w,\n/static/8cfef3b0b61fbad1d50c84620e2e806f/95e59/bookmark_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXUlEQVQI102LSQ6AMAwDeRFJoUmbluX/rxoEiOVgWR7bg2hiFEVEGUUQVTRNN9OPnf7Xs3+znvvE0JYN80JtCyU6JRp93cnmRF/vLjqz+cXMK9kKXoM5O17bxZ/vAcReP/hJx9DSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 수행시간\"\n        title=\"북마크 복합 인덱스 수행시간\"\n        src=\"/static/c051125079ad15a29c01454795e6bc41/37523/bookmark_analyze_index.png\"\n        srcset=\"/static/c051125079ad15a29c01454795e6bc41/e9ff0/bookmark_analyze_index.png 180w,\n/static/c051125079ad15a29c01454795e6bc41/f21e7/bookmark_analyze_index.png 360w,\n/static/c051125079ad15a29c01454795e6bc41/37523/bookmark_analyze_index.png 720w,\n/static/c051125079ad15a29c01454795e6bc41/302a4/bookmark_analyze_index.png 1080w,\n/static/c051125079ad15a29c01454795e6bc41/07a9c/bookmark_analyze_index.png 1440w,\n/static/c051125079ad15a29c01454795e6bc41/95e59/bookmark_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0.161ms</td>\n<td>0.041ms</td>\n</tr>\n</tbody>\n</table>\n<p>더미데이터와 달리 한 메시지에 북마크가 몰리는 상황을 생각하면, 복합 인덱스 설정 시 조금 더 큰폭으로 효율이 개선될 것 같다.</p>\n<p>리마인더도 완전히 동일한 포맷의 sql문을 사용중이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> reminder\n<span class=\"token keyword\">where</span> message_id <span class=\"token operator\">=</span> :messageId <span class=\"token operator\">and</span> member_id <span class=\"token operator\">=</span> :memberId<span class=\"token punctuation\">;</span> </code></pre></div>\n<p>복합 인덱스 설정 전/후에 북마크와 동일한 설정의 실행계획이 나오는 것을 확인했고, 실행시간을 비교해보았다.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>북마크</th>\n<th>리마인더</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>복합 인덱스 설정 전</td>\n<td>0.161ms</td>\n<td>0.023ms</td>\n</tr>\n<tr>\n<td>복합 인덱스 설정 후</td>\n<td>0.041ms</td>\n<td>0.017ms</td>\n</tr>\n</tbody>\n</table>\n<p>북마크 수행 시간이 더 극적으로 차이나는 것은…\n북마크를 테스트하고 맥북이 좀 느려졌길래 재부팅을 한번 해서 그런 것 같다 🙃</p>\n<p><code class=\"language-text\">Querydsl</code>을 제외하고 남은 마지막 쿼리는 리마인더 발송을 위해 10분마다 실행되는 쿼리다.</p>\n<ul>\n<li>findAllByRemindDate(LocalDateTime remindDate)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> reminder\n<span class=\"token keyword\">where</span> remind_date <span class=\"token operator\">=</span> <span class=\"token string\">'2022-10-03 00:10:30'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">#이해를 돕기 위해 아무 시각이나 넣었다 </span></code></pre></div>\n<p>예상 가능한 부분이지만 사용할 수 있는 인덱스가 없어서 <strong>풀 테이블 스캔</strong>이 일어나고 있다.\n시간도 앞선 쿼리들에 비하면 아주 길다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAd0lEQVQI1x2KXQ6DIBjAvBCfDzpgAwTnD+Kcu/9pusBD06RpF8LEXk6c98SUKNePLZ+subDlgnOeZds5Pl9imlnz0fq6H8zvhXLd7Q1TJJ8XnYig7ZNqpRRaa4ZhQInQ931rFWNf+CkhUpu0XxuLC7HxMJZxHPkD4T5D4W1pOxUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"리마인더 실행계획\"\n        title=\"리마인더 실행계획\"\n        src=\"/static/33afadc187330a6b1211d0e9f8621881/37523/reminder_no_index.png\"\n        srcset=\"/static/33afadc187330a6b1211d0e9f8621881/e9ff0/reminder_no_index.png 180w,\n/static/33afadc187330a6b1211d0e9f8621881/f21e7/reminder_no_index.png 360w,\n/static/33afadc187330a6b1211d0e9f8621881/37523/reminder_no_index.png 720w,\n/static/33afadc187330a6b1211d0e9f8621881/302a4/reminder_no_index.png 1080w,\n/static/33afadc187330a6b1211d0e9f8621881/07a9c/reminder_no_index.png 1440w,\n/static/33afadc187330a6b1211d0e9f8621881/95e59/reminder_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAWUlEQVQI102LWQrAIBBDPVKVOlvG3v9WKQ4V+vFIyNKQSffg1lxPASQzVxFAdSc7vvTH7jyCTS149UExp2Mx8uFUowVokbyncm+mKM1B+fzORK1+ol7b3gdfIk9C1zN7twgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"리마인더 수행시간\"\n        title=\"리마인더 수행시간\"\n        src=\"/static/f9674b1a18e7d4ee6c48b1fba93b90ad/37523/reminder_analyze_no_index.png\"\n        srcset=\"/static/f9674b1a18e7d4ee6c48b1fba93b90ad/e9ff0/reminder_analyze_no_index.png 180w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/f21e7/reminder_analyze_no_index.png 360w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/37523/reminder_analyze_no_index.png 720w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/302a4/reminder_analyze_no_index.png 1080w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/07a9c/reminder_analyze_no_index.png 1440w,\n/static/f9674b1a18e7d4ee6c48b1fba93b90ad/95e59/reminder_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code class=\"language-text\">remind_date</code>에 인덱스를 설정했다.\n정상적으로 해당 인덱스를 이용하고, 실행시간도 1/1000 이하로 줄어들었다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeklEQVQI1x2LSxKDIBQEPZAipoJBHv5QAY3J/W/TqbCYRU/PVDFfeD9y3l/2mHFOWNZAfn8Kj9PMdiTSeeNE2I5Ium7mNbDHxJGvsgvbXvqq6x7UdY11HpkWrBPMy6J1h2rb4p7GYAehaZqS/2dcAkqpwq3WDOIxfc8P8IdD7sDooZwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"리마인더 인덱스 실행계획\"\n        title=\"리마인더 인덱스 실행계획\"\n        src=\"/static/30330ca05bd0eabdf60e8bf01b1d468a/37523/remider_explain_index.png\"\n        srcset=\"/static/30330ca05bd0eabdf60e8bf01b1d468a/e9ff0/remider_explain_index.png 180w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/f21e7/remider_explain_index.png 360w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/37523/remider_explain_index.png 720w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/302a4/remider_explain_index.png 1080w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/07a9c/remider_explain_index.png 1440w,\n/static/30330ca05bd0eabdf60e8bf01b1d468a/95e59/remider_explain_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 5.555555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAQUlEQVQI1yXLwRWAMAjAUFeyQKFAdf+p4lNv+Yccfd2sarI2HonNILLwVUwPzF835xCGKGqOTkfU/jb/nqFG9uYBJT8g4PFfUq0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"리마인더 인덱스 수행시간\"\n        title=\"리마인더 인덱스 수행시간\"\n        src=\"/static/4afb3decc1f56222258deacaf80128bc/37523/reminder_analyze_index.png\"\n        srcset=\"/static/4afb3decc1f56222258deacaf80128bc/e9ff0/reminder_analyze_index.png 180w,\n/static/4afb3decc1f56222258deacaf80128bc/f21e7/reminder_analyze_index.png 360w,\n/static/4afb3decc1f56222258deacaf80128bc/37523/reminder_analyze_index.png 720w,\n/static/4afb3decc1f56222258deacaf80128bc/302a4/reminder_analyze_index.png 1080w,\n/static/4afb3decc1f56222258deacaf80128bc/07a9c/reminder_analyze_index.png 1440w,\n/static/4afb3decc1f56222258deacaf80128bc/95e59/reminder_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>remind_date 인덱스 X</th>\n<th>remind_date 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>554ms</td>\n<td>0.139ms</td>\n</tr>\n</tbody>\n</table>\n<br>\n<h2 id=\"️-querydsl을-이용한-복잡한-쿼리들\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-querydsl%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B3%B5%EC%9E%A1%ED%95%9C-%EC%BF%BC%EB%A6%AC%EB%93%A4\" aria-label=\"️ querydsl을 이용한 복잡한 쿼리들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✉️ Querydsl을 이용한 복잡한 쿼리들</h2>\n<p>이제 글 초반에 적었던 체크리스트에서 세 쿼리만 남았다!</p>\n<ul>\n<li>Message의 Querydsl을 이용한 복잡한 조회쿼리</li>\n<li>Bookmark의 Querydsl을 이용한 복잡한 조회쿼리</li>\n<li>Reminder의 Querydsl을 이용한 복잡한 조회쿼리</li>\n</ul>\n<p>메시지부터 보자면 동적으로 조건이 변화하지만, 결국 아래 네 가지로 수렴한다.</p>\n<ul>\n<li>특정 한 채널에서 최신으로부터 n개를 작성시간 내림차순 조회</li>\n<li>특정 한 채널에서 특정 시각을 기준으로 작성시간이 과거/미래인 n개를 작성시간 내림차순 조회 (페이지네이션 대체)</li>\n<li>특정 한 채널에서 특정 시각을 기준으로 작성시간이 과거/미래인 메시지가 존재하는지 조회 (페이지네이션 대체)</li>\n<li>특정 여러 채널에서 특정 키워드를 포함한 메시지를 특정 시간 기준으로 n개를 작성시간 내림차순 조회</li>\n</ul>\n<p>여기서 1,2,3번 쿼리는 <code class=\"language-text\">특정 여러 채널</code> 조건으로 실행할 수도 있게 코드가 짜여있다.\n하지만 처음 구상과 달리 현재 서비스에서 사용하고 있지 않기에, <code class=\"language-text\">특정 한 채널</code>로만 진행했다.\n키워드 검색은 <code class=\"language-text\">like %keyword%</code> 방식이라 인덱스를 적용할 수 없어 제외했다.\n결국 나머지 셋의 공통점을 보자면 <code class=\"language-text\">채널, 쟉셩시간</code> 조건으로 조회하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> \n    message<span class=\"token punctuation\">.</span>id            <span class=\"token keyword\">as</span> message_id<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>member_id     <span class=\"token keyword\">as</span> member_id<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>username       <span class=\"token keyword\">as</span> username<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>thumbnail_url  <span class=\"token keyword\">as</span> thumbnail<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span><span class=\"token keyword\">text</span>          <span class=\"token keyword\">as</span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>posted_date   <span class=\"token keyword\">as</span> posted_date<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>modified_date <span class=\"token keyword\">as</span> modified_date<span class=\"token punctuation\">,</span>\n    bookmark<span class=\"token punctuation\">.</span>id           <span class=\"token keyword\">as</span> bookmark_id<span class=\"token punctuation\">,</span>\n    reminder<span class=\"token punctuation\">.</span>id           <span class=\"token keyword\">as</span> reminder_id<span class=\"token punctuation\">,</span>\n    reminder<span class=\"token punctuation\">.</span>remind_date  <span class=\"token keyword\">as</span> remind_date\n<span class=\"token keyword\">from</span>\n    message\n    <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n        member <span class=\"token keyword\">on</span> message<span class=\"token punctuation\">.</span>member_id <span class=\"token operator\">=</span> member<span class=\"token punctuation\">.</span>id\n    <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n        bookmark\n        <span class=\"token keyword\">on</span> <span class=\"token punctuation\">(</span>bookmark<span class=\"token punctuation\">.</span>member_id <span class=\"token operator\">=</span> :memberId\n              <span class=\"token operator\">and</span> bookmark<span class=\"token punctuation\">.</span>message_id <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span>id\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n        reminder\n        <span class=\"token keyword\">on</span> <span class=\"token punctuation\">(</span>reminder<span class=\"token punctuation\">.</span>member_id <span class=\"token operator\">=</span> :memberId\n              <span class=\"token operator\">and</span> reminder<span class=\"token punctuation\">.</span>message_id <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span>id\n              <span class=\"token operator\">and</span> reminder<span class=\"token punctuation\">.</span>remind_date <span class=\"token operator\">></span> :remindDate\n        <span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">where</span>\n    message<span class=\"token punctuation\">.</span>channel_id <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span>:channelId<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span><span class=\"token keyword\">text</span> <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">and</span> length<span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span><span class=\"token keyword\">text</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;></span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>\n    message<span class=\"token punctuation\">.</span>posted_date <span class=\"token keyword\">desc</span>\n<span class=\"token keyword\">limit</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>참고로 <code class=\"language-text\">channel_id</code>는 위에서 말했듯 복수의 값이 들어올 수도 있어서, 하나라도 <code class=\"language-text\">in()</code> 형태로 조회한다.\n여기서 결국 중요한 건 <code class=\"language-text\">where</code>안의 <code class=\"language-text\">channel_id</code>와 <code class=\"language-text\">order by</code>의 <code class=\"language-text\">posted_date</code>이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAoklEQVQI1y2La66CMBhEWY4a8Aqtpf1o6RON+1/QuaH64ySTMzNDe3/wYSe3g7BHSjuIqeCc4ES6OzchJpxsyOY7uTZ8iCil0FqjtcIYw7Cnyt9jRmnDdL+zOmHPjUVplH4yLwtmtb+sOo/561Yr6OeKsa7/zm6orw/GCmZ1jNPEFiKnC7EQUu3jkAo+ZsZx5Ha7cr1csOKJ5SDVF7m9O048/5TZZFWfVb69AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 전\"\n        title=\"메시지 복합 인덱스 추가 전\"\n        src=\"/static/526249afe0f3ea91e120bdd4e4dcd11e/37523/message_explain_no_index.png\"\n        srcset=\"/static/526249afe0f3ea91e120bdd4e4dcd11e/e9ff0/message_explain_no_index.png 180w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/f21e7/message_explain_no_index.png 360w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/37523/message_explain_no_index.png 720w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/302a4/message_explain_no_index.png 1080w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/07a9c/message_explain_no_index.png 1440w,\n/static/526249afe0f3ea91e120bdd4e4dcd11e/95e59/message_explain_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>실행계획을 보면, 제일 먼저 적용되는 <code class=\"language-text\">channel_id</code> 외래키 인덱스의 <code class=\"language-text\">Extra</code>에 <code class=\"language-text\">Using filesort</code>가 보인다.\n이는 <code class=\"language-text\">channel</code> 기준으로 조회한 레코드를 엔진에서 <code class=\"language-text\">posted_date</code>로 다시 정렬하고 있기 때문이다.\n따라서 <code class=\"language-text\">channel_id</code>와 <code class=\"language-text\">posted_date</code>로 복합 인덱스를 걸어준다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAnklEQVQI1yWMUQ6DIBBEPY4oKCgIywJimzb96P2vM43bj5dsZt/M0PoDuVRQzuBSEVPCeT1BmZEoIxHJXVtH65d4mYtkArP0bi+EgKE/3wiRYN0GHyK0MXh9vsilwR8RkRhOfge4NOw+wDonrNbBbTuMMVDjiHmeMRAXHIlg7V8wZgFxFe68tC6FbffgesqwUiOmaYJSSvxlXWVMa40f7fZhqEP7nI0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 후\"\n        title=\"메시지 복합 인덱스 추가 후\"\n        src=\"/static/5ee440445c195369d3fad1d32aa6b18a/37523/message_explain_index.png\"\n        srcset=\"/static/5ee440445c195369d3fad1d32aa6b18a/e9ff0/message_explain_index.png 180w,\n/static/5ee440445c195369d3fad1d32aa6b18a/f21e7/message_explain_index.png 360w,\n/static/5ee440445c195369d3fad1d32aa6b18a/37523/message_explain_index.png 720w,\n/static/5ee440445c195369d3fad1d32aa6b18a/302a4/message_explain_index.png 1080w,\n/static/5ee440445c195369d3fad1d32aa6b18a/07a9c/message_explain_index.png 1440w,\n/static/5ee440445c195369d3fad1d32aa6b18a/95e59/message_explain_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>해당 복합 인덱스를 사용함과 실행시간이 줄어듬을 확인할 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXElEQVQI12WLSQqAMBRDPZBD+7V/qNWFiPe/UcQIblw8MpB0x3lhbdtH2/YfT59lJikLkgiVWV6dUiadWsCiYikKNYfXxmwe9OpBX9RQzLl7mIuy488D4zihHwbcvxdBegme1I8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 전\"\n        title=\"메시지 복합 인덱스 추가 전\"\n        src=\"/static/dc9141a4838919dda5d2589ded95bd44/37523/message_analyze_no_index.png\"\n        srcset=\"/static/dc9141a4838919dda5d2589ded95bd44/e9ff0/message_analyze_no_index.png 180w,\n/static/dc9141a4838919dda5d2589ded95bd44/f21e7/message_analyze_no_index.png 360w,\n/static/dc9141a4838919dda5d2589ded95bd44/37523/message_analyze_no_index.png 720w,\n/static/dc9141a4838919dda5d2589ded95bd44/302a4/message_analyze_no_index.png 1080w,\n/static/dc9141a4838919dda5d2589ded95bd44/07a9c/message_analyze_no_index.png 1440w,\n/static/dc9141a4838919dda5d2589ded95bd44/95e59/message_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXUlEQVQI11XISQqAMBBEUe+ThRm7O51BEPH+NypJhIiLR1F/O68bpbal9gO19Z+sBdb5xfmwWP+23dr5N+IMzoqYCMQCLQ0sCpIM0Tp3SCTwIU6J+MOjBxhjEBPjAbvNQXWMYNBDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 후\"\n        title=\"메시지 복합 인덱스 추가 후\"\n        src=\"/static/4a0e76d36dc54ffc27da97f7d0330a32/37523/message_analyze_index.png\"\n        srcset=\"/static/4a0e76d36dc54ffc27da97f7d0330a32/e9ff0/message_analyze_index.png 180w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/f21e7/message_analyze_index.png 360w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/37523/message_analyze_index.png 720w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/302a4/message_analyze_index.png 1080w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/07a9c/message_analyze_index.png 1440w,\n/static/4a0e76d36dc54ffc27da97f7d0330a32/95e59/message_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>여기서 보면 거의 처음으로  <code class=\"language-text\">actual time</code>값이 <code class=\"language-text\">...</code>을 두고 유의미하게 서로 다른 값이 표시됐다.\n이는 <code class=\"language-text\">첫 레코드를 읽은 시간...마지막 레코드를 읽은 시간</code>이라는 뜻이다.</p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>425…433ms</td>\n<td>4.1…24.6ms</td>\n</tr>\n</tbody>\n</table>\n<p>마지막 레코드를 읽은 시간 기준으로 거의 <strong>95%</strong> 감소했다.\n키워드 검색의 경우도 <code class=\"language-text\">like</code> 부분을 제외하면 동일한 검색조건이라, 시간이 줄어듬을 확인할 수 있었다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAYElEQVQI13WLSwqAMBBDe59itbXzqe3oTgTvf54Io1sXIY9HEs7rxrAdfRh6H87D7OvX235grYQll9/MS8aUEkIlBktDZUFZK7R1sKg7aZszicJ32kAsviWPfqz+jTHiAbxEQWfwjW2uAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 전\"\n        title=\"메시지 복합 인덱스 추가 전\"\n        src=\"/static/a0f4299e7c72890c79ade4faedbdb30d/37523/message_keyword_analyze_no_index.png\"\n        srcset=\"/static/a0f4299e7c72890c79ade4faedbdb30d/e9ff0/message_keyword_analyze_no_index.png 180w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/f21e7/message_keyword_analyze_no_index.png 360w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/37523/message_keyword_analyze_no_index.png 720w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/302a4/message_keyword_analyze_no_index.png 1080w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/07a9c/message_keyword_analyze_no_index.png 1440w,\n/static/a0f4299e7c72890c79ade4faedbdb30d/95e59/message_keyword_analyze_no_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAa0lEQVQI112MSQ4DMQgE50OTWQzGGLBzixQp/39ORya3HEql6kNvr/cHMZ8wD/iY8BjJ6kVfewwQV1x3wVXozyV93j9vFhOiHU0NxIxuAe0OaZpnTTvUPA+5CogFhTibVlcB14bjOLHvD3wB59pB4nu3tX0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"메시지 복합 인덱스 추가 후\"\n        title=\"메시지 복합 인덱스 추가 후\"\n        src=\"/static/b6d48655f45f28424856fab49b52230d/37523/message_keyword_analyze_index.png\"\n        srcset=\"/static/b6d48655f45f28424856fab49b52230d/e9ff0/message_keyword_analyze_index.png 180w,\n/static/b6d48655f45f28424856fab49b52230d/f21e7/message_keyword_analyze_index.png 360w,\n/static/b6d48655f45f28424856fab49b52230d/37523/message_keyword_analyze_index.png 720w,\n/static/b6d48655f45f28424856fab49b52230d/302a4/message_keyword_analyze_index.png 1080w,\n/static/b6d48655f45f28424856fab49b52230d/07a9c/message_keyword_analyze_index.png 1440w,\n/static/b6d48655f45f28424856fab49b52230d/95e59/message_keyword_analyze_index.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>502…628ms</td>\n<td>19…263ms</td>\n</tr>\n</tbody>\n</table>\n<br>\n<p>북마크 조회는 메시지보다 간단하다.\n메시지는 특정 날짜로 이동해서 앞/뒤 어디든 볼 수 있게 해야했는데, 북마크는 무조건 <code class=\"language-text\">create_date</code>를 최신 또는 특정 시간부터 역순으로 조회한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span>\n    bookmark<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">as</span> bookmark_id<span class=\"token punctuation\">,</span>\n    bookmark<span class=\"token punctuation\">.</span>created_date <span class=\"token keyword\">as</span> created_date<span class=\"token punctuation\">,</span>\n    bookmark<span class=\"token punctuation\">.</span>member_id <span class=\"token keyword\">as</span> member_id<span class=\"token punctuation\">,</span>\n    bookmark<span class=\"token punctuation\">.</span>message_id <span class=\"token keyword\">as</span> message_id<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>channel_id <span class=\"token keyword\">as</span> channel_id<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>modified_date <span class=\"token keyword\">as</span> modified_date<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>posted_date <span class=\"token keyword\">as</span> posted_date<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span>slack_message_id <span class=\"token keyword\">as</span> message_slack_id<span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">.</span><span class=\"token keyword\">text</span> <span class=\"token keyword\">as</span> message_text<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>first_login <span class=\"token keyword\">as</span> member_first_login<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>slack_id <span class=\"token keyword\">as</span> member_slack_id<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>thumbnail_url <span class=\"token keyword\">as</span> member_thumbnail_url<span class=\"token punctuation\">,</span>\n    member<span class=\"token punctuation\">.</span>username <span class=\"token keyword\">as</span> member_username\n<span class=\"token keyword\">from</span>\n    bookmark\n        <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n    message <span class=\"token keyword\">on</span> bookmark<span class=\"token punctuation\">.</span>message_id<span class=\"token operator\">=</span>message<span class=\"token punctuation\">.</span>id\n        <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n    member <span class=\"token keyword\">on</span> bookmark<span class=\"token punctuation\">.</span>member_id<span class=\"token operator\">=</span>member<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">where</span>\n        bookmark<span class=\"token punctuation\">.</span>member_id<span class=\"token operator\">=</span>:memberId\n        <span class=\"token operator\">and</span> bookmark<span class=\"token punctuation\">.</span>created_date <span class=\"token operator\">&lt;</span> :createdDate\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>\n    bookmark<span class=\"token punctuation\">.</span>created_date <span class=\"token keyword\">desc</span> \n<span class=\"token keyword\">limit</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>차이점이 있다면 메시지와 달리 북마크는 개인이 소유한 북마크만 보여주기에, <code class=\"language-text\">member_id</code> 일치 조건이 항상 걸려있다는 것이다.\n이쯤 되니 <code class=\"language-text\">member_id</code> FK 인덱스를 사용하고 있을 것이며, <code class=\"language-text\">Using filesort</code>가 표기될 것이 짐작간다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.333333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAApUlEQVQI1yWN25KDIBBE/R1QsIIXEJQQb2uy+/+/c1LOPnRN9Zyu7uq4PqR5Yf95s+Qn5bWxnZf8Yprl5lJYj5N1P3mWF+f7j7JuxJhIaZbckjN3V1XWA2tb/JSw1tKPnv36JcRE1w/4KWKMQWvFw3XMucjI6AP9MIoGH3BdL6waQ6Su6//CtsW5jlw2mqZBKYVWSvitxhgZcM6Jv5nWWnK3D1PiC/lxYtcvmOgZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 적용 전\"\n        title=\"북마크 복합 인덱스 적용 전\"\n        src=\"/static/ee57f7956bae015ec87cbe43f1351057/37523/bookmark_explain_no_index2.png\"\n        srcset=\"/static/ee57f7956bae015ec87cbe43f1351057/e9ff0/bookmark_explain_no_index2.png 180w,\n/static/ee57f7956bae015ec87cbe43f1351057/f21e7/bookmark_explain_no_index2.png 360w,\n/static/ee57f7956bae015ec87cbe43f1351057/37523/bookmark_explain_no_index2.png 720w,\n/static/ee57f7956bae015ec87cbe43f1351057/302a4/bookmark_explain_no_index2.png 1080w,\n/static/ee57f7956bae015ec87cbe43f1351057/07a9c/bookmark_explain_no_index2.png 1440w,\n/static/ee57f7956bae015ec87cbe43f1351057/95e59/bookmark_explain_no_index2.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>예상이 맞았다.\n추가 정렬과 읽었지만 버려지는 레코드를 없앨 수 있도록 복합 인덱스를 걸어주자.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> bookmark_member_and_created_date <span class=\"token keyword\">on</span> bookmark <span class=\"token punctuation\">(</span>member_id<span class=\"token punctuation\">,</span> created_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.333333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmElEQVQI1z2MaxKDIBCDvQ44WLXycgFR1Gq9/3nSEbU/MpvNfEmxbF8QOaz7AR8GxCkhrRvIOZDz6Mn9vfMB0/LBmGbEMWH+7Pl/mPMWcVogqgouRLzqBkobzNsBbQlSG3RSQSoNZSzqpkVZluCcg/wA8gHa2Iu52UJpmyFt+jzcvjv4mHLGGMtlzln2Z/YoD3QSQoibu9gf3upiem4ynaoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 적용 후\"\n        title=\"북마크 복합 인덱스 적용 후\"\n        src=\"/static/3c203afa6cca2fb45105ffd697f66327/37523/bookmark_explain_index2.png\"\n        srcset=\"/static/3c203afa6cca2fb45105ffd697f66327/e9ff0/bookmark_explain_index2.png 180w,\n/static/3c203afa6cca2fb45105ffd697f66327/f21e7/bookmark_explain_index2.png 360w,\n/static/3c203afa6cca2fb45105ffd697f66327/37523/bookmark_explain_index2.png 720w,\n/static/3c203afa6cca2fb45105ffd697f66327/302a4/bookmark_explain_index2.png 1080w,\n/static/3c203afa6cca2fb45105ffd697f66327/07a9c/bookmark_explain_index2.png 1440w,\n/static/3c203afa6cca2fb45105ffd697f66327/95e59/bookmark_explain_index2.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAT0lEQVQI12WJSQ6AMAwD+yF6gTaLE/j/q4ygohJwGGk8Lg7wAYgf4/tuvHziYHEk161RDfTYKeY0j+lXvxuS6mAXo+johmBXI/Jg68KlVp4d70L2vv6A8wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 적용 전\"\n        title=\"북마크 복합 인덱스 적용 전\"\n        src=\"/static/c9e220c3f8257d251cc32bbe969cc6fa/37523/bookmark_analyze_no_index2.png\"\n        srcset=\"/static/c9e220c3f8257d251cc32bbe969cc6fa/e9ff0/bookmark_analyze_no_index2.png 180w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/f21e7/bookmark_analyze_no_index2.png 360w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/37523/bookmark_analyze_no_index2.png 720w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/302a4/bookmark_analyze_no_index2.png 1080w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/07a9c/bookmark_analyze_no_index2.png 1440w,\n/static/c9e220c3f8257d251cc32bbe969cc6fa/95e59/bookmark_analyze_no_index2.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.777777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAVElEQVQI13WKSw7AIBBCPZErPzMw2t7/UjTV1F0XLwQeyQGBFMCVZOy+iLOfTv4DKhlCjlApVYghZ8hAxbz1uW4ujmv/alMzlznEMdf2utq6cs56ABinQv+A/1mlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"북마크 복합 인덱스 적용 후\"\n        title=\"북마크 복합 인덱스 적용 후\"\n        src=\"/static/43b3bf753be7018e44d6d744454c6ef3/37523/bookmark_analyze_index2.png\"\n        srcset=\"/static/43b3bf753be7018e44d6d744454c6ef3/e9ff0/bookmark_analyze_index2.png 180w,\n/static/43b3bf753be7018e44d6d744454c6ef3/f21e7/bookmark_analyze_index2.png 360w,\n/static/43b3bf753be7018e44d6d744454c6ef3/37523/bookmark_analyze_index2.png 720w,\n/static/43b3bf753be7018e44d6d744454c6ef3/302a4/bookmark_analyze_index2.png 1080w,\n/static/43b3bf753be7018e44d6d744454c6ef3/07a9c/bookmark_analyze_index2.png 1440w,\n/static/43b3bf753be7018e44d6d744454c6ef3/95e59/bookmark_analyze_index2.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>의도한 인덱스를 타고, 실행시간이 줄어들었다.</p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>11.9…12.2ms</td>\n<td>6.7…7.2ms</td>\n</tr>\n</tbody>\n</table>\n<p>더미데이터는 한 멤버당 300개의 북마크 데이터를 넣었다.\n북마크 데이터 수가 늘어난다면, 실행시간의 차이도 더 커질 것이다.</p>\n<br>\n<p>마지막으로 리마인더는!\n북마크와 조건이 똑같다.\n멤버와 <code class=\"language-text\">remind_date</code>라는 알람 지정 시각을 기준으로 조회한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">where</span>\n    reminder<span class=\"token punctuation\">.</span>member_id<span class=\"token operator\">=</span>:memberId\n    <span class=\"token operator\">and</span> reminder<span class=\"token punctuation\">.</span>remind_date <span class=\"token operator\">&lt;</span> :remindDate\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>\n    reminder<span class=\"token punctuation\">.</span>remind_date <span class=\"token keyword\">desc</span> </code></pre></div>\n<p><code class=\"language-text\">member_id</code> FK 인덱스를 사용하고 <code class=\"language-text\">Using filesort</code> 표기까지 다~ 똑같았다.\n그래서 <code class=\"language-text\">member_id, remind_date</code>로 걸어줬고, 실행시간 차이만 적고 마치겠다.</p>\n<table>\n<thead>\n<tr>\n<th>복합 인덱스 X</th>\n<th>복합 인덱스 O</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>15.8…19.2ms</td>\n<td>3.4…8.0ms</td>\n</tr>\n</tbody>\n</table>\n<p>차이점이 있다면 리마인더는 알람을 발송하면 바로바로 데이터를 지우기 때문에, 실상황에서 효율은 더 낮지 않을까 싶은 점이다.</p>\n<br>\n<h2 id=\"finally\" style=\"position:relative;\"><a href=\"#finally\" aria-label=\"finally permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>finally</h2>\n<p>그래서 줍줍에는 추가로 이런 인덱스가 걸리게 되었다!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACM0lEQVQoz1WSS2/aQBSFvU6FZ8YvsDGYVwghGEMDtgMhpgpppbyQmiitFCmt+pBStYtuuuiv/6pxmkpdzOKee8/RPeeOYVkW+gkhqFQqSCl5xqRUKKVI4pg8y6hWq//1lbIwTbPkPmOGJphC0O12ybKMKIpKksYD38PzXDqtFuM4xvf9f4KmMPFqHmmeEidjpPXEMVzXwXMdWs0m02RcCuqGEJK93TZ5nlEPQ+ZpymKxwPM8pJI0/IBABYx6I+J+TGAFOJaD4ddcloucWs1nPB5TFAVBEJQ2vGqVs7MzBoNBKbZarbBtG6EkrxZbLt5+Y1bccXr1mf78mn5jiuHYNs1moxx0XZcwDP/mo0pM19qm3kzXSkqkUvRmK4q7j+xvrphd3DLcXOO2+hjamt5OZ6jtttttAj8oBfVRdOhR1KTT6eA4TolbykIoQUWaSMdC2hbCVkhLYTiuTdRq0O31KNYFySTBq3oIKQn8KqYp2B8MKYo1juOV2ZYOhIldqXCcpsyTBPViB0sKjNDxeT/bsu4tOY83nLSPiM09atLjcBrx7uaYZd5le5mSz5sMB0+i04OMg/iU0WRDvtxSb2fU/V0MW9qsx8csRzlH+ynZ3oyu3cK1bGYv6/z8fsGH+xWfHtY8fjklPQzZqQjO31zz4/cvrh7uuX/8yvr2hng4w1CWwpRmeTn9HXQOyraoaKt7EcVJRqcdcrLKuLx8TSuqYQpJqxcwmXQ5iNskSY9R0qEWevwB3V8ZV7EnE74AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"줍줍 추가 인덱스\"\n        title=\"줍줍 추가 인덱스\"\n        src=\"/static/1d3da01279e1099504af950bde40a98a/37523/final.png\"\n        srcset=\"/static/1d3da01279e1099504af950bde40a98a/e9ff0/final.png 180w,\n/static/1d3da01279e1099504af950bde40a98a/f21e7/final.png 360w,\n/static/1d3da01279e1099504af950bde40a98a/37523/final.png 720w,\n/static/1d3da01279e1099504af950bde40a98a/302a4/final.png 1080w,\n/static/1d3da01279e1099504af950bde40a98a/07a9c/final.png 1440w,\n/static/1d3da01279e1099504af950bde40a98a/95e59/final.png 1460w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"짧은-회고\" style=\"position:relative;\"><a href=\"#%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\" aria-label=\"짧은 회고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>짧은 회고</h2>\n<p>5차 스프린트 발표에 아쉬움이 많다.\n발표를 마치고부터 해당 포스팅을 적기 시작했는데… 하면 할 수록 발표 때 잘못 얘기한 부분만 보여서 유튜브에 올라올 것이 두려울 정도다 🥲\n그래도 깃허브 위키에 올려, 다른 백엔드 팀원들에게 공유해주려고 더 꼼꼼히 글을 쓰게 되었던건데…\n팀원들에게 잘못된 지식을 전하지 않아서 다행이다 😇</p>\n<p>별개로 인덱스 테스트에도 아쉬움이 있다.\n더미데이터를 적당히 넣으면 된다고 생각했는데, 실행계획을 분석할수록 <strong>실제 데이터가 어떻게 쌓이는가</strong>에 따라 결과가 많이 달라질 것 같아서였다.\n실사용 데이터가 좀 쌓인다면, 이번에 인덱스 과제를 하지 않은 다른 백엔드 팀원들이랑 함께, 한단계 더 최적화를 시도해보고 싶다🔥</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#-%EC%A4%8D%EC%A4%8D-mysql-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%ED%83%90%ED%97%98\">🧳 줍줍 MySQL 인덱스 탐험</a></li>\n<li><a href=\"#%EC%BF%BC%EB%A6%AC-%EC%B5%9C%EC%A0%81%ED%99%94-by%EB%B4%84\">쿼리 최적화 by.봄🌱</a></li>\n<li><a href=\"#-%EC%8B%A4%ED%97%98-%ED%99%98%EA%B2%BD\">🧪 실험 환경</a></li>\n<li><a href=\"#%EF%B8%8F-mysql%EC%9D%98-%EC%9E%90%EB%8F%99-%EC%83%9D%EC%84%B1-%EC%9D%B8%EB%8D%B1%EC%8A%A4\">⚙️ MySQL의 자동 생성 인덱스</a></li>\n<li><a href=\"#-channel\">📺 Channel</a></li>\n<li><a href=\"#-channelsubscription\">🔖 ChannelSubscription</a></li>\n<li><a href=\"#%EF%B8%8Fbookmark--reminder\">⭐️Bookmark &#x26; ⏰Reminder</a></li>\n<li><a href=\"#%EF%B8%8F-querydsl%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B3%B5%EC%9E%A1%ED%95%9C-%EC%BF%BC%EB%A6%AC%EB%93%A4\">✉️ Querydsl을 이용한 복잡한 쿼리들</a></li>\n<li><a href=\"#finally\">finally</a></li>\n<li><a href=\"#%EC%A7%A7%EC%9D%80-%ED%9A%8C%EA%B3%A0\">짧은 회고</a></li>\n</ul>\n</div>","frontmatter":{"date":"October 04, 2022","title":"줍줍 MySQL 인덱스 탐험","categories":"etc 우아한테크코스 트러블슈팅","author":"써머","emoji":"headers/db_index.png"},"fields":{"slug":"/db_index/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://hyewoncc.github.io","comments":{"utterances":{"repo":"hyewoncc/hyewoncc.github.io"}}}}},"pageContext":{"slug":"/jpa-auditing-and-ci/","nextSlug":"/db_index/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437","3350743975"]}